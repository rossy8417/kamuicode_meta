name: "Presentation Slide Creation Workflow"
run-name: "ðŸ“Š Creating presentation: ${{ github.event.inputs.presentation_topic || 'Business Presentation' }}"

on:
  workflow_dispatch:
    inputs:
      presentation_topic:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ãƒ¼ãƒžãƒ»é¡Œæ'
        required: true
        default: 'æ–°å•†å“ãƒžãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã€å››åŠæœŸæ¥­ç¸¾å ±å‘Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆææ¡ˆ'
        type: string
      target_audience:
        description: 'å¯¾è±¡è´è¡†'
        required: true
        type: choice
        options:
        - executives
        - management
        - colleagues
        - clients
        - general
        default: 'management'
      presentation_time:
        description: 'ç™ºè¡¨äºˆå®šæ™‚é–“'
        required: true
        type: choice
        options:
        - 5-minutes
        - 10-minutes
        - 15-minutes
        - 30-minutes
        - 45-minutes
        - 60-minutes
        default: '15-minutes'
      slide_count:
        description: 'å¸Œæœ›ã‚¹ãƒ©ã‚¤ãƒ‰æ•° (5-50)'
        required: true
        default: '15'
        type: choice
        options:
        - '5'
        - '10'
        - '15'
        - '20'
        - '25'
        - '30'
        - '35'
        - '40'
        - '45'
        - '50'
      content_type:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ž'
        required: true
        type: choice
        options:
        - proposal
        - report
        - analysis
        - training
        - sales
        - strategy
        default: 'proposal'
      data_visualization_needs:
        description: 'ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã®å¿…è¦æ€§'
        required: true
        type: choice
        options:
        - heavy
        - moderate
        - minimal
        default: 'moderate'
      presentation_style:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«'
        required: true
        type: choice
        options:
        - corporate
        - modern
        - creative
        - minimalist
        - technical
        default: 'corporate'
      color_preference:
        description: 'ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒžï¼ˆä»»æ„ï¼‰'
        required: false
        type: choice
        options:
        - blue
        - green
        - red
        - purple
        - neutral
        - brand
        default: 'blue'
      purpose:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ç›®çš„ï¼ˆä»»æ„ï¼‰'
        required: false
        default: 'æ–°å•†å“ã®æ‰¿èªã‚’å¾—ã‚‹ã€ãƒãƒ¼ãƒ ã®æ„è­˜çµ±ä¸€ã‚’å›³ã‚‹ã€æŠ•è³‡å®¶ã¸ã®èª¬å¾—'
        type: string

permissions:
  contents: write
  issues: read
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: äº‹å‰ãƒ†ã‚¹ãƒˆæ®µéšŽ
  connectivity-test:
    runs-on: ubuntu-latest
    outputs:
      services_ready: ${{ steps.test.outputs.services_ready }}
      image_generation_available: ${{ steps.test.outputs.image_generation_available }}
    steps:
      - name: Test design and generation services
        id: test
        run: |
          echo "ðŸ“Š Testing design and generation services..."
          
          mkdir -p generated/logs/connectivity-tests
          
          # Test Claude Code for presentation content generation
          echo "Testing presentation content generation..."
          if timeout 30 claude-code --prompt "Test: Create a simple slide title for testing." > generated/logs/connectivity-tests/content-test.log 2>&1; then
            CONTENT_GEN_STATUS="success"
            echo "âœ… Content Generation: Available"
          else
            CONTENT_GEN_STATUS="failed"
            echo "âŒ Content Generation: Failed"
          fi
          
          # Test image generation services for slide backgrounds
          echo "Testing image generation for slide backgrounds..."
          if timeout 90 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "professional business presentation background, corporate style" > generated/logs/connectivity-tests/image-test.log 2>&1; then
            IMAGE_GEN_STATUS="success"
            echo "âœ… Image Generation: Available"
          else
            IMAGE_GEN_STATUS="failed"
            echo "âš ï¸ Image Generation: Not available - will use text-only slides"
          fi
          
          # Set outputs
          echo "services_ready=true" >> $GITHUB_OUTPUT
          echo "image_generation_available=$IMAGE_GEN_STATUS" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Design services connectivity tests completed"

  # Phase 2: ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æžæ®µéšŽ
  presentation-analysis:
    needs: connectivity-test
    runs-on: ubuntu-latest
    outputs:
      analysis_ready: ${{ steps.analyze.outputs.analysis_ready }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Analyze presentation requirements
        id: analyze
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ” Analyzing presentation requirements..."
          
          mkdir -p generated/logs/presentation-analysis
          
          # Analyze presentation parameters
          TOPIC="${{ github.event.inputs.presentation_topic }}"
          AUDIENCE="${{ github.event.inputs.target_audience }}"
          TIME="${{ github.event.inputs.presentation_time }}"
          STYLE="${{ github.event.inputs.presentation_style }}"
          
          echo "Topic: $TOPIC"
          echo "Audience: $AUDIENCE"
          echo "Time: $TIME"
          echo "Style: $STYLE"
          
          # Generate presentation analysis
          claude-code --prompt "ä»¥ä¸‹ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶ã‚’åˆ†æžã—ã€æ§‹æˆã¨å†…å®¹ã®ææ¡ˆã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          ãƒ†ãƒ¼ãƒž: $TOPIC
          å¯¾è±¡è´è¡†: $AUDIENCE
          æ™‚é–“: $TIME
          ã‚¹ã‚¿ã‚¤ãƒ«: $STYLE
          ã‚¹ãƒ©ã‚¤ãƒ‰æ•°: ${{ github.event.inputs.slide_count }}
          å†…å®¹ã‚¿ã‚¤ãƒ—: ${{ github.event.inputs.content_type }}
          
          ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã¨å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®æ§‹æˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚" > generated/logs/presentation-analysis/requirements-analysis.json
          
          echo "analysis_ready=true" >> $GITHUB_OUTPUT
          echo "ðŸ” Presentation analysis completed"

  # Phase 3: ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆæ®µéšŽ
  slide-structure:
    needs: presentation-analysis
    runs-on: ubuntu-latest
    outputs:
      structure_ready: ${{ steps.structure.outputs.structure_ready }}
    steps:
      - name: Create slide structure and content
        id: structure
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ“‹ Creating slide structure and content..."
          
          mkdir -p generated/logs/slide-structure
          
          # Generate slide-by-slide content
          claude-code --prompt "å‰æ®µéšŽã®åˆ†æžçµæžœã‚’åŸºã«ã€å…·ä½“çš„ãªã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±:
          - ãƒ†ãƒ¼ãƒž: ${{ github.event.inputs.presentation_topic }}
          - å¯¾è±¡è´è¡†: ${{ github.event.inputs.target_audience }}
          - ã‚¹ãƒ©ã‚¤ãƒ‰æ•°: ${{ github.event.inputs.slide_count }}
          - å¯è¦–åŒ–ãƒ¬ãƒ™ãƒ«: ${{ github.event.inputs.data_visualization_needs }}
          
          å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®ã‚¿ã‚¤ãƒˆãƒ«ã€å†…å®¹ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚" > generated/logs/slide-structure/slide-content.json
          
          echo "structure_ready=true" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Slide structure creation completed"

  # Phase 4: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³æ®µéšŽ
  visual-design:
    needs: [connectivity-test, slide-structure]
    runs-on: ubuntu-latest
    outputs:
      design_ready: ${{ steps.design.outputs.design_ready }}
    steps:
      - name: Generate visual elements and backgrounds
        id: design
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸŽ¨ Generating visual elements and backgrounds..."
          
          mkdir -p generated/logs/visual-design
          
          IMAGE_GEN_AVAILABLE="${{ needs.connectivity-test.outputs.image_generation_available }}"
          
          if [ "$IMAGE_GEN_AVAILABLE" = "success" ]; then
            echo "Generating slide background..."
            STYLE_PROMPT="${{ github.event.inputs.presentation_style }} style, ${{ github.event.inputs.color_preference }} color scheme, professional presentation background"
            
            claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "$STYLE_PROMPT" > generated/logs/visual-design/background.json 2>&1 || echo "Background generation failed"
          else
            echo "âš ï¸ Image generation not available - using text-based design"
            echo '{"design_type": "text_only", "color_scheme": "${{ github.event.inputs.color_preference }}"}' > generated/logs/visual-design/design-plan.json
          fi
          
          echo "design_ready=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ¨ Visual design generation completed"

  # Phase 5: æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
  final-packaging:
    needs: [presentation-analysis, slide-structure, visual-design]
    runs-on: ubuntu-latest
    steps:
      - name: Create comprehensive presentation package
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ“¦ Creating comprehensive presentation package..."
          
          mkdir -p .final-output/{analysis,content,design}
          
          # Copy analysis documents
          cp generated/logs/presentation-analysis/requirements-analysis.json .final-output/analysis/ 2>/dev/null || true
          
          # Copy slide content
          cp generated/logs/slide-structure/slide-content.json .final-output/content/ 2>/dev/null || true
          
          # Copy design elements
          cp generated/logs/visual-design/*.json .final-output/design/ 2>/dev/null || true
          
          # Create master presentation information
          cat > .final-output/presentation-master.json << EOF
          {
            "project_info": {
              "project_name": "Business Presentation Creation",
              "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "github_run_id": "${{ github.run_id }}",
              "presentation_type": "business_slide_creation"
            },
            "input_parameters": {
              "presentation_topic": "${{ github.event.inputs.presentation_topic }}",
              "target_audience": "${{ github.event.inputs.target_audience }}",
              "presentation_time": "${{ github.event.inputs.presentation_time }}",
              "slide_count": "${{ github.event.inputs.slide_count }}",
              "content_type": "${{ github.event.inputs.content_type }}",
              "data_visualization_needs": "${{ github.event.inputs.data_visualization_needs }}",
              "presentation_style": "${{ github.event.inputs.presentation_style }}",
              "color_preference": "${{ github.event.inputs.color_preference }}",
              "purpose": "${{ github.event.inputs.purpose }}"
            },
            "deliverables": {
              "analysis_documents": {
                "requirements_analysis": "analysis/requirements-analysis.json"
              },
              "presentation_content": {
                "slide_content": "content/slide-content.json"
              },
              "design_elements": {
                "visual_design": "design/"
              }
            }
          }
          EOF
          
          # Create presentation creation guide
          cat > .final-output/PRESENTATION_GUIDE.md << 'EOF'
          # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰åˆ¶ä½œã‚¬ã‚¤ãƒ‰
          
          ## ðŸ“Š ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦
          - åˆ¶ä½œæ‰‹æ³•: AIåˆ†æžã«ã‚ˆã‚‹æ§‹é€ çš„ã‚¹ãƒ©ã‚¤ãƒ‰åˆ¶ä½œ
          - å“è³ªãƒ¬ãƒ™ãƒ«: ãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å¯¾å¿œ
          - ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚º: è´è¡†ãƒ»ç›®çš„åˆ¥æœ€é©åŒ–
          
          ## ðŸŽ¯ æ§‹æˆè¨­è¨ˆ
          - ãƒ†ãƒ¼ãƒžåˆ†æžã¨å¯¾è±¡è´è¡†ãƒžãƒƒãƒ”ãƒ³ã‚°
          - è«–ç†çš„ãªæµã‚Œã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ§‹ç¯‰
          - æ™‚é–“é…åˆ†ã¨æƒ…å ±å¯†åº¦æœ€é©åŒ–
          
          ## ðŸŽ¨ ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ 
          - ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ã¨ãƒ–ãƒ©ãƒ³ãƒ‰æ•´åˆæ€§
          - è¦–è¦šçš„éšŽå±¤ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­è¨ˆ
          - ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã¨å¯èª­æ€§ç¢ºä¿
          
          ## ðŸ“ˆ åŠ¹æžœçš„ãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
          - è´è¡†ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå‘ä¸Š
          - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ˜Žç¢ºåŒ–ã¨è¨˜æ†¶å®šç€
          - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³èª˜å°Žã¨ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—
          EOF
          
          echo "ðŸ“¦ Final presentation packaging completed"
          
      - name: Upload Presentation Package
        uses: actions/upload-artifact@v4
        with:
          name: presentation-package-${{ github.run_number }}
          path: .final-output/
          retention-days: 30
