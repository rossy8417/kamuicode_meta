# AIç”»åƒç”Ÿæˆ - è¶…è©³ç´°ã‚¿ã‚¹ã‚¯åˆ†è§£
name: "ai-image-generation"
description: "ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰AIç”»åƒã‚’ç”Ÿæˆ"
category: "visual-content-creation"
complexity_level: 3
estimated_duration_minutes: 25

# å‹•çš„ãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›ä»•æ§˜ (Dynamic Modal Input Specification)
dynamic_inputs_spec:
  modal_title: "AIç”»åƒç”Ÿæˆè¨­å®š"
  modal_description: "ç”Ÿæˆã—ãŸã„ç”»åƒã®è©³ç´°ãªè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  form_sections:
    - section_name: "åŸºæœ¬è¨­å®š"
      section_description: "ç”»åƒç”Ÿæˆã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"
      inputs:
        - name: "main_prompt"
          label: "ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
          type: "textarea"
          required: true
          placeholder: "ä¾‹: ç¾ã—ã„å¤•æ—¥ã®é¢¨æ™¯ã€ã‚¢ãƒ‹ãƒ¡ã‚¹ã‚¿ã‚¤ãƒ«ã€é«˜ç”»è³ªã€è©³ç´°ãªèƒŒæ™¯"
          description: "ç”Ÿæˆã—ãŸã„ç”»åƒã®è©³ç´°ãªèª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
          validation:
            min_length: 10
            max_length: 500
            pattern: "^[^<>\"'&]*$"  # HTMLã‚¿ã‚°ç­‰ã‚’é™¤å¤–
          
        - name: "negative_prompt"
          label: "ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (é™¤å¤–ã—ãŸã„è¦ç´ )"
          type: "textarea"
          required: false
          placeholder: "ä¾‹: ä½ç”»è³ªã€ä¸è‡ªç„¶ãªæ‰‹ã€ã¼ã‚„ã‘ãŸç”»åƒ"
          description: "ç”Ÿæˆã‹ã‚‰é™¤å¤–ã—ãŸã„è¦ç´ ã‚’æŒ‡å®š"
          validation:
            max_length: 200
    
    - section_name: "ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š"
      section_description: "ç”»åƒã®ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã¨å“è³ªè¨­å®š"
      inputs:
        - name: "art_style"
          label: "ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«"
          type: "select"
          required: true
          description: "ç”»åƒã®ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’é¸æŠ"
          options:
            - value: "photorealistic"
              label: "ğŸ“¸ ãƒ•ã‚©ãƒˆãƒªã‚¢ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯"
              description: "å†™çœŸã®ã‚ˆã†ãªãƒªã‚¢ãƒ«ãªç”»åƒ"
            - value: "anime"
              label: "ğŸŒ ã‚¢ãƒ‹ãƒ¡ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆ"
              description: "æ—¥æœ¬ã®ã‚¢ãƒ‹ãƒ¡ãƒ»ãƒãƒ³ã‚¬é¢¨ã‚¤ãƒ©ã‚¹ãƒˆ"
            - value: "oil_painting"
              label: "ğŸ¨ æ²¹çµµèª¿"
              description: "ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãªæ²¹çµµã®ã‚¿ãƒƒãƒ"
            - value: "digital_art"
              label: "ğŸ’» ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆ"
              description: "ç¾ä»£çš„ãªãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ãƒˆ"
            - value: "watercolor"
              label: "ğŸŒˆ æ°´å½©ç”»"
              description: "æŸ”ã‚‰ã‹ãªæ°´å½©ç”»èª¿"
          default: "photorealistic"
        
        - name: "quality_level"
          label: "å“è³ªãƒ¬ãƒ™ãƒ«"
          type: "range"
          required: true
          min: 1
          max: 10
          default: 8
          step: 1
          description: "ç”»åƒå“è³ª (1=æœ€ä½å“è³ªãƒ»é«˜é€Ÿ, 10=æœ€é«˜å“è³ªãƒ»ä½é€Ÿ)"
          
        - name: "creativity_level"
          label: "å‰µé€ æ€§ãƒ¬ãƒ™ãƒ«"
          type: "range"
          required: true
          min: 1
          max: 10
          default: 5
          step: 1
          description: "å‰µé€ æ€§ (1=ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå³å®ˆ, 10=å‰µé€ çš„è§£é‡ˆ)"
    
    - section_name: "ç”»åƒè¨­å®š"
      section_description: "ç”»åƒã‚µã‚¤ã‚ºã¨æŠ€è¡“çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"
      inputs:
        - name: "aspect_ratio"
          label: "ç¸¦æ¨ªæ¯”"
          type: "select"
          required: true
          description: "ç”»åƒã®ç¸¦æ¨ªæ¯”ã‚’é¸æŠï¼ˆSNSæ˜ ãˆé‡è¦–ã®ãŸã‚1:1ã‚’æ¨™æº–è¨­å®šï¼‰"
          options:
            - value: "1:1"
              label: "1:1 (æ­£æ–¹å½¢) - SNSæŠ•ç¨¿ãƒ»Instagramæœ€é© â­æ¨å¥¨"
            - value: "16:9"
              label: "16:9 (æ¨ªé•·) - ãƒãƒŠãƒ¼ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ã«æœ€é©"
            - value: "4:3"
              label: "4:3 (æ¨ªé•·) - ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ»å°åˆ·ã«æœ€é©"
            - value: "3:4"
              label: "3:4 (ç¸¦é•·) - ãƒã‚¹ã‚¿ãƒ¼ãƒ»ã‚¹ãƒãƒ›ç”»é¢ã«æœ€é©"
            - value: "9:16"
              label: "9:16 (ç¸¦é•·) - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ç¸¦å‹•ç”»ã«æœ€é©"
          default: "1:1"
        
        - name: "image_count"
          label: "ç”Ÿæˆæšæ•°"
          type: "number"
          required: true
          min: 1
          max: 8
          default: 4
          description: "åŒæ™‚ã«ç”Ÿæˆã™ã‚‹ç”»åƒã®æšæ•° (å¤šã„ã»ã©é¸æŠè‚¢ãŒå¢—ãˆã‚‹ãŒæ™‚é–“ãŒã‹ã‹ã‚‹)"
        
        - name: "mcp_service_priority"
          label: "ä½¿ç”¨MCPã‚µãƒ¼ãƒ“ã‚¹å„ªå…ˆåº¦"
          type: "select"
          required: true
          description: "ç”»åƒç”Ÿæˆã«ä½¿ç”¨ã™ã‚‹MCPã‚µãƒ¼ãƒ“ã‚¹ã®å„ªå…ˆé †ä½"
          options:
            - value: "ultra_quality"
              label: "ğŸ”¥ Ultraå“è³ªå„ªå…ˆ (imagen4-ultra â†’ imagen4-fast â†’ imagen3)"
            - value: "balanced"
              label: "âš¡ ãƒãƒ©ãƒ³ã‚¹é‡è¦– (imagen4-fast â†’ imagen4-ultra â†’ imagen3)"
            - value: "speed_priority"
              label: "ğŸš€ é€Ÿåº¦å„ªå…ˆ (imagen4-fast â†’ imagen3 â†’ imagen4-ultra)"
            - value: "google_only"
              label: "ğŸŸ¢ Googleå°‚ç”¨ (imagen3ã®ã¿)"
          default: "balanced"

# å‹•çš„inputsç”Ÿæˆç”¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°è¨­å®š
github_actions_inputs_mapping:
  # ä¸Šè¨˜ã®å‹•çš„inputsä»•æ§˜ã‚’GitHub Actions workflow inputsã«å¤‰æ›ã™ã‚‹éš›ã®è¨­å®š
  inputs_conversion:
    textarea: "string"
    select: "choice" 
    number: "number"
    range: "number"
  
  # ç”Ÿæˆã•ã‚Œã‚‹GitHub Actions inputsã®ä¾‹
  generated_inputs_preview:
    main_prompt:
      description: "ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ - ç”Ÿæˆã—ãŸã„ç”»åƒã®è©³ç´°ãªèª¬æ˜"
      required: true
      type: string
    art_style:
      description: "ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«"
      required: true
      type: choice
      options: ["photorealistic", "anime", "oil_painting", "digital_art", "watercolor"]
      default: "photorealistic"
    quality_level:
      description: "å“è³ªãƒ¬ãƒ™ãƒ« (1-10)"
      required: true
      type: number
      default: 8

# äººé–“ã®ç„¡æ„è­˜æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹
human_process:
  - phase: "concept_development"
    description: "ã‚³ãƒ³ã‚»ãƒ—ãƒˆé–‹ç™ºæ®µéšï¼ˆã‚¢ã‚¤ãƒ‡ã‚¢â†’å…·ä½“çš„ãªãƒ“ã‚¸ãƒ§ãƒ³ï¼‰"
  - phase: "prompt_engineering" 
    description: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆæ®µéšï¼ˆè©³ç´°ãªæŒ‡ç¤ºä½œæˆï¼‰"
  - phase: "generation_execution"
    description: "ç”Ÿæˆå®Ÿè¡Œæ®µéšï¼ˆAIç”Ÿæˆãƒ»èª¿æ•´ï¼‰"
  - phase: "quality_refinement"
    description: "å“è³ªæ”¹å–„æ®µéšï¼ˆæ¤œè¨¼ãƒ»ä¿®æ­£ãƒ»å‘ä¸Šï¼‰"
  - phase: "output_preparation"
    description: "å‡ºåŠ›æº–å‚™æ®µéšï¼ˆå½¢å¼æœ€é©åŒ–ãƒ»é…ä¿¡æº–å‚™ï¼‰"

# GitHub Actions ãƒãƒ¼ãƒ‰è¨­è¨ˆ
github_actions_config:
  workflow_name: "AI Image Generation"
  on_triggers: ["workflow_dispatch", "issues"]
  permissions:
    contents: "write"
    issues: "write"
    actions: "read"
  artifacts_retention_days: 14
  max_parallel_jobs: 3

# è¶…è©³ç´°ã‚¿ã‚¹ã‚¯åˆ†è§£
tasks:
  # === äº‹å‰ãƒ†ã‚¹ãƒˆæ®µéš ===
  - id: "mcp-api-connectivity-test"
    name: "ç”»åƒç”Ÿæˆç”¨MCPãƒ»APIæ¥ç¶šãƒ†ã‚¹ãƒˆ"
    phase: "pre_validation"
    github_job: "connectivity-test"
    type: "validation"
    implementation: "mcp"
    duration_minutes: 2
    dependencies: []
    parallel_group: null
    
    github_steps:
      - name: "Test image generation services"
        shell: "bash"
        script: |
          echo "ğŸ¨ Testing image generation services..."
          
          mkdir -p .logs/connectivity-tests
          
          # MCP Kamuicodeè¨­å®šãƒ†ã‚¹ãƒˆ
          echo "Testing MCP Kamuicode configuration..."
          if [ -f "~/.claude/mcp-kamuicode.json" ]; then
            echo "âœ… MCP Configuration file found"
            MCP_CONFIG_STATUS="success"
          else
            echo "âš ï¸ MCP Configuration file not found, using default"
            MCP_CONFIG_STATUS="default"
          fi
          
          # é«˜å“è³ªç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆImagen4 Ultraï¼‰
          echo "Testing high-quality image generation (Imagen4 Ultra)..."
          if timeout 60 claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-ultra --prompt "test high quality image" > .logs/connectivity-tests/imagen4-ultra-test.log 2>&1; then
            IMAGEN4_ULTRA_STATUS="success"
            echo "âœ… Imagen4 Ultra: Available"
          else
            IMAGEN4_ULTRA_STATUS="failed"
            echo "âš ï¸ Imagen4 Ultra: Not available"
          fi
          
          # é«˜é€Ÿç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆImagen4 Fastï¼‰
          echo "Testing fast image generation (Imagen4 Fast)..."
          if timeout 30 claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "test fast image" > .logs/connectivity-tests/imagen4-fast-test.log 2>&1; then
            IMAGEN4_FAST_STATUS="success"
            echo "âœ… Imagen4 Fast: Available"
          else
            IMAGEN4_FAST_STATUS="failed"
            echo "âš ï¸ Imagen4 Fast: Not available"
          fi
          
          # Google Imagen3 ãƒ†ã‚¹ãƒˆï¼ˆä»£æ›¿æ¡ˆï¼‰
          echo "Testing Google Imagen3..."
          if timeout 45 claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-google-imagen3 --prompt "test google imagen" > .logs/connectivity-tests/google-imagen3-test.log 2>&1; then
            GOOGLE_IMAGEN3_STATUS="success"
            echo "âœ… Google Imagen3: Available"
          else
            GOOGLE_IMAGEN3_STATUS="failed"
            echo "âš ï¸ Google Imagen3: Not available"
          fi
          
          # æœ€ä½1ã¤ã®ç”»åƒç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$IMAGEN4_ULTRA_STATUS" = "success" ] || [ "$IMAGEN4_FAST_STATUS" = "success" ] || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ]; then
            IMAGE_GEN_STATUS="success"
            echo "âœ… At least one image generation service available"
          else
            IMAGE_GEN_STATUS="failed"
            echo "âŒ No image generation services available - Cannot proceed"
          fi
          
          # MCP Kamuicode ãƒ†ã‚¹ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ç”»åƒå‡¦ç†ï¼‰
          echo "Testing MCP kamuicode (image processing functions)..."
          if timeout 20 claude-code --mcp kamuicode --function test-image-processing > .logs/connectivity-tests/kamuicode-test.log 2>&1; then
            KAMUICODE_STATUS="success"
            echo "âœ… MCP Kamuicode: Available"
          else
            KAMUICODE_STATUS="failed"
            echo "âš ï¸ MCP Kamuicode: Not available - will use standard processing"
          fi
          
          # å¤–éƒ¨ç”»åƒAPI ãƒ†ã‚¹ãƒˆï¼ˆStable Diffusion, DALL-Eç­‰ï¼‰
          echo "Testing external image APIs..."
          if [ -n "${{ secrets.EXTERNAL_IMAGE_API_KEY }}" ]; then
            if timeout 30 curl -s -H "Authorization: Bearer ${{ secrets.EXTERNAL_IMAGE_API_KEY }}" https://api.example-image-service.com/health > .logs/connectivity-tests/external-api-test.log 2>&1; then
              EXTERNAL_API_STATUS="success"
              echo "âœ… External Image API: Available"
            else
              EXTERNAL_API_STATUS="failed"
              echo "âš ï¸ External Image API: Failed - will use MCP generation only"
            fi
          else
            EXTERNAL_API_STATUS="not_configured"
            echo "â„¹ï¸ External Image API: Not configured - using MCP generation"
          fi
          
          # ãƒ†ã‚¹ãƒˆçµæœã‚’JSONä¿å­˜
          cat > .logs/connectivity-tests/test-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "mcp_config_status": "$MCP_CONFIG_STATUS",
            "available_image_services": {
              "imagen4_ultra": "$IMAGEN4_ULTRA_STATUS",
              "imagen4_fast": "$IMAGEN4_FAST_STATUS", 
              "google_imagen3": "$GOOGLE_IMAGEN3_STATUS",
              "kamuicode_processing": "$KAMUICODE_STATUS",
              "external_api": "$EXTERNAL_API_STATUS"
            },
            "service_priorities": [
              "$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || echo "")",
              "$([ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || echo "")",
              "$([ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "")"
            ],
            "overall_status": "$([ "$IMAGE_GEN_STATUS" = "success" ] && echo "ready" || echo "failed")",
            "critical_services_available": $([ "$IMAGE_GEN_STATUS" = "success" ] && echo "true" || echo "false"),
            "workflow_can_proceed": $([ "$IMAGE_GEN_STATUS" = "success" ] && echo "true" || echo "false"),
            "recommended_service": "$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || [ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "none")"
          }
          EOF
          
          # ç’°å¢ƒå¤‰æ•°ã«çµæœã‚’è¨­å®š
          echo "CONNECTIVITY_STATUS=$([ "$IMAGE_GEN_STATUS" = "success" ] && echo "ready" || echo "failed")" >> $GITHUB_ENV
          echo "RECOMMENDED_IMAGE_SERVICE=$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || [ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "none")" >> $GITHUB_ENV
          echo "HIGH_QUALITY_AVAILABLE=$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "true" || echo "false")" >> $GITHUB_ENV
          echo "FAST_GENERATION_AVAILABLE=$([ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "true" || echo "false")" >> $GITHUB_ENV
          
          echo "ğŸ¨ Image generation service tests completed"
          
    validation:
      criteria:
        - "ç”»åƒç”ŸæˆMCPãŒåˆ©ç”¨å¯èƒ½"
        - "å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®æ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªæ¸ˆã¿"
        - "ãƒ†ã‚¹ãƒˆçµæœãŒJSONå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹"
      validation_script: |
        if [ ! -f ".logs/connectivity-tests/test-results.json" ]; then
          echo "âŒ VALIDATION FAILED: Test results missing"
          exit 1
        fi
        
        WORKFLOW_CAN_PROCEED=$(jq -r '.workflow_can_proceed' .logs/connectivity-tests/test-results.json)
        if [ "$WORKFLOW_CAN_PROCEED" = "true" ]; then
          echo "âœ… Validation passed: Image generation services ready"
        else
          echo "âŒ VALIDATION FAILED: Image generation services unavailable"
          exit 1
        fi
        
    error_handling:
      retry_count: 2
      retry_delay_seconds: 15
      fallback_strategy: "abort_workflow"
      fallback_script: |
        echo "âŒ CRITICAL: Image generation services unavailable - workflow cannot proceed"
        exit 1
        
    progress_links:
      log_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      test_results: ".logs/connectivity-tests/test-results.json"

  # === ã‚³ãƒ³ã‚»ãƒ—ãƒˆé–‹ç™ºæ®µéš ===
  - id: "input-prompt-analysis"
    name: "å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆ†æãƒ»ç†è§£"
    phase: "concept_development"
    github_job: "prompt-analysis"
    type: "analysis"
    implementation: "ai"
    duration_minutes: 2
    dependencies: ["mcp-api-connectivity-test"]
    parallel_group: null
    
    github_steps:
      - name: "Analyze input prompt"
        shell: "bash"
        script: |
          echo "ğŸ” Analyzing input prompt for image generation..."
          
          mkdir -p .logs/concept-development
          
          # å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
          INPUT_PROMPT="${{ github.event.inputs.image_prompt || github.event.issue.body }}"
          echo "Input prompt: $INPUT_PROMPT"
          
          # Claude Code ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æ
          claude-code --prompt "ä»¥ä¸‹ã®ç”»åƒç”Ÿæˆè¦æ±‚ã‚’è©³ç´°ã«åˆ†æã—ã¦ãã ã•ã„ï¼š
          
          å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $INPUT_PROMPT
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"image_type\": \"portrait|landscape|illustration|photo|abstract|logo|icon|concept_art\",
            \"style_category\": \"photorealistic|artistic|cartoon|anime|vintage|modern|minimalist|detailed\",
            \"subject_matter\": \"ä¸»è¦ãªè¢«å†™ä½“ãƒ»ãƒ†ãƒ¼ãƒ\",
            \"mood_tone\": \"æ˜ã‚‹ã„|æš—ã„|ç¥ç§˜çš„|æ´»æ°—ã®ã‚ã‚‹|é™å¯‚ãª|ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯\",
            \"color_palette\": [\"æ¨å¥¨ã•ã‚Œã‚‹è‰²å½©ã®ãƒªã‚¹ãƒˆ\"],
            \"technical_requirements\": {
              \"aspect_ratio\": \"1:1|16:9|9:16|4:3|3:4\",
              \"resolution\": \"recommended resolution\",
              \"style_strength\": \"high|medium|low\"
            },
            \"creative_direction\": \"å‰µä½œã®æ–¹å‘æ€§èª¬æ˜\",
            \"potential_challenges\": [\"ç”Ÿæˆæ™‚ã«æ³¨æ„ã™ã¹ãç‚¹\"],
            \"enhancement_suggestions\": [\"ã‚ˆã‚Šè‰¯ã„çµæœã®ãŸã‚ã®ææ¡ˆ\"]
          }" > .logs/concept-development/prompt-analysis.json
          
          PROMPT_ANALYSIS=$(cat .logs/concept-development/prompt-analysis.json)
          echo "PROMPT_ANALYSIS=$PROMPT_ANALYSIS" >> $GITHUB_ENV
          
          echo "âœ… Prompt analysis completed"
          
    validation:
      criteria:
        - "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æçµæœãŒJSONå½¢å¼ã§å­˜åœ¨ã™ã‚‹"
        - "å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¨ã¦å«ã¾ã‚Œã¦ã„ã‚‹"
        - "å®Ÿè¡Œå¯èƒ½ãªæŠ€è¡“è¦ä»¶ãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹"
      validation_script: |
        if [ ! -f ".logs/concept-development/prompt-analysis.json" ]; then
          echo "âŒ VALIDATION FAILED: Prompt analysis missing"
          exit 1
        fi
        if ! jq -e '.image_type' .logs/concept-development/prompt-analysis.json > /dev/null; then
          echo "âŒ VALIDATION FAILED: Invalid analysis structure"
          exit 1
        fi
        echo "âœ… Validation passed: Prompt analysis complete"

  - id: "visual-concept-planning"
    name: "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¨ˆç”»"
    phase: "concept_development"
    github_job: "concept-planning"
    type: "planning"
    implementation: "ai"
    duration_minutes: 3
    dependencies: ["input-prompt-analysis"]
    parallel_group: null
    
    github_steps:
      - name: "Plan visual concept"
        shell: "bash"
        script: |
          echo "ğŸ¯ Planning visual concept..."
          
          # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è©³ç´°è¨ˆç”»
          claude-code --prompt "ä»¥ä¸‹ã®åˆ†æçµæœã‚’åŸºã«ã€å…·ä½“çš„ãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è¨ˆç”»ã—ã¦ãã ã•ã„ï¼š
          
          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æ: $PROMPT_ANALYSIS
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"composition_plan\": {
              \"main_focus\": \"ãƒ¡ã‚¤ãƒ³ã®ç„¦ç‚¹è¦ç´ \",
              \"background\": \"èƒŒæ™¯ã®æå†™\",
              \"foreground\": \"å‰æ™¯ã®è¦ç´ \",
              \"depth_layers\": [\"å¥¥è¡Œãã‚’æ§‹æˆã™ã‚‹å±¤ã®ãƒªã‚¹ãƒˆ\"]
            },
            \"lighting_plan\": {
              \"light_source\": \"å…‰æºã®ç¨®é¡ã¨ä½ç½®\",
              \"shadow_direction\": \"å½±ã®æ–¹å‘\",
              \"ambient_lighting\": \"ç’°å¢ƒå…‰ã®ç‰¹å¾´\",
              \"mood_lighting\": \"ãƒ ãƒ¼ãƒ‰ã‚’ä½œã‚‹ç…§æ˜åŠ¹æœ\"
            },
            \"color_scheme\": {
              \"primary_colors\": [\"ä¸»è¦è‰²ã®ãƒªã‚¹ãƒˆ\"],
              \"accent_colors\": [\"ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²ã®ãƒªã‚¹ãƒˆ\"],
              \"color_temperature\": \"warm|cool|neutral\",
              \"contrast_level\": \"high|medium|low\"
            },
            \"detail_specifications\": {
              \"texture_details\": [\"ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®è©³ç´°\"],
              \"material_properties\": [\"ç´ æã®ç‰¹æ€§\"],
              \"fine_details\": [\"ç´°ã‹ãªãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«\"]
            },
            \"generation_strategy\": {
              \"primary_approach\": \"ç”Ÿæˆã®ä¸»è¦ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ\",
              \"fallback_options\": [\"ä»£æ›¿æ¡ˆã®ãƒªã‚¹ãƒˆ\"],
              \"iteration_plan\": \"åå¾©æ”¹å–„ã®è¨ˆç”»\"
            }
          }" > .logs/concept-development/visual-concept.json
          
          VISUAL_CONCEPT=$(cat .logs/concept-development/visual-concept.json)
          echo "VISUAL_CONCEPT=$VISUAL_CONCEPT" >> $GITHUB_ENV
          
          echo "âœ… Visual concept planning completed"

  # === ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆæ®µéš ===
  - id: "detailed-prompt-engineering"
    name: "è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°"
    phase: "prompt_engineering"
    github_job: "prompt-engineering"
    type: "generation"
    implementation: "ai"
    duration_minutes: 4
    dependencies: ["visual-concept-planning"]
    parallel_group: null
    
    github_steps:
      - name: "Engineer detailed prompts"
        shell: "bash"
        script: |
          echo "âš™ï¸ Engineering detailed generation prompts..."
          
          mkdir -p .logs/prompt-engineering
          
          # è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ
          claude-code --prompt "ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€AIç”»åƒç”Ÿæˆç”¨ã®æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æ: $PROMPT_ANALYSIS
          ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $VISUAL_CONCEPT
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"primary_prompt\": \"ãƒ¡ã‚¤ãƒ³ã®ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆè©³ç´°ã§å…·ä½“çš„ï¼‰\",
            \"negative_prompt\": \"é™¤å¤–ã—ãŸã„è¦ç´ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"style_prompts\": {
              \"photorealistic\": \"å†™å®Ÿçš„ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"artistic\": \"èŠ¸è¡“çš„ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"alternative\": \"ä»£æ›¿ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\"
            },
            \"technical_parameters\": {
              \"recommended_steps\": \"æ¨å¥¨ã‚¹ãƒ†ãƒƒãƒ—æ•°\",
              \"cfg_scale\": \"æ¨å¥¨CFGã‚¹ã‚±ãƒ¼ãƒ«\",
              \"seed_strategy\": \"ã‚·ãƒ¼ãƒ‰å€¤ã®æˆ¦ç•¥\",
              \"batch_settings\": \"ãƒãƒƒãƒç”Ÿæˆè¨­å®š\"
            },
            \"quality_enhancers\": [\"å“è³ªå‘ä¸Šã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ \"],
            \"variation_prompts\": [\"ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¡ˆ\"],
            \"prompt_weights\": {\"é‡è¦åº¦ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ ã®é‡ã¿ä»˜ã‘\": \"å€¤\"}
          }" > .logs/prompt-engineering/engineered-prompts.json
          
          ENGINEERED_PROMPTS=$(cat .logs/prompt-engineering/engineered-prompts.json)
          echo "ENGINEERED_PROMPTS=$ENGINEERED_PROMPTS" >> $GITHUB_ENV
          
          echo "âœ… Prompt engineering completed"

  - id: "prompt-optimization"
    name: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ãƒ»æ¤œè¨¼"
    phase: "prompt_engineering"
    github_job: "prompt-optimization"
    type: "optimization"
    implementation: "ai"
    duration_minutes: 2
    dependencies: ["detailed-prompt-engineering"]
    parallel_group: null
    
    github_steps:
      - name: "Optimize and validate prompts"
        shell: "bash"
        script: |
          echo "ğŸ”§ Optimizing and validating prompts..."
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–ã¨æ¤œè¨¼
          claude-code --prompt "ä»¥ä¸‹ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–ã—ã€æ¤œè¨¼ã—ã¦ãã ã•ã„ï¼š
          
          ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGINEERED_PROMPTS
          
          æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ:
          - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é•·ã•ã¨åŠ¹ç‡æ€§
          - çŸ›ç›¾ã™ã‚‹æŒ‡ç¤ºã®å‰Šé™¤
          - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å„ªå…ˆé †ä½ä»˜ã‘
          - AIç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã¨ã®äº’æ›æ€§
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"optimized_primary_prompt\": \"æœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"optimized_negative_prompt\": \"æœ€é©åŒ–ã•ã‚ŒãŸãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"prompt_validation\": {
              \"clarity_score\": \"1-10ç‚¹ã§ã®æ˜ç¢ºæ€§è©•ä¾¡\",
              \"specificity_score\": \"1-10ç‚¹ã§ã®å…·ä½“æ€§è©•ä¾¡\",
              \"compatibility_score\": \"1-10ç‚¹ã§ã®AIäº’æ›æ€§è©•ä¾¡\",
              \"potential_issues\": [\"æ½œåœ¨çš„ãªå•é¡Œç‚¹\"],
              \"improvement_notes\": [\"æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ\"]
            },
            \"final_generation_config\": {
              \"prompt\": \"æœ€çµ‚çš„ãªç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"negative_prompt\": \"æœ€çµ‚çš„ãªãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"parameters\": {\"æŠ€è¡“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\": \"å€¤\"}
            }
          }" > .logs/prompt-engineering/optimized-prompts.json
          
          OPTIMIZED_PROMPTS=$(cat .logs/prompt-engineering/optimized-prompts.json)
          echo "OPTIMIZED_PROMPTS=$OPTIMIZED_PROMPTS" >> $GITHUB_ENV
          
          echo "âœ… Prompt optimization completed"

  # === ç”Ÿæˆå®Ÿè¡Œæ®µéš ===
  - id: "initial-image-generation"
    name: "åˆå›ç”»åƒç”Ÿæˆ"
    phase: "generation_execution"
    github_job: "initial-generation"
    type: "generation"
    implementation: "mcp"
    tool: "image-generation"
    duration_minutes: 5
    dependencies: ["prompt-optimization"]
    parallel_group: null
    
    github_steps:
      - name: "Generate initial images"
        shell: "bash"
        script: |
          echo "ğŸ¨ Generating initial images..."
          
          mkdir -p .logs/generation .outputs/images
          
          # æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
          FINAL_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.prompt')
          NEGATIVE_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.negative_prompt')
          
          echo "Final prompt: $FINAL_PROMPT"
          echo "Negative prompt: $NEGATIVE_PROMPT"
          
          # æ¨å¥¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãŸç”»åƒç”Ÿæˆ
          RECOMMENDED_SERVICE="$RECOMMENDED_IMAGE_SERVICE"
          echo "Using recommended service: $RECOMMENDED_SERVICE"
          
          # ãƒ¡ã‚¤ãƒ³ç”»åƒç”Ÿæˆ
          echo "Generating primary image with $RECOMMENDED_SERVICE..."
          if [ "$RECOMMENDED_SERVICE" = "t2i-fal-imagen4-ultra" ]; then
            # é«˜å“è³ªç”Ÿæˆï¼ˆImagen4 Ultraï¼‰
            if claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-ultra \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              --config '{"quality": "ultra", "aspect_ratio": "1:1", "safety_level": "standard"}' \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Imagen4 Ultra"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Imagen4 Ultra generation failed"
            fi
            
          elif [ "$RECOMMENDED_SERVICE" = "t2i-fal-imagen4-fast" ]; then
            # é«˜é€Ÿç”Ÿæˆï¼ˆImagen4 Fastï¼‰
            if claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              --config '{"speed": "fast", "aspect_ratio": "1:1"}' \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Imagen4 Fast"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Imagen4 Fast generation failed"
            fi
            
          elif [ "$RECOMMENDED_SERVICE" = "t2i-google-imagen3" ]; then
            # Google Imagen3 ç”Ÿæˆ
            if claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-google-imagen3 \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Google Imagen3"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Google Imagen3 generation failed"
            fi
          else
            PRIMARY_STATUS="failed"
            echo "âŒ No available image generation service"
          fi
          
          # ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆé«˜é€Ÿã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨ï¼‰
          echo "Generating variation with fast service..."
          if [ "$FAST_GENERATION_AVAILABLE" = "true" ]; then
            if claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast \
              --prompt "$FINAL_PROMPT, artistic variation, creative interpretation" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/variant_1.png" \
              --config '{"speed": "fast", "variation": "high"}' \
              > .logs/generation/variant1-generation.log 2>&1; then
              VARIANT1_STATUS="success"
              echo "âœ… Variant 1 generated with fast service"
            else
              VARIANT1_STATUS="failed"
              echo "âš ï¸ Variant 1 generation failed"
            fi
          else
            VARIANT1_STATUS="skipped"
            echo "âš ï¸ Fast generation not available, skipping variant"
          fi
          
          # ç”Ÿæˆçµæœã‚’ãƒ­ã‚°ä¿å­˜
          cat > .logs/generation/generation-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "primary_image": {
              "status": "$PRIMARY_STATUS",
              "path": ".outputs/images/primary_image.png",
              "prompt_used": "$FINAL_PROMPT",
              "generation_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            },
            "variant_1": {
              "status": "$VARIANT1_STATUS",
              "path": ".outputs/images/variant_1.png"
            },
            "overall_success": $([ "$PRIMARY_STATUS" = "success" ] && echo "true" || echo "false")
          }
          EOF
          
          echo "GENERATION_RESULTS=$(cat .logs/generation/generation-results.json)" >> $GITHUB_ENV
          
          echo "ğŸ¨ Initial image generation completed"
          
    validation:
      criteria:
        - "å°‘ãªãã¨ã‚‚1ã¤ã®ç”»åƒãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹"
        - "ç”Ÿæˆã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹"
        - "ç”ŸæˆçµæœãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹"
      validation_script: |
        if [ ! -f ".logs/generation/generation-results.json" ]; then
          echo "âŒ VALIDATION FAILED: Generation results missing"
          exit 1
        fi
        
        OVERALL_SUCCESS=$(jq -r '.overall_success' .logs/generation/generation-results.json)
        if [ "$OVERALL_SUCCESS" = "true" ]; then
          echo "âœ… Validation passed: At least one image generated successfully"
        else
          echo "âŒ VALIDATION FAILED: No images generated successfully"
          exit 1
        fi
        
    error_handling:
      retry_count: 3
      retry_delay_seconds: 30
      fallback_strategy: "simplified_generation"
      fallback_script: |
        echo "âš ï¸ Using fallback: Trying alternative image generation services"
        SIMPLE_PROMPT=$(echo "$PROMPT_ANALYSIS" | jq -r '.subject_matter')
        
        # Google Imagen3 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if [ "$GOOGLE_IMAGEN3_STATUS" = "success" ]; then
          claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-google-imagen3 \
            --prompt "$SIMPLE_PROMPT, high quality" \
            --output ".outputs/images/fallback_image.png" \
            > .logs/generation/fallback-generation.log 2>&1 || echo "Google Imagen3 fallback failed"
        # Imagen4 Fast ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯  
        elif [ "$IMAGEN4_FAST_STATUS" = "success" ]; then
          claude-code --mcp-config=~/.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast \
            --prompt "$SIMPLE_PROMPT, high quality" \
            --output ".outputs/images/fallback_image.png" \
            > .logs/generation/fallback-generation.log 2>&1 || echo "Imagen4 Fast fallback failed"
        else
          echo "No fallback services available"
        fi

  - id: "image-quality-analysis"
    name: "ç”»åƒå“è³ªåˆ†æ"
    phase: "generation_execution"
    github_job: "quality-analysis"
    type: "analysis"
    implementation: "ai"
    duration_minutes: 3
    dependencies: ["initial-image-generation"]
    parallel_group: "quality_parallel"
    
    github_steps:
      - name: "Analyze image quality"
        shell: "bash"
        script: |
          echo "ğŸ” Analyzing generated image quality..."
          
          mkdir -p .logs/quality-analysis
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®å“è³ªåˆ†æ
          claude-code --prompt "ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’åˆ†æã—ã¦å“è³ªè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          
          ç”Ÿæˆçµæœ: $GENERATION_RESULTS
          å…ƒã®è¦æ±‚: $PROMPT_ANALYSIS
          
          ä»¥ä¸‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦åˆ†æã—ã¦ãã ã•ã„ï¼š
          - .outputs/images/primary_image.png
          - .outputs/images/variant_1.pngï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"primary_image_analysis\": {
              \"technical_quality\": \"1-10ç‚¹ã§ã®æŠ€è¡“å“è³ªè©•ä¾¡\",
              \"prompt_adherence\": \"1-10ç‚¹ã§ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¿ å®Ÿåº¦\",
              \"artistic_merit\": \"1-10ç‚¹ã§ã®èŠ¸è¡“çš„ä¾¡å€¤\",
              \"composition_quality\": \"1-10ç‚¹ã§ã®æ§‹å›³å“è³ª\",
              \"color_harmony\": \"1-10ç‚¹ã§ã®è‰²å½©èª¿å’Œ\",
              \"detail_level\": \"1-10ç‚¹ã§ã®è©³ç´°åº¦\",
              \"overall_rating\": \"1-10ç‚¹ã§ã®ç·åˆè©•ä¾¡\"
            },
            \"strengths\": [\"ç”»åƒã®å„ªã‚Œã¦ã„ã‚‹ç‚¹\"],
            \"weaknesses\": [\"æ”¹å–„ãŒå¿…è¦ãªç‚¹\"],
            \"improvement_suggestions\": [\"å…·ä½“çš„ãªæ”¹å–„ææ¡ˆ\"],
            \"regeneration_needed\": $([ "$OVERALL_SUCCESS" = "true" ] && echo "false" || echo "true"),
            \"refinement_areas\": [\"é‡ç‚¹çš„ã«æ”¹å–„ã™ã¹ãé ˜åŸŸ\"]
          }" > .logs/quality-analysis/quality-assessment.json
          
          QUALITY_ANALYSIS=$(cat .logs/quality-analysis/quality-assessment.json)
          echo "QUALITY_ANALYSIS=$QUALITY_ANALYSIS" >> $GITHUB_ENV
          
          echo "âœ… Image quality analysis completed"

  - id: "metadata-extraction"
    name: "ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º"
    phase: "generation_execution"
    github_job: "metadata-extraction"
    type: "processing"
    implementation: "script"
    duration_minutes: 1
    dependencies: ["initial-image-generation"]
    parallel_group: "quality_parallel"
    
    github_steps:
      - name: "Extract image metadata"
        shell: "bash"
        script: |
          echo "ğŸ“Š Extracting image metadata..."
          
          mkdir -p .logs/metadata
          
          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
          if [ -f ".outputs/images/primary_image.png" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨åŸºæœ¬æƒ…å ±
            FILE_SIZE=$(stat -f%z ".outputs/images/primary_image.png" 2>/dev/null || stat -c%s ".outputs/images/primary_image.png" 2>/dev/null || echo "unknown")
            
            # ç”»åƒã®åŸºæœ¬æƒ…å ±ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            if command -v identify >/dev/null 2>&1; then
              IMAGE_INFO=$(identify ".outputs/images/primary_image.png" 2>/dev/null || echo "ImageMagick not available")
            else
              IMAGE_INFO="Image analysis tools not available"
            fi
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONä½œæˆ
            cat > .logs/metadata/image-metadata.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "primary_image": {
              "filename": "primary_image.png",
              "file_size_bytes": $FILE_SIZE,
              "generation_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "image_info": "$IMAGE_INFO"
            },
            "generation_parameters": {
              "prompt_used": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.prompt'),
              "negative_prompt": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.negative_prompt'),
              "technical_config": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.parameters')
            }
          }
          EOF
            
            echo "âœ… Metadata extracted for primary image"
          else
            echo "âš ï¸ No primary image found for metadata extraction"
          fi
          
          IMAGE_METADATA=$(cat .logs/metadata/image-metadata.json)
          echo "IMAGE_METADATA=$IMAGE_METADATA" >> $GITHUB_ENV

  # === å“è³ªæ”¹å–„æ®µéš ===
  - id: "image-refinement"
    name: "ç”»åƒã®ç²¾ç´°åŒ–ãƒ»æ”¹å–„"
    phase: "quality_refinement"
    github_job: "image-refinement"
    type: "optimization"
    implementation: "mcp"
    tool: "image-processing"
    duration_minutes: 4
    dependencies: ["image-quality-analysis", "metadata-extraction"]
    parallel_group: null
    
    github_steps:
      - name: "Refine and improve images"
        shell: "bash"
        script: |
          echo "âœ¨ Refining and improving images..."
          
          mkdir -p .outputs/refined
          
          # å“è³ªåˆ†æçµæœã‚’ç¢ºèª
          REGENERATION_NEEDED=$(echo "$QUALITY_ANALYSIS" | jq -r '.regeneration_needed')
          OVERALL_RATING=$(echo "$QUALITY_ANALYSIS" | jq -r '.primary_image_analysis.overall_rating // 0')
          
          if [ "$REGENERATION_NEEDED" = "true" ] || [ "$OVERALL_RATING" -lt 7 ]; then
            echo "ğŸ”„ Regenerating image with improvements..."
            
            # æ”¹å–„ææ¡ˆã‚’å–å¾—
            IMPROVEMENT_SUGGESTIONS=$(echo "$QUALITY_ANALYSIS" | jq -r '.improvement_suggestions[]' | head -3 | tr '\n' ', ')
            
            # æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å†ç”Ÿæˆ
            IMPROVED_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.prompt')", $IMPROVEMENT_SUGGESTIONS, enhanced quality, masterpiece"
            
            if claude-code --mcp image-generation \
              --prompt "$IMPROVED_PROMPT" \
              --negative-prompt "$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.negative_prompt'), low quality, blurry, artifacts" \
              --output ".outputs/refined/improved_primary.png" \
              --config '{"steps": 40, "cfg_scale": 8.5, "width": 1024, "height": 1024}' \
              > .logs/generation/refinement-generation.log 2>&1; then
              echo "âœ… Improved image generated"
              REFINEMENT_STATUS="success"
            else
              echo "âš ï¸ Image refinement failed, using original"
              cp ".outputs/images/primary_image.png" ".outputs/refined/improved_primary.png" 2>/dev/null || true
              REFINEMENT_STATUS="fallback_to_original"
            fi
          else
            echo "âœ… Original image quality is good, copying to refined folder"
            cp ".outputs/images/primary_image.png" ".outputs/refined/improved_primary.png"
            REFINEMENT_STATUS="no_refinement_needed"
          fi
          
          # ã‚«ã‚¹ã‚¿ãƒ ç”»åƒå‡¦ç†ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
          if [ "$KAMUICODE_STATUS" = "success" ]; then
            echo "ğŸ¨ Applying custom image processing..."
            claude-code --mcp kamuicode \
              --function enhance-image \
              --input ".outputs/refined/improved_primary.png" \
              --output ".outputs/refined/enhanced_primary.png" \
              > .logs/generation/enhancement.log 2>&1 || echo "Custom enhancement failed"
          fi
          
          # ç²¾ç´°åŒ–çµæœã‚’ãƒ­ã‚°ä¿å­˜
          cat > .logs/generation/refinement-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "refinement_status": "$REFINEMENT_STATUS",
            "regeneration_performed": $([ "$REGENERATION_NEEDED" = "true" ] && echo "true" || echo "false"),
            "original_rating": $OVERALL_RATING,
            "refinement_approach": "$IMPROVEMENT_SUGGESTIONS",
            "output_files": [
              ".outputs/refined/improved_primary.png"
            ]
          }
          EOF
          
          echo "âœ¨ Image refinement completed"

  - id: "final-quality-validation"
    name: "æœ€çµ‚å“è³ªæ¤œè¨¼"
    phase: "quality_refinement"
    github_job: "final-validation"
    type: "validation"
    implementation: "ai"
    duration_minutes: 2
    dependencies: ["image-refinement"]
    parallel_group: null
    
    github_steps:
      - name: "Validate final image quality"
        shell: "bash"
        script: |
          echo "ğŸ Performing final quality validation..."
          
          mkdir -p .logs/final-validation
          
          # æœ€çµ‚ç”»åƒã®å“è³ªæ¤œè¨¼
          claude-code --prompt "æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®å“è³ªã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„ï¼š
          
          å…ƒã®è¦æ±‚: $PROMPT_ANALYSIS
          ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹: $GENERATION_RESULTS
          ç²¾ç´°åŒ–çµæœ: $(cat .logs/generation/refinement-results.json)
          
          æœ€çµ‚ç”»åƒã‚’ç¢ºèªã—ã¦ãã ã•ã„: .outputs/refined/improved_primary.png
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"final_quality_assessment\": {
              \"meets_requirements\": \"true|false\",
              \"quality_score\": \"1-10ç‚¹ã§ã®æœ€çµ‚å“è³ªè©•ä¾¡\",
              \"prompt_fulfillment\": \"1-10ç‚¹ã§ã®è¦æ±‚é”æˆåº¦\",
              \"technical_excellence\": \"1-10ç‚¹ã§ã®æŠ€è¡“çš„å®Œæˆåº¦\",
              \"ready_for_delivery\": \"true|false\"
            },
            \"final_strengths\": [\"æœ€çµ‚ç”»åƒã®å„ªã‚ŒãŸç‚¹\"],
            \"remaining_issues\": [\"æ®‹å­˜ã™ã‚‹å•é¡Œç‚¹ï¼ˆã‚ã‚Œã°ï¼‰\"],
            \"delivery_recommendation\": \"é…ä¿¡ã«é–¢ã™ã‚‹æ¨å¥¨äº‹é …\",
            \"success_summary\": \"æˆåŠŸãƒã‚¤ãƒ³ãƒˆã®è¦ç´„\"
          }" > .logs/final-validation/final-assessment.json
          
          FINAL_ASSESSMENT=$(cat .logs/final-validation/final-assessment.json)
          echo "FINAL_ASSESSMENT=$FINAL_ASSESSMENT" >> $GITHUB_ENV
          
          # é…ä¿¡å¯å¦åˆ¤å®š
          READY_FOR_DELIVERY=$(echo "$FINAL_ASSESSMENT" | jq -r '.final_quality_assessment.ready_for_delivery')
          echo "READY_FOR_DELIVERY=$READY_FOR_DELIVERY" >> $GITHUB_ENV
          
          echo "ğŸ Final quality validation completed"
          
    validation:
      criteria:
        - "æœ€çµ‚å“è³ªè©•ä¾¡ãŒå®Œäº†ã—ã¦ã„ã‚‹"
        - "é…ä¿¡å¯å¦ãŒåˆ¤å®šã•ã‚Œã¦ã„ã‚‹"
        - "å“è³ªã‚¹ã‚³ã‚¢ãŒ6ç‚¹ä»¥ä¸Š"
      validation_script: |
        if [ ! -f ".logs/final-validation/final-assessment.json" ]; then
          echo "âŒ VALIDATION FAILED: Final assessment missing"
          exit 1
        fi
        
        QUALITY_SCORE=$(jq -r '.final_quality_assessment.quality_score // 0' .logs/final-validation/final-assessment.json)
        if [ "$QUALITY_SCORE" -ge 6 ]; then
          echo "âœ… Validation passed: Quality meets minimum standards ($QUALITY_SCORE/10)"
        else
          echo "âš ï¸ WARNING: Quality below recommended threshold ($QUALITY_SCORE/10)"
        fi

  # === å‡ºåŠ›æº–å‚™æ®µéš ===
  - id: "format-optimization"
    name: "å½¢å¼æœ€é©åŒ–ãƒ»å¤‰æ›"
    phase: "output_preparation"
    github_job: "format-optimization"
    type: "processing"
    implementation: "script"
    duration_minutes: 2
    dependencies: ["final-quality-validation"]
    parallel_group: "output_parallel"
    
    github_steps:
      - name: "Optimize image formats"
        shell: "bash"
        script: |
          echo "ğŸ”§ Optimizing image formats..."
          
          mkdir -p .final-output/{web,print,social}
          
          # Webç”¨æœ€é©åŒ–ï¼ˆJPEG, WebPï¼‰
          if [ -f ".outputs/refined/improved_primary.png" ]; then
            echo "Creating web-optimized versions..."
            
            # JPEGç‰ˆï¼ˆå“è³ª85%ï¼‰
            if command -v convert >/dev/null 2>&1; then
              convert ".outputs/refined/improved_primary.png" -quality 85 ".final-output/web/image.jpg" 2>/dev/null || echo "JPEG conversion failed"
              
              # WebPç‰ˆï¼ˆå“è³ª80%ï¼‰
              convert ".outputs/refined/improved_primary.png" -quality 80 ".final-output/web/image.webp" 2>/dev/null || echo "WebP conversion failed"
              
              # ã‚µãƒ ãƒã‚¤ãƒ«ç‰ˆï¼ˆ500x500ï¼‰
              convert ".outputs/refined/improved_primary.png" -resize 500x500 ".final-output/web/thumbnail.png" 2>/dev/null || echo "Thumbnail creation failed"
            else
              echo "ImageMagick not available, copying original"
              cp ".outputs/refined/improved_primary.png" ".final-output/web/image.png"
            fi
            
            # å°åˆ·ç”¨é«˜å“è³ªç‰ˆ
            cp ".outputs/refined/improved_primary.png" ".final-output/print/high_quality.png"
            
            # SNSç”¨æ­£æ–¹å½¢ç‰ˆï¼ˆ1080x1080ï¼‰
            if command -v convert >/dev/null 2>&1; then
              convert ".outputs/refined/improved_primary.png" -resize 1080x1080^ -gravity center -extent 1080x1080 ".final-output/social/square.png" 2>/dev/null || \
              cp ".outputs/refined/improved_primary.png" ".final-output/social/square.png"
            else
              cp ".outputs/refined/improved_primary.png" ".final-output/social/square.png"
            fi
            
            echo "âœ… Format optimization completed"
          else
            echo "âŒ No refined image found for optimization"
          fi

  - id: "metadata-compilation"
    name: "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ»æƒ…å ±ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«"
    phase: "output_preparation"
    github_job: "metadata-compilation"
    type: "integration"
    implementation: "script"
    duration_minutes: 2
    dependencies: ["final-quality-validation"]
    parallel_group: "output_parallel"
    
    github_steps:
      - name: "Compile comprehensive metadata"
        shell: "bash"
        script: |
          echo "ğŸ“‹ Compiling comprehensive metadata..."
          
          mkdir -p .final-output
          
          # åŒ…æ‹¬çš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > .final-output/image-info.json << EOF
          {
            "project_info": {
              "creation_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "workflow_run_id": "${{ github.run_id }}",
              "generated_by": "AI Image Generation Workflow"
            },
            "original_request": $PROMPT_ANALYSIS,
            "generation_process": {
              "visual_concept": $VISUAL_CONCEPT,
              "engineered_prompts": $OPTIMIZED_PROMPTS,
              "generation_results": $GENERATION_RESULTS,
              "quality_analysis": $QUALITY_ANALYSIS,
              "final_assessment": $FINAL_ASSESSMENT
            },
            "output_files": {
              "primary_png": ".final-output/print/high_quality.png",
              "web_jpg": ".final-output/web/image.jpg",
              "web_webp": ".final-output/web/image.webp",
              "thumbnail": ".final-output/web/thumbnail.png",
              "social_square": ".final-output/social/square.png"
            },
            "usage_recommendations": {
              "web_display": "Use image.webp for modern browsers, image.jpg as fallback",
              "print_usage": "Use high_quality.png for print applications",
              "social_media": "Use square.png for social media platforms",
              "thumbnail": "Use thumbnail.png for gallery views"
            },
            "technical_specs": $IMAGE_METADATA,
            "quality_metrics": {
              "final_quality_score": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.quality_score // 0'),
              "prompt_fulfillment": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.prompt_fulfillment // 0'),
              "ready_for_delivery": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.ready_for_delivery // false')
            }
          }
          EOF
          
          echo "âœ… Metadata compilation completed"

  - id: "final-package-creation"
    name: "æœ€çµ‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ"
    phase: "output_preparation"
    github_job: "package-creation"
    type: "integration"
    implementation: "script"
    duration_minutes: 1
    dependencies: ["format-optimization", "metadata-compilation"]
    parallel_group: null
    
    github_steps:
      - name: "Create final delivery package"
        shell: "bash"
        script: |
          echo "ğŸ“¦ Creating final delivery package..."
          
          # ZIPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
          cd .final-output && zip -r ../ai-generated-images.zip . && cd ..
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±
          PACKAGE_SIZE=$(stat -f%z "ai-generated-images.zip" 2>/dev/null || stat -c%s "ai-generated-images.zip" 2>/dev/null || echo "unknown")
          
          # é…ä¿¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±
          cat > .final-output/package-info.json << EOF
          {
            "package_created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "package_size_bytes": $PACKAGE_SIZE,
            "package_contents": [
              "print/high_quality.png",
              "web/image.jpg",
              "web/image.webp", 
              "web/thumbnail.png",
              "social/square.png",
              "image-info.json"
            ],
            "delivery_status": "ready",
            "quality_approved": $READY_FOR_DELIVERY
          }
          EOF
          
          echo "ğŸ“¦ Final package created successfully"
          
    success_links:
      package_download: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
      primary_image: "${{ github.server_url }}/${{ github.repository }}/blob/main/.final-output/print/high_quality.png"
      web_version: "${{ github.server_url }}/${{ github.repository }}/blob/main/.final-output/web/image.jpg"
      metadata: "${{ github.server_url }}/${{ github.repository }}/blob/main/.final-output/image-info.json"

# å®Ÿè¡Œãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
execution_flow:
  - stage: 0
    name: "äº‹å‰ãƒ†ã‚¹ãƒˆ"
    parallel: false
    jobs: ["connectivity-test"]
    
  - stage: 1
    name: "ã‚³ãƒ³ã‚»ãƒ—ãƒˆé–‹ç™º"
    parallel: false
    jobs: ["prompt-analysis", "concept-planning"]
    
  - stage: 2
    name: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ"
    parallel: false
    jobs: ["prompt-engineering", "prompt-optimization"]
    
  - stage: 3
    name: "ç”»åƒç”Ÿæˆ"
    parallel: false
    jobs: ["initial-generation"]
    then:
      parallel: true
      jobs: ["quality-analysis", "metadata-extraction"]
      
  - stage: 4
    name: "å“è³ªæ”¹å–„"
    parallel: false
    jobs: ["image-refinement", "final-validation"]
    
  - stage: 5
    name: "å‡ºåŠ›æº–å‚™"
    parallel: true
    jobs: ["format-optimization", "metadata-compilation"]
    then:
      parallel: false
      jobs: ["package-creation"]

# å…¨ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
global_error_handling:
  max_retries: 2
  retry_delay_seconds: 20
  critical_failure_notification: true
  fallback_mode: "basic_generation"
  
# æˆåŠŸåŸºæº–
success_criteria:
  - "å°‘ãªãã¨ã‚‚1ã¤ã®ç”»åƒãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹"
  - "æœ€çµ‚å“è³ªã‚¹ã‚³ã‚¢ãŒ6ç‚¹ä»¥ä¸Š"
  - "è¤‡æ•°ã®å½¢å¼ã§å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹"
  - "åŒ…æ‹¬çš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹"
  - "é…ä¿¡ç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹"

# ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿æŒ
artifacts:
  - name: "image-generation-logs"
    path: ".logs/"
    retention_days: 7
  - name: "generated-images"  
    path: ".outputs/"
    retention_days: 30
  - name: "final-delivery-package"
    path: ".final-output/"
    retention_days: 90
  - name: "image-package-zip"
    path: "ai-generated-images.zip"
    retention_days: 90