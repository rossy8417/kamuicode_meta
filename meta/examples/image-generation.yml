name: "AI Image Generation Workflow"
run-name: "ðŸŽ¨ Generating AI images: ${{ github.event.inputs.main_prompt || 'Image Generation' }}"

on:
  workflow_dispatch:
    inputs:
      main_prompt:
        description: 'ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ - ç”Ÿæˆã—ãŸã„ç”»åƒã®è©³ç´°ãªèª¬æ˜Ž'
        required: true
        default: 'ç¾Žã—ã„å¤•æ—¥ã®é¢¨æ™¯ã€ã‚¢ãƒ‹ãƒ¡ã‚¹ã‚¿ã‚¤ãƒ«ã€é«˜ç”»è³ªã€è©³ç´°ãªèƒŒæ™¯'
        type: string
      negative_prompt:
        description: 'ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (é™¤å¤–ã—ãŸã„è¦ç´ )'
        required: false
        default: 'ä½Žç”»è³ªã€ä¸è‡ªç„¶ãªæ‰‹ã€ã¼ã‚„ã‘ãŸç”»åƒ'
        type: string
      art_style:
        description: 'ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«'
        required: true
        type: choice
        options:
        - photorealistic
        - anime
        - oil_painting
        - digital_art
        - watercolor
        default: 'photorealistic'
      quality_level:
        description: 'å“è³ªãƒ¬ãƒ™ãƒ« (1-10)'
        required: true
        default: '8'
        type: choice
        options:
        - '1'
        - '2'
        - '3'
        - '4'
        - '5'
        - '6'
        - '7'
        - '8'
        - '9'
        - '10'
      aspect_ratio:
        description: 'ç”»åƒã®ç¸¦æ¨ªæ¯”'
        required: true
        type: choice
        options:
        - '1:1'
        - '16:9'
        - '4:3'
        - '3:4'
        - '9:16'
        default: '1:1'
      image_count:
        description: 'ç”Ÿæˆæžšæ•° (1-8)'
        required: true
        default: '4'
        type: choice
        options:
        - '1'
        - '2'
        - '3'
        - '4'
        - '5'
        - '6'
        - '7'
        - '8'
      mcp_service_priority:
        description: 'ä½¿ç”¨MCPã‚µãƒ¼ãƒ“ã‚¹å„ªå…ˆåº¦'
        required: true
        type: choice
        options:
        - ultra_quality
        - balanced
        - speed_priority
        - google_only
        default: 'balanced'

permissions:
  contents: write
  issues: read
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: äº‹å‰ãƒ†ã‚¹ãƒˆæ®µéšŽ
  connectivity-test:
    runs-on: ubuntu-latest
    outputs:
      services_ready: ${{ steps.test.outputs.services_ready }}
      recommended_service: ${{ steps.test.outputs.recommended_service }}
    steps:
      - name: Test image generation services
        id: test
        run: |
          echo "ðŸŽ¨ Testing image generation services..."
          
          mkdir -p .logs/connectivity-tests
          
          # MCP Kamuicodeè¨­å®šãƒ†ã‚¹ãƒˆ
          echo "Testing MCP Kamuicode configuration..."
          if [ -f ".claude/mcp-kamuicode.json" ]; then
            echo "âœ… MCP Configuration file found"
            MCP_CONFIG_STATUS="success"
          else
            echo "âš ï¸ MCP Configuration file not found, using default"
            MCP_CONFIG_STATUS="default"
          fi
          
          # é«˜å“è³ªç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆImagen4 Ultraï¼‰
          echo "Testing high-quality image generation (Imagen4 Ultra)..."
          if timeout 60 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-ultra --prompt "test high quality image" > .logs/connectivity-tests/imagen4-ultra-test.log 2>&1; then
            IMAGEN4_ULTRA_STATUS="success"
            echo "âœ… Imagen4 Ultra: Available"
          else
            IMAGEN4_ULTRA_STATUS="failed"
            echo "âš ï¸ Imagen4 Ultra: Not available"
          fi
          
          # é«˜é€Ÿç”»åƒç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆImagen4 Fastï¼‰
          echo "Testing fast image generation (Imagen4 Fast)..."
          if timeout 30 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "test fast image" > .logs/connectivity-tests/imagen4-fast-test.log 2>&1; then
            IMAGEN4_FAST_STATUS="success"
            echo "âœ… Imagen4 Fast: Available"
          else
            IMAGEN4_FAST_STATUS="failed"
            echo "âš ï¸ Imagen4 Fast: Not available"
          fi
          
          # Google Imagen3 ãƒ†ã‚¹ãƒˆï¼ˆä»£æ›¿æ¡ˆï¼‰
          echo "Testing Google Imagen3..."
          if timeout 45 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-google-imagen3 --prompt "test google imagen" > .logs/connectivity-tests/google-imagen3-test.log 2>&1; then
            GOOGLE_IMAGEN3_STATUS="success"
            echo "âœ… Google Imagen3: Available"
          else
            GOOGLE_IMAGEN3_STATUS="failed"
            echo "âš ï¸ Google Imagen3: Not available"
          fi
          
          # æœ€ä½Ž1ã¤ã®ç”»åƒç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$IMAGEN4_ULTRA_STATUS" = "success" ] || [ "$IMAGEN4_FAST_STATUS" = "success" ] || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ]; then
            IMAGE_GEN_STATUS="success"
            echo "âœ… At least one image generation service available"
          else
            IMAGE_GEN_STATUS="failed"
            echo "âŒ No image generation services available - Cannot proceed"
          fi
          
          # MCP Kamuicode ãƒ†ã‚¹ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ç”»åƒå‡¦ç†ï¼‰
          echo "Testing MCP kamuicode (image processing functions)..."
          if timeout 20 claude-code --mcp kamuicode --function test-image-processing > .logs/connectivity-tests/kamuicode-test.log 2>&1; then
            KAMUICODE_STATUS="success"
            echo "âœ… MCP Kamuicode: Available"
          else
            KAMUICODE_STATUS="failed"
            echo "âš ï¸ MCP Kamuicode: Not available - will use standard processing"
          fi
          
          # å¤–éƒ¨ç”»åƒAPI ãƒ†ã‚¹ãƒˆï¼ˆStable Diffusion, DALL-Eç­‰ï¼‰
          echo "Testing external image APIs..."
          if [ -n "${{ secrets.EXTERNAL_IMAGE_API_KEY }}" ]; then
            if timeout 30 curl -s -H "Authorization: Bearer ${{ secrets.EXTERNAL_IMAGE_API_KEY }}" https://api.example-image-service.com/health > .logs/connectivity-tests/external-api-test.log 2>&1; then
              EXTERNAL_API_STATUS="success"
              echo "âœ… External Image API: Available"
            else
              EXTERNAL_API_STATUS="failed"
              echo "âš ï¸ External Image API: Failed - will use MCP generation only"
            fi
          else
            EXTERNAL_API_STATUS="not_configured"
            echo "â„¹ï¸ External Image API: Not configured - using MCP generation"
          fi
          
          # ãƒ†ã‚¹ãƒˆçµæžœã‚’JSONä¿å­˜
          cat > .logs/connectivity-tests/test-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "mcp_config_status": "$MCP_CONFIG_STATUS",
            "available_image_services": {
              "imagen4_ultra": "$IMAGEN4_ULTRA_STATUS",
              "imagen4_fast": "$IMAGEN4_FAST_STATUS", 
              "google_imagen3": "$GOOGLE_IMAGEN3_STATUS",
              "kamuicode_processing": "$KAMUICODE_STATUS",
              "external_api": "$EXTERNAL_API_STATUS"
            },
            "service_priorities": [
              "$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || echo "")",
              "$([ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || echo "")",
              "$([ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "")"
            ],
            "overall_status": "$([ "$IMAGE_GEN_STATUS" = "success" ] && echo "ready" || echo "failed")",
            "critical_services_available": $([ "$IMAGE_GEN_STATUS" = "success" ] && echo "true" || echo "false"),
            "workflow_can_proceed": $([ "$IMAGE_GEN_STATUS" = "success" ] && echo "true" || echo "false"),
            "recommended_service": "$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || [ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "none")"
          }
          EOF
          
          # ç’°å¢ƒå¤‰æ•°ã«çµæžœã‚’è¨­å®š
          echo "CONNECTIVITY_STATUS=$([ "$IMAGE_GEN_STATUS" = "success" ] && echo "ready" || echo "failed")" >> $GITHUB_ENV
          echo "RECOMMENDED_IMAGE_SERVICE=$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "t2i-fal-imagen4-ultra" || [ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "t2i-fal-imagen4-fast" || [ "$GOOGLE_IMAGEN3_STATUS" = "success" ] && echo "t2i-google-imagen3" || echo "none")" >> $GITHUB_ENV
          echo "HIGH_QUALITY_AVAILABLE=$([ "$IMAGEN4_ULTRA_STATUS" = "success" ] && echo "true" || echo "false")" >> $GITHUB_ENV
          echo "FAST_GENERATION_AVAILABLE=$([ "$IMAGEN4_FAST_STATUS" = "success" ] && echo "true" || echo "false")" >> $GITHUB_ENV
          
          echo "ðŸŽ¨ Image generation service tests completed"
          
          # å‡ºåŠ›è¨­å®š
          echo "services_ready=true" >> $GITHUB_OUTPUT
          echo "recommended_service=$RECOMMENDED_IMAGE_SERVICE" >> $GITHUB_OUTPUT

  # Phase 2: ã‚³ãƒ³ã‚»ãƒ—ãƒˆé–‹ç™ºæ®µéšŽ
  prompt-analysis:
    needs: connectivity-test
    runs-on: ubuntu-latest
    outputs:
      prompt_analysis: ${{ steps.analyze.outputs.prompt_analysis }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Analyze input prompt
        id: analyze
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ” Analyzing input prompt for image generation..."
          
          mkdir -p .logs/concept-development
          
          # å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
          INPUT_PROMPT="${{ github.event.inputs.main_prompt }}"
          echo "Input prompt: $INPUT_PROMPT"
          
          # Claude Code ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æž
          claude-code --prompt "ä»¥ä¸‹ã®ç”»åƒç”Ÿæˆè¦æ±‚ã‚’è©³ç´°ã«åˆ†æžã—ã¦ãã ã•ã„ï¼š
          
          å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $INPUT_PROMPT
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"image_type\": \"portrait|landscape|illustration|photo|abstract|logo|icon|concept_art\",
            \"style_category\": \"photorealistic|artistic|cartoon|anime|vintage|modern|minimalist|detailed\",
            \"subject_matter\": \"ä¸»è¦ãªè¢«å†™ä½“ãƒ»ãƒ†ãƒ¼ãƒž\",
            \"mood_tone\": \"æ˜Žã‚‹ã„|æš—ã„|ç¥žç§˜çš„|æ´»æ°—ã®ã‚ã‚‹|é™å¯‚ãª|ãƒ‰ãƒ©ãƒžãƒãƒƒã‚¯\",
            \"color_palette\": [\"æŽ¨å¥¨ã•ã‚Œã‚‹è‰²å½©ã®ãƒªã‚¹ãƒˆ\"],
            \"technical_requirements\": {
              \"aspect_ratio\": \"1:1|16:9|9:16|4:3|3:4\",
              \"resolution\": \"recommended resolution\",
              \"style_strength\": \"high|medium|low\"
            },
            \"creative_direction\": \"å‰µä½œã®æ–¹å‘æ€§èª¬æ˜Ž\",
            \"potential_challenges\": [\"ç”Ÿæˆæ™‚ã«æ³¨æ„ã™ã¹ãç‚¹\"],
            \"enhancement_suggestions\": [\"ã‚ˆã‚Šè‰¯ã„çµæžœã®ãŸã‚ã®ææ¡ˆ\"]
          }" > .logs/concept-development/prompt-analysis.json
          
          PROMPT_ANALYSIS=$(cat .logs/concept-development/prompt-analysis.json)
          echo "prompt_analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT_ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Prompt analysis completed"

  concept-planning:
    needs: prompt-analysis
    runs-on: ubuntu-latest
    outputs:
      visual_concept: ${{ steps.plan.outputs.visual_concept }}
    steps:
      - name: Plan visual concept
        id: plan
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸŽ¯ Planning visual concept..."
          
          # ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è©³ç´°è¨ˆç”»
          PROMPT_ANALYSIS='${{ needs.prompt-analysis.outputs.prompt_analysis }}'
          claude-code --prompt "ä»¥ä¸‹ã®åˆ†æžçµæžœã‚’åŸºã«ã€å…·ä½“çš„ãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è¨ˆç”»ã—ã¦ãã ã•ã„ï¼š
          
          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æž: $PROMPT_ANALYSIS
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"composition_plan\": {
              \"main_focus\": \"ãƒ¡ã‚¤ãƒ³ã®ç„¦ç‚¹è¦ç´ \",
              \"background\": \"èƒŒæ™¯ã®æå†™\",
              \"foreground\": \"å‰æ™¯ã®è¦ç´ \",
              \"depth_layers\": [\"å¥¥è¡Œãã‚’æ§‹æˆã™ã‚‹å±¤ã®ãƒªã‚¹ãƒˆ\"]
            },
            \"lighting_plan\": {
              \"light_source\": \"å…‰æºã®ç¨®é¡žã¨ä½ç½®\",
              \"shadow_direction\": \"å½±ã®æ–¹å‘\",
              \"ambient_lighting\": \"ç’°å¢ƒå…‰ã®ç‰¹å¾´\",
              \"mood_lighting\": \"ãƒ ãƒ¼ãƒ‰ã‚’ä½œã‚‹ç…§æ˜ŽåŠ¹æžœ\"
            },
            \"color_scheme\": {
              \"primary_colors\": [\"ä¸»è¦è‰²ã®ãƒªã‚¹ãƒˆ\"],
              \"accent_colors\": [\"ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²ã®ãƒªã‚¹ãƒˆ\"],
              \"color_temperature\": \"warm|cool|neutral\",
              \"contrast_level\": \"high|medium|low\"
            },
            \"detail_specifications\": {
              \"texture_details\": [\"ãƒ†ã‚¯ã‚¹ãƒãƒ£ã®è©³ç´°\"],
              \"material_properties\": [\"ç´ æã®ç‰¹æ€§\"],
              \"fine_details\": [\"ç´°ã‹ãªãƒ‡ã‚£ãƒ†ãƒ¼ãƒ«\"]
            },
            \"generation_strategy\": {
              \"primary_approach\": \"ç”Ÿæˆã®ä¸»è¦ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ\",
              \"fallback_options\": [\"ä»£æ›¿æ¡ˆã®ãƒªã‚¹ãƒˆ\"],
              \"iteration_plan\": \"åå¾©æ”¹å–„ã®è¨ˆç”»\"
            }
          }" > .logs/concept-development/visual-concept.json
          
          VISUAL_CONCEPT=$(cat .logs/concept-development/visual-concept.json)
          echo "visual_concept<<EOF" >> $GITHUB_OUTPUT
          echo "$VISUAL_CONCEPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Visual concept planning completed"

  # Phase 3: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆæ®µéšŽ
  prompt-engineering:
    needs: concept-planning
    runs-on: ubuntu-latest
    outputs:
      engineered_prompts: ${{ steps.engineer.outputs.engineered_prompts }}
    steps:
      - name: Engineer detailed prompts
        id: engineer
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "âš™ï¸ Engineering detailed generation prompts..."
          
          mkdir -p .logs/prompt-engineering
          
          # è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ
          PROMPT_ANALYSIS='${{ needs.prompt-analysis.outputs.prompt_analysis }}'
          VISUAL_CONCEPT='${{ needs.concept-planning.outputs.visual_concept }}'
          claude-code --prompt "ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€AIç”»åƒç”Ÿæˆç”¨ã®æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ†æž: $PROMPT_ANALYSIS
          ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: $VISUAL_CONCEPT
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"primary_prompt\": \"ãƒ¡ã‚¤ãƒ³ã®ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆè©³ç´°ã§å…·ä½“çš„ï¼‰\",
            \"negative_prompt\": \"é™¤å¤–ã—ãŸã„è¦ç´ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"style_prompts\": {
              \"photorealistic\": \"å†™å®Ÿçš„ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"artistic\": \"èŠ¸è¡“çš„ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"alternative\": \"ä»£æ›¿ã‚¹ã‚¿ã‚¤ãƒ«ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\"
            },
            \"technical_parameters\": {
              \"recommended_steps\": \"æŽ¨å¥¨ã‚¹ãƒ†ãƒƒãƒ—æ•°\",
              \"cfg_scale\": \"æŽ¨å¥¨CFGã‚¹ã‚±ãƒ¼ãƒ«\",
              \"seed_strategy\": \"ã‚·ãƒ¼ãƒ‰å€¤ã®æˆ¦ç•¥\",
              \"batch_settings\": \"ãƒãƒƒãƒç”Ÿæˆè¨­å®š\"
            },
            \"quality_enhancers\": [\"å“è³ªå‘ä¸Šã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ \"],
            \"variation_prompts\": [\"ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¡ˆ\"],
            \"prompt_weights\": {\"é‡è¦åº¦ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ ã®é‡ã¿ä»˜ã‘\": \"å€¤\"}
          }" > .logs/prompt-engineering/engineered-prompts.json
          
          ENGINEERED_PROMPTS=$(cat .logs/prompt-engineering/engineered-prompts.json)
          echo "engineered_prompts<<EOF" >> $GITHUB_OUTPUT
          echo "$ENGINEERED_PROMPTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Prompt engineering completed"

  prompt-optimization:
    needs: prompt-engineering
    runs-on: ubuntu-latest
    outputs:
      optimized_prompts: ${{ steps.optimize.outputs.optimized_prompts }}
    steps:
      - name: Optimize and validate prompts
        id: optimize
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ”§ Optimizing and validating prompts..."
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–ã¨æ¤œè¨¼
          ENGINEERED_PROMPTS='${{ needs.prompt-engineering.outputs.engineered_prompts }}'
          claude-code --prompt "ä»¥ä¸‹ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–ã—ã€æ¤œè¨¼ã—ã¦ãã ã•ã„ï¼š
          
          ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: $ENGINEERED_PROMPTS
          
          æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ:
          - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é•·ã•ã¨åŠ¹çŽ‡æ€§
          - çŸ›ç›¾ã™ã‚‹æŒ‡ç¤ºã®å‰Šé™¤
          - ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å„ªå…ˆé †ä½ä»˜ã‘
          - AIç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã¨ã®äº’æ›æ€§
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"optimized_primary_prompt\": \"æœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"optimized_negative_prompt\": \"æœ€é©åŒ–ã•ã‚ŒãŸãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
            \"prompt_validation\": {
              \"clarity_score\": \"1-10ç‚¹ã§ã®æ˜Žç¢ºæ€§è©•ä¾¡\",
              \"specificity_score\": \"1-10ç‚¹ã§ã®å…·ä½“æ€§è©•ä¾¡\",
              \"compatibility_score\": \"1-10ç‚¹ã§ã®AIäº’æ›æ€§è©•ä¾¡\",
              \"potential_issues\": [\"æ½œåœ¨çš„ãªå•é¡Œç‚¹\"],
              \"improvement_notes\": [\"æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ\"]
            },
            \"final_generation_config\": {
              \"prompt\": \"æœ€çµ‚çš„ãªç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"negative_prompt\": \"æœ€çµ‚çš„ãªãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\",
              \"parameters\": {\"æŠ€è¡“ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿\": \"å€¤\"}
            }
          }" > .logs/prompt-engineering/optimized-prompts.json
          
          OPTIMIZED_PROMPTS=$(cat .logs/prompt-engineering/optimized-prompts.json)
          echo "optimized_prompts<<EOF" >> $GITHUB_OUTPUT
          echo "$OPTIMIZED_PROMPTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Prompt optimization completed"

  # Phase 4: ç”Ÿæˆå®Ÿè¡Œæ®µéšŽ
  initial-generation:
    needs: [connectivity-test, prompt-optimization]
    runs-on: ubuntu-latest
    outputs:
      generation_results: ${{ steps.generate.outputs.generation_results }}
    steps:
      - name: Generate initial images
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸŽ¨ Generating initial images..."
          
          mkdir -p .logs/generation .outputs/images
          
          # æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
          OPTIMIZED_PROMPTS='${{ needs.prompt-optimization.outputs.optimized_prompts }}'
          FINAL_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.prompt')
          NEGATIVE_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.negative_prompt')
          
          echo "Final prompt: $FINAL_PROMPT"
          echo "Negative prompt: $NEGATIVE_PROMPT"
          
          # æŽ¨å¥¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãŸç”»åƒç”Ÿæˆ
          RECOMMENDED_SERVICE="${{ needs.connectivity-test.outputs.recommended_service }}"
          echo "Using recommended service: $RECOMMENDED_SERVICE"
          
          # ãƒ¡ã‚¤ãƒ³ç”»åƒç”Ÿæˆ
          echo "Generating primary image with $RECOMMENDED_SERVICE..."
          if [ "$RECOMMENDED_SERVICE" = "t2i-fal-imagen4-ultra" ]; then
            # é«˜å“è³ªç”Ÿæˆï¼ˆImagen4 Ultraï¼‰
            if claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-ultra \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              --config '{"quality": "ultra", "aspect_ratio": "1:1", "safety_level": "standard"}' \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Imagen4 Ultra"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Imagen4 Ultra generation failed"
            fi
            
          elif [ "$RECOMMENDED_SERVICE" = "t2i-fal-imagen4-fast" ]; then
            # é«˜é€Ÿç”Ÿæˆï¼ˆImagen4 Fastï¼‰
            if claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              --config '{"speed": "fast", "aspect_ratio": "1:1"}' \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Imagen4 Fast"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Imagen4 Fast generation failed"
            fi
            
          elif [ "$RECOMMENDED_SERVICE" = "t2i-google-imagen3" ]; then
            # Google Imagen3 ç”Ÿæˆ
            if claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-google-imagen3 \
              --prompt "$FINAL_PROMPT" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/primary_image.png" \
              > .logs/generation/primary-generation.log 2>&1; then
              PRIMARY_STATUS="success"
              echo "âœ… Primary image generated with Google Imagen3"
            else
              PRIMARY_STATUS="failed"
              echo "âŒ Google Imagen3 generation failed"
            fi
          else
            PRIMARY_STATUS="failed"
            echo "âŒ No available image generation service"
          fi
          
          # ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆé«˜é€Ÿã‚µãƒ¼ãƒ“ã‚¹ä½¿ç”¨ï¼‰
          echo "Generating variation with fast service..."
          if [ "$FAST_GENERATION_AVAILABLE" = "true" ]; then
            if claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast \
              --prompt "$FINAL_PROMPT, artistic variation, creative interpretation" \
              --negative-prompt "$NEGATIVE_PROMPT" \
              --output ".outputs/images/variant_1.png" \
              --config '{"speed": "fast", "variation": "high"}' \
              > .logs/generation/variant1-generation.log 2>&1; then
              VARIANT1_STATUS="success"
              echo "âœ… Variant 1 generated with fast service"
            else
              VARIANT1_STATUS="failed"
              echo "âš ï¸ Variant 1 generation failed"
            fi
          else
            VARIANT1_STATUS="skipped"
            echo "âš ï¸ Fast generation not available, skipping variant"
          fi
          
          # ç”Ÿæˆçµæžœã‚’ãƒ­ã‚°ä¿å­˜
          cat > .logs/generation/generation-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "primary_image": {
              "status": "$PRIMARY_STATUS",
              "path": ".outputs/images/primary_image.png",
              "prompt_used": "$FINAL_PROMPT",
              "generation_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            },
            "variant_1": {
              "status": "$VARIANT1_STATUS",
              "path": ".outputs/images/variant_1.png"
            },
            "overall_success": $([ "$PRIMARY_STATUS" = "success" ] && echo "true" || echo "false")
          }
          EOF
          
          echo "generation_results<<EOF" >> $GITHUB_OUTPUT
          cat .logs/generation/generation-results.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¨ Initial image generation completed"

  quality-analysis:
    needs: [initial-generation, prompt-analysis]
    runs-on: ubuntu-latest
    outputs:
      quality_analysis: ${{ steps.analyze.outputs.quality_analysis }}
    steps:
      - name: Analyze image quality
        id: analyze
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ” Analyzing generated image quality..."
          
          mkdir -p .logs/quality-analysis
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®å“è³ªåˆ†æž
          GENERATION_RESULTS='${{ needs.initial-generation.outputs.generation_results }}'
          PROMPT_ANALYSIS='${{ needs.prompt-analysis.outputs.prompt_analysis }}'
          claude-code --prompt "ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’åˆ†æžã—ã¦å“è³ªè©•ä¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          
          ç”Ÿæˆçµæžœ: $GENERATION_RESULTS
          å…ƒã®è¦æ±‚: $PROMPT_ANALYSIS
          
          ä»¥ä¸‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦åˆ†æžã—ã¦ãã ã•ã„ï¼š
          - .outputs/images/primary_image.png
          - .outputs/images/variant_1.pngï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"primary_image_analysis\": {
              \"technical_quality\": \"1-10ç‚¹ã§ã®æŠ€è¡“å“è³ªè©•ä¾¡\",
              \"prompt_adherence\": \"1-10ç‚¹ã§ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¿ å®Ÿåº¦\",
              \"artistic_merit\": \"1-10ç‚¹ã§ã®èŠ¸è¡“çš„ä¾¡å€¤\",
              \"composition_quality\": \"1-10ç‚¹ã§ã®æ§‹å›³å“è³ª\",
              \"color_harmony\": \"1-10ç‚¹ã§ã®è‰²å½©èª¿å’Œ\",
              \"detail_level\": \"1-10ç‚¹ã§ã®è©³ç´°åº¦\",
              \"overall_rating\": \"1-10ç‚¹ã§ã®ç·åˆè©•ä¾¡\"
            },
            \"strengths\": [\"ç”»åƒã®å„ªã‚Œã¦ã„ã‚‹ç‚¹\"],
            \"weaknesses\": [\"æ”¹å–„ãŒå¿…è¦ãªç‚¹\"],
            \"improvement_suggestions\": [\"å…·ä½“çš„ãªæ”¹å–„ææ¡ˆ\"],
            \"regeneration_needed\": $([ "$OVERALL_SUCCESS" = "true" ] && echo "false" || echo "true"),
            \"refinement_areas\": [\"é‡ç‚¹çš„ã«æ”¹å–„ã™ã¹ãé ˜åŸŸ\"]
          }" > .logs/quality-analysis/quality-assessment.json
          
          QUALITY_ANALYSIS=$(cat .logs/quality-analysis/quality-assessment.json)
          echo "quality_analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$QUALITY_ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Image quality analysis completed"

  metadata-extraction:
    needs: [initial-generation, prompt-optimization]
    runs-on: ubuntu-latest
    outputs:
      image_metadata: ${{ steps.extract.outputs.image_metadata }}
    steps:
      - name: Extract image metadata
        id: extract
        run: |
          echo "ðŸ“Š Extracting image metadata..."
          
          mkdir -p .logs/metadata
          
          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
          if [ -f ".outputs/images/primary_image.png" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨åŸºæœ¬æƒ…å ±
            FILE_SIZE=$(stat -f%z ".outputs/images/primary_image.png" 2>/dev/null || stat -c%s ".outputs/images/primary_image.png" 2>/dev/null || echo "unknown")
            
            # ç”»åƒã®åŸºæœ¬æƒ…å ±ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            if command -v identify >/dev/null 2>&1; then
              IMAGE_INFO=$(identify ".outputs/images/primary_image.png" 2>/dev/null || echo "ImageMagick not available")
            else
              IMAGE_INFO="Image analysis tools not available"
            fi
            
            # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONä½œæˆ
            OPTIMIZED_PROMPTS='${{ needs.prompt-optimization.outputs.optimized_prompts }}'
            cat > .logs/metadata/image-metadata.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "primary_image": {
              "filename": "primary_image.png",
              "file_size_bytes": $FILE_SIZE,
              "generation_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "image_info": "$IMAGE_INFO"
            },
            "generation_parameters": {
              "prompt_used": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.prompt'),
              "negative_prompt": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.negative_prompt'),
              "technical_config": $(echo "$OPTIMIZED_PROMPTS" | jq '.final_generation_config.parameters')
            }
          }
          EOF
            
            echo "âœ… Metadata extracted for primary image"
          else
            echo "âš ï¸ No primary image found for metadata extraction"
          fi
          
          IMAGE_METADATA=$(cat .logs/metadata/image-metadata.json)
          echo "image_metadata<<EOF" >> $GITHUB_OUTPUT
          echo "$IMAGE_METADATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Phase 5: å“è³ªæ”¹å–„æ®µéšŽ
  image-refinement:
    needs: [quality-analysis, metadata-extraction, prompt-optimization]
    runs-on: ubuntu-latest
    outputs:
      refinement_status: ${{ steps.refine.outputs.refinement_status }}
    steps:
      - name: Refine and improve images
        id: refine
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "âœ¨ Refining and improving images..."
          
          mkdir -p .outputs/refined
          
          # å“è³ªåˆ†æžçµæžœã‚’ç¢ºèª
          QUALITY_ANALYSIS='${{ needs.quality-analysis.outputs.quality_analysis }}'
          OPTIMIZED_PROMPTS='${{ needs.prompt-optimization.outputs.optimized_prompts }}'
          REGENERATION_NEEDED=$(echo "$QUALITY_ANALYSIS" | jq -r '.regeneration_needed')
          OVERALL_RATING=$(echo "$QUALITY_ANALYSIS" | jq -r '.primary_image_analysis.overall_rating // 0')
          
          if [ "$REGENERATION_NEEDED" = "true" ] || [ "$OVERALL_RATING" -lt 7 ]; then
            echo "ðŸ”„ Regenerating image with improvements..."
            
            # æ”¹å–„ææ¡ˆã‚’å–å¾—
            IMPROVEMENT_SUGGESTIONS=$(echo "$QUALITY_ANALYSIS" | jq -r '.improvement_suggestions[]' | head -3 | tr '\n' ', ')
            
            # æ”¹å–„ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å†ç”Ÿæˆ
            IMPROVED_PROMPT=$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.prompt')", $IMPROVEMENT_SUGGESTIONS, enhanced quality, masterpiece"
            
            if claude-code --mcp image-generation \
              --prompt "$IMPROVED_PROMPT" \
              --negative-prompt "$(echo "$OPTIMIZED_PROMPTS" | jq -r '.final_generation_config.negative_prompt'), low quality, blurry, artifacts" \
              --output ".outputs/refined/improved_primary.png" \
              --config '{"steps": 40, "cfg_scale": 8.5, "width": 1024, "height": 1024}' \
              > .logs/generation/refinement-generation.log 2>&1; then
              echo "âœ… Improved image generated"
              REFINEMENT_STATUS="success"
            else
              echo "âš ï¸ Image refinement failed, using original"
              cp ".outputs/images/primary_image.png" ".outputs/refined/improved_primary.png" 2>/dev/null || true
              REFINEMENT_STATUS="fallback_to_original"
            fi
          else
            echo "âœ… Original image quality is good, copying to refined folder"
            cp ".outputs/images/primary_image.png" ".outputs/refined/improved_primary.png"
            REFINEMENT_STATUS="no_refinement_needed"
          fi
          
          # ã‚«ã‚¹ã‚¿ãƒ ç”»åƒå‡¦ç†ï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
          if [ "$KAMUICODE_STATUS" = "success" ]; then
            echo "ðŸŽ¨ Applying custom image processing..."
            claude-code --mcp kamuicode \
              --function enhance-image \
              --input ".outputs/refined/improved_primary.png" \
              --output ".outputs/refined/enhanced_primary.png" \
              > .logs/generation/enhancement.log 2>&1 || echo "Custom enhancement failed"
          fi
          
          # ç²¾ç´°åŒ–çµæžœã‚’ãƒ­ã‚°ä¿å­˜
          cat > .logs/generation/refinement-results.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "refinement_status": "$REFINEMENT_STATUS",
            "regeneration_performed": $([ "$REGENERATION_NEEDED" = "true" ] && echo "true" || echo "false"),
            "original_rating": $OVERALL_RATING,
            "refinement_approach": "$IMPROVEMENT_SUGGESTIONS",
            "output_files": [
              ".outputs/refined/improved_primary.png"
            ]
          }
          EOF
          
          echo "refinement_status=$REFINEMENT_STATUS" >> $GITHUB_OUTPUT
          echo "âœ¨ Image refinement completed"

  final-validation:
    needs: [image-refinement, prompt-analysis, initial-generation]
    runs-on: ubuntu-latest
    outputs:
      final_assessment: ${{ steps.validate.outputs.final_assessment }}
      ready_for_delivery: ${{ steps.validate.outputs.ready_for_delivery }}
    steps:
      - name: Validate final image quality
        id: validate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "ðŸ Performing final quality validation..."
          
          mkdir -p .logs/final-validation
          
          # æœ€çµ‚ç”»åƒã®å“è³ªæ¤œè¨¼
          PROMPT_ANALYSIS='${{ needs.prompt-analysis.outputs.prompt_analysis }}'
          GENERATION_RESULTS='${{ needs.initial-generation.outputs.generation_results }}'
          claude-code --prompt "æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚ŒãŸç”»åƒã®å“è³ªã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„ï¼š
          
          å…ƒã®è¦æ±‚: $PROMPT_ANALYSIS
          ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹: $GENERATION_RESULTS
          ç²¾ç´°åŒ–çµæžœ: $(cat .logs/generation/refinement-results.json)
          
          æœ€çµ‚ç”»åƒã‚’ç¢ºèªã—ã¦ãã ã•ã„: .outputs/refined/improved_primary.png
          
          ä»¥ä¸‹ã®å½¢å¼ã§JSONã§å›žç­”ã—ã¦ãã ã•ã„ï¼š
          {
            \"final_quality_assessment\": {
              \"meets_requirements\": \"true|false\",
              \"quality_score\": \"1-10ç‚¹ã§ã®æœ€çµ‚å“è³ªè©•ä¾¡\",
              \"prompt_fulfillment\": \"1-10ç‚¹ã§ã®è¦æ±‚é”æˆåº¦\",
              \"technical_excellence\": \"1-10ç‚¹ã§ã®æŠ€è¡“çš„å®Œæˆåº¦\",
              \"ready_for_delivery\": \"true|false\"
            },
            \"final_strengths\": [\"æœ€çµ‚ç”»åƒã®å„ªã‚ŒãŸç‚¹\"],
            \"remaining_issues\": [\"æ®‹å­˜ã™ã‚‹å•é¡Œç‚¹ï¼ˆã‚ã‚Œã°ï¼‰\"],
            \"delivery_recommendation\": \"é…ä¿¡ã«é–¢ã™ã‚‹æŽ¨å¥¨äº‹é …\",
            \"success_summary\": \"æˆåŠŸãƒã‚¤ãƒ³ãƒˆã®è¦ç´„\"
          }" > .logs/final-validation/final-assessment.json
          
          FINAL_ASSESSMENT=$(cat .logs/final-validation/final-assessment.json)
          echo "final_assessment<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL_ASSESSMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # é…ä¿¡å¯å¦åˆ¤å®š
          READY_FOR_DELIVERY=$(echo "$FINAL_ASSESSMENT" | jq -r '.final_quality_assessment.ready_for_delivery')
          echo "ready_for_delivery=$READY_FOR_DELIVERY" >> $GITHUB_OUTPUT
          
          echo "ðŸ Final quality validation completed"

  # Phase 6: å‡ºåŠ›æº–å‚™æ®µéšŽ
  format-optimization:
    needs: final-validation
    runs-on: ubuntu-latest
    steps:
      - name: Optimize image formats
        run: |
          echo "ðŸ”§ Optimizing image formats..."
          
          mkdir -p .final-output/{web,print,social}
          
          # Webç”¨æœ€é©åŒ–ï¼ˆJPEG, WebPï¼‰
          if [ -f ".outputs/refined/improved_primary.png" ]; then
            echo "Creating web-optimized versions..."
            
            # JPEGç‰ˆï¼ˆå“è³ª85%ï¼‰
            if command -v convert >/dev/null 2>&1; then
              convert ".outputs/refined/improved_primary.png" -quality 85 ".final-output/web/image.jpg" 2>/dev/null || echo "JPEG conversion failed"
              
              # WebPç‰ˆï¼ˆå“è³ª80%ï¼‰
              convert ".outputs/refined/improved_primary.png" -quality 80 ".final-output/web/image.webp" 2>/dev/null || echo "WebP conversion failed"
              
              # ã‚µãƒ ãƒã‚¤ãƒ«ç‰ˆï¼ˆ500x500ï¼‰
              convert ".outputs/refined/improved_primary.png" -resize 500x500 ".final-output/web/thumbnail.png" 2>/dev/null || echo "Thumbnail creation failed"
            else
              echo "ImageMagick not available, copying original"
              cp ".outputs/refined/improved_primary.png" ".final-output/web/image.png"
            fi
            
            # å°åˆ·ç”¨é«˜å“è³ªç‰ˆ
            cp ".outputs/refined/improved_primary.png" ".final-output/print/high_quality.png"
            
            # SNSç”¨æ­£æ–¹å½¢ç‰ˆï¼ˆ1080x1080ï¼‰
            if command -v convert >/dev/null 2>&1; then
              convert ".outputs/refined/improved_primary.png" -resize 1080x1080^ -gravity center -extent 1080x1080 ".final-output/social/square.png" 2>/dev/null || \
              cp ".outputs/refined/improved_primary.png" ".final-output/social/square.png"
            else
              cp ".outputs/refined/improved_primary.png" ".final-output/social/square.png"
            fi
            
            echo "âœ… Format optimization completed"
          else
            echo "âŒ No refined image found for optimization"
          fi

  metadata-compilation:
    needs: [final-validation, prompt-analysis, initial-generation, quality-analysis, metadata-extraction]
    runs-on: ubuntu-latest
    steps:
      - name: Compile comprehensive metadata
        run: |
          echo "ðŸ“‹ Compiling comprehensive metadata..."
          
          mkdir -p .final-output
          
          # åŒ…æ‹¬çš„ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          PROMPT_ANALYSIS='${{ needs.prompt-analysis.outputs.prompt_analysis }}'
          GENERATION_RESULTS='${{ needs.initial-generation.outputs.generation_results }}'
          QUALITY_ANALYSIS='${{ needs.quality-analysis.outputs.quality_analysis }}'
          FINAL_ASSESSMENT='${{ needs.final-validation.outputs.final_assessment }}'
          IMAGE_METADATA='${{ needs.metadata-extraction.outputs.image_metadata }}'
          
          cat > .final-output/image-info.json << EOF
          {
            "project_info": {
              "creation_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "workflow_run_id": "${{ github.run_id }}",
              "generated_by": "AI Image Generation Workflow"
            },
            "original_request": $PROMPT_ANALYSIS,
            "generation_process": {
              "generation_results": $GENERATION_RESULTS,
              "quality_analysis": $QUALITY_ANALYSIS,
              "final_assessment": $FINAL_ASSESSMENT
            },
            "output_files": {
              "primary_png": ".final-output/print/high_quality.png",
              "web_jpg": ".final-output/web/image.jpg",
              "web_webp": ".final-output/web/image.webp",
              "thumbnail": ".final-output/web/thumbnail.png",
              "social_square": ".final-output/social/square.png"
            },
            "usage_recommendations": {
              "web_display": "Use image.webp for modern browsers, image.jpg as fallback",
              "print_usage": "Use high_quality.png for print applications",
              "social_media": "Use square.png for social media platforms",
              "thumbnail": "Use thumbnail.png for gallery views"
            },
            "technical_specs": $IMAGE_METADATA,
            "quality_metrics": {
              "final_quality_score": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.quality_score // 0'),
              "prompt_fulfillment": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.prompt_fulfillment // 0'),
              "ready_for_delivery": $(echo "$FINAL_ASSESSMENT" | jq '.final_quality_assessment.ready_for_delivery // false')
            }
          }
          EOF
          
          echo "âœ… Metadata compilation completed"

  package-creation:
    needs: [format-optimization, metadata-compilation, final-validation]
    runs-on: ubuntu-latest
    steps:
      - name: Create final delivery package
        run: |
          echo "ðŸ“¦ Creating final delivery package..."
          
          # ZIPãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
          cd .final-output && zip -r ../ai-generated-images.zip . && cd ..
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±
          PACKAGE_SIZE=$(stat -f%z "ai-generated-images.zip" 2>/dev/null || stat -c%s "ai-generated-images.zip" 2>/dev/null || echo "unknown")
          
          # é…ä¿¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æƒ…å ±
          READY_FOR_DELIVERY='${{ needs.final-validation.outputs.ready_for_delivery }}'
          cat > .final-output/package-info.json << EOF
          {
            "package_created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "package_size_bytes": $PACKAGE_SIZE,
            "package_contents": [
              "print/high_quality.png",
              "web/image.jpg",
              "web/image.webp", 
              "web/thumbnail.png",
              "social/square.png",
              "image-info.json"
            ],
            "delivery_status": "ready",
            "quality_approved": $READY_FOR_DELIVERY
          }
          EOF
          
          echo "ðŸ“¦ Final package created successfully"
      
      - name: Upload Image Generation Package
        uses: actions/upload-artifact@v4
        with:
          name: ai-image-generation-package-${{ github.run_number }}
          path: .final-output/
          retention-days: 30

