# Claude Code T2I (Text-to-Image) æ­£ã—ã„å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ç”»åƒç”Ÿæˆæ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å•é¡Œã‚’é˜²ããŸã‚ã®å‚ç…§å®Ÿè£…ã§ã™

name: "Claude Code T2I Correct Pattern Example"
on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
        required: true
        default: "Professional news anchor in studio"

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  generate-image:
    name: "ç”»åƒç”Ÿæˆï¼ˆæ­£ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰"
    runs-on: ubuntu-latest
    steps:
      - name: Setup Project Directory
        id: setup
        run: |
          PROJECT_DIR="projects/t2i-example-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$PROJECT_DIR"/{media/images,logs}
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Project directory created: $PROJECT_DIR"

      - name: Generate Image with Explicit Save
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          
          # âœ… CORRECT: æ˜ç¤ºçš„ãªä¿å­˜ãƒ‘ã‚¹ã‚’å®šç¾©
          SAVE_PATH="${PROJECT_DIR}/media/images/generated.png"
          URL_PATH="${PROJECT_DIR}/media/images/generated-url.txt"
          
          # âœ… CORRECT: è©³ç´°ãªæ‰‹é †ã‚’å«ã‚€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          GENERATION_PROMPT="ä»¥ä¸‹ã®æ‰‹é †ã§ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
          
          1. MCPãƒ„ãƒ¼ãƒ« mcp__t2i-kamui-imagen3__imagen_t2i ã‚’ä½¿ç”¨ã—ã¦ç”»åƒç”Ÿæˆ
             - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ inputs.prompt }}
             - è§£åƒåº¦: 1920x1080
             - å“è³ª: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«
          
          2. Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆç”»åƒã‚’ä»¥ä¸‹ã®ãƒ‘ã‚¹ã«ä¿å­˜
             - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹: ${SAVE_PATH}
          
          3. Google Cloud Storage URLã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
             - URLãƒ•ã‚¡ã‚¤ãƒ«: ${URL_PATH}
          
          4. Bashãƒ„ãƒ¼ãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ä¿å­˜ç¢ºèª
             - ls -la ${PROJECT_DIR}/media/images/
          
          é‡è¦: ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †ç•ªã«å®Ÿè¡Œã—ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          
          # âœ… CORRECT: Write, Bashãƒ„ãƒ¼ãƒ«ã‚’è¨±å¯
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$GENERATION_PROMPT"
          
          # âœ… CORRECT: å³åº§ã®ç¢ºèª
          echo "=== ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª ==="
          ls -la "${PROJECT_DIR}/media/images/"
          
          # âœ… CORRECT: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®å³åº§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ -f "$URL_PATH" ]; then
            URL=$(cat "$URL_PATH")
            echo "ğŸ“¥ Downloading from Google Cloud Storage: $URL"
            curl -L -o "$SAVE_PATH" "$URL" || echo "âš ï¸ Download failed, file may already be local"
          fi
          
          # âœ… CORRECT: å¤šæ®µéšãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
          echo "=== ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ ==="
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«å
          IMAGE=$(find "$PROJECT_DIR" -type f -name "generated.png" 2>/dev/null | head -1)
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: 2åˆ†ä»¥å†…ã«ä½œæˆã•ã‚ŒãŸPNGãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$IMAGE" ]; then
            echo "Searching for recently created PNG files..."
            IMAGE=$(find "$PROJECT_DIR" -type f -name "*.png" -mmin -2 2>/dev/null | head -1)
          fi
          
          # ãƒ‘ã‚¿ãƒ¼ãƒ³3: ä»»æ„ã®PNGãƒ•ã‚¡ã‚¤ãƒ«
          if [ -z "$IMAGE" ]; then
            echo "Searching for any PNG files..."
            IMAGE=$(find "$PROJECT_DIR" -type f -name "*.png" 2>/dev/null | head -1)
          fi
          
          # âœ… CORRECT: æ¤œè¨¼ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          if [ -n "$IMAGE" ] && [ -f "$IMAGE" ]; then
            FILE_SIZE=$(stat -c%s "$IMAGE" 2>/dev/null || echo 0)
            if [ "$FILE_SIZE" -gt 10000 ]; then
              echo "âœ… ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ: $IMAGE (${FILE_SIZE} bytes)"
            else
              echo "âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãã¾ã™: $IMAGE (${FILE_SIZE} bytes)"
            fi
          else
            # âœ… CORRECT: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯æœ€çµ‚æ‰‹æ®µã®ã¿
            echo "âŒ ERROR: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "Creating placeholder as last resort..."
            IMAGE="${SAVE_PATH}"
            mkdir -p "$(dirname "$IMAGE")"
            echo "Placeholder image - generation failed" > "$IMAGE"
          fi
          
          # âœ… CORRECT: GitHub Step Summaryã«çµæœã‚’è¨˜éŒ²
          echo "## ğŸ¨ ç”»åƒç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
          if [ "$FILE_SIZE" -gt 10000 ]; then
            echo "- âœ… ç”ŸæˆæˆåŠŸ: ${IMAGE}" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ ç”Ÿæˆå¤±æ•—: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Generated Image
        uses: actions/upload-artifact@v4
        with:
          name: generated-image
          path: ${{ steps.setup.outputs.project_dir }}/media/images/

# ãƒã‚¤ãƒ³ãƒˆè§£èª¬:
# 1. æ˜ç¤ºçš„ãªä¿å­˜ãƒ‘ã‚¹æŒ‡å®š: ${PROJECT_DIR}/media/images/generated.png
# 2. URLãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæŒ‡ç¤º: ${PROJECT_DIR}/media/images/generated-url.txt
# 3. è©³ç´°ãªæ‰‹é †èª¬æ˜: 1â†’2â†’3â†’4ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ˜è¨˜
# 4. Writeãƒ„ãƒ¼ãƒ«è¨±å¯: --allowedTools ã« Write ã‚’å«ã‚ã‚‹
# 5. Bashãƒ„ãƒ¼ãƒ«è¨±å¯: --allowedTools ã« Bash ã‚’å«ã‚ã‚‹
# 6. å³åº§ã®ç¢ºèª: ls -la ã§ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚’ç¢ºèª
# 7. URLãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: curl -L -o ã§å³åº§ã«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
# 8. å¤šæ®µéšæ¤œç´¢: 3ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
# 9. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæ¤œè¨¼: 10KBä»¥ä¸Šã§æˆåŠŸåˆ¤å®š
# 10. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯æœ€çµ‚æ‰‹æ®µ: ã™ã¹ã¦ã®æ¤œç´¢ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿