name: "Social Media Content Creation Workflow"
run-name: "📱 Creating social content: ${{ github.event.inputs.content_theme || 'Social Media Campaign' }}"

on:
  workflow_dispatch:
    inputs:
      content_theme:
        description: 'コンテンツテーマ・メッセージ'
        required: true
        default: '新商品プロモーション、ブランド認知向上、キャンペーン告知'
        type: string
      target_platforms:
        description: 'ターゲットプラットフォーム'
        required: true
        type: choice
        options:
        - multi_platform
        - instagram_focused
        - twitter_focused
        - tiktok_focused
        - linkedin_focused
        - facebook_focused
        default: 'multi_platform'
      content_style:
        description: 'コンテンツスタイル'
        required: true
        type: choice
        options:
        - casual
        - professional
        - trendy
        - educational
        - entertaining
        - minimalist
        default: 'casual'
      visual_type:
        description: 'ビジュアルタイプ'
        required: true
        type: choice
        options:
        - static_image
        - carousel_images
        - short_video
        - mixed_content
        - infographic
        default: 'mixed_content'
      target_audience:
        description: 'ターゲット層'
        required: true
        type: choice
        options:
        - teens
        - young_adults
        - professionals
        - families
        - seniors
        - general
        default: 'young_adults'
      posting_frequency:
        description: '投稿頻度'
        required: true
        type: choice
        options:
        - daily
        - weekly
        - campaign_burst
        - event_driven
        default: 'weekly'
      engagement_goal:
        description: 'エンゲージメント目標'
        required: true
        type: choice
        options:
        - awareness
        - engagement
        - conversion
        - community_building
        - viral_potential
        default: 'engagement'
      brand_voice:
        description: 'ブランドボイス'
        required: false
        type: choice
        options:
        - friendly
        - authoritative
        - playful
        - inspirational
        - informative
        - quirky
        default: 'friendly'
      call_to_action:
        description: 'コールトゥアクション（任意）'
        required: false
        default: 'いいね・シェア、コメント歓迎、詳細はプロフィールから'
        type: string

permissions:
  contents: write
  issues: read
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: 事前テスト段階
  connectivity-test:
    runs-on: ubuntu-latest
    outputs:
      services_ready: ${{ steps.test.outputs.services_ready }}
      image_gen_available: ${{ steps.test.outputs.image_gen_available }}
      video_gen_available: ${{ steps.test.outputs.video_gen_available }}
    steps:
      - name: Test social media content generation services
        id: test
        run: |
          echo "📱 Testing social media content generation services..."
          
          mkdir -p .logs/connectivity-tests
          
          # 画像生成サービステスト（ソーシャルメディア投稿用）
          echo "Testing image generation for social media posts..."
          if timeout 90 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "social media post image test" > .logs/connectivity-tests/image-test.log 2>&1; then
            IMAGE_GEN_STATUS="success"
            echo "✅ Image Generation: Available"
          else
            IMAGE_GEN_STATUS="failed"
            echo "⚠️ Image Generation: Not available - will use text-only posts"
          fi
          
          # 動画生成サービステスト（ショート動画用）
          echo "Testing video generation for short content..."
          if timeout 120 claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2v-fal-veo3-fast --prompt "short social media video test" > .logs/connectivity-tests/video-test.log 2>&1; then
            VIDEO_GEN_STATUS="success"
            echo "✅ Video Generation: Available"
          else
            VIDEO_GEN_STATUS="failed"
            echo "⚠️ Video Generation: Not available - will focus on static content"
          fi
          
          # Set outputs
          echo "services_ready=true" >> $GITHUB_OUTPUT
          echo "image_gen_available=$IMAGE_GEN_STATUS" >> $GITHUB_OUTPUT
          echo "video_gen_available=$VIDEO_GEN_STATUS" >> $GITHUB_OUTPUT
          
          echo "📱 Social media services connectivity tests completed"

  # Phase 2: プラットフォーム分析段階
  platform-analysis:
    needs: connectivity-test
    runs-on: ubuntu-latest
    outputs:
      analysis_ready: ${{ steps.analyze.outputs.analysis_ready }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Analyze target platforms and optimization requirements
        id: analyze
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "🔍 Analyzing target platforms and optimization requirements..."
          
          mkdir -p .logs/platform-analysis
          
          TARGET_PLATFORMS="${{ github.event.inputs.target_platforms }}"
          CONTENT_STYLE="${{ github.event.inputs.content_style }}"
          TARGET_AUDIENCE="${{ github.event.inputs.target_audience }}"
          
          echo "Target platforms: $TARGET_PLATFORMS"
          echo "Content style: $CONTENT_STYLE"
          echo "Target audience: $TARGET_AUDIENCE"
          
          # Claude Code でプラットフォーム別最適化分析
          claude-code --prompt "以下のソーシャルメディア要件を分析し、プラットフォーム別の最適化戦略をJSON形式で提案してください：

          ターゲットプラットフォーム: $TARGET_PLATFORMS
          コンテンツスタイル: $CONTENT_STYLE
          ターゲット層: $TARGET_AUDIENCE
          ビジュアルタイプ: ${{ github.event.inputs.visual_type }}
          エンゲージメント目標: ${{ github.event.inputs.engagement_goal }}

          各プラットフォームの特性、最適な投稿サイズ、ハッシュタグ戦略、投稿時間などを含めてください。" > .logs/platform-analysis/platform-strategy.json
          
          echo "analysis_ready=true" >> $GITHUB_OUTPUT
          echo "🔍 Platform analysis completed"

  # Phase 3: コンテンツ企画段階
  content-strategy:
    needs: platform-analysis
    runs-on: ubuntu-latest
    outputs:
      strategy_ready: ${{ steps.strategy.outputs.strategy_ready }}
    steps:
      - name: Develop comprehensive content strategy
        id: strategy
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "📋 Developing comprehensive content strategy..."
          
          mkdir -p .logs/content-strategy
          
          CONTENT_THEME="${{ github.event.inputs.content_theme }}"
          POSTING_FREQUENCY="${{ github.event.inputs.posting_frequency }}"
          BRAND_VOICE="${{ github.event.inputs.brand_voice }}"
          
          # コンテンツ戦略とキャンペーン設計
          claude-code --prompt "以下の要件に基づいて、詳細なソーシャルメディアコンテンツ戦略を設計してください：

          コンテンツテーマ: $CONTENT_THEME
          投稿頻度: $POSTING_FREQUENCY
          ブランドボイス: $BRAND_VOICE
          コールトゥアクション: ${{ github.event.inputs.call_to_action }}

          投稿カレンダー、コンテンツシリーズ、エンゲージメント戦略をJSON形式で返してください。" > .logs/content-strategy/content-plan.json
          
          echo "strategy_ready=true" >> $GITHUB_OUTPUT
          echo "📋 Content strategy development completed"

  # Phase 4: ビジュアルコンテンツ制作段階
  visual-content-creation:
    needs: [connectivity-test, content-strategy]
    runs-on: ubuntu-latest
    outputs:
      visuals_ready: ${{ steps.create.outputs.visuals_ready }}
    steps:
      - name: Generate visual content for social media
        id: create
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "🎨 Generating visual content for social media..."
          
          mkdir -p .logs/visual-content
          
          IMAGE_GEN_AVAILABLE="${{ needs.connectivity-test.outputs.image_gen_available }}"
          VIDEO_GEN_AVAILABLE="${{ needs.connectivity-test.outputs.video_gen_available }}"
          VISUAL_TYPE="${{ github.event.inputs.visual_type }}"
          
          if [ "$IMAGE_GEN_AVAILABLE" = "success" ]; then
            echo "Generating social media images..."
            
            # メイン投稿画像生成
            MAIN_IMAGE_PROMPT="${{ github.event.inputs.content_theme }}, social media post, ${{ github.event.inputs.content_style }} style, engaging visual, high quality, optimized for social platforms"
            
            claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "$MAIN_IMAGE_PROMPT" > .logs/visual-content/main-post-image.json 2>&1 || echo "Main image generation failed"
            
            # インスタグラム正方形フォーマット
            SQUARE_PROMPT="${{ github.event.inputs.content_theme }}, Instagram square format, 1:1 aspect ratio, ${{ github.event.inputs.content_style }} aesthetic"
            
            claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2i-fal-imagen4-fast --prompt "$SQUARE_PROMPT" > .logs/visual-content/instagram-square.json 2>&1 || echo "Square format generation failed"
            
            echo "✅ Image content generated"
          else
            echo "⚠️ Image generation not available - will create text-only content strategy"
          fi
          
          if [ "$VIDEO_GEN_AVAILABLE" = "success" ] && [ "$VISUAL_TYPE" = "short_video" ]; then
            echo "Generating short video content..."
            
            VIDEO_PROMPT="${{ github.event.inputs.content_theme }}, short social media video, engaging, ${{ github.event.inputs.content_style }} style, 15-30 seconds"
            
            claude-code --mcp-config=.claude/mcp-kamuicode.json --mcp t2v-fal-veo3-fast --prompt "$VIDEO_PROMPT" > .logs/visual-content/short-video.json 2>&1 || echo "Video generation failed"
            
            echo "✅ Video content generated"
          else
            echo "ℹ️ Video generation skipped or not available"
          fi
          
          echo "visuals_ready=true" >> $GITHUB_OUTPUT
          echo "🎨 Visual content creation completed"

  # Phase 5: テキスト最適化段階
  text-optimization:
    needs: content-strategy
    runs-on: ubuntu-latest
    outputs:
      text_ready: ${{ steps.optimize.outputs.text_ready }}
    steps:
      - name: Generate and optimize platform-specific text content
        id: optimize
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "📝 Generating and optimizing platform-specific text content..."
          
          mkdir -p .logs/text-optimization
          
          TARGET_PLATFORMS="${{ github.event.inputs.target_platforms }}"
          CONTENT_THEME="${{ github.event.inputs.content_theme }}"
          BRAND_VOICE="${{ github.event.inputs.brand_voice }}"
          
          # プラットフォーム別テキスト最適化
          claude-code --prompt "以下の要件に基づいて、各ソーシャルメディアプラットフォーム向けに最適化されたテキストコンテンツを作成してください：

          コンテンツテーマ: $CONTENT_THEME
          対象プラットフォーム: $TARGET_PLATFORMS
          ブランドボイス: $BRAND_VOICE
          コールトゥアクション: ${{ github.event.inputs.call_to_action }}

          プラットフォーム別の文字数制限、ハッシュタグ戦略、エンゲージメント最適化を考慮してJSON形式で返してください。" > .logs/text-optimization/platform-text.json
          
          echo "text_ready=true" >> $GITHUB_OUTPUT
          echo "📝 Text optimization completed"

  # Phase 6: ハッシュタグ・SEO最適化段階
  hashtag-seo-optimization:
    needs: text-optimization
    runs-on: ubuntu-latest
    outputs:
      seo_ready: ${{ steps.seo.outputs.seo_ready }}
    steps:
      - name: Generate hashtag strategy and SEO optimization
        id: seo
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "🔍 Generating hashtag strategy and SEO optimization..."
          
          mkdir -p .logs/hashtag-seo
          
          # ハッシュタグ戦略とSEO最適化
          claude-code --prompt "以下のソーシャルメディアコンテンツに対して、ハッシュタグ戦略とSEO最適化を設計してください：

          コンテンツテーマ: ${{ github.event.inputs.content_theme }}
          ターゲット層: ${{ github.event.inputs.target_audience }}
          プラットフォーム: ${{ github.event.inputs.target_platforms }}
          エンゲージメント目標: ${{ github.event.inputs.engagement_goal }}

          人気ハッシュタグ、ニッチハッシュタグ、ブランドハッシュタグの組み合わせ戦略をJSON形式で返してください。" > .logs/hashtag-seo/hashtag-strategy.json
          
          echo "seo_ready=true" >> $GITHUB_OUTPUT
          echo "🔍 Hashtag and SEO optimization completed"

  # Phase 7: 最終パッケージ作成
  final-packaging:
    needs: [platform-analysis, content-strategy, visual-content-creation, text-optimization, hashtag-seo-optimization]
    runs-on: ubuntu-latest
    steps:
      - name: Create comprehensive social media campaign package
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "📦 Creating comprehensive social media campaign package..."
          
          mkdir -p .final-output/{strategy,content,visuals,optimization}
          
          # 戦略ドキュメント
          cp .logs/platform-analysis/platform-strategy.json .final-output/strategy/ 2>/dev/null || true
          cp .logs/content-strategy/content-plan.json .final-output/strategy/ 2>/dev/null || true
          
          # ビジュアルコンテンツ
          cp .logs/visual-content/*.json .final-output/visuals/ 2>/dev/null || true
          
          # テキスト・最適化資料
          cp .logs/text-optimization/platform-text.json .final-output/content/ 2>/dev/null || true
          cp .logs/hashtag-seo/hashtag-strategy.json .final-output/optimization/ 2>/dev/null || true
          
          # マスターソーシャルメディア情報
          cat > .final-output/social-media-master.json << EOF
          {
            "project_info": {
              "project_name": "Social Media Content Creation",
              "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "github_run_id": "${{ github.run_id }}",
              "campaign_type": "social_media_content_generation"
            },
            "input_parameters": {
              "content_theme": "${{ github.event.inputs.content_theme }}",
              "target_platforms": "${{ github.event.inputs.target_platforms }}",
              "content_style": "${{ github.event.inputs.content_style }}",
              "visual_type": "${{ github.event.inputs.visual_type }}",
              "target_audience": "${{ github.event.inputs.target_audience }}",
              "posting_frequency": "${{ github.event.inputs.posting_frequency }}",
              "engagement_goal": "${{ github.event.inputs.engagement_goal }}",
              "brand_voice": "${{ github.event.inputs.brand_voice }}",
              "call_to_action": "${{ github.event.inputs.call_to_action }}"
            },
            "deliverables": {
              "strategy_documents": {
                "platform_strategy": "strategy/platform-strategy.json",
                "content_plan": "strategy/content-plan.json"
              },
              "visual_content": {
                "generated_visuals": "visuals/"
              },
              "text_content": {
                "platform_optimized_text": "content/platform-text.json"
              },
              "optimization": {
                "hashtag_strategy": "optimization/hashtag-strategy.json"
              }
            }
          }
          EOF
          
          # ソーシャルメディアキャンペーンガイド
          cat > .final-output/SOCIAL_MEDIA_GUIDE.md << 'EOF'
          # ソーシャルメディアコンテンツ制作ガイド
          
          ## 📱 キャンペーン概要
          - 制作手法: AI生成による統合ソーシャルメディアコンテンツ
          - 品質レベル: プロフェッショナルマーケティング対応
          - 最適化: マルチプラットフォーム戦略
          
          ## 🎯 戦略設計
          - プラットフォーム別特性分析
          - ターゲット層マッピング
          - エンゲージメント戦略
          - 投稿カレンダー最適化
          
          ## 🎨 コンテンツ制作
          - ビジュアルアセット生成
          - プラットフォーム別サイズ最適化
          - ブランド統一性確保
          - 動画・静止画コンテンツ
          
          ## 📝 テキスト最適化
          - プラットフォーム別文字数調整
          - ブランドボイス統一
          - コールトゥアクション設計
          - ハッシュタグ戦略実装
          
          ## 📊 パフォーマンス最適化
          - エンゲージメント最大化
          - リーチ拡大戦略
          - コンバージョン誘導
          - 分析・改善サイクル
          EOF
          
          echo "📦 Final social media campaign packaging completed"
          
      - name: Upload Social Media Campaign Package
        uses: actions/upload-artifact@v4
        with:
          name: social-media-campaign-${{ github.run_number }}
          path: .final-output/
          retention-days: 30