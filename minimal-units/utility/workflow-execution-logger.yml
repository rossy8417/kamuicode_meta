name: workflow-execution-logger
description: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°åŽé›†ã®æœ€å°å˜ä½ãƒ¦ãƒ‹ãƒƒãƒˆ

on:
  workflow_call:
    inputs:
      project_folder:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€å'
        required: true
        type: string
      workflow_name:
        description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å'
        required: true
        type: string
      issue_number:
        description: 'Issueç•ªå·ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰'
        required: false
        type: string
        default: 'N/A'
      additional_info:
        description: 'è¿½åŠ æƒ…å ±ï¼ˆJSONå½¢å¼ï¼‰'
        required: false
        type: string
        default: '{}'

jobs:
  collect-execution-logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Collect Comprehensive Execution Logs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ“‹ Collecting execution logs for ${{ inputs.workflow_name }}..."
          
          PROJECT_FOLDER="${{ inputs.project_folder }}"
          RUN_ID="${{ github.run_id }}"
          WORKFLOW_NAME="${{ inputs.workflow_name }}"
          ISSUE_NUMBER="${{ inputs.issue_number }}"
          
          # Create log directory
          mkdir -p "$PROJECT_FOLDER/execution-logs"
          
          EXECUTION_LOG="$PROJECT_FOLDER/execution-logs/workflow-execution-log.txt"
          
          # Generate comprehensive execution log
          cat > "$EXECUTION_LOG" << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         WORKFLOW EXECUTION LOG
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸ“… EXECUTION TIMESTAMP: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ðŸ”— GITHUB RUN: https://github.com/${{ github.repository }}/actions/runs/$RUN_ID
          
          ðŸš€ EXECUTION DETAILS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â€¢ Workflow Name: $WORKFLOW_NAME
          â€¢ GitHub Run ID: $RUN_ID
          â€¢ Issue Number: #$ISSUE_NUMBER
          â€¢ Execution Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          â€¢ Trigger Type: ${{ github.event_name }}
          â€¢ Repository: ${{ github.repository }}
          â€¢ Branch: ${{ github.ref_name }}
          â€¢ Actor: ${{ github.actor }}
          â€¢ Project Folder: $PROJECT_FOLDER
          
          ðŸŽ¯ WORKFLOW CONFIGURATION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â€¢ Environment Variables: $(env | grep -E '^(CLAUDE|OPENAI|GITHUB)' | wc -l) configuration vars
          â€¢ Runner OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)
          â€¢ Runner Architecture: $(uname -m)
          â€¢ Available Cores: $(nproc)
          â€¢ Memory: $(free -h | grep Mem | awk '{print $2}')
          
          ðŸ”§ INSTALLED TOOLS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â€¢ GitHub CLI: $(gh --version | head -1)
          â€¢ Python: $(python3 --version)
          â€¢ Node.js: $(node --version 2>/dev/null || echo 'Not Available')
          â€¢ Git: $(git --version)
          â€¢ jq: $(jq --version)
          
          ðŸŒ NETWORK & API STATUS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â€¢ GitHub API: $(curl -s -I https://api.github.com | head -1)
          â€¢ Internet Connectivity: $(ping -c 1 8.8.8.8 >/dev/null && echo 'Active' || echo 'Limited')
          
          ðŸ“Š WORKFLOW RUN INFORMATION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          
          # Get detailed run information from GitHub API
          gh api "repos/${{ github.repository }}/actions/runs/$RUN_ID" --jq '
          "â€¢ Run ID: " + (.id | tostring) + "\n" +
          "â€¢ Run Number: " + (.run_number | tostring) + "\n" +
          "â€¢ Status: " + .status + "\n" +
          "â€¢ Conclusion: " + (.conclusion // "in_progress") + "\n" +
          "â€¢ Created: " + .created_at + "\n" +
          "â€¢ Updated: " + .updated_at + "\n" +
          "â€¢ Started: " + (.run_started_at // "N/A") + "\n" +
          "â€¢ HTML URL: " + .html_url + "\n" +
          "â€¢ Head Branch: " + .head_branch + "\n" +
          "â€¢ Head SHA: " + .head_sha + "\n" +
          "â€¢ Actor: " + .actor.login + "\n" +
          "â€¢ Event: " + .event + "\n" +
          "â€¢ Workflow ID: " + (.workflow_id | tostring)
          ' >> "$EXECUTION_LOG" 2>/dev/null || echo "â€¢ APIæƒ…å ±ã®å–å¾—ã«å¤±æ•—" >> "$EXECUTION_LOG"
          
          # Get job execution details
          echo "" >> "$EXECUTION_LOG"
          echo "ðŸ“‹ JOB EXECUTION DETAILS" >> "$EXECUTION_LOG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$EXECUTION_LOG"
          
          gh api "repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs" --jq '.jobs[] | 
          "Job: " + .name + "\n" +
          "  â€¢ Status: " + .status + "\n" +  
          "  â€¢ Conclusion: " + (.conclusion // "in_progress") + "\n" +
          "  â€¢ Started: " + (.started_at // "not_started") + "\n" +
          "  â€¢ Completed: " + (.completed_at // "in_progress") + "\n" +
          "  â€¢ Duration: " + (if .started_at and .completed_at then 
              (((.completed_at | fromdateiso8601) - (.started_at | fromdateiso8601)) | tostring) + " seconds"
          else "in_progress" end) + "\n" +
          "  â€¢ Runner: " + (.runner_name // "pending") + "\n" +
          "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          ' >> "$EXECUTION_LOG" 2>/dev/null || echo "â€¢ ã‚¸ãƒ§ãƒ–æƒ…å ±ã®å–å¾—ã«å¤±æ•—" >> "$EXECUTION_LOG"
          
          # Get artifacts information
          echo "" >> "$EXECUTION_LOG"
          echo "ðŸ“¦ ARTIFACTS INFORMATION" >> "$EXECUTION_LOG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$EXECUTION_LOG"
          
          ARTIFACTS_INFO=$(gh api "repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts" 2>/dev/null) || echo ""
          
          if [ -n "$ARTIFACTS_INFO" ]; then
              ARTIFACT_COUNT=$(echo "$ARTIFACTS_INFO" | jq '.total_count // 0')
              echo "â€¢ Total Artifacts: $ARTIFACT_COUNT" >> "$EXECUTION_LOG"
              
              if [ "$ARTIFACT_COUNT" -gt 0 ]; then
                  echo "" >> "$EXECUTION_LOG"
                  echo "$ARTIFACTS_INFO" | jq -r '.artifacts[] | 
                  "Artifact: " + .name + "\n" +
                  "  â€¢ Size: " + (.size_in_bytes | tostring) + " bytes\n" +
                  "  â€¢ Created: " + .created_at + "\n" +
                  "  â€¢ Expired: " + (.expired | tostring) + "\n" +
                  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                  ' >> "$EXECUTION_LOG"
              fi
          else
              echo "â€¢ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—" >> "$EXECUTION_LOG"
          fi
          
          # Generated files information
          echo "" >> "$EXECUTION_LOG"
          echo "ðŸ“ GENERATED FILES" >> "$EXECUTION_LOG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$EXECUTION_LOG"
          
          if [ -d "$PROJECT_FOLDER" ]; then
              TOTAL_FILES=$(find "$PROJECT_FOLDER" -type f | wc -l)
              TOTAL_SIZE=$(du -sh "$PROJECT_FOLDER" 2>/dev/null | cut -f1 || echo "Unknown")
              
              echo "â€¢ Total Files: $TOTAL_FILES" >> "$EXECUTION_LOG"
              echo "â€¢ Total Size: $TOTAL_SIZE" >> "$EXECUTION_LOG"
              echo "" >> "$EXECUTION_LOG"
              echo "File Structure:" >> "$EXECUTION_LOG"
              find "$PROJECT_FOLDER" -type f -exec ls -la {} \; 2>/dev/null | head -30 | while read -r line; do
                  echo "  $line" >> "$EXECUTION_LOG"
              done
          fi
          
          # Additional information from input
          ADDITIONAL_INFO='${{ inputs.additional_info }}'
          if [ "$ADDITIONAL_INFO" != '{}' ]; then
              echo "" >> "$EXECUTION_LOG"  
              echo "ðŸ”§ WORKFLOW SPECIFIC INFORMATION" >> "$EXECUTION_LOG"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$EXECUTION_LOG"
              echo "$ADDITIONAL_INFO" | jq -r 'to_entries[] | "â€¢ " + .key + ": " + (.value | tostring)' >> "$EXECUTION_LOG" 2>/dev/null || echo "â€¢ è¿½åŠ æƒ…å ±: $ADDITIONAL_INFO" >> "$EXECUTION_LOG"
          fi
          
          # Footer
          echo "" >> "$EXECUTION_LOG"
          echo "âœ¨ LOG GENERATED BY" >> "$EXECUTION_LOG"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> "$EXECUTION_LOG"
          echo "Workflow Execution Logger v1.0" >> "$EXECUTION_LOG"
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$EXECUTION_LOG"
          echo "Repository: ${{ github.repository }}" >> "$EXECUTION_LOG"
          echo "" >> "$EXECUTION_LOG"
          
          echo "âœ… Execution log generated: $EXECUTION_LOG"
          
          # Create summary file for easy download detection
          cat > "$PROJECT_FOLDER/execution-logs/log-summary.json" << EOF
          {
            "workflow_name": "$WORKFLOW_NAME",
            "run_id": "$RUN_ID",
            "issue_number": "$ISSUE_NUMBER",
            "log_generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "log_file": "workflow-execution-log.txt",
            "project_folder": "$PROJECT_FOLDER"
          }
          EOF
          
          echo "ðŸ“‹ Log collection completed successfully"