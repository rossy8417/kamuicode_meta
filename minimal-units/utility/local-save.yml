name: local-save
description: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†

on:
  workflow_call:
    inputs:
      source_path:
        description: 'ä¿å­˜å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹'
        required: true
        type: string
      target_dir:
        description: 'ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆprojects/é…ä¸‹ï¼‰'
        required: true
        type: string
      file_pattern:
        description: 'ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ*.mp4, *.pngç­‰ï¼‰'
        required: false
        type: string
        default: '*'
      create_metadata:
        description: 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã‹'
        required: false
        type: boolean
        default: true
    outputs:
      saved_path:
        description: 'ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
        value: ${{ jobs.save.outputs.saved_path }}
      metadata_path:
        description: 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
        value: ${{ jobs.save.outputs.metadata_path }}

jobs:
  save:
    runs-on: ubuntu-latest
    outputs:
      saved_path: ${{ steps.save-files.outputs.saved_path }}
      metadata_path: ${{ steps.save-files.outputs.metadata_path }}
    
    steps:
      - name: Save Files to Local Directory
        id: save-files
        run: |
          echo "ðŸ“ Saving files to local directory..."
          
          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          TARGET_DIR="projects/${{ inputs.target_dir }}"
          mkdir -p "$TARGET_DIR"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼
          if [ -d "${{ inputs.source_path }}" ]; then
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆ
            cp -r "${{ inputs.source_path }}"/${{ inputs.file_pattern }} "$TARGET_DIR/" 2>/dev/null || true
            SAVED_PATH="$TARGET_DIR"
          else
            # å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
            cp "${{ inputs.source_path }}" "$TARGET_DIR/"
            SAVED_PATH="$TARGET_DIR/$(basename "${{ inputs.source_path }}")"
          fi
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
          if [ "${{ inputs.create_metadata }}" == "true" ]; then
            METADATA_FILE="$TARGET_DIR/save-metadata.json"
            cat > "$METADATA_FILE" << EOF
          {
            "saved_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source_path": "${{ inputs.source_path }}",
            "target_dir": "$TARGET_DIR",
            "file_pattern": "${{ inputs.file_pattern }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "files": $(ls -1 "$TARGET_DIR" | grep -v metadata | jq -R . | jq -s .)
          }
          EOF
            echo "metadata_path=$METADATA_FILE" >> $GITHUB_OUTPUT
          fi
          
          echo "saved_path=$SAVED_PATH" >> $GITHUB_OUTPUT
          echo "âœ… Files saved to: $TARGET_DIR"