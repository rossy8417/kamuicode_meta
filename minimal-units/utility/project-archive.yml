name: project-archive
description: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆã¨æ•´ç†

on:
  workflow_call:
    inputs:
      project_dir:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹'
        required: true
        type: string
      archive_name:
        description: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰'
        required: true
        type: string
      include_logs:
        description: 'ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹ã‹'
        required: false
        type: boolean
        default: false
      cleanup_source:
        description: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¾Œã«å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã‹'
        required: false
        type: boolean
        default: false
    outputs:
      archive_path:
        description: 'ä½œæˆã•ã‚ŒãŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ãƒ‘ã‚¹'
        value: ${{ jobs.archive.outputs.archive_path }}
      archive_size:
        description: 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ã‚µã‚¤ã‚º'
        value: ${{ jobs.archive.outputs.archive_size }}

jobs:
  archive:
    runs-on: ubuntu-latest
    outputs:
      archive_path: ${{ steps.create-archive.outputs.archive_path }}
      archive_size: ${{ steps.create-archive.outputs.archive_size }}
    
    steps:
      - name: Create Project Archive
        id: create-archive
        run: |
          echo "ðŸ—œï¸ Creating project archive..."
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          ARCHIVE_DIR="projects/archives"
          mkdir -p "$ARCHIVE_DIR"
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_NAME="${{ inputs.archive_name }}_${TIMESTAMP}"
          ARCHIVE_PATH="$ARCHIVE_DIR/${ARCHIVE_NAME}.tar.gz"
          
          # é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­å®š
          EXCLUDE_OPTS=""
          if [ "${{ inputs.include_logs }}" != "true" ]; then
            EXCLUDE_OPTS="--exclude='*.log' --exclude='logs/'"
          fi
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä½œæˆ
          tar czf "$ARCHIVE_PATH" \
            $EXCLUDE_OPTS \
            --exclude='*.tmp' \
            --exclude='.git' \
            -C "$(dirname "${{ inputs.project_dir }}")" \
            "$(basename "${{ inputs.project_dir }}")"
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚µã‚¤ã‚ºã®å–å¾—
          ARCHIVE_SIZE=$(ls -lh "$ARCHIVE_PATH" | awk '{print $5}')
          
          # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          cat > "$ARCHIVE_DIR/${ARCHIVE_NAME}_info.json" << EOF
          {
            "archive_name": "${ARCHIVE_NAME}.tar.gz",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source_dir": "${{ inputs.project_dir }}",
            "archive_size": "$ARCHIVE_SIZE",
            "include_logs": ${{ inputs.include_logs }},
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}"
          }
          EOF
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼‰
          if [ "${{ inputs.cleanup_source }}" == "true" ]; then
            echo "ðŸ§¹ Cleaning up source files..."
            rm -rf "${{ inputs.project_dir }}"
          fi
          
          echo "archive_path=$ARCHIVE_PATH" >> $GITHUB_OUTPUT
          echo "archive_size=$ARCHIVE_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… Archive created: $ARCHIVE_PATH ($ARCHIVE_SIZE)"