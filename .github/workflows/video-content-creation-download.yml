name: "Video Content Creation with Download"
run-name: "🎥 Download Test: ${{ github.event.inputs.video_concept }}"

on:
  workflow_dispatch:
    inputs:
      video_concept:
        description: '動画コンセプト・テーマ'
        required: true
        default: 'ダウンロードテスト - AIとロボットの協力'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  test-mcp-download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup environment
        run: |
          mkdir -p generated/images
          mkdir -p generated/videos
          mkdir -p generated/3d-models
          mkdir -p .claude
          
      - name: Create MCP config
        run: |
          cat > .claude/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "t2i-google-imagen3": {
                "type": "http",
                "url": "https://mcp-creatify-lipsync-20250719-010824-a071b7b8-820994673238.us-central1.run.app/t2i/google/imagen",
                "description": "Google Imagen 3 Text-to-Image Generation"
              },
              "i2v-fal-hailuo-02-pro": {
                "type": "http",
                "url": "https://mcp-creatify-lipsync-20250719-010824-a071b7b8-820994673238.us-central1.run.app/i2v/fal/minimax/hailuo-02/pro",
                "description": "Fal.ai Hailuo-02 Pro Image-to-Video Generation"
              },
              "i2i3d-fal-hunyuan3d-v21": {
                "type": "http",
                "url": "https://mcp-creatify-lipsync-20250719-010824-a071b7b8-820994673238.us-central1.run.app/i2i3d/fal/hunyuan/3d-v21",
                "description": "Fal.ai Hunyuan3D v2.1 Image-to-3D Model Generation"
              }
            }
          }
          EOF
          chmod 600 .claude/mcp-config.json
          
      - name: Generate and Download Image
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            1. Generate an image using MCP service t2i-google-imagen3 with prompt: "${{ github.event.inputs.video_concept }}"
            2. Use aspect ratio 1:1 (default)
            3. Get the full authenticated URL from the response (Google URLs are long, Fal URLs are short)
            4. Download the image to the current directory using wget with the FULL URL (no abbreviation)
            5. Display the full path where the file was saved using pwd
            6. Save the generation details to generated/images/result.json including the full URL
          system_prompt: |
            You are Claude Code in a CI/CD environment.
            All MCP tools are pre-authorized. Proceed without waiting for permissions.
            IMPORTANT: Always use the FULL authenticated URL for downloads - never abbreviate URLs.
            For Google URLs: use the complete long URL with all parameters.
            For Fal URLs: use the complete short URL.
            Display saved file locations with full path starting from ~.
          mcp_config: ".claude/mcp-config.json"
          allowed_tools: "View,mcp__t2i-google-imagen3__*,Bash,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
      - name: Generate and Download Video (I2V)
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            1. Read the image URL from generated/images/result.json
            2. Use that FULL Google URL as input for i2v-fal-hailuo-02-pro service
            3. Generate a video from the image
            4. Download the video to current directory using the FULL authenticated URL
            5. Display the full path where saved
            6. Save details to generated/videos/result.json
          system_prompt: |
            You are Claude Code in a CI/CD environment.
            All MCP tools are pre-authorized.
            IMPORTANT: Use the FULL Google URL from the image as input - no file paths!
          mcp_config: ".claude/mcp-config.json"
          allowed_tools: "View,mcp__i2v-fal-hailuo-02-pro__*,Bash,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
      - name: Generate and Download 3D Model
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            1. Read the image URL from generated/images/result.json
            2. Use that FULL Google URL as input for i2i3d-fal-hunyuan3d-v21 service
            3. Generate a 3D model from the image
            4. Download the 3D model to current directory using the FULL authenticated URL
            5. Display the full path where saved
            6. Save details to generated/3d-models/result.json
          system_prompt: |
            You are Claude Code in a CI/CD environment.
            All MCP tools are pre-authorized.
            IMPORTANT: Use the FULL Google URL from the image as input!
          mcp_config: ".claude/mcp-config.json"
          allowed_tools: "View,mcp__i2i3d-fal-hunyuan3d-v21__*,Bash,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
      - name: List Downloaded Files
        run: |
          echo "📁 Downloaded files:"
          echo "Current directory: $(pwd)"
          echo ""
          echo "All files in current directory:"
          ls -la
          echo ""
          echo "Generated files:"
          find generated -type f -name "*" | while read file; do
            echo "Found: ~$(pwd)/$file"
          done
          echo ""
          echo "Downloaded media files:"
          find . -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.mp4" -o -name "*.glb" -o -name "*.obj" \) | while read file; do
            echo "Downloaded: ~$(pwd)/$file"
          done
          
      - name: Upload All Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-download-test-${{ github.run_number }}
          path: |
            generated/
            *.png
            *.jpg
            *.mp4
            *.glb
            *.obj
          retention-days: 30