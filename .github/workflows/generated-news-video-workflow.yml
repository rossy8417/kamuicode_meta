name: "Professional News Video Creation Workflow"

on:
  workflow_dispatch:
    inputs:
      news_topic:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šæŠ€è¡“é©æ–°ã€æ”¿æ²»ã€çµŒæ¸ˆï¼‰"
        required: true
        default: "æœ€æ–°ã®æŠ€è¡“é©æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹"
      time_period:
        description: "å¯¾è±¡æœŸé–“ï¼ˆä¾‹ï¼š24æ™‚é–“ä»¥å†…ã€1é€±é–“ä»¥å†…ï¼‰"
        required: true
        default: "24æ™‚é–“ä»¥å†…"
      project_name:
        description: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä½¿ç”¨ï¼‰"
        required: true
        default: "news-video-production"

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  # Phase 1: Foundation - Information Gathering
  phase1-foundation:
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      research_data: ${{ steps.research.outputs.research_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup project structure
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="${GITHUB_WORKSPACE}/projects/${{ inputs.project_name }}-${TIMESTAMP}"
          mkdir -p "${PROJECT_DIR}"/{metadata,logs,media/{images,videos,audio,3d},final,temp}
          echo "project_dir=${PROJECT_DIR}" >> $GITHUB_OUTPUT
          echo "[$(date)] Phase 1: Foundation started" >> "${PROJECT_DIR}/logs/execution.log"
          echo "Project directory: ${PROJECT_DIR}"
          
          # Initialize Progressive Report in GitHub Actions Summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“º Professional News Video Creation å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ
          
          ## ðŸ“‹ å®Ÿè¡Œæ¦‚è¦
          EOF
          
          echo "- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯**: ${{ inputs.news_topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡æœŸé–“**: ${{ inputs.time_period }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œé–‹å§‹æ™‚åˆ»**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡ŒçŠ¶æ³**: ðŸ”„ é€²è¡Œä¸­..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ—ï¸ Phase 1: Foundation - æƒ…å ±åŽé›†åŸºç›¤æ§‹ç¯‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ä½œæˆå®Œäº†: ${PROJECT_DIR##*/}" >> $GITHUB_STEP_SUMMARY

      - name: News Research and Information Gathering
        id: research
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          echo "[$(date)] Starting news research for topic: ${{ inputs.news_topic }}" >> "${PROJECT_DIR}/logs/execution.log"
          
          RESEARCH_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åŽé›†ãƒ»ãƒªã‚µãƒ¼ãƒã‚¿ã‚¹ã‚¯ï¼š
          ãƒˆãƒ”ãƒƒã‚¯: ${{ inputs.news_topic }}
          æœŸé–“: ${{ inputs.time_period }}
          
          ä»¥ä¸‹ã®è¦ä»¶ã§æƒ…å ±åŽé›†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. æŒ‡å®šã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯ã®æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¤‡æ•°ã®ä¿¡é ¼æ€§ã®é«˜ã„æƒ…å ±æºã‹ã‚‰åŽé›†
          2. äº‹å®Ÿç¢ºèªã¨æƒ…å ±ã®ä¿¡é ¼æ€§æ¤œè¨¼
          3. 60ç§’ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã«é©ã—ãŸè¦ç‚¹ã®æ•´ç†
          4. JSONå½¢å¼ã§structured dataã¨ã—ã¦ä¿å­˜: ${PROJECT_DIR}/metadata/research_data.json
          
          å‡ºåŠ›å½¢å¼:
          {
            \"topic\": \"ãƒˆãƒ”ãƒƒã‚¯å\",
            \"sources\": [\"æƒ…å ±æº1\", \"æƒ…å ±æº2\", \"æƒ…å ±æº3\"],
            \"key_facts\": [\"é‡è¦äº‹å®Ÿ1\", \"é‡è¦äº‹å®Ÿ2\"],
            \"timeline\": \"æ™‚ç³»åˆ—æƒ…å ±\",
            \"reliability_score\": 0.95
          }"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Read" \
            --max-turns 20 \
            --permission-mode "acceptEdits" \
            -p "$RESEARCH_PROMPT"
          
          if [ -f "${PROJECT_DIR}/metadata/research_data.json" ]; then
            echo "research_data=${PROJECT_DIR}/metadata/research_data.json" >> $GITHUB_OUTPUT
            echo "[$(date)] Research completed successfully" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 1 Research Report
            echo "- âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åŽé›†å®Œäº†: ${{ inputs.news_topic }}" >> $GITHUB_STEP_SUMMARY
            
            # Extract research summary for report
            if command -v jq > /dev/null; then
              SOURCES_COUNT=$(jq '.sources | length' "${PROJECT_DIR}/metadata/research_data.json" 2>/dev/null || echo "0")
              RELIABILITY_SCORE=$(jq -r '.reliability_score' "${PROJECT_DIR}/metadata/research_data.json" 2>/dev/null || echo "N/A")
              echo "- âœ… åŽé›†æƒ…å ±æºæ•°: ${SOURCES_COUNT}ä»¶" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢: ${RELIABILITY_SCORE}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] ERROR: Research data not generated" >> "${PROJECT_DIR}/logs/execution.log"
            exit 1
          fi

      - name: Upload Phase 1 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase1-foundation
          path: ${{ steps.setup.outputs.project_dir }}/

  # Phase 2: Content Creation - Script and Structure
  phase2-content-creation:
    runs-on: ubuntu-latest
    needs: phase1-foundation
    outputs:
      script_data: ${{ steps.script.outputs.script_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Phase 1 artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase1-foundation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Create News Script and Structure
        id: script
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          RESEARCH_DATA="${{ needs.phase1-foundation.outputs.research_data }}"
          echo "[$(date)] Phase 2: Content creation started" >> "${PROJECT_DIR}/logs/execution.log"
          
          SCRIPT_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽŸç¨¿ãƒ»æ§‹æˆä½œæˆã‚¿ã‚¹ã‚¯ï¼š
          
          å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: ${RESEARCH_DATA}
          ç›®æ¨™: 60ç§’ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”¨ã®æ§‹æˆã¨åŽŸç¨¿ä½œæˆ
          
          ä»¥ä¸‹ã®è¦ä»¶ã§åŽŸç¨¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          1. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®é»„é‡‘æ¯”ï¼šãƒ•ãƒƒã‚¯(20%) â†’ æœ¬ç·¨(60%) â†’ ã¾ã¨ã‚(20%)
          2. æœ€åˆã®3ç§’ã§è¦–è´è€…ã‚’å¼•ãã¤ã‘ã‚‹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚ã‚‹ãƒ•ãƒƒã‚¯
          3. æ˜Žç¢ºã§èžãå–ã‚Šã‚„ã™ã„æ—¥æœ¬èªžãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿
          4. 10-12ã‚·ãƒ¼ãƒ³ã®è¦–è¦šçš„æ§‹æˆï¼ˆå„5-6ç§’ï¼‰
          5. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼é¢¨ã®ãƒˆãƒ¼ãƒ³
          
          å‡ºåŠ›: ${PROJECT_DIR}/metadata/script_data.json
          å½¢å¼:
          {
            \"total_duration\": 60,
            \"structure\": {
              \"hook\": \"æœ€åˆã®3ç§’ã®ãƒ•ãƒƒã‚¯æ–‡\",
              \"main_content\": \"æœ¬ç·¨ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³\",
              \"conclusion\": \"ã¾ã¨ã‚æ–‡\"
            },
            \"narration_script\": \"å®Œå…¨ãªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿\",
            \"visual_scenes\": [
              {\"scene_id\": 1, \"duration\": 6, \"description\": \"ã‚·ãƒ¼ãƒ³èª¬æ˜Ž\", \"image_prompt\": \"ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\"},
              {\"scene_id\": 2, \"duration\": 6, \"description\": \"ã‚·ãƒ¼ãƒ³èª¬æ˜Ž\", \"image_prompt\": \"ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\"}
            ]
          }"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write,Edit" \
            --max-turns 20 \
            --permission-mode "acceptEdits" \
            -p "$SCRIPT_PROMPT"
          
          if [ -f "${PROJECT_DIR}/metadata/script_data.json" ]; then
            echo "script_data=${PROJECT_DIR}/metadata/script_data.json" >> $GITHUB_OUTPUT
            echo "[$(date)] Script creation completed successfully" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 2 Report
            echo "## ðŸ“ Phase 2: Content Creation - è„šæœ¬ãƒ»æ§‹æˆä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹è„šæœ¬ä½œæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
            
            # Extract script summary for report
            if command -v jq > /dev/null; then
              TOTAL_DURATION=$(jq -r '.total_duration // "60"' "${PROJECT_DIR}/metadata/script_data.json" 2>/dev/null)
              SCENE_COUNT=$(jq '.visual_scenes | length' "${PROJECT_DIR}/metadata/script_data.json" 2>/dev/null || echo "0")
              echo "- âœ… å‹•ç”»ç·æ™‚é–“: ${TOTAL_DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… è¦–è¦šã‚·ãƒ¼ãƒ³æ•°: ${SCENE_COUNT}ã‚·ãƒ¼ãƒ³" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] ERROR: Script data not generated" >> "${PROJECT_DIR}/logs/execution.log"
            exit 1
          fi

      - name: Upload Phase 2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  # Phase 3A: Audio Generation (Independent Job)
  phase3-audio-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      audio_file: ${{ steps.audio-task.outputs.audio_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Audio Generation Task
        id: audio-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3: Audio generation started [Fan-out Pattern]" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Check MCP connection time (15-minute safety window)
          # GitHub Actions doesn't provide run_started_at, so we track from job start
          JOB_START_TIME=$(date +%s)
          echo "JOB_START_TIME=$JOB_START_TIME" >> $GITHUB_ENV
          ELAPSED_MINUTES=0  # First job in phase 3, so assume fresh connection
          
          echo "[$(date)] MCP connection check: $ELAPSED_MINUTES minutes elapsed" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Ensure audio directory exists
          mkdir -p "${PROJECT_DIR}/media/audio"
          
          if [ $ELAPSED_MINUTES -lt 12 ]; then
            echo "[$(date)] MCP connection should be active, attempting generation" >> "${PROJECT_DIR}/logs/execution.log"
            
            AUDIO_PROMPT="Generate Japanese news narration: Professional announcer voice, clear pronunciation, -14LUFS level. Input: ${SCRIPT_DATA}. Output: ${PROJECT_DIR}/media/audio/narration.mp3"
            
            # 3-attempt retry logic for Audio generation
            AUDIO_SUCCESS=false
            for attempt in 1 2 3; do
              echo "[$(date)] Audio generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
              
              if npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2s-kamui-minimax-speech__minimax_speech_02_turbo_submit,mcp__t2s-kamui-minimax-speech__minimax_speech_02_turbo_status,mcp__t2s-kamui-minimax-speech__minimax_speech_02_turbo_result,Write,Read" \
                --max-turns 20 \
                --permission-mode "acceptEdits" \
                -p "$AUDIO_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-audio-mcp.log"; then
                
                # Check if audio was actually generated
                AUDIO_CHECK=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" 2>/dev/null | head -1)
                if [ -n "$AUDIO_CHECK" ] && [ -f "$AUDIO_CHECK" ] && [ -s "$AUDIO_CHECK" ]; then
                  echo "[$(date)] Audio SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                  AUDIO_SUCCESS=true
                  break
                else
                  echo "[$(date)] Audio generation completed but no valid file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                fi
              else
                echo "[$(date)] Audio FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
              
              if [ $attempt -lt 3 ]; then
                echo "[$(date)] Retrying Audio in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep 5
              fi
            done
            
            if [ "$AUDIO_SUCCESS" != "true" ]; then
              echo "[$(date)] All 3 attempts failed for Audio, will use fallback generation" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          else
            echo "[$(date)] MCP timeout risk detected, using fallback generation" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Check for generated audio
          AUDIO_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" 2>/dev/null | head -1)
          
          # Fallback: Generate test audio if MCP failed
          if [ -z "$AUDIO_FILE" ] || [ ! -s "$AUDIO_FILE" ]; then
            echo "[$(date)] WARNING: MCP audio generation failed, creating fallback audio" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Install TTS tools
            sudo apt-get update && sudo apt-get install -y espeak-ng ffmpeg
            
            # Extract text from script data
            NARRATION_TEXT=$(echo "$SCRIPT_DATA" | head -20)
            
            # Generate audio using espeak
            espeak-ng -v ja -s 150 -w "${PROJECT_DIR}/media/audio/temp.wav" "$NARRATION_TEXT" 2>/dev/null || \
              espeak-ng -v en -s 150 -w "${PROJECT_DIR}/media/audio/temp.wav" "This is a test narration for the news video"
            
            # Convert to MP3
            ffmpeg -i "${PROJECT_DIR}/media/audio/temp.wav" -c:a libmp3lame -b:a 192k "${PROJECT_DIR}/media/audio/narration.mp3" -y
            rm -f "${PROJECT_DIR}/media/audio/temp.wav"
            
            AUDIO_FILE="${PROJECT_DIR}/media/audio/narration.mp3"
          fi
          
          if [ -f "$AUDIO_FILE" ] && [ -s "$AUDIO_FILE" ]; then
            echo "audio_file=${AUDIO_FILE}" >> $GITHUB_OUTPUT
            AUDIO_SIZE=$(stat -c%s "$AUDIO_FILE" 2>/dev/null || ls -l "$AUDIO_FILE" 2>/dev/null | awk '{print $5}' || echo "0")
            echo "[$(date)] Audio generation completed: ${AUDIO_FILE} (${AUDIO_SIZE} bytes)" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 3A Audio Report
            echo "## ðŸŽ™ï¸ Phase 3A: Audio Generation - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… éŸ³å£°ç”Ÿæˆå®Œäº†: $(basename "$AUDIO_FILE")" >> $GITHUB_STEP_SUMMARY
            AUDIO_SIZE_KB=$((AUDIO_SIZE / 1024))
            echo "- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${AUDIO_SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
            if [ $ELAPSED_MINUTES -lt 12 ]; then
              echo "- âœ… ç”Ÿæˆæ–¹å¼: MCP TTS (é«˜å“è³ª)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ ç”Ÿæˆæ–¹å¼: Fallback TTS (MCP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] ERROR: Failed to generate audio" >> "${PROJECT_DIR}/logs/execution.log"
            echo "audio_file=placeholder" >> $GITHUB_OUTPUT
            # Add error report
            echo "## ðŸŽ™ï¸ Phase 3A: Audio Generation - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ éŸ³å£°ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Audio artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-audio-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Add Phase 3A Audio Generation Report with Direct Links
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Add Phase 3A Audio Report to GitHub Summary
          echo "## ðŸŽµ Phase 3A Audio Generation - å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check generated audio files and create direct links
          AUDIO_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" 2>/dev/null | head -1)
          if [ -n "$AUDIO_FILE" ] && [ -f "$AUDIO_FILE" ]; then
            AUDIO_SIZE=$(ls -lh "$AUDIO_FILE" | awk '{print $5}')
            AUDIO_BASENAME=$(basename "$AUDIO_FILE")
            echo "- âœ… **ç”ŸæˆéŸ³å£°**: [\`${AUDIO_BASENAME}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) (${AUDIO_SIZE})" >> $GITHUB_STEP_SUMMARY
            
            # Duration check if possible
            if command -v ffprobe > /dev/null 2>&1; then
              DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$AUDIO_FILE" 2>/dev/null | cut -d'.' -f1)
              if [ -n "$DURATION" ]; then
                echo "- â±ï¸ **å†ç”Ÿæ™‚é–“**: ${DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "- âŒ **ç”ŸæˆéŸ³å£°**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # MCP Audio URL if available
          AUDIO_URL_FILE="${PROJECT_DIR}/media/audio/narration-url.txt"
          if [ -f "$AUDIO_URL_FILE" ]; then
            AUDIO_URL=$(cat "$AUDIO_URL_FILE")
            echo "- ðŸ”— **ç›´æŽ¥å†ç”ŸURL**: [éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«](${AUDIO_URL})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Generation method
          if [ -f "${PROJECT_DIR}/logs/phase3a-audio-mcp.log" ]; then
            echo "- ðŸ”§ **ç”Ÿæˆæ–¹æ³•**: MCP (MiniMax Speech-02-Turbo)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ”§ **ç”Ÿæˆæ–¹æ³•**: Fallback (espeak-ng)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 3B: Individual Image Generation Jobs (1-5)
  phase3-image1-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      image1_path: ${{ steps.image1-task.outputs.image1_path }}
      image1_url: ${{ steps.image1-task.outputs.image1_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Image 1 Generation Task
        id: image1-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3B1: Image 1 generation started [Data Parallelism 1/5]" >> "${PROJECT_DIR}/logs/execution.log"
          mkdir -p "${PROJECT_DIR}/media/images/individual"
          
          IMAGE1_PROMPT="Generate scene 1 news image: Professional news style, 16:9, 1920x1080, blue/red colors, rule of thirds. Save Google URL to ${PROJECT_DIR}/media/images/image1-url.txt and download image to ${PROJECT_DIR}/media/images/scene1.png"
          
          # 3-attempt retry logic for Image 1 generation
          IMAGE1_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Image 1 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,Write,Read" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$IMAGE1_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-image1-mcp.log"; then
              
              # Check if image was actually generated
              IMAGE1_CHECK=$(find "${PROJECT_DIR}/media/images" -name "*scene1*" -o -name "*1.*" 2>/dev/null | grep -v "url.txt" | head -1)
              if [ -n "$IMAGE1_CHECK" ] && [ -f "$IMAGE1_CHECK" ]; then
                echo "[$(date)] Image 1 SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                IMAGE1_SUCCESS=true
                break
              else
                echo "[$(date)] Image 1 generation completed but no file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Image 1 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Image 1 in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$IMAGE1_SUCCESS" != "true" ]; then
            echo "[$(date)] All 3 attempts failed for Image 1, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Attempt explicit download if URL exists but file missing
          if [ -f "${PROJECT_DIR}/media/images/image1-url.txt" ]; then
            IMAGE1_URL=$(cat "${PROJECT_DIR}/media/images/image1-url.txt")
            if [ ! -f "${PROJECT_DIR}/media/images/scene1.png" ] || [ ! -s "${PROJECT_DIR}/media/images/scene1.png" ]; then
              if curl -IfsS --max-time 20 "$IMAGE1_URL" | grep -Ei '^content-type:.*(png|jpeg|jpg|octet-stream)' >/dev/null || [[ "$IMAGE1_URL" == *.png* || "$IMAGE1_URL" == *.jpg* || "$IMAGE1_URL" == *.jpeg* ]]; then
                timeout 30 curl -L -fSs --retry 3 --retry-delay 2 "$IMAGE1_URL" -o "${PROJECT_DIR}/media/images/scene1.png" || true
              fi
            fi
          fi

          # Check for generated image and URL
          IMAGE1_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene1*" -o -name "*1.*" 2>/dev/null | grep -v "url.txt" | head -1)
          IMAGE1_URL_FILE="${PROJECT_DIR}/media/images/image1-url.txt"
          
          if [ -n "$IMAGE1_FILE" ] && [ -f "$IMAGE1_FILE" ]; then
            echo "image1_path=${IMAGE1_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Image 1 completed: ${IMAGE1_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check for Google URL
            if [ -f "$IMAGE1_URL_FILE" ]; then
              IMAGE1_URL=$(cat "$IMAGE1_URL_FILE")
              echo "image1_url=${IMAGE1_URL}" >> $GITHUB_OUTPUT
              echo "[$(date)] Image 1 Google URL saved: ${IMAGE1_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] WARNING: Image 1 Google URL not found" >> "${PROJECT_DIR}/logs/execution.log"
              echo "image1_url=" >> $GITHUB_OUTPUT
            fi
            
            # Add Phase 3B1 Image Report
            echo "## ðŸ–¼ï¸ Phase 3B1: Image Generation - ã‚·ãƒ¼ãƒ³1ç”»åƒä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç”»åƒç”Ÿæˆå®Œäº†: $(basename "$IMAGE1_FILE")" >> $GITHUB_STEP_SUMMARY
            IMAGE1_SIZE=$(stat -c%s "$IMAGE1_FILE" 2>/dev/null || echo "0")
            IMAGE1_SIZE_KB=$((IMAGE1_SIZE / 1024))
            echo "- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${IMAGE1_SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç”Ÿæˆæ–¹å¼: Google Imagen3 (é«˜å“è³ª)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] WARNING: Image 1 not generated, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
            echo "image1_path=placeholder" >> $GITHUB_OUTPUT
            echo "image1_url=" >> $GITHUB_OUTPUT
            # Add error report
            echo "## ðŸ–¼ï¸ Phase 3B1: Image Generation - ã‚·ãƒ¼ãƒ³1ç”»åƒä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ç”»åƒç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Image 1 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-image1-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  phase3-image2-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      image2_path: ${{ steps.image2-task.outputs.image2_path }}
      image2_url: ${{ steps.image2-task.outputs.image2_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Image 2 Generation Task
        id: image2-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3B2: Image 2 generation started [Data Parallelism 2/5]" >> "${PROJECT_DIR}/logs/execution.log"
          mkdir -p "${PROJECT_DIR}/media/images/individual"
          
          IMAGE2_PROMPT="Generate scene 2 news image: Professional news style, 16:9, 1920x1080, blue/red colors, rule of thirds. Save Google URL to ${PROJECT_DIR}/media/images/image2-url.txt and download image to ${PROJECT_DIR}/media/images/scene2.png"
          
          # 3-attempt retry logic for Image 2 generation
          IMAGE2_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Image 2 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,Write,Read" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$IMAGE2_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-image2-mcp.log"; then
              
              # Check if image was actually generated
              IMAGE2_CHECK=$(find "${PROJECT_DIR}/media/images" -name "*scene2*" -o -name "*2.*" 2>/dev/null | grep -v "url.txt" | head -1)
              if [ -n "$IMAGE2_CHECK" ] && [ -f "$IMAGE2_CHECK" ]; then
                echo "[$(date)] Image 2 SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                IMAGE2_SUCCESS=true
                break
              else
                echo "[$(date)] Image 2 generation completed but no file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Image 2 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Image 2 in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$IMAGE2_SUCCESS" != "true" ]; then
            echo "[$(date)] All 3 attempts failed for Image 2, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Attempt explicit download if URL exists but file missing
          if [ -f "${PROJECT_DIR}/media/images/image2-url.txt" ]; then
            IMAGE2_URL=$(cat "${PROJECT_DIR}/media/images/image2-url.txt")
            if [ ! -f "${PROJECT_DIR}/media/images/scene2.png" ] || [ ! -s "${PROJECT_DIR}/media/images/scene2.png" ]; then
              if curl -IfsS --max-time 20 "$IMAGE2_URL" | grep -Ei '^content-type:.*(png|jpeg|jpg|octet-stream)' >/dev/null || [[ "$IMAGE2_URL" == *.png* || "$IMAGE2_URL" == *.jpg* || "$IMAGE2_URL" == *.jpeg* ]]; then
                timeout 30 curl -L -fSs --retry 3 --retry-delay 2 "$IMAGE2_URL" -o "${PROJECT_DIR}/media/images/scene2.png" || true
              fi
            fi
          fi

          # Check for generated image and URL
          IMAGE2_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene2*" -o -name "*2.*" 2>/dev/null | grep -v "url.txt" | head -1)
          IMAGE2_URL_FILE="${PROJECT_DIR}/media/images/image2-url.txt"
          
          if [ -n "$IMAGE2_FILE" ] && [ -f "$IMAGE2_FILE" ]; then
            echo "image2_path=${IMAGE2_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Image 2 completed: ${IMAGE2_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check for Google URL
            if [ -f "$IMAGE2_URL_FILE" ]; then
              IMAGE2_URL=$(cat "$IMAGE2_URL_FILE")
              echo "image2_url=${IMAGE2_URL}" >> $GITHUB_OUTPUT
              echo "[$(date)] Image 2 Google URL saved: ${IMAGE2_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] WARNING: Image 2 Google URL not found" >> "${PROJECT_DIR}/logs/execution.log"
              echo "image2_url=" >> $GITHUB_OUTPUT
            fi
            
            # Add Phase 3B2 Image Report
            echo "## ðŸ–¼ï¸ Phase 3B2: Image Generation - ã‚·ãƒ¼ãƒ³2ç”»åƒä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç”»åƒç”Ÿæˆå®Œäº†: $(basename "$IMAGE2_FILE")" >> $GITHUB_STEP_SUMMARY
            IMAGE2_SIZE=$(stat -c%s "$IMAGE2_FILE" 2>/dev/null || echo "0")
            IMAGE2_SIZE_KB=$((IMAGE2_SIZE / 1024))
            echo "- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${IMAGE2_SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç”Ÿæˆæ–¹å¼: Google Imagen3 (é«˜å“è³ª)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] WARNING: Image 2 not generated, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
            echo "image2_path=placeholder" >> $GITHUB_OUTPUT
            echo "image2_url=" >> $GITHUB_OUTPUT
            # Add error report
            echo "## ðŸ–¼ï¸ Phase 3B2: Image Generation - ã‚·ãƒ¼ãƒ³2ç”»åƒä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ç”»åƒç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Image 2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-image2-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  phase3-image3-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      image3_path: ${{ steps.image3-task.outputs.image3_path }}
      image3_url: ${{ steps.image3-task.outputs.image3_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Image 3 Generation Task
        id: image3-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3B3: Image 3 generation started [Data Parallelism 3/5]" >> "${PROJECT_DIR}/logs/execution.log"
          mkdir -p "${PROJECT_DIR}/media/images"
          
          IMAGE3_PROMPT="Generate scene 3 news image: Professional news style, 16:9, 1920x1080, blue/red colors, rule of thirds. Save Google URL to ${PROJECT_DIR}/media/images/image3-url.txt and download image to ${PROJECT_DIR}/media/images/scene3.png"
          
          # 3-attempt retry logic for Image 3 generation
          IMAGE3_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Image 3 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,Write,Read" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$IMAGE3_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-image3-mcp.log"; then
              
              # Check if image was actually generated
              IMAGE3_CHECK=$(find "${PROJECT_DIR}/media/images" -name "*scene3*" -o -name "*3.*" | grep -v "url.txt" | head -1)
              if [ -n "$IMAGE3_CHECK" ] && [ -f "$IMAGE3_CHECK" ]; then
                echo "[$(date)] Image 3 SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                IMAGE3_SUCCESS=true
                break
              else
                echo "[$(date)] Image 3 generation completed but no file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Image 3 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Image 3 in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$IMAGE3_SUCCESS" != "true" ]; then
            echo "[$(date)] All 3 attempts failed for Image 3, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Attempt explicit download if URL exists but file missing
          if [ -f "${PROJECT_DIR}/media/images/image3-url.txt" ]; then
            IMAGE3_URL=$(cat "${PROJECT_DIR}/media/images/image3-url.txt")
            if [ ! -f "${PROJECT_DIR}/media/images/scene3.png" ] || [ ! -s "${PROJECT_DIR}/media/images/scene3.png" ]; then
              if curl -IfsS --max-time 20 "$IMAGE3_URL" | grep -Ei '^content-type:.*(png|jpeg|jpg|octet-stream)' >/dev/null || [[ "$IMAGE3_URL" == *.png* || "$IMAGE3_URL" == *.jpg* || "$IMAGE3_URL" == *.jpeg* ]]; then
                timeout 30 curl -L -fSs --retry 3 --retry-delay 2 "$IMAGE3_URL" -o "${PROJECT_DIR}/media/images/scene3.png" || true
              fi
            fi
          fi

          # Check for generated image and URL
          IMAGE3_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene3*" -o -name "*3.*" | grep -v "url.txt" | head -1)
          IMAGE3_URL_FILE="${PROJECT_DIR}/media/images/image3-url.txt"
          
          if [ -n "$IMAGE3_FILE" ] && [ -f "$IMAGE3_FILE" ]; then
            echo "image3_path=${IMAGE3_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Image 3 completed: ${IMAGE3_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check for Google URL
            if [ -f "$IMAGE3_URL_FILE" ]; then
              IMAGE3_URL=$(cat "$IMAGE3_URL_FILE")
              echo "image3_url=${IMAGE3_URL}" >> $GITHUB_OUTPUT
              echo "[$(date)] Image 3 Google URL saved: ${IMAGE3_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] WARNING: Image 3 Google URL not found" >> "${PROJECT_DIR}/logs/execution.log"
              echo "image3_url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "[$(date)] WARNING: Image 3 not generated, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
            echo "image3_path=placeholder" >> $GITHUB_OUTPUT
            echo "image3_url=" >> $GITHUB_OUTPUT
          fi

      - name: Upload Image 3 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-image3-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  phase3-image4-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      image4_path: ${{ steps.image4-task.outputs.image4_path }}
      image4_url: ${{ steps.image4-task.outputs.image4_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Image 4 Generation Task
        id: image4-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3B4: Image 4 generation started [Data Parallelism 4/5]" >> "${PROJECT_DIR}/logs/execution.log"
          mkdir -p "${PROJECT_DIR}/media/images/individual"
          
          IMAGE4_PROMPT="Generate scene 4 news image: Professional news style, 16:9, 1920x1080, blue/red colors, rule of thirds. Save Google URL to ${PROJECT_DIR}/media/images/image4-url.txt and download image to ${PROJECT_DIR}/media/images/scene4.png"
          
          # 3-attempt retry logic for Image 4 generation
          IMAGE4_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Image 4 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,Write,Read" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$IMAGE4_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-image4-mcp.log"; then
              
              # Check if image was actually generated
              IMAGE4_CHECK=$(find "${PROJECT_DIR}/media/images" -name "*scene4*" -o -name "*4.*" 2>/dev/null | grep -v "url.txt" | head -1)
              if [ -n "$IMAGE4_CHECK" ] && [ -f "$IMAGE4_CHECK" ]; then
                echo "[$(date)] Image 4 SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                IMAGE4_SUCCESS=true
                break
              else
                echo "[$(date)] Image 4 generation completed but no file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Image 4 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Image 4 in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$IMAGE4_SUCCESS" != "true" ]; then
            echo "[$(date)] All 3 attempts failed for Image 4, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Attempt explicit download if URL exists but file missing
          if [ -f "${PROJECT_DIR}/media/images/image4-url.txt" ]; then
            IMAGE4_URL=$(cat "${PROJECT_DIR}/media/images/image4-url.txt")
            if [ ! -f "${PROJECT_DIR}/media/images/scene4.png" ] || [ ! -s "${PROJECT_DIR}/media/images/scene4.png" ]; then
              if curl -IfsS --max-time 20 "$IMAGE4_URL" | grep -Ei '^content-type:.*(png|jpeg|jpg|octet-stream)' >/dev/null || [[ "$IMAGE4_URL" == *.png* || "$IMAGE4_URL" == *.jpg* || "$IMAGE4_URL" == *.jpeg* ]]; then
                timeout 30 curl -L -fSs --retry 3 --retry-delay 2 "$IMAGE4_URL" -o "${PROJECT_DIR}/media/images/scene4.png" || true
              fi
            fi
          fi

          # Check for generated image and URL
          IMAGE4_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene4*" -o -name "*4.*" 2>/dev/null | grep -v "url.txt" | head -1)
          IMAGE4_URL_FILE="${PROJECT_DIR}/media/images/image4-url.txt"
          
          if [ -n "$IMAGE4_FILE" ] && [ -f "$IMAGE4_FILE" ]; then
            echo "image4_path=${IMAGE4_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Image 4 completed: ${IMAGE4_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check for Google URL
            if [ -f "$IMAGE4_URL_FILE" ]; then
              IMAGE4_URL=$(cat "$IMAGE4_URL_FILE")
              echo "image4_url=${IMAGE4_URL}" >> $GITHUB_OUTPUT
              echo "[$(date)] Image 4 Google URL saved: ${IMAGE4_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] WARNING: Image 4 Google URL not found" >> "${PROJECT_DIR}/logs/execution.log"
              echo "image4_url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "[$(date)] WARNING: Image 4 not generated, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
            echo "image4_path=placeholder" >> $GITHUB_OUTPUT
            echo "image4_url=" >> $GITHUB_OUTPUT
          fi

      - name: Upload Image 4 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-image4-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  phase3-image5-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      image5_path: ${{ steps.image5-task.outputs.image5_path }}
      image5_url: ${{ steps.image5-task.outputs.image5_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Image 5 Generation Task
        id: image5-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 3B5: Image 5 generation started [Data Parallelism 5/5]" >> "${PROJECT_DIR}/logs/execution.log"
          mkdir -p "${PROJECT_DIR}/media/images/individual"
          
          IMAGE5_PROMPT="Generate scene 5 news image: Professional news style, 16:9, 1920x1080, blue/red colors, rule of thirds. Save Google URL to ${PROJECT_DIR}/media/images/image5-url.txt and download image to ${PROJECT_DIR}/media/images/scene5.png"
          
          # 3-attempt retry logic for Image 5 generation
          IMAGE5_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Image 5 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,Write,Read" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$IMAGE5_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-image5-mcp.log"; then
              
              # Check if image was actually generated
              IMAGE5_CHECK=$(find "${PROJECT_DIR}/media/images" -name "*scene5*" -o -name "*5.*" 2>/dev/null | grep -v "url.txt" | head -1)
              if [ -n "$IMAGE5_CHECK" ] && [ -f "$IMAGE5_CHECK" ]; then
                echo "[$(date)] Image 5 SUCCESS on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                IMAGE5_SUCCESS=true
                break
              else
                echo "[$(date)] Image 5 generation completed but no file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Image 5 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Image 5 in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$IMAGE5_SUCCESS" != "true" ]; then
            echo "[$(date)] All 3 attempts failed for Image 5, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Attempt explicit download if URL exists but file missing
          if [ -f "${PROJECT_DIR}/media/images/image5-url.txt" ]; then
            IMAGE5_URL=$(cat "${PROJECT_DIR}/media/images/image5-url.txt")
            if [ ! -f "${PROJECT_DIR}/media/images/scene5.png" ] || [ ! -s "${PROJECT_DIR}/media/images/scene5.png" ]; then
              if curl -IfsS --max-time 20 "$IMAGE5_URL" | grep -Ei '^content-type:.*(png|jpeg|jpg|octet-stream)' >/dev/null || [[ "$IMAGE5_URL" == *.png* || "$IMAGE5_URL" == *.jpg* || "$IMAGE5_URL" == *.jpeg* ]]; then
                timeout 30 curl -L -fSs --retry 3 --retry-delay 2 "$IMAGE5_URL" -o "${PROJECT_DIR}/media/images/scene5.png" || true
              fi
            fi
          fi

          # Check for generated image and URL
          IMAGE5_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene5*" -o -name "*5.*" 2>/dev/null | grep -v "url.txt" | head -1)
          IMAGE5_URL_FILE="${PROJECT_DIR}/media/images/image5-url.txt"
          
          if [ -n "$IMAGE5_FILE" ] && [ -f "$IMAGE5_FILE" ]; then
            echo "image5_path=${IMAGE5_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Image 5 completed: ${IMAGE5_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check for Google URL
            if [ -f "$IMAGE5_URL_FILE" ]; then
              IMAGE5_URL=$(cat "$IMAGE5_URL_FILE")
              echo "image5_url=${IMAGE5_URL}" >> $GITHUB_OUTPUT
              echo "[$(date)] Image 5 Google URL saved: ${IMAGE5_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] WARNING: Image 5 Google URL not found" >> "${PROJECT_DIR}/logs/execution.log"
              echo "image5_url=" >> $GITHUB_OUTPUT
            fi
          else
            echo "[$(date)] WARNING: Image 5 not generated, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
            echo "image5_path=placeholder" >> $GITHUB_OUTPUT
            echo "image5_url=" >> $GITHUB_OUTPUT
          fi

      - name: Upload Image 5 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-image5-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Add Phase 3 Image 5 Report with Direct Links
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Add Phase 3 Image 5 Report to GitHub Summary
          echo "## ðŸ–¼ï¸ Phase 3 Image 5 Generation - å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check generated files and create direct links
          IMAGE5_FILE=$(find "${PROJECT_DIR}/media/images" -name "*scene5*" -o -name "*5.*" 2>/dev/null | grep -v "url.txt" | head -1)
          if [ -n "$IMAGE5_FILE" ] && [ -f "$IMAGE5_FILE" ]; then
            IMAGE5_SIZE=$(ls -lh "$IMAGE5_FILE" | awk '{print $5}')
            IMAGE5_BASENAME=$(basename "$IMAGE5_FILE")
            echo "- âœ… **ç”Ÿæˆç”»åƒ**: [\`${IMAGE5_BASENAME}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) (${IMAGE5_SIZE})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **ç”Ÿæˆç”»åƒ**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Google Cloud URL link
          IMAGE5_URL_FILE="${PROJECT_DIR}/media/images/image5-url.txt"
          if [ -f "$IMAGE5_URL_FILE" ]; then
            IMAGE5_URL=$(cat "$IMAGE5_URL_FILE")
            echo "- ðŸ”— **Google Cloud URL**: [ç›´æŽ¥ã‚¢ã‚¯ã‚»ã‚¹](${IMAGE5_URL})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Google Cloud URL**: å–å¾—å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Metadata files
          if [ -f "${PROJECT_DIR}/metadata" ]; then
            METADATA_COUNT=$(find "${PROJECT_DIR}/metadata" -name "*.json" 2>/dev/null | wc -l)
            echo "- ðŸ“Š **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«**: ${METADATA_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã§ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Log files
          if [ -f "${PROJECT_DIR}/logs" ]; then
            LOG_COUNT=$(find "${PROJECT_DIR}/logs" -name "*.log" 2>/dev/null | wc -l)
            echo "- ðŸ“ **å®Ÿè¡Œãƒ­ã‚°**: ${LOG_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã§ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 3C: BGM Generation (Independent Job) - Relocated from Phase 5
  phase3-bgm-generation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation]
    outputs:
      bgm_file: ${{ steps.bgm.outputs.bgm_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: BGM Generation Task
        id: bgm
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          echo "[$(date)] Phase 3C: BGM generation started [Independent Task Parallelization]" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Check MCP connection time
          # Use job start time from first phase3 job
          JOB_START_TIME=${JOB_START_TIME:-$(date +%s)}
          CURRENT_TIME=$(date +%s)
          ELAPSED_MINUTES=$(( (CURRENT_TIME - JOB_START_TIME) / 60 ))
          
          # Ensure audio directory exists
          mkdir -p "${PROJECT_DIR}/media/audio"
          
          if [ $ELAPSED_MINUTES -lt 12 ]; then
            echo "[$(date)] MCP connection active, attempting BGM generation with retry" >> "${PROJECT_DIR}/logs/execution.log"
            
            BGM_PROMPT="Generate professional news BGM: 60s instrumental, subtle, trust/urgency balance, -25dB below narration. Output: ${PROJECT_DIR}/media/audio/bgm.mp3"
            
            # 3å›žãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
            for attempt in 1 2 3; do
              echo "[$(date)] BGM generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
              
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2m-kamui-lyria__lyria_generate,Write,Read" \
                --max-turns 20 \
                --permission-mode "acceptEdits" \
                -p "$BGM_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase3-bgm-mcp-attempt$attempt.log"
              
              # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆç¢ºèª
              BGM_CHECK=$(find "${PROJECT_DIR}/media/audio" -name "*bgm*" -o -name "*background*" 2>/dev/null | head -1)
              if [ -n "$BGM_CHECK" ] && [ -s "$BGM_CHECK" ]; then
                echo "[$(date)] BGM generation successful on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                break
              else
                echo "[$(date)] BGM generation failed on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                if [ $attempt -lt 3 ]; then
                  sleep 10
                fi
              fi
            done
          else
            echo "[$(date)] MCP timeout risk, skipping MCP attempts" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Check for generated BGM
          BGM_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*bgm*" -o -name "*background*" 2>/dev/null | head -1)
          
          # Fallbackç„¡ã—æ–¹é‡ï¼ˆã“ã®æ®µéšŽã§ã¯ffmpegéžä½¿ç”¨ï¼‰ã€‚
          # MCPã§å–å¾—ã§ããªã„å ´åˆã¯BGMãªã—ã§é€²ã‚ã€Phase 8ã§å®‰å…¨ã«ãƒŸãƒƒã‚¯ã‚¹ã™ã‚‹ã€‚
          
          if [ -f "$BGM_FILE" ] && [ -s "$BGM_FILE" ]; then
            echo "bgm_file=${BGM_FILE}" >> $GITHUB_OUTPUT
            FILE_SIZE=$(stat -c%s "$BGM_FILE" 2>/dev/null || ls -l "$BGM_FILE" 2>/dev/null | awk '{print $5}' || echo "unknown")
            echo "[$(date)] BGM generation completed: ${BGM_FILE} (${FILE_SIZE} bytes)" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "[$(date)] WARNING: BGM generation failed completely" >> "${PROJECT_DIR}/logs/execution.log"
            echo "bgm_file=none" >> $GITHUB_OUTPUT
          fi

      - name: Upload BGM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-bgm-generation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Add Phase 3C BGM Generation Report with Direct Links
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Add Phase 3C BGM Report to GitHub Summary
          echo "## ðŸŽ¼ Phase 3C BGM Generation - å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check generated BGM files and create direct links
          BGM_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*bgm*" -o -name "*background*" 2>/dev/null | head -1)
          if [ -n "$BGM_FILE" ] && [ -f "$BGM_FILE" ]; then
            BGM_SIZE=$(ls -lh "$BGM_FILE" | awk '{print $5}')
            BGM_BASENAME=$(basename "$BGM_FILE")
            echo "- âœ… **ç”ŸæˆBGM**: [\`${BGM_BASENAME}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) (${BGM_SIZE})" >> $GITHUB_STEP_SUMMARY
            
            # Duration check if possible
            if command -v ffprobe > /dev/null 2>&1; then
              BGM_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$BGM_FILE" 2>/dev/null | cut -d'.' -f1)
              if [ -n "$BGM_DURATION" ]; then
                echo "- â±ï¸ **BGMå†ç”Ÿæ™‚é–“**: ${BGM_DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "- âŒ **ç”ŸæˆBGM**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # MCP BGM URL if available
          BGM_URL_FILE="${PROJECT_DIR}/media/audio/bgm-url.txt"
          if [ -f "$BGM_URL_FILE" ]; then
            BGM_URL=$(cat "$BGM_URL_FILE")
            echo "- ðŸ”— **ç›´æŽ¥å†ç”ŸURL**: [BGMãƒ•ã‚¡ã‚¤ãƒ«](${BGM_URL})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Generation method
          if [ -f "${PROJECT_DIR}/logs/phase3c-bgm-mcp.log" ]; then
            echo "- ðŸ”§ **ç”Ÿæˆæ–¹æ³•**: MCP (Google Lyria)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ”§ **ç”Ÿæˆæ–¹æ³•**: Fallback (FFmpegç”Ÿæˆ)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 4: Individual Imageâ†’Video Conversion Jobs (1-5)
  phase4-image1-to-video1:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-image1-generation]
    outputs:
      video1_path: ${{ steps.video1-task.outputs.video1_path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download specific required artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Image 1 to Video 1 Conversion Task
        id: video1-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          IMAGE1_PATH="${{ needs.phase3-image1-generation.outputs.image1_path }}"
          IMAGE1_URL="${{ needs.phase3-image1-generation.outputs.image1_url }}"
          # Fallback: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
          if [ -z "$IMAGE1_URL" ] || [ "$IMAGE1_URL" = "" ]; then
            URL_FILE="${PROJECT_DIR}/media/images/image1-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE1_URL=$(cat "$URL_FILE")
              echo "[$(date)] Filled IMAGE1_URL from file: ${IMAGE1_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          fi
          
          # Create directories first!
          mkdir -p "${PROJECT_DIR}/logs"
          mkdir -p "${PROJECT_DIR}/media/videos/individual"
          
          echo "[$(date)] Phase 4.1: Image 1 â†’ Video 1 conversion started [Pipeline Processing]" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Image 1 URL: ${IMAGE1_URL}" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Image 1 Path: ${IMAGE1_PATH}" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Check MCP connection time
          # Use job start time from first phase3 job
          JOB_START_TIME=${JOB_START_TIME:-$(date +%s)}
          CURRENT_TIME=$(date +%s)
          ELAPSED_MINUTES=$(( (CURRENT_TIME - JOB_START_TIME) / 60 ))
          
          echo "[$(date)] MCP connection check: $ELAPSED_MINUTES minutes elapsed" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Prepare clear i2v instruction with Google URL if available
          if [ -n "$IMAGE1_URL" ] && [ "$IMAGE1_URL" != "" ]; then
            echo "[$(date)] Using Google URL for video generation" >> "${PROJECT_DIR}/logs/execution.log"
            VIDEO1_PROMPT="Convert image to video using i2v-kamui-hailuo-02-pro. Parameters: image_url='${IMAGE1_URL}', prompt='Professional news segment with subtle motion'. Save video URL to ${PROJECT_DIR}/media/videos/individual/video1-url.txt and download to ${PROJECT_DIR}/media/videos/individual/scene1_video.mp4"
          else
            echo "[$(date)] WARNING: No Google URL available, using local path" >> "${PROJECT_DIR}/logs/execution.log"
            VIDEO1_PROMPT="IMPORTANT: Image-to-Video task. Read the image file at ${IMAGE1_PATH} and use mcp__i2v-kamui-hailuo-02-pro to convert it to an 8-second video. The image_url parameter should be ${IMAGE1_PATH}. Use prompt 'Professional news segment with subtle motion'. Save output to ${PROJECT_DIR}/media/videos/individual/scene1_video.mp4"
          fi
          
          # Try MCP generation if within time window
          VIDEO_GENERATED=false
          if [ $ELAPSED_MINUTES -lt 12 ]; then
            echo "[$(date)] MCP connection should be active, attempting video generation" >> "${PROJECT_DIR}/logs/execution.log"
            
            # 3-attempt retry logic for Video 1 generation
            MAX_TURNS=${CLAUDE_CODE_MAX_TURNS:-120}
            for attempt in 1 2 3; do
              echo "[$(date)] Video 1 MCP generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
              
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,Write,Read,Bash" \
                --max-turns "$MAX_TURNS" \
                --permission-mode "acceptEdits" \
                -p "$VIDEO1_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase4-video1-mcp.log"

              # max-turnsã«é”ã—ãŸå ´åˆã¯æ¬¡ã®è©¦è¡Œã§å¼•ä¸Šã’
              if grep -q "Reached max turns" "${PROJECT_DIR}/logs/phase4-video1-mcp.log"; then
                echo "[$(date)] Max turns reached for Video 1. Increasing for next attempt" >> "${PROJECT_DIR}/logs/execution.log"
                MAX_TURNS=${CLAUDE_CODE_MAX_TURNS_RETRY:-160}
              fi
              
              # ç”Ÿæˆå¾Œã«ç›´æŽ¥URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚è©¦è¡Œï¼ˆMCPãŒURLã®ã¿ä¿å­˜ã™ã‚‹ã‚±ãƒ¼ã‚¹ï¼‰
              VIDEO1_URL_FILE="${PROJECT_DIR}/media/videos/individual/video1-url.txt"
              if [ -f "$VIDEO1_URL_FILE" ]; then
                VIDEO1_URL=$(cat "$VIDEO1_URL_FILE")
              if curl -IfsS --max-time 20 "$VIDEO1_URL" | grep -Ei '^content-type:.*(mp4|octet-stream)' >/dev/null || [[ "$VIDEO1_URL" == *.mp4* ]]; then
                  mkdir -p "${PROJECT_DIR}/media/videos/individual"
                  curl -fsS "$VIDEO1_URL" -o "${PROJECT_DIR}/media/videos/individual/scene1_video.mp4" || true
                fi
              fi
              # ç¢ºå®ŸãªMP4ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸåˆ¤å®šï¼ˆURL txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
              VIDEO1_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -type f \( -name "*scene1*.mp4" -o -name "*video1*.mp4" \) 2>/dev/null | head -1)
              if [ -n "$VIDEO1_FILE" ] && [ -f "$VIDEO1_FILE" ] && [ $(stat -c%s "$VIDEO1_FILE" 2>/dev/null || echo 0) -gt 300000 ]; then
                echo "[$(date)] Video 1 MCP SUCCESS on attempt $attempt: $(ls -lh "$VIDEO1_FILE")" >> "${PROJECT_DIR}/logs/execution.log"
                VIDEO_GENERATED=true
                break
              else
                echo "[$(date)] Video 1 MCP FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
                if [ $attempt -lt 3 ]; then
                  sleep 10
                fi
              fi
            done
          else
            echo "[$(date)] MCP timeout risk detected, skipping MCP generation" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          
          # Fallback: Generate test video if MCP failed
          if [ "$VIDEO_GENERATED" = false ]; then
            echo "[$(date)] Creating fallback video for Video 1" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Check if input image exists
            if [ -f "$IMAGE1_PATH" ] && [ -s "$IMAGE1_PATH" ]; then
              # Convert image to video with zoom effect
              ffmpeg -loop 1 -i "$IMAGE1_PATH" -c:v libx264 -t 8 -pix_fmt yuv420p \
                -vf "scale=1920:1080,zoompan=z='min(zoom+0.0015,1.5)':x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)':d=240" \
                "${PROJECT_DIR}/media/videos/individual/scene1_video.mp4" -y
            else
              # Generate test pattern video
              ffmpeg -f lavfi -i testsrc=duration=8:size=1920x1080:rate=30 \
                -vf "drawtext=text='Scene 1':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2" \
                -c:v libx264 -pix_fmt yuv420p \
                "${PROJECT_DIR}/media/videos/individual/scene1_video.mp4" -y
            fi
            
            VIDEO1_FILE="${PROJECT_DIR}/media/videos/individual/scene1_video.mp4"
          fi
          
          # Final output
          if [ -f "$VIDEO1_FILE" ] && [ -s "$VIDEO1_FILE" ]; then
            echo "video1_path=${VIDEO1_FILE}" >> $GITHUB_OUTPUT
            VIDEO1_SIZE=$(stat -c%s "$VIDEO1_FILE" 2>/dev/null || ls -l "$VIDEO1_FILE" 2>/dev/null | awk '{print $5}' || echo "0")
            echo "[$(date)] Video 1 completed: ${VIDEO1_FILE} (${VIDEO1_SIZE} bytes)" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date)] ERROR: Failed to generate Video 1" >> "${PROJECT_DIR}/logs/execution.log"
              echo "video1_path=placeholder" >> $GITHUB_OUTPUT
            fi

      - name: Upload Video 1 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-image1-to-video1
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Add Phase 4 Video 1 I2V Report with Direct Links
        if: always()
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Add Phase 4 Video 1 I2V Report to GitHub Summary
          echo "## ðŸŽ¬ Phase 4 Video 1 I2V Generation - å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Finalize Video 1 status
        if: always()
        run: |
          FILE="${{ steps.video1-task.outputs.video1_path }}"
          if [ -z "$FILE" ] || [ "$FILE" = "placeholder" ] || [ ! -f "$FILE" ] || [ $(stat -c%s "$FILE" 2>/dev/null || echo 0) -le 300000 ]; then
            echo "::error title=Video 1 verification failed::File invalid or missing"
            exit 1
          fi
          
          # Check generated video files and create direct linksï¼ˆçµ±ä¸€åˆ¤å®šï¼‰
          VIDEO1_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -name "*scene1*.mp4" -o -name "*video1*.mp4" 2>/dev/null | head -1)
          if [ -n "$VIDEO1_FILE" ] && [ -f "$VIDEO1_FILE" ]; then
            VIDEO1_SIZE=$(ls -lh "$VIDEO1_FILE" | awk '{print $5}')
            VIDEO1_BASENAME=$(basename "$VIDEO1_FILE")
            echo "- âœ… **ç”Ÿæˆå‹•ç”»**: [\`${VIDEO1_BASENAME}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) (${VIDEO1_SIZE})" >> $GITHUB_STEP_SUMMARY
            
            # Duration and resolution check if possible
            if command -v ffprobe > /dev/null 2>&1; then
              VIDEO1_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$VIDEO1_FILE" 2>/dev/null | cut -d'.' -f1)
              VIDEO1_RESOLUTION=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width,height -of csv="p=0" "$VIDEO1_FILE" 2>/dev/null | tr ',' 'x')
              if [ -n "$VIDEO1_DURATION" ]; then
                echo "- â±ï¸ **å‹•ç”»æ™‚é–“**: ${VIDEO1_DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -n "$VIDEO1_RESOLUTION" ]; then
                echo "- ðŸ“ **è§£åƒåº¦**: ${VIDEO1_RESOLUTION}" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "- âŒ **ç”Ÿæˆå‹•ç”»**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # MCP Video URL if available
          VIDEO1_URL_FILE="${PROJECT_DIR}/media/videos/individual/video1-url.txt"
          if [ -f "$VIDEO1_URL_FILE" ]; then
            VIDEO1_URL=$(cat "$VIDEO1_URL_FILE")
            echo "- ðŸ”— **ç›´æŽ¥å†ç”ŸURL**: [å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«](${VIDEO1_URL})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Source image info
          IMAGE1_URL="${{ needs.phase3-image1-generation.outputs.image1_url }}"
          if [ -n "$IMAGE1_URL" ]; then
            if [[ "$IMAGE1_URL" == *"storage.googleapis.com"* ]]; then
              echo "- ðŸ–¼ï¸ **å¤‰æ›å…ƒç”»åƒ**: [Google Cloudç”»åƒ]($IMAGE1_URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ðŸ–¼ï¸ **å¤‰æ›å…ƒç”»åƒ**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Generation method and service
          if [ -f "${PROJECT_DIR}/logs/phase4-video1-mcp.log" ]; then
            echo "- ðŸ”§ **å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹**: MCP (Hailuo-02 Pro I2V)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ”§ **å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹**: Fallbackå‡¦ç†" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

  phase4-image2-to-video2:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-image2-generation]
    outputs:
      video2_path: ${{ steps.video2-task.outputs.video2_path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download specific required artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Image 2 to Video 2 Conversion Task
        id: video2-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          IMAGE2_PATH="${{ needs.phase3-image2-generation.outputs.image2_path }}"
          IMAGE2_URL="${{ needs.phase3-image2-generation.outputs.image2_url }}"
          # Fallback: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
          if [ -z "$IMAGE2_URL" ] || [ "$IMAGE2_URL" = "" ]; then
            URL_FILE="${PROJECT_DIR}/media/images/image2-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE2_URL=$(cat "$URL_FILE")
              echo "[$(date)] Filled IMAGE2_URL from file: ${IMAGE2_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          fi
          
          # Create directories first!
          mkdir -p "${PROJECT_DIR}/logs"
          mkdir -p "${PROJECT_DIR}/media/videos/individual"
          
          echo "[$(date)] Phase 4.2: Image 2 â†’ Video 2 conversion started [Pipeline Processing]" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Image 2 URL: ${IMAGE2_URL}" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Image 2 Path: ${IMAGE2_PATH}" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Prepare clear i2v instruction with Google URL if available
          if [ -n "$IMAGE2_URL" ] && [ "$IMAGE2_URL" != "" ]; then
            echo "[$(date)] Using Google URL for video generation" >> "${PROJECT_DIR}/logs/execution.log"
            VIDEO2_PROMPT="Convert image to video using i2v-kamui-hailuo-02-pro. Parameters: image_url='${IMAGE2_URL}', prompt='Professional news segment with subtle motion'. Save video URL to ${PROJECT_DIR}/media/videos/individual/video2-url.txt and download to ${PROJECT_DIR}/media/videos/individual/scene2_video.mp4"
          else
            echo "[$(date)] WARNING: No Google URL available, using local path" >> "${PROJECT_DIR}/logs/execution.log"
            VIDEO2_PROMPT="Read image at ${IMAGE2_PATH}. Use mcp__i2v-kamui-hailuo-02-pro to create 8s video. Parameters: image_url=${IMAGE2_PATH}, prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene2_video.mp4"
          fi
          
          # 3-attempt retry logic for Video 2 generation
          for attempt in 1 2 3; do
            echo "[$(date)] Video 2 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,Write,Read,Bash" \
              --max-turns "${CLAUDE_CODE_MAX_TURNS:-120}" \
              --permission-mode "acceptEdits" \
              -p "$VIDEO2_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase4-video2-mcp.log" || echo "[$(date)] Claude Code execution failed on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"

            # max-turnsã«é”ã—ãŸå ´åˆã¯æ¬¡ã®è©¦è¡Œã§å¼•ä¸Šã’
            if grep -q "Reached max turns" "${PROJECT_DIR}/logs/phase4-video2-mcp.log"; then
              echo "[$(date)] Max turns reached for Video 2. Will retry with higher cap" >> "${PROJECT_DIR}/logs/execution.log"
              export CLAUDE_CODE_MAX_TURNS=160
            fi
            
            # ç”Ÿæˆå¾Œã«ç›´æŽ¥URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚è©¦è¡Œ
            VIDEO2_URL_FILE="${PROJECT_DIR}/media/videos/individual/video2-url.txt"
            if [ -f "$VIDEO2_URL_FILE" ]; then
              VIDEO2_URL=$(cat "$VIDEO2_URL_FILE")
              if curl -IfsS --max-time 20 "$VIDEO2_URL" | grep -Ei '^content-type:.*(mp4|octet-stream)' >/dev/null || [[ "$VIDEO2_URL" == *.mp4* ]]; then
                mkdir -p "${PROJECT_DIR}/media/videos/individual"
                curl -fsS "$VIDEO2_URL" -o "${PROJECT_DIR}/media/videos/individual/scene2_video.mp4" || true
              fi
            fi
            # ç¢ºå®ŸãªMP4ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸåˆ¤å®šï¼ˆURL txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
            VIDEO2_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -type f \( -name "*scene2*.mp4" -o -name "*video2*.mp4" \) 2>/dev/null | head -1)
            if [ -n "$VIDEO2_FILE" ] && [ -f "$VIDEO2_FILE" ] && [ $(stat -c%s "$VIDEO2_FILE" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "[$(date)] Video 2 SUCCESS on attempt $attempt: $(ls -lh "$VIDEO2_FILE")" >> "${PROJECT_DIR}/logs/execution.log"
              echo "video2_path=${VIDEO2_FILE}" >> $GITHUB_OUTPUT
              break
            else
              echo "[$(date)] Video 2 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              if [ $attempt -eq 3 ]; then
                echo "[$(date)] All 3 attempts failed for Video 2, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
                echo "video2_path=placeholder" >> $GITHUB_OUTPUT
              else
                echo "[$(date)] Retrying Video 2 in 10 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep 10
              fi
            fi
          done

      - name: Upload Video 2 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-image2-to-video2
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Finalize Video 2 status
        if: always()
        run: |
          FILE="${{ steps.video2-task.outputs.video2_path }}"
          if [ -z "$FILE" ] || [ "$FILE" = "placeholder" ] || [ ! -f "$FILE" ] || [ $(stat -c%s "$FILE" 2>/dev/null || echo 0) -le 300000 ]; then
            echo "::error title=Video 2 verification failed::File invalid or missing"
            exit 1
          fi

  phase4-image3-to-video3:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-image3-generation]
    outputs:
      video3_path: ${{ steps.video3-task.outputs.video3_path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download specific required artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Image 3 to Video 3 Conversion Task
        id: video3-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          IMAGE3_PATH="${{ needs.phase3-image3-generation.outputs.image3_path }}"
          IMAGE3_URL="${{ needs.phase3-image3-generation.outputs.image3_url }}"
          # Fallback: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
          if [ -z "$IMAGE3_URL" ] || [ "$IMAGE3_URL" = "" ]; then
            URL_FILE="${PROJECT_DIR}/media/images/image3-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE3_URL=$(cat "$URL_FILE")
              echo "[$(date)] Filled IMAGE3_URL from file: ${IMAGE3_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          fi
          
          # Create directories first!
          mkdir -p "${PROJECT_DIR}/logs"
          mkdir -p "${PROJECT_DIR}/media/videos/individual"
          
          echo "[$(date)] Phase 4.3: Image 3 â†’ Video 3 conversion started [Pipeline Processing]" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Image 3 URL: ${IMAGE3_URL}" >> "${PROJECT_DIR}/logs/execution.log"
          
          if [ -n "$IMAGE3_URL" ] && [ "$IMAGE3_URL" != "" ]; then
            VIDEO3_PROMPT="Convert image to video using i2v-kamui-hailuo-02-pro. Parameters: image_url='${IMAGE3_URL}', prompt='Professional news segment'. Save video URL to ${PROJECT_DIR}/media/videos/individual/video3-url.txt and download to scene3_video.mp4"
          else
            VIDEO3_PROMPT="Read image at ${IMAGE3_PATH}. Use mcp__i2v-kamui-hailuo-02-pro to create 8s video. Parameters: image_url=${IMAGE3_PATH}, prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene3_video.mp4"
          fi
          
          # 3-attempt retry logic for Video 3 generation
          for attempt in 1 2 3; do
            echo "[$(date)] Video 3 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            # æ®µéšŽçš„å¾…æ©Ÿæ™‚é–“ï¼ˆé€£ç¶šç”Ÿæˆè² è·å¯¾ç­–ï¼‰
            if [ $attempt -eq 2 ]; then
              echo "[$(date)] Waiting 30s for MCP recovery (Video 3)..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 30
            elif [ $attempt -eq 3 ]; then
              echo "[$(date)] Waiting 60s for MCP recovery (Video 3)..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 60
            fi
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,Write,Read,Bash" \
              --max-turns "${CLAUDE_CODE_MAX_TURNS:-120}" \
              --permission-mode "acceptEdits" \
              -p "$VIDEO3_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase4-video3-mcp.log" || echo "[$(date)] Claude Code execution failed on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            if grep -q "Reached max turns" "${PROJECT_DIR}/logs/phase4-video3-mcp.log"; then export CLAUDE_CODE_MAX_TURNS=160; fi
            
            # ç”Ÿæˆå¾Œã«ç›´æŽ¥URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚è©¦è¡Œ
            VIDEO3_URL_FILE="${PROJECT_DIR}/media/videos/individual/video3-url.txt"
            if [ -f "$VIDEO3_URL_FILE" ]; then
              VIDEO3_URL=$(cat "$VIDEO3_URL_FILE")
              if curl -IfsS --max-time 20 "$VIDEO3_URL" | grep -Ei '^content-type:.*(mp4|octet-stream)' >/dev/null || [[ "$VIDEO3_URL" == *.mp4* ]]; then
                mkdir -p "${PROJECT_DIR}/media/videos/individual"
                curl -fsS "$VIDEO3_URL" -o "${PROJECT_DIR}/media/videos/individual/scene3_video.mp4" || true
              fi
            fi
            # ç¢ºå®ŸãªMP4ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸåˆ¤å®šï¼ˆURL txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
            VIDEO3_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -type f \( -name "*scene3*.mp4" -o -name "*video3*.mp4" \) 2>/dev/null | head -1)
            if [ -n "$VIDEO3_FILE" ] && [ -f "$VIDEO3_FILE" ] && [ $(stat -c%s "$VIDEO3_FILE" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "[$(date)] Video 3 SUCCESS on attempt $attempt: $(ls -lh "$VIDEO3_FILE")" >> "${PROJECT_DIR}/logs/execution.log"
              echo "video3_path=${VIDEO3_FILE}" >> $GITHUB_OUTPUT
              break
            else
              echo "[$(date)] Video 3 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              if [ $attempt -eq 3 ]; then
                echo "[$(date)] All 3 attempts failed for Video 3, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
                echo "video3_path=placeholder" >> $GITHUB_OUTPUT
              else
                echo "[$(date)] Retrying Video 3 in 10 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep 10
              fi
            fi
          done

      - name: Upload Video 3 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-image3-to-video3
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Finalize Video 3 status
        if: always()
        run: |
          FILE="${{ steps.video3-task.outputs.video3_path }}"
          if [ -z "$FILE" ] || [ "$FILE" = "placeholder" ] || [ ! -f "$FILE" ] || [ $(stat -c%s "$FILE" 2>/dev/null || echo 0) -le 300000 ]; then
            echo "::error title=Video 3 verification failed::File invalid or missing"
            exit 1
          fi

  phase4-image4-to-video4:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-image4-generation]
    outputs:
      video4_path: ${{ steps.video4-task.outputs.video4_path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download specific required artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Image 4 to Video 4 Conversion Task
        id: video4-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          IMAGE4_PATH="${{ needs.phase3-image4-generation.outputs.image4_path }}"
          IMAGE4_URL="${{ needs.phase3-image4-generation.outputs.image4_url }}"
          # Fallback: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
          if [ -z "$IMAGE4_URL" ] || [ "$IMAGE4_URL" = "" ]; then
            URL_FILE="${PROJECT_DIR}/media/images/image4-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE4_URL=$(cat "$URL_FILE")
              echo "[$(date)] Filled IMAGE4_URL from file: ${IMAGE4_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          fi
          # Create directories first!
          mkdir -p "${PROJECT_DIR}/logs"
          mkdir -p "${PROJECT_DIR}/media/videos/individual"
          
          echo "[$(date)] Phase 4.4: Image 4 â†’ Video 4 conversion started [Pipeline Processing]" >> "${PROJECT_DIR}/logs/execution.log"
          
          if [ -n "$IMAGE4_URL" ] && [ "$IMAGE4_URL" != "" ]; then
            VIDEO4_PROMPT="Convert image to video using i2v-kamui-hailuo-02-pro. Parameters: image_url='${IMAGE4_URL}', prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene4_video.mp4"
          else
            VIDEO4_PROMPT="Read image at ${IMAGE4_PATH}. Use mcp__i2v-kamui-hailuo-02-pro to create 8s video. Parameters: image_url=${IMAGE4_PATH}, prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene4_video.mp4"
          fi
          
          # 3-attempt retry logic for Video 4 generation
          for attempt in 1 2 3; do
            echo "[$(date)] Video 4 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,Write,Read,Bash" \
              --max-turns "${CLAUDE_CODE_MAX_TURNS:-120}" \
              --permission-mode "acceptEdits" \
              -p "$VIDEO4_PROMPT" || echo "[$(date)] Claude Code execution failed on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            if grep -q "Reached max turns" "${PROJECT_DIR}/logs/phase4-video4-mcp.log" 2>/dev/null; then export CLAUDE_CODE_MAX_TURNS=160; fi
            
            # ç”Ÿæˆå¾Œã«ç›´æŽ¥URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚è©¦è¡Œ
            VIDEO4_URL_FILE="${PROJECT_DIR}/media/videos/individual/video4-url.txt"
            if [ -f "$VIDEO4_URL_FILE" ]; then
              VIDEO4_URL=$(cat "$VIDEO4_URL_FILE")
              if curl -IfsS --max-time 20 "$VIDEO4_URL" | grep -Ei '^content-type:.*(mp4|octet-stream)' >/dev/null || [[ "$VIDEO4_URL" == *.mp4* ]]; then
                mkdir -p "${PROJECT_DIR}/media/videos/individual"
                curl -fsS "$VIDEO4_URL" -o "${PROJECT_DIR}/media/videos/individual/scene4_video.mp4" || true
              fi
            fi
            # ç¢ºå®ŸãªMP4ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸåˆ¤å®šï¼ˆURL txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
            VIDEO4_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -type f \( -name "*scene4*.mp4" -o -name "*video4*.mp4" \) 2>/dev/null | head -1)
            if [ -n "$VIDEO4_FILE" ] && [ -f "$VIDEO4_FILE" ] && [ $(stat -c%s "$VIDEO4_FILE" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "[$(date)] Video 4 SUCCESS on attempt $attempt: $(ls -lh "$VIDEO4_FILE")" >> "${PROJECT_DIR}/logs/execution.log"
              echo "video4_path=${VIDEO4_FILE}" >> $GITHUB_OUTPUT
              break
            else
              echo "[$(date)] Video 4 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              if [ $attempt -eq 3 ]; then
                echo "[$(date)] All 3 attempts failed for Video 4, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
                echo "video4_path=placeholder" >> $GITHUB_OUTPUT
              else
                echo "[$(date)] Retrying Video 4 in 10 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep 10
              fi
            fi
          done

      - name: Upload Video 4 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-image4-to-video4
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Finalize Video 4 status
        if: always()
        run: |
          FILE="${{ steps.video4-task.outputs.video4_path }}"
          if [ -z "$FILE" ] || [ "$FILE" = "placeholder" ] || [ ! -f "$FILE" ] || [ $(stat -c%s "$FILE" 2>/dev/null || echo 0) -le 300000 ]; then
            echo "::error title=Video 4 verification failed::File invalid or missing"
            exit 1
          fi

  phase4-image5-to-video5:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-image5-generation]
    outputs:
      video5_path: ${{ steps.video5-task.outputs.video5_path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download specific required artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Image 5 to Video 5 Conversion Task
        id: video5-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          IMAGE5_PATH="${{ needs.phase3-image5-generation.outputs.image5_path }}"
          IMAGE5_URL="${{ needs.phase3-image5-generation.outputs.image5_url }}"
          # Fallback: URLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
          if [ -z "$IMAGE5_URL" ] || [ "$IMAGE5_URL" = "" ]; then
            URL_FILE="${PROJECT_DIR}/media/images/image5-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE5_URL=$(cat "$URL_FILE")
              echo "[$(date)] Filled IMAGE5_URL from file: ${IMAGE5_URL}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          fi
          # Create directories first!
          mkdir -p "${PROJECT_DIR}/logs"
          mkdir -p "${PROJECT_DIR}/media/videos/individual"
          
          echo "[$(date)] Phase 4.5: Image 5 â†’ Video 5 conversion started [Pipeline Processing]" >> "${PROJECT_DIR}/logs/execution.log"
          
          if [ -n "$IMAGE5_URL" ] && [ "$IMAGE5_URL" != "" ]; then
            VIDEO5_PROMPT="Convert image to video using i2v-kamui-hailuo-02-pro. Parameters: image_url='${IMAGE5_URL}', prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene5_video.mp4"
          else
            VIDEO5_PROMPT="Read image at ${IMAGE5_PATH}. Use mcp__i2v-kamui-hailuo-02-pro to create 8s video. Parameters: image_url=${IMAGE5_PATH}, prompt='News segment', duration='8s'. Save to ${PROJECT_DIR}/media/videos/individual/scene5_video.mp4"
          fi
          
          # 3-attempt retry logic for Video 5 generation
          for attempt in 1 2 3; do
            echo "[$(date)] Video 5 generation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            # æ®µéšŽçš„å¾…æ©Ÿæ™‚é–“ï¼ˆé€£ç¶šç”Ÿæˆè² è·å¯¾ç­–ï¼‰
            if [ $attempt -eq 2 ]; then
              echo "[$(date)] Waiting 30s for MCP recovery (Video 5)..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 30
            elif [ $attempt -eq 3 ]; then
              echo "[$(date)] Waiting 60s for MCP recovery (Video 5)..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 60
            fi
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,Write,Read,Bash" \
              --max-turns "${CLAUDE_CODE_MAX_TURNS:-120}" \
              --permission-mode "acceptEdits" \
              -p "$VIDEO5_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase4-video5-mcp.log" || echo "[$(date)] Claude Code execution failed on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            if grep -q "Reached max turns" "${PROJECT_DIR}/logs/phase4-video5-mcp.log"; then export CLAUDE_CODE_MAX_TURNS=160; fi
            
            # ç”Ÿæˆå¾Œã«ç›´æŽ¥URLã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚è©¦è¡Œ
            VIDEO5_URL_FILE="${PROJECT_DIR}/media/videos/individual/video5-url.txt"
            if [ -f "$VIDEO5_URL_FILE" ]; then
              VIDEO5_URL=$(cat "$VIDEO5_URL_FILE")
              if curl -IfsS --max-time 20 "$VIDEO5_URL" | grep -Ei '^content-type:.*(mp4|octet-stream)' >/dev/null || [[ "$VIDEO5_URL" == *.mp4* ]]; then
                mkdir -p "${PROJECT_DIR}/media/videos/individual"
                curl -fsS "$VIDEO5_URL" -o "${PROJECT_DIR}/media/videos/individual/scene5_video.mp4" || true
              fi
            fi
            # ç¢ºå®ŸãªMP4ãƒ•ã‚¡ã‚¤ãƒ«æˆåŠŸåˆ¤å®šï¼ˆURL txtãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
            VIDEO5_FILE=$(find "${PROJECT_DIR}/media/videos/individual" -type f \( -name "*scene5*.mp4" -o -name "*video5*.mp4" \) 2>/dev/null | head -1)
            if [ -n "$VIDEO5_FILE" ] && [ -f "$VIDEO5_FILE" ] && [ $(stat -c%s "$VIDEO5_FILE" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "[$(date)] Video 5 SUCCESS on attempt $attempt: $(ls -lh "$VIDEO5_FILE")" >> "${PROJECT_DIR}/logs/execution.log"
              echo "video5_path=${VIDEO5_FILE}" >> $GITHUB_OUTPUT
              break
            else
              echo "[$(date)] Video 5 FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              if [ $attempt -eq 3 ]; then
                echo "[$(date)] All 3 attempts failed for Video 5, creating placeholder" >> "${PROJECT_DIR}/logs/execution.log"
                echo "video5_path=placeholder" >> $GITHUB_OUTPUT
              else
                echo "[$(date)] Retrying Video 5 in 10 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep 10
              fi
            fi
          done

      - name: Upload Video 5 artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-image5-to-video5
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Finalize Video 5 status
        if: always()
        run: |
          FILE="${{ steps.video5-task.outputs.video5_path }}"
          if [ -z "$FILE" ] || [ "$FILE" = "placeholder" ] || [ ! -f "$FILE" ] || [ $(stat -c%s "$FILE" 2>/dev/null || echo 0) -le 300000 ]; then
            echo "::error title=Video 5 verification failed::File invalid or missing"
            exit 1
          fi


  # Phase 4b: Auto Expand Scenes to match narration duration
  phase4b-fill-gap-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 6
    needs:
      [
        phase1-foundation,
        phase2-content-creation,
        phase3-audio-generation,
        phase3-image1-generation,
        phase3-image2-generation,
        phase3-image3-generation,
        phase3-image4-generation,
        phase3-image5-generation,
        phase4-image1-to-video1,
        phase4-image2-to-video2,
        phase4-image3-to-video3,
        phase4-image4-to-video4,
        phase4-image5-to-video5
      ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Install ffmpeg
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Generate filler videos to match narration length
        run: |
          set -euo pipefail
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCENE_DIR="${PROJECT_DIR}/media/videos/individual"
          IMG1="${{ needs.phase3-image1-generation.outputs.image1_path }}"
          IMG2="${{ needs.phase3-image2-generation.outputs.image2_path }}"
          IMG3="${{ needs.phase3-image3-generation.outputs.image3_path }}"
          IMG4="${{ needs.phase3-image4-generation.outputs.image4_path }}"
          IMG5="${{ needs.phase3-image5-generation.outputs.image5_path }}"
          NARRATION_FILE="${PROJECT_DIR}/media/audio/narration.mp3"
          mkdir -p "$SCENE_DIR" "${PROJECT_DIR}/logs"

          # ç›®æ¨™: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é•·ã€‚å–å¾—å¤±æ•—æ™‚ã¯60ç§’
          TARGET=60
          if command -v ffprobe >/dev/null 2>&1 && [ -f "$NARRATION_FILE" ]; then
            D=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$NARRATION_FILE" 2>/dev/null | cut -d'.' -f1)
            if [ -n "$D" ] && [ "$D" -gt 0 ] 2>/dev/null; then TARGET="$D"; fi
          fi

          # ç¾åœ¨ã®åˆè¨ˆå°ºã‚’ç®—å‡º
          total=0
          if command -v ffprobe >/dev/null 2>&1; then
            while IFS= read -r f; do
              [ -f "$f" ] || continue
              dur=$(ffprobe -v error -select_streams v:0 -show_entries stream=duration -of csv=p=0 "$f" 2>/dev/null | cut -d'.' -f1)
              if [ -z "$dur" ]; then
                dur=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$f" 2>/dev/null | cut -d'.' -f1)
              fi
              [ -n "$dur" ] || dur=0
              total=$(( total + dur ))
            done < <(find "$SCENE_DIR" -type f -name "scene*_video.mp4" | sort -V)
          fi

          echo "[$(date)] Current total video duration: ${total}s / target ${TARGET}s" >> "${PROJECT_DIR}/logs/execution.log"

          gap=$(( TARGET - total ))
          if [ "$gap" -le 2 ]; then
            echo "[$(date)] No filler needed (gap=${gap}s)" >> "${PROJECT_DIR}/logs/execution.log"
            exit 0
          fi

          # æ—¢å­˜æœ€å¤§ã‚·ãƒ¼ãƒ³ç•ªå·ã‚’å–å¾—
          maxn=0
          while IFS= read -r f; do
            bn=$(basename "$f")
            n=$(echo "$bn" | sed -n 's/^scene\([0-9]\+\)_video\.mp4$/\1/p')
            [ -n "$n" ] && [ "$n" -gt "$maxn" ] 2>/dev/null && maxn="$n"
          done < <(find "$SCENE_DIR" -type f -name "scene*_video.mp4")

          # ç”»åƒå€™è£œã®é…åˆ—
          imgs=()
          for p in "$IMG1" "$IMG2" "$IMG3" "$IMG4" "$IMG5"; do
            [ -f "$p" ] && imgs+=("$p") || true
          done

          idx=0
          while [ "$gap" -gt 0 ]; do
            chunk=8
            if [ "$gap" -lt 8 ]; then chunk="$gap"; fi
            maxn=$(( maxn + 1 ))
            out="$SCENE_DIR/scene${maxn}_video.mp4"

            src=""
            if [ "${#imgs[@]}" -gt 0 ]; then
              src="${imgs[$(( idx % ${#imgs[@]} ))]}"
            fi

            if [ -n "$src" ] && [ -f "$src" ]; then
              # è»½é‡åŒ–: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚±ãƒ¼ãƒ«ã®ã¿ã€ã‚ºãƒ¼ãƒ ãƒ‘ãƒ³åŠ¹æžœã‚’å‰Šé™¤
              timeout 120 ffmpeg -y -loop 1 -t "$chunk" -i "$src" \
                -vf "scale=1920:1080" \
                -c:v libx264 -pix_fmt yuv420p -preset ultrafast "$out" 2>> "${PROJECT_DIR}/logs/ffmpeg-filler.log" || {
                echo "[$(date)] ffmpeg failed for filler ${maxn}, using fallback" >> "${PROJECT_DIR}/logs/execution.log"
                timeout 60 ffmpeg -y -f lavfi -i "color=c=black:duration=${chunk}:size=1920x1080:rate=30" \
                  -vf "drawtext=text='Scene ${maxn}':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2" \
                  -c:v libx264 -pix_fmt yuv420p -preset ultrafast "$out" 2>> "${PROJECT_DIR}/logs/ffmpeg-filler.log" || true
              }
            else
              # è»½é‡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              timeout 60 ffmpeg -y -f lavfi -i "color=c=black:duration=${chunk}:size=1920x1080:rate=30" \
                -vf "drawtext=text='Filler ${maxn}':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2" \
                -c:v libx264 -pix_fmt yuv420p -preset ultrafast "$out" 2>> "${PROJECT_DIR}/logs/ffmpeg-filler.log" || true
            fi

            echo "[$(date)] Created filler: $(basename "$out") (${chunk}s)" >> "${PROJECT_DIR}/logs/execution.log"
            gap=$(( gap - chunk ))
            idx=$(( idx + 1 ))
          done

      - name: Upload filler artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4b-fill-gap-videos
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/


  # Phase 5: Video Editing Planning (Claude Code SDK)
  phase5-video-editing-planning:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-audio-generation, phase3-bgm-generation, phase4-image1-to-video1, phase4-image2-to-video2, phase4-image3-to-video3, phase4-image4-to-video4, phase4-image5-to-video5, phase4b-fill-gap-videos]
    outputs:
      editing_plan: ${{ steps.editing-plan.outputs.editing_plan }}
      timeline_config: ${{ steps.editing-plan.outputs.timeline_config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Video Editing Plan Generation (Claude Code SDK)
        id: editing-plan
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          echo "[$(date)] Phase 5: Video editing planning started" >> "${PROJECT_DIR}/logs/execution.log"
          
          # å‹•çš„ï¼šåˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒ³ä¸€è¦§ã¨ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é•·ã®åŽé›†
          NARRATION_FILE="${PROJECT_DIR}/media/audio/narration.mp3"
          TARGET_DURATION=60
          if command -v ffprobe > /dev/null 2>&1 && [ -f "$NARRATION_FILE" ]; then
            NARR_SEC=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$NARRATION_FILE" 2>/dev/null | cut -d'.' -f1)
            if [ -n "$NARR_SEC" ] && [ "$NARR_SEC" -gt 0 ] 2>/dev/null; then
              TARGET_DURATION="$NARR_SEC"
            fi
          fi
          SCENE_DIR="${PROJECT_DIR}/media/videos/individual"
          mkdir -p "$SCENE_DIR"
          VIDEOS_FOUND=$(find "$SCENE_DIR" -type f -name "scene*_video.mp4" 2>/dev/null | sort -V)
          if command -v jq > /dev/null 2>&1; then
            VIDEOS_JSON=$(printf '%s\n' $VIDEOS_FOUND | jq -R . | jq -s .)
          else
            VIDEOS_JSON="[]"
          fi

          EDITING_PLAN_PROMPT="å‹•ç”»ç·¨é›†è¨ˆç”»ç«‹æ¡ˆã‚¿ã‚¹ã‚¯ï¼ˆClaude Code SDKä½¿ç”¨ï¼‰ï¼š
          
          å…¥åŠ›ãƒ‡ãƒ¼ã‚¿åˆ†æž:
          - ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ãƒ¼ã‚¿: ${SCRIPT_DATA}
          - åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒ³å‹•ç”»ä¸€è¦§: ${VIDEOS_JSON}
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°: narration.mp3ï¼ˆç›®æ¨™åˆè¨ˆæ™‚é–“: ${TARGET_DURATION}ç§’ï¼‰
          - BGMéŸ³å£°: bgm.mp3
          
          ç·¨é›†è¨ˆç”»è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®${TARGET_DURATION}ç§’å‰å¾Œã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«æ¥µåŠ›åˆã‚ã›ã‚‹ï¼‰
          2. ã‚¹ãƒ ãƒ¼ã‚ºãªã‚·ãƒ¼ãƒ³é·ç§»ã¨é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
          3. éŸ³å£°ãƒ¬ãƒ™ãƒ«æœ€é©åŒ–ã¨ãƒŸãƒƒã‚¯ã‚¹æ¯”çŽ‡
          4. è¦–è´è€…ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæœ€å¤§åŒ–
          5. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã¨ã—ã¦ã®ä¿¡é ¼æ€§ã¨ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
          
          å‡ºåŠ›è¦æ±‚:
          1. è©³ç´°ãªç·¨é›†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³: ${PROJECT_DIR}/metadata/editing_timeline.json
          2. ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ä»•æ§˜: ${PROJECT_DIR}/metadata/transitions_config.json
          3. éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹è¨­è¨ˆ: ${PROJECT_DIR}/metadata/audio_mixing_plan.json
          4. æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: ${PROJECT_DIR}/metadata/quality_checklist.json
          
          å……è¶³æ¡ä»¶ã¨è£œè¶³:
          - åˆ©ç”¨å¯èƒ½ãªã‚·ãƒ¼ãƒ³ãŒå°‘ãªãå…¨é•·ã«æº€ãŸãªã„å ´åˆã€ã‚·ãƒ¼ãƒ³å†åˆ©ç”¨ã‚„B-rollï¼ˆé™æ­¢ç”»ã®ãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ ï¼‰ã§æ™‚é–“ã‚’æº€ãŸã™ã€‚
          - å„ã‚·ãƒ¼ãƒ³ã®æ¨™æº–é•·ã¯6-10ç§’ç›®å®‰ã€‚å…¨ä½“ã®æµã‚ŒãŒè‡ªç„¶ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã™ã‚‹ã“ã¨ã€‚
          - åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆscene*_video.mp4ï¼‰ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®å¯¾å¿œé–¢ä¿‚ã‚’æ˜Žç¤ºã€‚
          
          ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å½¢å¼ä¾‹:
          {
            \"total_duration\": ${TARGET_DURATION},
            \"segments\": [
              {\"start\": 0, \"end\": 12, \"content\": \"opening\", \"video\": \"scene1_video.mp4\", \"transition\": \"fade_in\"},
              {\"start\": 10, \"end\": 22, \"content\": \"main_story\", \"video\": \"scene2_video.mp4\", \"transition\": \"crossfade\"}
            ],
            \"audio_layers\": {
              \"narration\": {\"level\": -6, \"duck_during\": []},
              \"bgm\": {\"level\": -20, \"fade_points\": []}
            }
          }"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write,Bash" \
            --max-turns 30 \
            --permission-mode "acceptEdits" \
            -p "$EDITING_PLAN_PROMPT"
          
          # Check for generated editing plan
          if [ -f "${PROJECT_DIR}/metadata/editing_timeline.json" ]; then
            echo "editing_plan=${PROJECT_DIR}/metadata/editing_timeline.json" >> $GITHUB_OUTPUT
            echo "timeline_config=${PROJECT_DIR}/metadata/editing_timeline.json" >> $GITHUB_OUTPUT
            echo "[$(date)] Video editing plan completed" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 5 Report
            echo "## ðŸŽ¬ Phase 5: Video Editing Planning - ç·¨é›†è¨ˆç”»ç«‹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç·¨é›†è¨ˆç”»ä½œæˆå®Œäº† (Claude Code SDK)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¨­è¨ˆ: editing_timeline.json" >> $GITHUB_STEP_SUMMARY
            
            # Extract plan summary
            if command -v jq > /dev/null && [ -f "${PROJECT_DIR}/metadata/editing_timeline.json" ]; then
              TOTAL_DURATION=$(jq -r '.total_duration // "60"' "${PROJECT_DIR}/metadata/editing_timeline.json" 2>/dev/null)
              SEGMENTS_COUNT=$(jq '.segments | length' "${PROJECT_DIR}/metadata/editing_timeline.json" 2>/dev/null || echo "0")
              echo "- âœ… å‹•ç”»ç·æ™‚é–“: ${TOTAL_DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°: ${SEGMENTS_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for additional config files
            if [ -f "${PROJECT_DIR}/metadata/audio_mixing_plan.json" ]; then
              echo "- âœ… éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹è¨­è¨ˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f "${PROJECT_DIR}/metadata/transitions_config.json" ]; then
              echo "- âœ… ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³è¨­è¨ˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] ERROR: Editing plan not generated" >> "${PROJECT_DIR}/logs/execution.log"
            # Add error report
            echo "## ðŸŽ¬ Phase 5: Video Editing Planning - ç·¨é›†è¨ˆç”»ç«‹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ç·¨é›†è¨ˆç”»ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Video Editing Planning artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase5-video-editing-planning
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  # Phase 6: Opening Creation
  phase6-opening-creation:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-audio-generation, phase3-bgm-generation, phase4-image1-to-video1, phase4-image2-to-video2, phase4-image3-to-video3, phase4-image4-to-video4, phase4-image5-to-video5, phase5-video-editing-planning]
    outputs:
      opening_video: ${{ steps.opening-task.outputs.opening_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Opening Creation Task
        id: opening-task
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          SCRIPT_DATA="${{ needs.phase2-content-creation.outputs.script_data }}"
          EDITING_PLAN="${{ needs.phase5-video-editing-planning.outputs.editing_plan }}"
          echo "[$(date)] Phase 6: Opening creation started" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Using editing plan: ${EDITING_PLAN}" >> "${PROJECT_DIR}/logs/execution.log"
          
          OPENING_PROMPT="ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ä½œæˆã‚¿ã‚¹ã‚¯ï¼ˆç·¨é›†è¨ˆç”»çµ±åˆç‰ˆï¼‰ï¼š
          
          å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:
          - ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ‡ãƒ¼ã‚¿: ${SCRIPT_DATA}
          - ç·¨é›†è¨ˆç”»ãƒ•ã‚¡ã‚¤ãƒ«: ${EDITING_PLAN}
          
          ç·¨é›†è¨ˆç”»çµ±åˆè¦ä»¶:
          1. ç·¨é›†è¨ˆç”»ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä»•æ§˜ã‚’ç¢ºèªãƒ»å‚ç…§
          2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä¸Šã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ™‚é–“ï¼ˆé€šå¸¸0-3ç§’ï¼‰ã«æœ€é©åŒ–
          3. ç·¨é›†è¨ˆç”»ã§æŒ‡å®šã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³åŠ¹æžœã«å¯¾å¿œ
          4. å…¨ä½“çš„ãªè¦–è¦šçš„çµ±ä¸€æ€§ã‚’ç·¨é›†è¨ˆç”»ã«åˆã‚ã›ã¦èª¿æ•´
          
          è¦–è¦šçš„è¦ä»¶:
          1. çž¬æ™‚ã«æ³¨æ„ã‚’å¼•ãè¦–è¦šçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ
          2. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã¨ã—ã¦ã®ä¿¡é ¼æ€§è¡¨ç¾
          3. ä¿¡é ¼æ€§ï¼ˆé’ç³»ï¼‰ã¨ç·Šæ€¥æ€§ï¼ˆèµ¤ç³»ï¼‰ã®è‰²å½©æ´»ç”¨
          4. 3ç§’ä»¥å†…ã«ãƒˆãƒ”ãƒƒã‚¯ã‚’æ˜Žç¤º
          5. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚¹ã‚¿ã‚¤ãƒ«
          
          å‡¦ç†æ‰‹é †:
          1. ç·¨é›†è¨ˆç”»ã®openingã‚»ã‚°ãƒ¡ãƒ³ãƒˆä»•æ§˜ã‚’èª­ã¿è¾¼ã¿åˆ†æž
          2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦ä»¶ã«åŸºã¥ã„ã¦ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚ã‚‹ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã‚’ç”Ÿæˆ
          3. ç·¨é›†è¨ˆç”»ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ä»•æ§˜ã«é©åˆã™ã‚‹å‹•ç”»ã«å¤‰æ›ï¼ˆ3-5ç§’ï¼‰
          4. ç·¨é›†è¨ˆç”»ã®è¦–è¦šçš„çµ±ä¸€æ€§ã«åˆã‚ã›ãŸã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
          
          å‡ºåŠ›: ${PROJECT_DIR}/media/videos/opening.mp4
          ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: ${PROJECT_DIR}/metadata/opening_metadata.json"
          
          # 3-attempt retry logic for Opening creation
          # CRITICAL: Media generation (including opening video) requires retry logic due to API instability
          OPENING_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Opening creation attempt $attempt of 3" >> "${PROJECT_DIR}/logs/execution.log"
            
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-kamui-imagen3__imagen_t2i,mcp__i2v-kamui-hailuo-02-fast__hailuo_02_fast_submit,mcp__i2v-kamui-hailuo-02-fast__hailuo_02_fast_status,mcp__i2v-kamui-hailuo-02-fast__hailuo_02_fast_result,Write,Read" \
              --max-turns "${CLAUDE_CODE_MAX_TURNS:-120}" \
              --permission-mode "acceptEdits" \
              -p "$OPENING_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase6-opening-mcp.log"; then
              
              # Check if opening video was actually generated
              OPENING_CHECK=$(find "${PROJECT_DIR}/media/videos" -name "*opening*" | head -1)
              if [ -n "$OPENING_CHECK" ] && [ -f "$OPENING_CHECK" ] && [ -s "$OPENING_CHECK" ]; then
                # è¿½åŠ æ¤œè¨¼: ã‚µã‚¤ã‚ºã¨durationãŒå¦¥å½“ã‹ï¼ˆç ´æ8Bç­‰ã®æ¤œå‡ºï¼‰
                OPENING_OK=true
                SIZE=$(stat -c%s "$OPENING_CHECK" 2>/dev/null || echo 0)
                if [ "$SIZE" -le 30000 ]; then OPENING_OK=false; fi
                if command -v ffprobe >/dev/null 2>&1; then
                  DUR=$(ffprobe -v error -show_entries format=duration -of csv=p=0 "$OPENING_CHECK" 2>/dev/null | cut -d'.' -f1)
                  [ -z "$DUR" ] && DUR=0
                  if [ "$DUR" -lt 1 ] 2>/dev/null; then OPENING_OK=false; fi
                fi
                if [ "$OPENING_OK" != true ]; then
                  echo "[$(date)] Opening file seems invalid (size=${SIZE} bytes). Generating fallback..." >> "${PROJECT_DIR}/logs/execution.log"
                  timeout 30 ffmpeg -y -f lavfi -i "color=c=black:duration=3:size=1920x1080:rate=30" \
                    -vf "drawtext=text='Opening':fontcolor=white:fontsize=72:x=(w-text_w)/2:y=(h-text_h)/2" \
                    -c:v libx264 -pix_fmt yuv420p -preset ultrafast "${PROJECT_DIR}/media/videos/opening.mp4" 2>> "${PROJECT_DIR}/logs/ffmpeg-opening-fallback.log" || true
                  OPENING_CHECK="${PROJECT_DIR}/media/videos/opening.mp4"
                fi
                echo "[$(date)] Opening SUCCESS on attempt $attempt: $(basename "$OPENING_CHECK")" >> "${PROJECT_DIR}/logs/execution.log"
                OPENING_SUCCESS=true
                break
              else
                echo "[$(date)] Opening generation completed but no valid file found on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
              fi
            else
              echo "[$(date)] Opening FAILED on attempt $attempt" >> "${PROJECT_DIR}/logs/execution.log"
            fi
            
            if [ $attempt -lt 3 ]; then
              echo "[$(date)] Retrying Opening in 5 seconds..." >> "${PROJECT_DIR}/logs/execution.log"
              sleep 5
            fi
          done
          
          if [ "$OPENING_SUCCESS" = "true" ]; then
            OPENING_FILE=$(find "${PROJECT_DIR}/media/videos" -name "*opening*" | head -1)
            echo "opening_video=${OPENING_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Opening creation completed: ${OPENING_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 6 Report
            echo "## ðŸŽ¬ Phase 6: Opening Creation - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å‹•ç”»ä½œæˆå®Œäº†: $(basename "$OPENING_FILE")" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç·¨é›†è¨ˆç”»çµ±åˆ: å®Œäº†" >> $GITHUB_STEP_SUMMARY
            OPENING_SIZE=$(stat -c%s "$OPENING_FILE" 2>/dev/null || echo "0")
            OPENING_SIZE_KB=$((OPENING_SIZE / 1024))
            echo "- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${OPENING_SIZE_KB}KB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] All 3 attempts failed for Opening creation" >> "${PROJECT_DIR}/logs/execution.log"
            # Add error report
            echo "## ðŸŽ¬ Phase 6: Opening Creation - ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ä½œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å‹•ç”»ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Opening Creation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase6-opening-creation
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  # Phase 7: Integration - Video Concatenation
  phase7-integration:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase2-content-creation, phase3-bgm-generation, phase4-image1-to-video1, phase4-image2-to-video2, phase4-image3-to-video3, phase4-image4-to-video4, phase4-image5-to-video5, phase5-video-editing-planning, phase6-opening-creation]
    outputs:
      concatenated_video: ${{ steps.concat.outputs.concatenated_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Video Concatenation with Editing Plan Integration
        id: concat
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          EDITING_PLAN="${{ needs.phase5-video-editing-planning.outputs.editing_plan }}"
          echo "[$(date)] Phase 7: Video concatenation started [Fan-in Pattern]" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Using editing plan: ${EDITING_PLAN}" >> "${PROJECT_DIR}/logs/execution.log"
          
          CONCAT_PROMPT="å‹•ç”»çµåˆã‚¿ã‚¹ã‚¯ï¼ˆç·¨é›†è¨ˆç”»ã«åŸºã¥ãï¼‰ï¼š
          
          ç·¨é›†è¨ˆç”»ãƒ•ã‚¡ã‚¤ãƒ«: ${EDITING_PLAN}
          
          è¦æ±‚:
          1. ç·¨é›†è¨ˆç”»ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ä»•æ§˜ã«å¾“ã£ã¦å‹•ç”»ã‚’çµåˆ
          2. æŒ‡å®šã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³åŠ¹æžœã‚’é©ç”¨
          3. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé–‹å§‹ãƒ»çµ‚äº†æ™‚é–“ã®æ­£ç¢ºãªå®Ÿè£…
          4. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®60ç§’ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»
          
          å‡¦ç†æ‰‹é †:
          1. ${EDITING_PLAN}ã‚’èª­ã¿è¾¼ã¿ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ§‹æˆã‚’è§£æž
          2. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé †åºã¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ä»•æ§˜ã‚’é©ç”¨
          3. æœ€çµ‚çš„ãªå‹•ç”»ã‚’${PROJECT_DIR}/media/videos/concatenated.mp4ã¨ã—ã¦å‡ºåŠ›
          
          æ³¨æ„: ç·¨é›†è¨ˆç”»ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ã€åŸºæœ¬çš„ãªçµåˆã‚’å®Ÿè¡Œ"
          
          # 3å›žãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
          CONCAT_SUCCESS=false
          for attempt in 1 2 3; do
            echo "[$(date)] Video concatenation attempt $attempt/3" >> "${PROJECT_DIR}/logs/execution.log"
            
            # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§Claude Codeå®Ÿè¡Œ
            if npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "Bash,Write,Read" \
              --max-turns 20 \
              --permission-mode "acceptEdits" \
              -p "$CONCAT_PROMPT" 2>&1 | tee -a "${PROJECT_DIR}/logs/phase6-concat-attempt$attempt.log"; then
              
              echo "[$(date)] Video concatenation attempt $attempt succeeded" >> "${PROJECT_DIR}/logs/execution.log"
              CONCAT_SUCCESS=true
              break
            else
              echo "[$(date)] Video concatenation attempt $attempt failed (API Error or timeout)" >> "${PROJECT_DIR}/logs/execution.log"
              if [ $attempt -lt 3 ]; then
                WAIT_TIME=$((attempt * 10))
                echo "[$(date)] Waiting ${WAIT_TIME} seconds before retry..." >> "${PROJECT_DIR}/logs/execution.log"
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
          if [ "$CONCAT_SUCCESS" = false ]; then
            echo "[$(date)] ERROR: All concatenation attempts failed. Using fallback method." >> "${PROJECT_DIR}/logs/execution.log"
            
            # FFmpegã«ã‚ˆã‚‹ç›´æŽ¥çµåˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            echo "[$(date)] Attempting FFmpeg fallback concatenation" >> "${PROJECT_DIR}/logs/execution.log"
            
            # å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ä½œæˆ
            find "${PROJECT_DIR}/media/videos" -name "*.mp4" | sort > "${PROJECT_DIR}/video_list.txt"
            
            if [ -s "${PROJECT_DIR}/video_list.txt" ]; then
              # FFmpegã§çµåˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
              ffmpeg -f concat -safe 0 -i <(while read p; do echo "file '$p'"; done < "${PROJECT_DIR}/video_list.txt") \
                -c copy "${PROJECT_DIR}/media/videos/concatenated_fallback.mp4" 2>&1 | tee -a "${PROJECT_DIR}/logs/ffmpeg-fallback.log" || true
              
              if [ -f "${PROJECT_DIR}/media/videos/concatenated_fallback.mp4" ]; then
                echo "[$(date)] Fallback concatenation succeeded" >> "${PROJECT_DIR}/logs/execution.log"
                mv "${PROJECT_DIR}/media/videos/concatenated_fallback.mp4" "${PROJECT_DIR}/media/videos/concatenated.mp4"
              else
                echo "[$(date)] Fallback concatenation also failed. Creating placeholder." >> "${PROJECT_DIR}/logs/execution.log"
                # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ã®ä½œæˆ
                ffmpeg -f lavfi -i color=c=black:s=1280x720:d=5 -vf "drawtext=text='Video Generation Failed':fontcolor=white:fontsize=48:x=(w-text_w)/2:y=(h-text_h)/2" \
                  "${PROJECT_DIR}/media/videos/concatenated.mp4" 2>/dev/null || true
              fi
            fi
          fi
          
          # Check for concatenated video (original or fallback)
          CONCAT_FILE=$(find "${PROJECT_DIR}/media/videos" -name "*concatenated*" -o -name "*final*" | head -1)
          if [ -n "$CONCAT_FILE" ] && [ -f "$CONCAT_FILE" ]; then
            echo "concatenated_video=${CONCAT_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Video concatenation completed: ${CONCAT_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "[$(date)] ERROR: No video output available" >> "${PROJECT_DIR}/logs/execution.log"
            # Create minimal placeholder to prevent workflow failure
            touch "${PROJECT_DIR}/media/videos/placeholder.mp4"
            echo "concatenated_video=${PROJECT_DIR}/media/videos/placeholder.mp4" >> $GITHUB_OUTPUT
          fi

      - name: Upload Phase 7 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase7-integration
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

  # Phase 8: Final Audio Mix
  phase8-audio-mix:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [phase1-foundation, phase3-audio-generation, phase3-bgm-generation, phase5-video-editing-planning, phase7-integration]
    outputs:
      final_video: ${{ steps.mix.outputs.final_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Audio and BGM Mixing with Editing Plan Integration
        id: mix
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          CONCATENATED_VIDEO="${{ needs.phase7-integration.outputs.concatenated_video }}"
          EDITING_PLAN="${{ needs.phase5-video-editing-planning.outputs.editing_plan }}"
          echo "[$(date)] Phase 8: Audio mixing started" >> "${PROJECT_DIR}/logs/execution.log"
          echo "[$(date)] Using editing plan: ${EDITING_PLAN}" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Find audio files
          NARRATION_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*narration*" -o -name "*speech*" | head -1)
          BGM_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*bgm*" -o -name "*background*" | head -1)
          
          MIX_PROMPT="éŸ³å£°ãƒ»BGMãƒŸãƒƒã‚¯ã‚¹ã‚¿ã‚¹ã‚¯ï¼ˆç·¨é›†è¨ˆç”»ã«åŸºã¥ãï¼‰ï¼š
          
          ç·¨é›†è¨ˆç”»ãƒ•ã‚¡ã‚¤ãƒ«: ${EDITING_PLAN}
          éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹è¨­è¨ˆ: ${PROJECT_DIR}/metadata/audio_mixing_plan.json
          
          å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«:
          - å‹•ç”»: ${CONCATENATED_VIDEO}
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${NARRATION_FILE}
          - BGM: ${BGM_FILE}
          
          å‡¦ç†æ‰‹é †:
          1. audio_mixing_plan.jsonã‚’èª­ã¿è¾¼ã¿ã€éŸ³å£°ãƒ¬ãƒ™ãƒ«è¨­å®šã‚’å–å¾—
          2. ç·¨é›†è¨ˆç”»ã§æŒ‡å®šã•ã‚ŒãŸduck_duringï¼ˆBGMéŸ³é‡èª¿æ•´ï¼‰ãƒã‚¤ãƒ³ãƒˆã‚’é©ç”¨
          3. fade_pointsã§æŒ‡å®šã•ã‚ŒãŸBGMãƒ•ã‚§ãƒ¼ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œ
          4. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®éŸ³éŸ¿ãƒãƒ©ãƒ³ã‚¹å®Ÿç¾
          
          ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¦ä»¶ï¼ˆè¨ˆç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆï¼‰:
          1. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ãƒ¬ãƒ™ãƒ«: -14LUFS
          2. BGMãƒ¬ãƒ™ãƒ«: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ˆã‚Š20-25dBä½Žã
          3. éŸ³å£°ã®æ˜Žçž­æ€§æœ€å„ªå…ˆ
          4. é©åˆ‡ãªéŸ³éŸ¿ãƒãƒ©ãƒ³ã‚¹
          5. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå“è³ªåŸºæº–
          
          å‡¦ç†:
          1. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ç”»ã«åŒæœŸ
          2. BGMã‚’é©åˆ‡ãªãƒ¬ãƒ™ãƒ«ã§ãƒŸãƒƒã‚¯ã‚¹
          3. éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´ã¨æœ€é©åŒ–
          
          å‡ºåŠ›: ${PROJECT_DIR}/final/professional_news_video.mp4
          ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: ${PROJECT_DIR}/metadata/final_mix_metadata.json"
          
          # ffmpeg ãŒç„¡ã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          if ! command -v ffmpeg >/dev/null 2>&1; then
            echo "[$(date)] Installing ffmpeg..." >> "${PROJECT_DIR}/logs/execution.log"
            sudo apt-get update && sudo apt-get install -y ffmpeg >/dev/null 2>&1 || true
          fi

          # å…¥åŠ›å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if [ ! -f "$CONCATENATED_VIDEO" ]; then
            echo "[$(date)] ERROR: Concatenated video not found" >> "${PROJECT_DIR}/logs/execution.log"
            exit 1
          fi
          if [ ! -f "$NARRATION_FILE" ]; then
            echo "[$(date)] WARNING: Narration not found; generating with anullsrc" >> "${PROJECT_DIR}/logs/execution.log"
          fi
          if [ ! -f "$BGM_FILE" ]; then
            echo "[$(date)] WARNING: BGM not found; continuing without BGM" >> "${PROJECT_DIR}/logs/execution.log"
          fi

          OUT_DIR="${PROJECT_DIR}/final"
          mkdir -p "$OUT_DIR"
          OUT_FILE="${OUT_DIR}/professional_news_video.mp4"

          # ãƒŸãƒƒã‚¯ã‚¹å‡¦ç†ï¼ˆå®‰å…¨ã§ã‚·ãƒ³ãƒ—ãƒ«ãªæ¨™æº–æ‰‹é †ï¼‰
          # 1) ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ or 2) ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³+bgm or 3) ç„¡éŸ³æ™‚ã¯ç„¡éŸ³ãƒˆãƒ©ãƒƒã‚¯åˆæˆ
          if command -v ffmpeg >/dev/null 2>&1; then
            if [ -f "$NARRATION_FILE" ] && [ -f "$BGM_FILE" ]; then
              # æ­£å¸¸: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨BGMã®ãƒŸãƒƒã‚¯ã‚¹ï¼ˆBGM -20dBï¼‰
              timeout 180 ffmpeg -y -i "$CONCATENATED_VIDEO" -i "$NARRATION_FILE" -i "$BGM_FILE" \
                -filter_complex "[1:a]volume=1.0[a1];[2:a]volume=0.1[a2];[a1][a2]amix=inputs=2:duration=first:dropout_transition=0[aout]" \
                -map 0:v -map "[aout]" -c:v copy -c:a aac -b:a 192k "$OUT_FILE" 2>> "${PROJECT_DIR}/logs/ffmpeg-mix.log" || true
            elif [ -f "$NARRATION_FILE" ]; then
              # ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
              timeout 120 ffmpeg -y -i "$CONCATENATED_VIDEO" -i "$NARRATION_FILE" \
                -map 0:v -map 1:a -c:v copy -c:a aac -b:a 192k "$OUT_FILE" 2>> "${PROJECT_DIR}/logs/ffmpeg-mix.log" || true
            else
              # ç„¡éŸ³ã®å®‰å…¨å¼¾ï¼ˆanullsrcã§ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚’ä»˜ä¸Žï¼‰
              timeout 90 ffmpeg -y -i "$CONCATENATED_VIDEO" -f lavfi -i anullsrc=channel_layout=stereo:sample_rate=44100 \
                -shortest -map 0:v -map 1:a -c:v copy -c:a aac -b:a 128k "$OUT_FILE" 2>> "${PROJECT_DIR}/logs/ffmpeg-mix.log" || true
            fi
          fi

          # ã‚‚ã—ç·¨é›†è¨ˆç”»ã®è©³ç´°é©ç”¨ãŒå¿…è¦ãªã‚‰ã€å¾Œæ®µã§ä¸Šæ›¸ãå‡ºåŠ›ã«åˆ‡æ›¿
          # npx @anthropic-ai/claude-code ... ã¯å¿…è¦ã«å¿œã˜ã¦å†åº¦å‘¼ã³å‡ºã—å¯èƒ½ï¼ˆç¾çŠ¶ã¯å®ŸãƒŸãƒƒã‚¯ã‚¹å„ªå…ˆï¼‰
          
          # Check for final video
          FINAL_FILE=$(find "${PROJECT_DIR}/final" -name "*.mp4" | head -1)
          if [ -n "$FINAL_FILE" ]; then
            # éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã®å­˜åœ¨ã‚’ç¢ºèª
            if command -v ffprobe >/dev/null 2>&1; then
              AC=$(ffprobe -v error -select_streams a:0 -show_entries stream=index -of csv=p=0 "$FINAL_FILE" 2>/dev/null | wc -l | tr -d ' ')
              if [ "$AC" = "0" ]; then
                echo "[$(date)] ERROR: No audio track in final video" >> "${PROJECT_DIR}/logs/execution.log"
                exit 1
              fi
            fi
            echo "final_video=${FINAL_FILE}" >> $GITHUB_OUTPUT
            echo "[$(date)] Audio mixing completed: ${FINAL_FILE}" >> "${PROJECT_DIR}/logs/execution.log"
            
            # Add Phase 8 Report
            echo "## ðŸŽµ Phase 8: Final Audio Mix - æœ€çµ‚éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… æœ€çµ‚å‹•ç”»ä½œæˆå®Œäº†: $(basename "$FINAL_FILE")" >> $GITHUB_STEP_SUMMARY
            FINAL_SIZE=$(stat -c%s "$FINAL_FILE" 2>/dev/null || echo "0")
            FINAL_SIZE_MB=$((FINAL_SIZE / 1024 / 1024))
            echo "- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FINAL_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… ç·¨é›†è¨ˆç”»çµ±åˆ: å®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… å‡ºåŠ›ãƒ‘ã‚¹: ${FINAL_FILE}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "[$(date)] ERROR: Final video not generated" >> "${PROJECT_DIR}/logs/execution.log"
            # Add error report
            echo "## ðŸŽµ Phase 8: Final Audio Mix - æœ€çµ‚éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ æœ€çµ‚å‹•ç”»ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Phase 8 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase8-audio-mix
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Add Phase 8 Final Audio Mix Report with Direct Links
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Add Phase 8 Final Audio Mix Report to GitHub Summary
          echo "## ðŸŽ¤ Phase 8 Final Audio Mix - å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check final video with audio
          FINAL_VIDEO=$(find "${PROJECT_DIR}/final" -name "*.mp4" 2>/dev/null | head -1)
          if [ -n "$FINAL_VIDEO" ] && [ -f "$FINAL_VIDEO" ]; then
            FINAL_SIZE=$(ls -lh "$FINAL_VIDEO" | awk '{print $5}')
            FINAL_BASENAME=$(basename "$FINAL_VIDEO")
            echo "- âœ… **æœ€çµ‚å‹•ç”»**: [\`${FINAL_BASENAME}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) (${FINAL_SIZE})" >> $GITHUB_STEP_SUMMARY
            
            # Video specs
            if command -v ffprobe > /dev/null 2>&1; then
              FINAL_DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null | cut -d'.' -f1)
              FINAL_RESOLUTION=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width,height -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null | tr ',' 'x')
              AUDIO_CODEC=$(ffprobe -v quiet -select_streams a:0 -show_entries stream=codec_name -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null)
              
              if [ -n "$FINAL_DURATION" ]; then
                echo "- â±ï¸ **æœ€çµ‚å‹•ç”»æ™‚é–“**: ${FINAL_DURATION}ç§’" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -n "$FINAL_RESOLUTION" ]; then
                echo "- ðŸ“ **æœ€çµ‚è§£åƒåº¦**: ${FINAL_RESOLUTION}" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -n "$AUDIO_CODEC" ]; then
                echo "- ðŸ”Š **éŸ³å£°ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯**: ${AUDIO_CODEC}" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "- âŒ **æœ€çµ‚å‹•ç”»**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Complete artifact summary
          echo "## ðŸ“¦ å…¨æˆæžœç‰©ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç›´ãƒªãƒ³ã‚¯ä¸€è¦§" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          
          # Images count
          IMAGE_COUNT=$(find "${PROJECT_DIR}/media/images" -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | wc -l)
          echo "- ðŸ–¼ï¸ **ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«**: ${IMAGE_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          
          # Videos count
          VIDEO_COUNT=$(find "${PROJECT_DIR}/media/videos" -name "*.mp4" 2>/dev/null | wc -l)
          echo "- ðŸŽ¬ **å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«**: ${VIDEO_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          
          # Audio count
          AUDIO_COUNT=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" 2>/dev/null | wc -l)
          echo "- ðŸŽµ **éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«**: ${AUDIO_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿" >> $GITHUB_STEP_SUMMARY
          
          # JSON metadata count
          JSON_COUNT=$(find "${PROJECT_DIR}/metadata" -name "*.json" 2>/dev/null | wc -l)
          echo "- ðŸ“Š **JSONãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**: ${JSON_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          
          # Log files count
          LOG_COUNT=$(find "${PROJECT_DIR}/logs" -name "*.log" 2>/dev/null | wc -l)
          echo "- ðŸ“ **å®Ÿè¡Œãƒ­ã‚°**: ${LOG_COUNT}ä»¶ - [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸Šè¨˜ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
          echo "2. å„Phaseåˆ¥ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY  
          echo "3. ZIPã‚’å±•é–‹ã—ã¦å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 9: Quality Assurance and Final Output
  phase9-quality-assurance:
    runs-on: ubuntu-latest
    needs: [phase1-foundation, phase8-audio-mix]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/
          merge-multiple: true

      - name: Final Quality Check and Export
        id: quality-check
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          FINAL_VIDEO="${{ needs.phase8-audio-mix.outputs.final_video }}"
          echo "[$(date)] Phase 9: Quality assurance started" >> "${PROJECT_DIR}/logs/execution.log"
          
          QC_PROMPT="æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯ãƒ»æ›¸ãå‡ºã—ã‚¿ã‚¹ã‚¯ï¼š
          
          å…¥åŠ›: ${FINAL_VIDEO}
          ç›®æ¨™: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã¨ã—ã¦å…¬é–‹æº–å‚™å®Œäº†
          
          ãƒã‚§ãƒƒã‚¯é …ç›®:
          1. éŸ³å£°ãƒ¬ãƒ™ãƒ«ç¢ºèªï¼ˆ-14LUFSåŸºæº–ï¼‰
          2. ç”»è³ªãƒ»è§£åƒåº¦çµ±ä¸€ç¢ºèª
          3. æƒ…å ±ã®æ­£ç¢ºæ€§ãƒã‚§ãƒƒã‚¯
          4. 60ç§’åˆ¶é™æ™‚é–“æº–æ‹ ç¢ºèª
          5. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„å“è³ªåŸºæº–æº€äº†
          
          æœ€çµ‚å‡ºåŠ›:
          1. å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆ: ${PROJECT_DIR}/final/quality_report.json
          2. æœ€çµ‚å‹•ç”»ç¢ºèªãƒ»æœ€é©åŒ–
          3. é…ä¿¡æº–å‚™å®Œäº†çŠ¶æ…‹ã§ã®ä¿å­˜
          
          å“è³ªåŸºæº–:
          - æŠ€è¡“ä»•æ§˜: 1920x1080, 30fps, H.264
          - éŸ³å£°: -14LUFS, æ˜Žçž­ã§èžãå–ã‚Šã‚„ã™ã„
          - æ™‚é–“: 60ç§’ä»¥å†…
          - å†…å®¹: æ­£ç¢ºã§ä¿¡é ¼æ€§ã®é«˜ã„æƒ…å ±"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Bash,Write,Read" \
            --max-turns 8 \
            --permission-mode "acceptEdits" \
            -p "$QC_PROMPT"
          
          echo "[$(date)] Quality assurance completed" >> "${PROJECT_DIR}/logs/execution.log"
          
          # Add Phase 9 Report
          echo "## âœ… Phase 9: Quality Assurance - æœ€çµ‚å“è³ªä¿è¨¼" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          
          # Check if quality report was generated
          if [ -f "${PROJECT_DIR}/final/quality_report.json" ]; then
            echo "- âœ… å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: quality_report.json" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… æœ€çµ‚å‹•ç”»ç¢ºèªãƒ»æœ€é©åŒ–å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é…ä¿¡æº–å‚™å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create final summary
          echo "=== PROFESSIONAL NEWS VIDEO CREATION COMPLETED ===" >> "${PROJECT_DIR}/final/completion_report.txt"
          echo "Project: ${{ inputs.project_name }}" >> "${PROJECT_DIR}/final/completion_report.txt"
          echo "Topic: ${{ inputs.news_topic }}" >> "${PROJECT_DIR}/final/completion_report.txt"
          echo "Completed: $(date)" >> "${PROJECT_DIR}/final/completion_report.txt"
          echo "Final video: ${FINAL_VIDEO}" >> "${PROJECT_DIR}/final/completion_report.txt"

      - name: Upload Final Results
        uses: actions/upload-artifact@v4
        with:
          name: final-professional-news-video
          path: ${{ needs.phase1-foundation.outputs.project_dir }}/

      - name: Create workflow summary
        run: |
          PROJECT_DIR="${{ needs.phase1-foundation.outputs.project_dir }}"
          
          # Update execution status
          echo "- **å®Ÿè¡Œå®Œäº†æ™‚åˆ»**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡ŒçŠ¶æ³**: âœ… å…¨å·¥ç¨‹å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ‰ Professional News Video Creation å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ inputs.news_topic }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ inputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** 60 seconds professional news video" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count generated assets
          IMAGE_COUNT=$(find "${PROJECT_DIR}/media/images" -name "*.png" -o -name "*.jpg" 2>/dev/null | wc -l)
          VIDEO_COUNT=$(find "${PROJECT_DIR}/media/videos" -name "*.mp4" 2>/dev/null | wc -l)  
          AUDIO_COUNT=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" 2>/dev/null | wc -l)
          
          echo "### ðŸ“Š ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆçµ±è¨ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¼ï¸ ç”Ÿæˆç”»åƒæ•°: ${IMAGE_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¬ ç”Ÿæˆå‹•ç”»æ•°: ${VIDEO_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽµ ç”ŸæˆéŸ³å£°æ•°: ${AUDIO_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”„ å®Ÿè¡Œã•ã‚ŒãŸãƒ•ã‚§ãƒ¼ã‚º" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 1: Information Gathering & Research" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 2: Script & Structure Creation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 3: Parallel Audio & Image Generation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 4: Parallel Image Batch 2 & Video Conversion" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 5: Video Editing Planning (Claude Code SDK)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 6: Opening Creation" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Phase 7: Video Integration & Concatenation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 8: Professional Audio Mixing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Phase 9: Quality Assurance & Final Export" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å‡ºåŠ›å ´æ‰€" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€çµ‚å‹•ç”»**: \`${PROJECT_DIR}/final/professional_news_video.mp4\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å…¨ãƒ‡ãƒªãƒãƒ©ãƒ–ãƒ«**: \`${PROJECT_DIR}/final/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ é”æˆã•ã‚ŒãŸå“è³ªåŸºæº–" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“º ãƒ‹ãƒ¥ãƒ¼ã‚¹æ”¾é€å“è³ªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ™ï¸ ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒŠãƒ¬ãƒ¼ã‚¿ãƒ¼å“è³ªéŸ³å£° (-14LUFS)" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ æœ€é©åŒ–ã•ã‚ŒãŸ60ç§’æƒ…å ±é…ä¿¡" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ ä¸€è²«ã—ãŸãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‚¹ã‚¿ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š è¤‡æ•°ã‚½ãƒ¼ã‚¹æ¤œè¨¼æ¸ˆã¿æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¥ æˆæžœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ãƒ­ãƒ¼ã‚«ãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# å°‚ç”¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼ˆæŽ¨å¥¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/download-workflow-artifacts.sh ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY  
          echo "# ã¾ãŸã¯æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
          echo "gh run download ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY