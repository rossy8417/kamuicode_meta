name: "ðŸŽ¬ News Video Creation Workflow - Improved Version"

on:
  workflow_dispatch:
    inputs:
      topic:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹: æœ€æ–°ã®æŠ€è¡“ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€çµŒæ¸ˆå‹•å‘ã€ç¤¾ä¼šæƒ…å‹¢ãªã©ï¼‰"
        required: true
        default: "æœ€æ–°ã®AIæŠ€è¡“å‹•å‘"
      style:
        description: "å‹•ç”»ã®ã‚¹ã‚¿ã‚¤ãƒ«"
        required: false
        default: "professional news"
        type: choice
        options:
          - professional news
          - casual news
          - documentary style
      language:
        description: "è¨€èªžè¨­å®š"
        required: false
        default: "japanese"
        type: choice
        options:
          - japanese
          - english

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: Setup and Information Gathering
  setup-and-info-gathering:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      info_summary: ${{ steps.gather-info.outputs.summary }}
      topic: ${{ steps.extract-topic.outputs.topic }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup project directory
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/news-video-${TIMESTAMP}"
          mkdir -p "${PROJECT_DIR}"/{metadata,logs,media/{images,videos,audio},final,temp}
          echo "project_dir=${PROJECT_DIR}" >> $GITHUB_OUTPUT
          echo "âœ… Project directory created: ${PROJECT_DIR}"

      - name: Extract topic
        id: extract-topic
        run: |
          TOPIC="${{ inputs.topic }}"
          echo "topic=${TOPIC}" >> $GITHUB_OUTPUT
          echo "Topic: ${TOPIC}" > ${{ steps.setup.outputs.project_dir }}/metadata/topic.txt

      - name: Information gathering and validation
        id: gather-info
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          TOPIC="${{ steps.extract-topic.outputs.topic }}"
          
          INFO_PROMPT="æŒ‡å®šã•ã‚ŒãŸãƒˆãƒ”ãƒƒã‚¯ã€Œ${TOPIC}ã€ã«ã¤ã„ã¦ã€ä¿¡é ¼ã§ãã‚‹æœ€æ–°æƒ…å ±ã‚’åŽé›†ã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. æœ€ä½Ž3ã¤ã®ç‹¬ç«‹ã—ãŸæƒ…å ±æºã‹ã‚‰æƒ…å ±ã‚’åŽé›†
          2. æƒ…å ±ã®æ­£ç¢ºæ€§ã¨ä¿¡é ¼æ€§ã‚’ç¢ºèª
          3. 60ç§’ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã«é©ã—ãŸå†…å®¹ã‚’é¸åˆ¥
          4. å„æƒ…å ±æºã®URLã€ç™ºä¿¡æ™‚åˆ»ã€ä¿¡é ¼åº¦ã‚’è¨˜éŒ²

          å‡ºåŠ›å½¢å¼:
          - collected_info.json: åŽé›†ã—ãŸæƒ…å ±
          - info_summary.txt: è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆ
          - sources.json: æƒ…å ±æºã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Read" \
            --max-turns 30 \
            --permission-mode "acceptEdits" \
            -p "$INFO_PROMPT"

          # Validate results
          if [ -f "collected_info.json" ]; then
            mv collected_info.json "$PROJECT_DIR/metadata/"
            echo "summary=$(head -1 info_summary.txt 2>/dev/null || echo 'Information gathered successfully')" >> $GITHUB_OUTPUT
            mv info_summary.txt "$PROJECT_DIR/metadata/" 2>/dev/null || echo "No summary file"
            mv sources.json "$PROJECT_DIR/metadata/" 2>/dev/null || echo "No sources file"
            echo "âœ… Information gathering completed"
          else
            echo "summary=Information gathering completed with basic data" >> $GITHUB_OUTPUT
            echo "âœ… Basic information gathering completed"
          fi

      - name: Upload Phase 1 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase1-info-gathering
          path: ${{ steps.setup.outputs.project_dir }}/

      - name: Phase 1 Progress Report
        run: |
          echo "## ðŸ“Š Phase 1: Information Gathering & Setup" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Topic**: ${{ steps.extract-topic.outputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: Setup and info gathering within 10min timeout" >> $GITHUB_STEP_SUMMARY
          echo "- **Result**: Project structure created and information collected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 2: Content Structure and Script Creation
  content-structure:
    runs-on: ubuntu-latest
    needs: setup-and-info-gathering
    timeout-minutes: 8
    outputs:
      script_path: ${{ steps.create-script.outputs.script_path }}
      scene_count: ${{ steps.create-script.outputs.scene_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Phase 1 artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase1-info-gathering
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Create news script and structure
        id: create-script
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          TOPIC="${{ needs.setup-and-info-gathering.outputs.topic }}"
          STYLE="${{ inputs.style }}"
          LANGUAGE="${{ inputs.language }}"

          SCRIPT_PROMPT="åŽé›†ã—ãŸæƒ…å ±ã‚’åŸºã«ã€60ç§’ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”¨å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. è¦–è´è€…ã®æ³¨æ„ã‚’å¼•ãå°Žå…¥éƒ¨ï¼ˆ0-8ç§’ï¼‰
          2. æ˜Žç¢ºãªæƒ…å ±ä¼é”éƒ¨ï¼ˆ8-45ç§’ï¼‰  
          3. é©åˆ‡ãªçµè«–éƒ¨ï¼ˆ45-60ç§’ï¼‰
          4. å„ã‚·ãƒ¼ãƒ³ã¯ç´„5ç§’ã€åˆè¨ˆ12ã‚·ãƒ¼ãƒ³æ§‹æˆ
          5. ã‚¹ã‚¿ã‚¤ãƒ«: ${STYLE}
          6. è¨€èªž: ${LANGUAGE}

          å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«:
          - news_script.txt: å®Œå…¨ãªå°æœ¬
          - scene_breakdown.json: ã‚·ãƒ¼ãƒ³åˆ¥æ§‹æˆ
          - timing_plan.json: ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­è¨ˆ"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write" \
            --max-turns 25 \
            --permission-mode "acceptEdits" \
            -p "$SCRIPT_PROMPT"

          # Process results
          if [ -f "news_script.txt" ]; then
            mv news_script.txt "$PROJECT_DIR/metadata/"
            SCRIPT_PATH="$PROJECT_DIR/metadata/news_script.txt"
            echo "script_path=${SCRIPT_PATH}" >> $GITHUB_OUTPUT
          fi

          if [ -f "scene_breakdown.json" ]; then
            mv scene_breakdown.json "$PROJECT_DIR/metadata/"
            # Extract scene count from JSON
            SCENE_COUNT=$(jq -r '.scenes | length' "$PROJECT_DIR/metadata/scene_breakdown.json" 2>/dev/null || echo "12")
            echo "scene_count=${SCENE_COUNT}" >> $GITHUB_OUTPUT
          else
            echo "scene_count=12" >> $GITHUB_OUTPUT
          fi

          mv timing_plan.json "$PROJECT_DIR/metadata/" 2>/dev/null || echo "No timing plan"
          echo "âœ… Script creation completed"

      - name: Upload Phase 2 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase2-content-structure
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Phase 2 Progress Report
        run: |
          echo "## ðŸ“Š Phase 2: Content Structure & Script" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Scene Count**: ${{ steps.create-script.outputs.scene_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Script**: Created 60-second news script" >> $GITHUB_STEP_SUMMARY
          echo "- **Structure**: Professional news format with intro-content-conclusion flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 3: Asset Generation (Parallel)
  asset-generation:
    runs-on: ubuntu-latest
    needs: [setup-and-info-gathering, content-structure]
    timeout-minutes: 12
    strategy:
      matrix:
        asset_type: [narration, caster_image, studio_background]
      max-parallel: 3
    outputs:
      narration_path: ${{ steps.generate-narration.outputs.narration_path }}
      caster_image_path: ${{ steps.generate-caster.outputs.caster_path }}
      caster_image_url: ${{ steps.generate-caster.outputs.caster_url }}
      studio_bg_path: ${{ steps.generate-studio.outputs.studio_path }}
      studio_bg_url: ${{ steps.generate-studio.outputs.studio_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download previous artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-content-structure
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Generate narration audio
        if: matrix.asset_type == 'narration'
        id: generate-narration
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          LANGUAGE="${{ inputs.language }}"

          NARRATION_PROMPT="å°æœ¬ã‚’èª­ã¿ä¸Šã’ã‚‹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. æ˜Žçž­ã§æ¨©å¨æ€§ã®ã‚ã‚‹å£°è³ª
          2. é©åˆ‡ãªãƒšãƒ¼ã‚¹ï¼ˆæ¯Žåˆ†150-180èªžï¼‰
          3. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„ãƒˆãƒ¼ãƒ³
          4. éŸ³å£°ãƒ¬ãƒ™ãƒ«: -14LUFSï¼ˆYouTubeæœ€é©åŒ–ï¼‰
          5. è¨€èªž: ${LANGUAGE}

          å…¥åŠ›: ${PROJECT_DIR}/metadata/news_script.txt
          å‡ºåŠ›: narration.mp3"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-*,Read,Write" \
            --max-turns 25 \
            --permission-mode "acceptEdits" \
            -p "$NARRATION_PROMPT"

          # Handle dynamic filename
          AUDIO_FILE=$(find . -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
          if [ -n "$AUDIO_FILE" ] && [ -f "$AUDIO_FILE" ]; then
            mv "$AUDIO_FILE" "$PROJECT_DIR/media/audio/narration.mp3"
            echo "narration_path=$PROJECT_DIR/media/audio/narration.mp3" >> $GITHUB_OUTPUT
            echo "âœ… Narration audio generated"
          else
            echo "âŒ Narration generation failed"
          fi

      - name: Generate news caster image
        if: matrix.asset_type == 'caster_image'
        id: generate-caster
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          CASTER_PROMPT="ä¿¡é ¼æ„Ÿã¨æ¨©å¨æ€§ã‚’æŒã¤ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå¤–è¦‹ã¨æœè£…
          2. ä¿¡é ¼æ„Ÿã‚’æ¼”å‡ºã™ã‚‹è¡¨æƒ…
          3. é’ç³»åŸºèª¿ã§ä¿¡é ¼æ„Ÿã‚’æ¼”å‡º
          4. Rule of thirdsã«å¾“ã£ãŸé…ç½®
          5. é«˜è§£åƒåº¦ï¼ˆ512x512ä»¥ä¸Šï¼‰
          6. ä¸€è²«æ€§ç¢ºä¿ã®ãŸã‚å›ºå®šseed: 12345

          å‡ºåŠ›: professional_news_caster.png"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write" \
            --max-turns 30 \
            --permission-mode "acceptEdits" \
            -p "$CASTER_PROMPT"

          # Handle generated image
          IMAGE_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -1)
          if [ -n "$IMAGE_FILE" ] && [ -f "$IMAGE_FILE" ]; then
            cp "$IMAGE_FILE" "$PROJECT_DIR/media/images/news_caster.png"
            echo "caster_path=$PROJECT_DIR/media/images/news_caster.png" >> $GITHUB_OUTPUT
            
            # Check for Google URL in generated files
            URL_FILE=$(find . -name "*url*.txt" -o -name "*gcs*.txt" | head -1)
            if [ -f "$URL_FILE" ]; then
              CASTER_URL=$(cat "$URL_FILE")
              echo "$CASTER_URL" > "$PROJECT_DIR/media/images/news_caster_url.txt"
              echo "caster_url=$CASTER_URL" >> $GITHUB_OUTPUT
            else
              echo "caster_url=" >> $GITHUB_OUTPUT
            fi
            echo "âœ… News caster image generated"
          else
            echo "âŒ Caster image generation failed"
          fi

      - name: Generate studio background
        if: matrix.asset_type == 'studio_background'
        id: generate-studio
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          STUDIO_PROMPT="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„æ¨©å¨æ€§
          2. é’ç³»åŸºèª¿ã§ä¿¡é ¼æ„Ÿæ¼”å‡º
          3. ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ã¨ã®èª¿å’Œã‚’è€ƒæ…®
          4. é©åˆ‡ãªæ˜Žåº¦ãƒ»ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ
          5. ç¾ä»£çš„ã§æ´—ç·´ã•ã‚ŒãŸè¨­è¨ˆ
          6. 1920x1080è§£åƒåº¦å¯¾å¿œ

          å‡ºåŠ›: news_studio_background.png"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write" \
            --max-turns 25 \
            --permission-mode "acceptEdits" \
            -p "$STUDIO_PROMPT"

          # Handle generated background
          BG_FILE=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -1)
          if [ -n "$BG_FILE" ] && [ -f "$BG_FILE" ]; then
            cp "$BG_FILE" "$PROJECT_DIR/media/images/studio_background.png"
            echo "studio_path=$PROJECT_DIR/media/images/studio_background.png" >> $GITHUB_OUTPUT
            
            # Check for Google URL
            URL_FILE=$(find . -name "*url*.txt" -o -name "*gcs*.txt" | head -1)
            if [ -f "$URL_FILE" ]; then
              STUDIO_URL=$(cat "$URL_FILE")
              echo "$STUDIO_URL" > "$PROJECT_DIR/media/images/studio_background_url.txt"
              echo "studio_url=$STUDIO_URL" >> $GITHUB_OUTPUT
            else
              echo "studio_url=" >> $GITHUB_OUTPUT
            fi
            echo "âœ… Studio background generated"
          else
            echo "âŒ Studio background generation failed"
          fi

      - name: Upload Phase 3 artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase3-assets-${{ matrix.asset_type }}
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Phase 3 Progress Report
        run: |
          echo "## ðŸ“Š Phase 3: Asset Generation (${{ matrix.asset_type }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Asset Type**: ${{ matrix.asset_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality**: Professional grade with consistent parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 4: Scene Video Generation (Matrix Parallel with URL Expiration Handling)
  scene-video-generation:
    runs-on: ubuntu-latest
    needs: [setup-and-info-gathering, content-structure, asset-generation]
    timeout-minutes: 15
    strategy:
      matrix:
        scene_id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      max-parallel: 6  # Reduced from 12 to manage resources and avoid API limits
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all previous artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/
          merge-multiple: true

      - name: Generate scene ${{ matrix.scene_id }} video (Imageâ†’Video immediate conversion)
        id: generate-scene
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          SCENE_ID="${{ matrix.scene_id }}"
          
          # Check if caster image URL is available (prioritize Google URL)
          CASTER_URL=""
          if [ -f "$PROJECT_DIR/media/images/news_caster_url.txt" ]; then
            CASTER_URL=$(cat "$PROJECT_DIR/media/images/news_caster_url.txt")
            # Verify URL accessibility
            if curl -IfsS --max-time 10 "$CASTER_URL" >/dev/null 2>&1; then
              echo "âœ… Using Google URL for scene $SCENE_ID: $CASTER_URL"
              USE_GOOGLE_URL=true
            else
              echo "âš ï¸ Google URL inaccessible, using local path for scene $SCENE_ID"
              USE_GOOGLE_URL=false
            fi
          else
            echo "â„¹ï¸ Google URL not available, using local path for scene $SCENE_ID"
            USE_GOOGLE_URL=false
          fi

          # Create scene-specific prompt with immediate I2V conversion
          SCENE_PROMPT="ã‚·ãƒ¼ãƒ³${SCENE_ID}ã®å‹•ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
          
          æ‰‹é †:
          1. ã¾ãšã€ã“ã®ã‚·ãƒ¼ãƒ³ç”¨ã®ç”»åƒã‚’ç”Ÿæˆã¾ãŸã¯æ—¢å­˜ã®ç”»åƒã‚’ä½¿ç”¨
          2. å³åº§ã«ç”»åƒã‚’ãƒ“ãƒ‡ã‚ªã«å¤‰æ›ï¼ˆURLæœŸé™åˆ‡ã‚Œé˜²æ­¢ã®ãŸã‚ï¼‰
          
          ã‚·ãƒ¼ãƒ³${SCENE_ID}ã®è¦ä»¶:
          - ç´„6ç§’ã®å‹•ç”»
          - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚¹ã‚¿ã‚¤ãƒ«
          - ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼ã®ä¸€è²«æ€§ï¼ˆåŒä¸€äººç‰©ã€seed: 12345ï¼‰
          - 1920x1080è§£åƒåº¦ã€30fps
          - ã‚¹ãƒ ãƒ¼ã‚ºã§è‡ªç„¶ãªå‹•ã

          $(if [ "$USE_GOOGLE_URL" = "true" ]; then
            echo "ãƒ™ãƒ¼ã‚¹ç”»åƒURL: $CASTER_URL"
          else
            echo "ãƒ™ãƒ¼ã‚¹ç”»åƒãƒ‘ã‚¹: $PROJECT_DIR/media/images/news_caster.png"
          fi)

          å‡ºåŠ›: scene${SCENE_ID}_video.mp4"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__i2v-*,mcp__t2i-*,Write,Read" \
            --max-turns 80 \
            --permission-mode "acceptEdits" \
            -p "$SCENE_PROMPT"

          # Enhanced video validation
          VIDEO_FILE=$(find . -name "*.mp4" -o -name "*.mov" | head -1)
          if [ -n "$VIDEO_FILE" ] && [ -f "$VIDEO_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$VIDEO_FILE" 2>/dev/null || echo 0)
            
            # Enhanced validation: Size + format check
            if [ "$FILE_SIZE" -gt 300000 ]; then  # 300KB minimum
              if ffprobe "$VIDEO_FILE" >/dev/null 2>&1; then
                DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$VIDEO_FILE" 2>/dev/null || echo "0")
                if (( $(echo "$DURATION >= 5.0" | bc -l 2>/dev/null || echo 0) )); then
                  cp "$VIDEO_FILE" "$PROJECT_DIR/media/videos/scene${SCENE_ID}_video.mp4"
                  echo "âœ… VALID SCENE $SCENE_ID: ${FILE_SIZE} bytes, ${DURATION}s"
                  echo "scene_${SCENE_ID}_status=success" >> $GITHUB_OUTPUT
                else
                  echo "âŒ SCENE $SCENE_ID: Too short (${DURATION}s)"
                  echo "scene_${SCENE_ID}_status=failed" >> $GITHUB_OUTPUT
                fi
              else
                echo "âŒ SCENE $SCENE_ID: Invalid video format"
                echo "scene_${SCENE_ID}_status=failed" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ SCENE $SCENE_ID: File too small (${FILE_SIZE} bytes)"
              echo "scene_${SCENE_ID}_status=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ SCENE $SCENE_ID: No video file generated"
            echo "scene_${SCENE_ID}_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload scene ${{ matrix.scene_id }} artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase4-scene-${{ matrix.scene_id }}
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/media/videos/

      - name: Scene ${{ matrix.scene_id }} Progress Report
        if: always()
        run: |
          STATUS="${{ steps.generate-scene.outputs[format('scene_{0}_status', matrix.scene_id)] }}"
          if [ "$STATUS" = "success" ]; then
            echo "## ðŸ“Š Phase 4: Scene ${{ matrix.scene_id }} Video" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“Š Phase 4: Scene ${{ matrix.scene_id }} Video" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âš ï¸ Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Scene ID**: ${{ matrix.scene_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Immediate I2V conversion after image generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 5: Enhancement Processing (Mixed Parallel)
  enhancement-processing:
    runs-on: ubuntu-latest
    needs: [setup-and-info-gathering, content-structure, asset-generation, scene-video-generation]
    timeout-minutes: 10
    strategy:
      matrix:
        enhancement_type: [lipsync, bgm, graphics]
      max-parallel: 3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/
          merge-multiple: true

      - name: Lip-sync processing
        if: matrix.enhancement_type == 'lipsync'
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          # Check for available videos and audio
          VIDEO_COUNT=$(find "$PROJECT_DIR/media/videos" -name "scene*_video.mp4" | wc -l)
          AUDIO_FILE="$PROJECT_DIR/media/audio/narration.mp3"
          
          if [ "$VIDEO_COUNT" -gt 0 ] && [ -f "$AUDIO_FILE" ]; then
            LIPSYNC_PROMPT="ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒ¼ãƒ³å‹•ç”»ã«ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ã‚’åŒæœŸã•ã›ã‚‹ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

            è¦ä»¶:
            1. éŸ³ç´ è§£æžã«åŸºã¥ãæ­£ç¢ºãªå£ã®å‹•ã
            2. åŒæœŸã‚ºãƒ¬50msä»¥å†…
            3. è‡ªç„¶ãªå£ã®å‹•ã
            4. å…¨ã‚·ãƒ¼ãƒ³ã®ä¸€è²«ã—ãŸå‡¦ç†

            å…¥åŠ›:
            - å‹•ç”»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $PROJECT_DIR/media/videos/
            - éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $AUDIO_FILE

            å‡ºåŠ›: ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‡¦ç†æ¸ˆã¿å‹•ç”»"

            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__v2v-*,Read,Write,Bash" \
              --max-turns 40 \
              --permission-mode "acceptEdits" \
              -p "$LIPSYNC_PROMPT"

            echo "âœ… Lip-sync processing completed"
          else
            echo "âš ï¸ Insufficient materials for lip-sync: $VIDEO_COUNT videos, audio available: $([ -f "$AUDIO_FILE" ] && echo 'yes' || echo 'no')"
          fi

      - name: BGM and audio mixing
        if: matrix.enhancement_type == 'bgm'
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          BGM_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªBGMã‚’ç”Ÿæˆã—ã€éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ä¿¡é ¼æ„Ÿã‚’æ¼”å‡º
          2. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é‚ªé­”ã—ãªã„é©åˆ‡ãªãƒ¬ãƒ™ãƒ«ï¼ˆBGM: -20dBç¨‹åº¦ï¼‰
          3. 60ç§’ã®å‹•ç”»é•·ã«åˆã‚ã›ãŸé•·ã•
          4. éŸ³å£°ãƒ¬ãƒ™ãƒ«æ­£è¦åŒ–ï¼ˆ-14LUFSï¼‰

          å…¥åŠ›: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°
          å‡ºåŠ›: BGMéŸ³å£°ã€ãƒŸãƒƒã‚¯ã‚¹æ¸ˆã¿éŸ³å£°"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2m-*,Bash,Write" \
            --max-turns 30 \
            --permission-mode "acceptEdits" \
            -p "$BGM_PROMPT"

          # Handle generated BGM
          BGM_FILE=$(find . -name "*.mp3" -o -name "*.wav" | head -1)
          if [ -n "$BGM_FILE" ] && [ -f "$BGM_FILE" ]; then
            cp "$BGM_FILE" "$PROJECT_DIR/media/audio/bgm.mp3"
            echo "âœ… BGM generation and mixing completed"
          fi

      - name: Graphics and text overlay
        if: matrix.enhancement_type == 'graphics'
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          GRAPHICS_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„ãƒ†ãƒ­ãƒƒãƒ—ã€è¦‹å‡ºã—ã€æƒ…å ±æºè¡¨ç¤ºãªã©ã®ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯è¦ç´ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

          è¦ä»¶:
          1. é«˜ã„è¦–èªæ€§ã¨èª­ã¿ã‚„ã™ã•
          2. æƒ…å ±ã®éšŽå±¤åŒ–è¡¨ç¤º
          3. é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨­è¨ˆ
          4. ãƒ–ãƒ©ãƒ³ãƒ‰çµ±ä¸€æ„Ÿ
          5. Rule of thirdsã«åŸºã¥ãé…ç½®

          å…¥åŠ›: ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±ã€å°æœ¬
          å‡ºåŠ›: ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯è¦ç´ ã€ãƒ†ãƒ­ãƒƒãƒ—è¨­è¨ˆ"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Write,Read" \
            --max-turns 25 \
            --permission-mode "acceptEdits" \
            -p "$GRAPHICS_PROMPT"

          # Create graphics specifications
          echo "Graphics and text overlay specifications created" > "$PROJECT_DIR/metadata/graphics_spec.txt"
          echo "âœ… Graphics design completed"

      - name: Upload enhancement artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase5-enhancement-${{ matrix.enhancement_type }}
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Enhancement Progress Report
        run: |
          echo "## ðŸ“Š Phase 5: Enhancement (${{ matrix.enhancement_type }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ matrix.enhancement_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality**: Professional processing standards applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Phase 6: Final Integration and Quality Check
  final-integration:
    runs-on: ubuntu-latest
    needs: [setup-and-info-gathering, content-structure, asset-generation, scene-video-generation, enhancement-processing]
    timeout-minutes: 15
    outputs:
      final_video_path: ${{ steps.integrate.outputs.final_path }}
      quality_score: ${{ steps.quality-check.outputs.score }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/
          merge-multiple: true

      - name: Video integration and editing
        id: integrate
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          
          # Count available video files
          VIDEO_COUNT=$(find "$PROJECT_DIR/media/videos" -name "scene*_video.mp4" 2>/dev/null | wc -l)
          echo "Found $VIDEO_COUNT scene videos for integration"
          
          if [ "$VIDEO_COUNT" -gt 0 ]; then
            INTEGRATION_PROMPT="å…¨ã¦ã®ã‚·ãƒ¼ãƒ³å‹•ç”»ã€éŸ³å£°ã€BGMã‚’çµ±åˆã—ã€60ç§’ã®å®Œæˆãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            è¦ä»¶:
            1. ã‚¹ãƒ ãƒ¼ã‚ºãªã‚·ãƒ¼ãƒ³é–“ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³
            2. éŸ³å£°ãƒ¬ãƒ™ãƒ«æ­£è¦åŒ–ï¼ˆ-14LUFSï¼‰
            3. æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯
            4. 60ç§’Â±2ç§’ã®é•·ã•
            5. YouTubeç­‰ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æœ€é©åŒ–

            å…¥åŠ›:
            - ã‚·ãƒ¼ãƒ³å‹•ç”»: $VIDEO_COUNT ãƒ•ã‚¡ã‚¤ãƒ«
            - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€BGM: $PROJECT_DIR/media/audio/
            - ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ä»•æ§˜: $PROJECT_DIR/metadata/

            å‡ºåŠ›: final_news_video.mp4"

            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "Bash,Write,Read" \
              --max-turns 40 \
              --permission-mode "acceptEdits" \
              -p "$INTEGRATION_PROMPT"

            # Handle final video
            FINAL_VIDEO=$(find . -name "*final*.mp4" -o -name "*complete*.mp4" -o -name "*news*.mp4" | head -1)
            if [ -n "$FINAL_VIDEO" ] && [ -f "$FINAL_VIDEO" ]; then
              cp "$FINAL_VIDEO" "$PROJECT_DIR/final/final_news_video.mp4"
              echo "final_path=$PROJECT_DIR/final/final_news_video.mp4" >> $GITHUB_OUTPUT
              echo "âœ… Final video integration completed"
            else
              echo "âš ï¸ Final video not found, attempting manual integration with FFmpeg"
              
              # Fallback: Manual FFmpeg integration
              cd "$PROJECT_DIR/media/videos"
              if ls scene*_video.mp4 >/dev/null 2>&1; then
                echo "file 'scene1_video.mp4'" > concat_list.txt
                for i in {2..12}; do
                  if [ -f "scene${i}_video.mp4" ]; then
                    echo "file 'scene${i}_video.mp4'" >> concat_list.txt
                  fi
                done
                
                ffmpeg -f concat -safe 0 -i concat_list.txt -c copy "$PROJECT_DIR/final/final_news_video.mp4" 2>/dev/null
                if [ -f "$PROJECT_DIR/final/final_news_video.mp4" ]; then
                  echo "final_path=$PROJECT_DIR/final/final_news_video.mp4" >> $GITHUB_OUTPUT
                  echo "âœ… Manual FFmpeg integration successful"
                else
                  echo "âŒ Manual integration failed"
                fi
              fi
            fi
          else
            echo "âŒ No scene videos available for integration"
          fi

      - name: Quality assurance check
        id: quality-check
        run: |
          PROJECT_DIR="${{ needs.setup-and-info-gathering.outputs.project_dir }}"
          FINAL_VIDEO="$PROJECT_DIR/final/final_news_video.mp4"
          
          if [ -f "$FINAL_VIDEO" ]; then
            # Basic quality checks
            FILE_SIZE=$(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0)
            DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null || echo 0)
            
            QUALITY_SCORE=0
            
            # Size check (minimum 5MB for 60s video)
            if [ "$FILE_SIZE" -gt 5000000 ]; then
              QUALITY_SCORE=$((QUALITY_SCORE + 30))
            fi
            
            # Duration check (58-62 seconds)
            if (( $(echo "$DURATION >= 58 && $DURATION <= 62" | bc -l 2>/dev/null || echo 0) )); then
              QUALITY_SCORE=$((QUALITY_SCORE + 40))
            fi
            
            # Format validation
            if ffprobe "$FINAL_VIDEO" >/dev/null 2>&1; then
              QUALITY_SCORE=$((QUALITY_SCORE + 30))
            fi
            
            echo "score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
            echo "âœ… Quality check completed: Score $QUALITY_SCORE/100"
            
            # Create quality report
            {
              echo "# Final Video Quality Report"
              echo "- **File Size**: ${FILE_SIZE} bytes"
              echo "- **Duration**: ${DURATION} seconds" 
              echo "- **Quality Score**: ${QUALITY_SCORE}/100"
              echo "- **Status**: $([ $QUALITY_SCORE -gt 70 ] && echo 'PASS' || echo 'NEEDS_IMPROVEMENT')"
            } > "$PROJECT_DIR/final/quality_report.md"
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "âŒ Final video not available for quality check"
          fi

      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-news-video
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/final/

      - name: Upload complete project
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complete-news-video-project
          path: ${{ needs.setup-and-info-gathering.outputs.project_dir }}/

      - name: Final Progress Report
        if: always()
        run: |
          QUALITY_SCORE="${{ steps.quality-check.outputs.score }}"
          
          echo "## ðŸ“Š Phase 6: Final Integration & Quality Check" >> $GITHUB_STEP_SUMMARY
          if [ "$QUALITY_SCORE" -gt 70 ]; then
            echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: âš ï¸ Needs Improvement" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Quality Score**: ${QUALITY_SCORE}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Final Output**: 60-second professional news video" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Final Summary Report
  workflow-summary:
    runs-on: ubuntu-latest
    needs: [setup-and-info-gathering, content-structure, asset-generation, scene-video-generation, enhancement-processing, final-integration]
    if: always()
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "# ðŸŽ¬ News Video Creation Workflow - Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Workflow Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **Topic**: ${{ needs.setup-and-info-gathering.outputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Style**: ${{ inputs.style }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Language**: ${{ inputs.language }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Duration**: 60 seconds" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Phase Completion Status" >> $GITHUB_STEP_SUMMARY
          echo "1. **Information Gathering**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "2. **Content Structure**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "3. **Asset Generation**: $([ '${{ needs.asset-generation.result }}' = 'success' ] && echo 'âœ… Success' || echo 'âš ï¸ Partial')" >> $GITHUB_STEP_SUMMARY
          echo "4. **Scene Video Generation**: $([ '${{ needs.scene-video-generation.result }}' = 'success' ] && echo 'âœ… Success' || echo 'âš ï¸ Partial')" >> $GITHUB_STEP_SUMMARY
          echo "5. **Enhancement Processing**: $([ '${{ needs.enhancement-processing.result }}' = 'success' ] && echo 'âœ… Success' || echo 'âš ï¸ Partial')" >> $GITHUB_STEP_SUMMARY
          echo "6. **Final Integration**: $([ '${{ needs.final-integration.result }}' = 'success' ] && echo 'âœ… Success' || echo 'âš ï¸ Failed')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸŽ¯ Final Results" >> $GITHUB_STEP_SUMMARY
          FINAL_QUALITY="${{ needs.final-integration.outputs.quality_score }}"
          if [ -n "$FINAL_QUALITY" ] && [ "$FINAL_QUALITY" -gt 70 ]; then
            echo "- **Overall Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Quality Score**: ${FINAL_QUALITY}/100 (PASS)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Overall Status**: âš ï¸ Partial Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Quality Score**: ${FINAL_QUALITY:-0}/100" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“¦ Generated Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Complete Project**: \`complete-news-video-project\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Final Video**: \`final-news-video\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Scene Videos**: \`phase4-scene-*\` (12 scenes)" >> $GITHUB_STEP_SUMMARY
          echo "- **Assets**: \`phase3-assets-*\` (audio, images)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”§ Technical Implementation Highlights" >> $GITHUB_STEP_SUMMARY
          echo "- **URL Expiration Mitigation**: âœ… Immediate I2V conversion strategy" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Processing**: âœ… Matrix orchestration for scene generation" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Validation**: âœ… Enhanced file size and format validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Recovery**: âœ… Fallback methods for integration" >> $GITHUB_STEP_SUMMARY
          echo "- **Progressive Reporting**: âœ… Real-time status updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Meta-Workflow v12 - Improved Version*" >> $GITHUB_STEP_SUMMARY