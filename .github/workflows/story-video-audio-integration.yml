---
name: Story Video Audio Integration Workflow
run-name: ${{ github.actor }} creates story-video-audio content 🎬🎵

on:
  workflow_dispatch:
    inputs:
      story_prompt:
        description: 'ストーリープロンプト'
        required: true
        type: string
      visual_style:
        description: '映像スタイル'
        required: false
        type: choice
        options:
          - realistic
          - anime
          - artistic
        default: realistic
      music_mood:
        description: 'BGMの雰囲気'
        required: false
        type: choice
        options:
          - calm
          - dramatic
          - uplifting
        default: calm
      voice_type:
        description: 'ナレーション音声タイプ'
        required: false
        type: choice
        options:
          - male
          - female
          - neutral
        default: neutral

jobs:
  # Step 1: ストーリーベース画像生成
  generate-story-image:
    runs-on: ubuntu-latest
    outputs:
      image_path: ${{ steps.t2i.outputs.image_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Story Image (T2I)
        id: t2i
        run: |
          echo "🎨 Generating story image..."
          echo "Story: ${{ github.event.inputs.story_prompt }}"
          echo "Style: ${{ github.event.inputs.visual_style }}"
          
          # T2I generation using MCP
          mkdir -p outputs/images
          IMAGE_OUTPUT="outputs/images/story-$(date +%Y%m%d-%H%M%S).png"
          
          # Simulate T2I generation (replace with actual MCP call)
          echo "📸 Story image generated: $IMAGE_OUTPUT"
          echo "image_path=$IMAGE_OUTPUT" >> $GITHUB_OUTPUT

  # Step 2: 画像から動画生成
  generate-video:
    needs: generate-story-image
    runs-on: ubuntu-latest
    outputs:
      video_path: ${{ steps.i2v.outputs.video_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Video from Image (I2V)
        id: i2v
        run: |
          echo "🎬 Generating video from story image..."
          echo "Input image: ${{ needs.generate-story-image.outputs.image_path }}"
          
          # I2V generation using MCP
          mkdir -p outputs/videos
          VIDEO_OUTPUT="outputs/videos/story-$(date +%Y%m%d-%H%M%S).mp4"
          
          # Simulate I2V generation (replace with actual MCP call)
          echo "🎥 Story video generated: $VIDEO_OUTPUT"
          echo "video_path=$VIDEO_OUTPUT" >> $GITHUB_OUTPUT

  # Step 3: BGM生成
  generate-bgm:
    runs-on: ubuntu-latest
    outputs:
      bgm_path: ${{ steps.t2m.outputs.bgm_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Background Music (T2M)
        id: t2m
        run: |
          echo "🎵 Generating background music..."
          echo "Story: ${{ github.event.inputs.story_prompt }}"
          echo "Mood: ${{ github.event.inputs.music_mood }}"
          
          # T2M generation using MCP
          mkdir -p outputs/audio
          BGM_OUTPUT="outputs/audio/bgm-$(date +%Y%m%d-%H%M%S).mp3"
          
          # Simulate T2M generation (replace with actual MCP call)
          echo "🎶 Background music generated: $BGM_OUTPUT"
          echo "bgm_path=$BGM_OUTPUT" >> $GITHUB_OUTPUT

  # Step 4: ナレーション生成
  generate-narration:
    runs-on: ubuntu-latest
    outputs:
      narration_path: ${{ steps.t2a.outputs.narration_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Narration (T2A)
        id: t2a
        run: |
          echo "🎙️ Generating narration..."
          echo "Story: ${{ github.event.inputs.story_prompt }}"
          echo "Voice: ${{ github.event.inputs.voice_type }}"
          
          # T2A generation using MCP
          mkdir -p outputs/audio
          NARRATION_OUTPUT="outputs/audio/narration-$(date +%Y%m%d-%H%M%S).mp3"
          
          # Simulate T2A generation (replace with actual MCP call)
          echo "🗣️ Narration generated: $NARRATION_OUTPUT"
          echo "narration_path=$NARRATION_OUTPUT" >> $GITHUB_OUTPUT

  # Step 5: 最終統合
  integrate-final-content:
    needs: [generate-video, generate-bgm, generate-narration]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Integrate All Components
        run: |
          echo "🎭 Integrating all story components..."
          echo "Video: ${{ needs.generate-video.outputs.video_path }}"
          echo "BGM: ${{ needs.generate-bgm.outputs.bgm_path }}"
          echo "Narration: ${{ needs.generate-narration.outputs.narration_path }}"
          
          # Final integration process
          mkdir -p outputs/final
          FINAL_OUTPUT="outputs/final/story-complete-$(date +%Y%m%d-%H%M%S).mp4"
          
          echo "🎬 Final story video with audio: $FINAL_OUTPUT"
          echo "✅ Story-Video-Audio integration completed!"
      
      - name: Upload Final Content
        uses: actions/upload-artifact@v4
        with:
          name: story-video-audio-${{ github.run_number }}
          path: outputs/
          retention-days: 30
