name: Stepback Response Handler
run-name: üîÑ Processing stepback response from Issue #${{ github.event.issue.number }}

on:
  issues:
    types: [edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # IssueÁ∑®ÈõÜÊ§úÁü•„Å®„Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØÂõûÁ≠î„ÅÆËß£Êûê
  detect-stepback-response:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'stepback-questions') || contains(github.event.issue.labels.*.name, 'awaiting-user-response')
    outputs:
      is_stepback_response: ${{ steps.detect.outputs.is_stepback_response }}
      user_answers: ${{ steps.detect.outputs.user_answers }}
      original_request: ${{ steps.detect.outputs.original_request }}
      workflow_type: ${{ steps.detect.outputs.workflow_type }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Detect Stepback Response in Same Issue
        id: detect
        run: |
          echo "üîç Checking if this Issue contains stepback response..."
          
          # Issue„ÅÆÂÜÖÂÆπ„Å®„É©„Éô„É´„ÇíÁ¢∫Ë™ç
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          echo "Issue #${{ github.event.issue.number }}: $ISSUE_TITLE"
          echo "Issue Labels: $ISSUE_LABELS"
          
          # „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™ÂïèÂØæÂøúIssue„Åã„Å©„ÅÜ„Åã„ÇíÁ¢∫Ë™ç
          if echo "$ISSUE_LABELS" | grep -q -E "(stepback-questions|awaiting-user-response)"; then
            echo "‚úÖ This Issue has stepback questions labels"
            
            # IssueÊú¨Êñá„Åã„Çâ„É¶„Éº„Ç∂„ÉºÂõûÁ≠îÈÉ®ÂàÜ„ÇíÊ§úÁ¥¢
            if echo "$ISSUE_BODY" | grep -q "## üìã „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™Âïè„Å∏„ÅÆÂõûÁ≠î"; then
              echo "‚úÖ User answers section found in Issue body"
              
              # „É¶„Éº„Ç∂„ÉºÂõûÁ≠îÈÉ®ÂàÜ„ÇíÊäΩÂá∫
              USER_ANSWERS=$(echo "$ISSUE_BODY" | sed -n '/## üìã „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™Âïè„Å∏„ÅÆÂõûÁ≠î/,$p')
              
              # ÂõûÁ≠î„ÅåÁ©∫„Åß„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÉÜ„Ç≠„Çπ„Éà„Åß„ÅØ„Å™„ÅÑÔºâ
              if echo "$USER_ANSWERS" | grep -q -v "Ôºà„Åì„Åì„Å´ÂõûÁ≠î„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ" && \
                 echo "$USER_ANSWERS" | grep -q -E "(Ë≥™Âïè[0-9]+„Å∏„ÅÆÂõûÁ≠î|„Å∏„ÅÆÂõûÁ≠î)" && \
                 ! echo "$USER_ANSWERS" | grep -q -E "^\s*$"; then
                echo "‚úÖ Valid user answers detected"
                
                # ÂÖÉ„ÅÆ„É™„ÇØ„Ç®„Çπ„ÉàÈÉ®ÂàÜ„ÇÇÊäΩÂá∫
                ORIGINAL_REQUEST=$(echo "$ISSUE_BODY" | sed -n '1,/## üìã „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™Âïè„Å∏„ÅÆÂõûÁ≠î/p' | head -20)
                
                # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„ÇíÊé®Ê∏¨ÔºàIssue„Çø„Ç§„Éà„É´„ÇÑÂÜÖÂÆπ„Åã„ÇâÔºâ
                if echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "video\|ÂãïÁîª"; then
                  WORKFLOW_TYPE="video-generation"
                elif echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "image\|ÁîªÂÉè"; then
                  WORKFLOW_TYPE="image-generation"
                elif echo "$ISSUE_TITLE $ISSUE_BODY" | grep -qi "audio\|music\|Èü≥Ê•Ω"; then
                  WORKFLOW_TYPE="audio-generation"
                else
                  WORKFLOW_TYPE="custom"
                fi
                
                echo "is_stepback_response=true" >> $GITHUB_OUTPUT
                echo "user_answers<<EOF" >> $GITHUB_OUTPUT
                echo "$USER_ANSWERS" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
                echo "original_request<<EOF" >> $GITHUB_OUTPUT
                echo "$ORIGINAL_REQUEST" >> $GITHUB_OUTPUT
                echo "EOF" >> $GITHUB_OUTPUT
                echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT
                
                echo "üéØ Stepback response detected in same Issue - preparing to resume workflow"
              else
                echo "‚ö†Ô∏è User answers section is empty or contains placeholder text"
                echo "is_stepback_response=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ÑπÔ∏è User answers section not found - checking if answers are in comments"
              
              # „Ç≥„É°„É≥„Éà„Åß„ÅÆÂõûÁ≠î„ÇÇÁ¢∫Ë™çÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
              echo "is_stepback_response=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ÑπÔ∏è This Issue is not related to stepback questions"
            echo "is_stepback_response=false" >> $GITHUB_OUTPUT
          fi

  # „É¶„Éº„Ç∂„ÉºÂõûÁ≠î„ÅÆËß£Êûê„Å®„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê
  process-stepback-response:
    needs: detect-stepback-response
    runs-on: ubuntu-latest
    if: needs.detect-stepback-response.outputs.is_stepback_response == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Process User Answers with Claude Code
        id: process
        run: |
          echo "ü§ñ Processing user answers with Claude Code..."
          
          mkdir -p .meta/stepback-response
          
          # ÂÖÉ„É™„ÇØ„Ç®„Çπ„Éà„Å®„É¶„Éº„Ç∂„ÉºÂõûÁ≠î„Çí‰øùÂ≠ò
          cat > .meta/stepback-response/original-request.md << 'EOF'
          ${{ needs.detect-stepback-response.outputs.original_request }}
          EOF
          
          cat > .meta/stepback-response/user-answers.md << 'EOF'
          ${{ needs.detect-stepback-response.outputs.user_answers }}
          EOF
          
          # ÂõûÁ≠îËß£Êûê„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
          cat > .meta/stepback-response/analysis-prompt.md << 'EOF'
          # „É¶„Éº„Ç∂„ÉºÂõûÁ≠î„ÅÆËß£Êûê„Å®Ë©≥Á¥∞ÂåñË¶ÅÊ±ÇÁîüÊàê
          
          ÂÖÉ„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„Å´ÂØæ„Åó„Å¶„É¶„Éº„Ç∂„Éº„Åã„ÇâËøΩÂä†„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÅåÊèê‰æõ„Åï„Çå„Åæ„Åó„Åü„ÄÇ
          „Åì„Çå„Çâ„ÅÆÊÉÖÂ†±„ÇíÁµ±Âêà„Åó„Å¶„ÄÅ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„Å´ÂøÖË¶Å„Å™Ë©≥Á¥∞Âåñ„Åï„Çå„ÅüË¶ÅÊ±Ç„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          ## ÂÖÉ„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà
          EOF
          
          cat .meta/stepback-response/original-request.md >> .meta/stepback-response/analysis-prompt.md
          
          cat >> .meta/stepback-response/analysis-prompt.md << 'EOF'
          
          ## „É¶„Éº„Ç∂„Éº„Åã„Çâ„ÅÆËøΩÂä†ÂõûÁ≠î
          EOF
          
          cat .meta/stepback-response/user-answers.md >> .meta/stepback-response/analysis-prompt.md
          
          cat >> .meta/stepback-response/analysis-prompt.md << 'EOF'
          
          ## Ëß£ÊûêÊåáÁ§∫
          
          1. **ÂõûÁ≠îÂÜÖÂÆπ„ÅÆËß£Èáà**: ÂêÑË≥™Âïè„Å∏„ÅÆÂõûÁ≠î„ÇíÁêÜËß£„Åó„ÄÅÊÑèÂõ≥„ÇíÊòéÁ¢∫Âåñ
          2. **Ë©≥Á¥∞ÂåñË¶ÅÊ±Ç„ÅÆÁîüÊàê**: ÂõûÁ≠î„Å´Âü∫„Å•„ÅÑ„Å¶ÂÖ∑‰ΩìÁöÑ„Å™Ë¶ÅÊ±Ç„ÇíÊßãÊàê
          3. **ÊäÄË°ì‰ªïÊßò„ÅÆÊäΩÂá∫**: ÂìÅË≥™Ë®≠ÂÆö„ÄÅÂΩ¢Âºè„ÄÅÂá¶ÁêÜ„Éï„É≠„Éº„Å™„Å©„ÇíÊòéÁ¢∫Âåñ
          4. **„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ**: ‰∏çÊòé„Å™ÈÉ®ÂàÜ„ÅØÂêàÁêÜÁöÑ„Å™‰ªÆÂÆö„ÅßË£úÂÆå
          
          ## ÂøÖÈ†àÂá∫Âäõ
          
          ‰ª•‰∏ã„ÅÆJSON„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          ```bash
          mkdir -p .meta/stepback-response
          cat > .meta/stepback-response/enhanced-requirements.json << 'EOFJSON'
          {
            "enhanced_request": "Ë©≥Á¥∞Âåñ„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±Ç",
            "technical_specs": {
              "image_quality": "high/medium/fast",
              "video_format": "MP4/AVI/etc",
              "audio_format": "MP3/WAV/etc",
              "processing_priority": "quality/speed/balanced"
            },
            "processing_flow": [
              "step1: „ÉÜ„Ç≠„Çπ„Éà‚ÜíÁîªÂÉèÁîüÊàê",
              "step2: ÁîªÂÉè‚ÜíÂãïÁîªÁîüÊàê",
              "step3: „ÉÜ„Ç≠„Çπ„Éà‚ÜíÈü≥Ê•ΩÁîüÊàê",
              "step4: ÂãïÁîª‚ÜíÈü≥Â£∞ÊäΩÂá∫"
            ],
            "user_preferences": {
              "quality_vs_speed": "quality/speed/balanced",
              "output_formats": ["format1", "format2"],
              "special_requirements": ["req1", "req2"]
            },
            "confidence_level": "high/medium/low"
          }
          EOFJSON
          ```
          EOF
          
          # Claude Code „ÅßÂõûÁ≠îËß£ÊûêÂÆüË°å
          if claude --continue "$(cat .meta/stepback-response/analysis-prompt.md)" --output-format text; then
            echo "‚úÖ User answer analysis completed"
            
            if [ -f ".meta/stepback-response/enhanced-requirements.json" ]; then
              echo "‚úÖ Enhanced requirements generated"
              
              # ÁîüÊàê„Åï„Çå„ÅüË©≥Á¥∞ÂåñË¶ÅÊ±Ç„ÇíË°®Á§∫
              echo "üìã Enhanced Requirements:"
              cat .meta/stepback-response/enhanced-requirements.json | jq '.'
              
              echo "enhanced_requirements_available=true" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Enhanced requirements not generated - using fallback"
              echo "enhanced_requirements_available=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå User answer analysis failed"
            echo "enhanced_requirements_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Enhanced Workflow Generation
        id: trigger
        run: |
          echo "üöÄ Triggering enhanced workflow generation..."
          
          WORKFLOW_TYPE="${{ needs.detect-stepback-response.outputs.workflow_type }}"
          
          # Ë©≥Á¥∞Âåñ„Åï„Çå„ÅüË¶ÅÊ±Ç„Çí‰ΩøÁî®„Åó„Å¶„É°„Çø„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÂÜçÂÆüË°å
          if [ -f ".meta/stepback-response/enhanced-requirements.json" ]; then
            ENHANCED_DESC=$(jq -r '.enhanced_request' .meta/stepback-response/enhanced-requirements.json)
            
            echo "üéØ Triggering meta workflow with enhanced requirements..."
            
            if command -v gh &> /dev/null; then
              gh workflow run kamuicode-meta-generator.yml \
                --field workflow_type="$WORKFLOW_TYPE" \
                --field description="$ENHANCED_DESC (Enhanced by Stepback Response)" \
                --field retry_mode=false
              
              echo "‚úÖ Enhanced workflow generation triggered"
              
              # Âêå‰∏ÄIssueÂÜÖ„Å´ÈÄ≤Êçó„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
              gh issue comment ${{ github.event.issue.number }} \
                --body "üöÄ **„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„ÇíÂÜçÈñã„Åó„Åæ„Åó„Åü**

          „ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î„ÇíÂàÜÊûê„Åó„ÄÅË©≥Á¥∞Âåñ„Åï„Çå„ÅüË¶ÅÊ±Ç„Åß„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê‰∏≠„Åß„Åô„ÄÇ

          **üìä Âá¶ÁêÜÁä∂Ê≥Å„ÅÆÊõ¥Êñ∞:**
          - [x] ÂàùÊúüÂàÜÊûêÂÆå‰∫Ü  
          - [x] „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™ÂïèÁîüÊàêÂÆå‰∫Ü
          - [x] „É¶„Éº„Ç∂„ÉºÂõûÁ≠îÂèó‰ø°ÂÆå‰∫Ü ‚ú®
          - [x] ÂõûÁ≠îÂÜÖÂÆπËß£ÊûêÂÆå‰∫Ü ‚ú®
          - [x] Ë©≥Á¥∞ÂåñË¶ÅÊ±ÇÁîüÊàêÂÆå‰∫Ü ‚ú®
          - [x] „ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàêÈñãÂßã üëà **ÁèæÂú®„Åì„Åì**
          - [ ] „ÉØ„Éº„ÇØ„Éï„É≠„ÉºÂÆåÊàê„ÉªÈÖçÁΩÆ

          **üéØ Ë©≥Á¥∞Âåñ„Åï„Çå„ÅüË¶ÅÊ±Ç:**
          \`\`\`
          $ENHANCED_DESC
          \`\`\`

          **‚è±Ô∏è ‰∫àÊÉ≥ÂÆå‰∫ÜÊôÇÈñì:** 5-10ÂàÜÁ®ãÂ∫¶

          ÁîüÊàêÂÆå‰∫ÜÂæå„ÄÅÁµêÊûú„ÇíÂÜçÂ∫¶„Åì„ÅÆIssue„Å´„ÅîÂ†±Âëä„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ

          ü§ñ *Meta Workflow Generator - Enhanced by Stepback Response*" \
                2>/dev/null || echo "‚ö†Ô∏è Failed to post progress comment"
              
            else
              echo "‚ö†Ô∏è gh CLI not available"
            fi
          else
            echo "‚ö†Ô∏è Enhanced requirements not available - using basic retry"
          fi

      - name: Update Issue Status
        run: |
          echo "üìù Updating Issue status..."
          
          # Issue„ÅÆ„É©„Éô„É´„ÇíÊõ¥Êñ∞ÔºàÂá¶ÁêÜ‰∏≠„ÇíÁ§∫„ÅôÔºâ
          if command -v gh &> /dev/null; then
            gh issue edit ${{ github.event.issue.number }} \
              --add-label "processing,workflow-generation,enhanced-by-stepback" \
              --remove-label "awaiting-user-response" \
              2>/dev/null || echo "‚ö†Ô∏è Failed to update labels"
              
            echo "‚úÖ Issue labels updated to show processing status"
          fi
          
          echo "‚úÖ Stepback response processing completed for same Issue"