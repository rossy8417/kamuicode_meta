name: Workflow Companion Monitor
run-name: ğŸ‘¥ Monitoring workflow for run ${{ github.event.workflow_run.run_number || 'manual' }}

on:
  workflow_run:
    workflows: 
      - "*"
      # å…¨ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç›£è¦–
    types:
      - requested
      - completed
  workflow_dispatch:
    inputs:
      target_run_id:
        description: 'ç›£è¦–å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼RUN ID'
        required: false
        type: string
      monitoring_enabled:
        description: 'ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é€£å‹•ç›£è¦–
  companion-monitoring:
    runs-on: ubuntu-latest
    # pushã‚¤ãƒ™ãƒ³ãƒˆã‚’æ˜ç¤ºçš„ã«é™¤å¤–
    if: github.event_name != 'push' && (github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_enabled == 'true'))
    outputs:
      critical_issue: ${{ steps.monitor.outputs.critical_issue }}
      immediate_fix_needed: ${{ steps.monitor.outputs.immediate_fix_needed }}
      issue_severity: ${{ steps.monitor.outputs.issue_severity }}
      affected_systems: ${{ steps.monitor.outputs.affected_systems }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Companion Monitoring Loop
        id: monitor
        run: |
          echo "ğŸ‘¥ Starting companion monitoring for main workflow..."
          
          # ç›£è¦–å¯¾è±¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼RUN IDã‚’ç‰¹å®š
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TARGET_RUN_ID="${{ github.event.workflow_run.id }}"
            TARGET_RUN_NUMBER="${{ github.event.workflow_run.run_number }}"
          else
            TARGET_RUN_ID="${{ github.event.inputs.target_run_id }}"
            TARGET_RUN_NUMBER="manual"
          fi
          
          echo "ğŸ¯ Monitoring target: Run ID $TARGET_RUN_ID (Run #$TARGET_RUN_NUMBER)"
          
          mkdir -p generated/monitoring/$TARGET_RUN_NUMBER
          
          CRITICAL_ISSUE=false
          IMMEDIATE_FIX_NEEDED=false
          ISSUE_SEVERITY="normal"
          AFFECTED_SYSTEMS=""
          
          # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œäº†ã¾ã§ç¶™ç¶šç›£è¦–
          echo "ğŸ”„ Starting continuous monitoring loop..."
          MONITORING_START=$(date +%s)
          MONITORING_DURATION=0
          CHECK_COUNT=0
          
          while true; do
            CHECK_COUNT=$((CHECK_COUNT + 1))
            CURRENT_TIME=$(date +%s)
            MONITORING_DURATION=$((CURRENT_TIME - MONITORING_START))
            
            echo "ğŸ” Check #$CHECK_COUNT - Monitoring duration: ${MONITORING_DURATION}s"
            
            # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
            if command -v gh &> /dev/null && [ -n "$TARGET_RUN_ID" ]; then
              WORKFLOW_STATUS=$(gh run view $TARGET_RUN_ID --json status,conclusion --jq '.status + ":" + (.conclusion // "null")' 2>/dev/null || echo "unknown:null")
              echo "ğŸ“Š Main workflow status: $WORKFLOW_STATUS"
              
              case "$WORKFLOW_STATUS" in
                "completed:success")
                  echo "âœ… Main workflow completed successfully - ending monitoring"
                  break
                  ;;
                "completed:failure")
                  echo "âŒ Main workflow failed - flagging for intervention"
                  CRITICAL_ISSUE=true
                  IMMEDIATE_FIX_NEEDED=true
                  ISSUE_SEVERITY="high"
                  AFFECTED_SYSTEMS="main-workflow-failure"
                  break
                  ;;
                "completed:cancelled")
                  echo "ğŸš« Main workflow was cancelled - ending monitoring"
                  break
                  ;;
                "in_progress:null"|"queued:null")
                  echo "ğŸ”„ Main workflow still running - continuing monitoring"
                  ;;
                *)
                  echo "â“ Unknown workflow status: $WORKFLOW_STATUS"
                  ;;
              esac
            else
              echo "âš ï¸ Cannot check main workflow status"
            fi
            
            # æœ€å¤§ç›£è¦–æ™‚é–“ã®åˆ¶é™ï¼ˆ5åˆ†ã«çŸ­ç¸®ï¼‰
            if [ $MONITORING_DURATION -gt 300 ]; then
              echo "â° Maximum monitoring time reached (5min) - ending monitoring"
              break
            fi
            
            # 60ç§’é–“éš”ã§ç›£è¦–ï¼ˆè² è·è»½æ¸›ï¼‰
            echo "ğŸ’¤ Waiting 60 seconds before next check..."
            sleep 60
            
          done
          
          echo "ğŸ Monitoring completed after $CHECK_COUNT checks (${MONITORING_DURATION}s)"
          
          # ç›£è¦–çµæœã®è¨˜éŒ²
          cat > generated/monitoring/$TARGET_RUN_NUMBER/monitoring-session.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "target_run_id": "$TARGET_RUN_ID",
            "target_run_number": "$TARGET_RUN_NUMBER",
            "monitoring_duration_seconds": $MONITORING_DURATION,
            "check_count": $CHECK_COUNT,
            "final_status": "$WORKFLOW_STATUS",
            "critical_issue": $CRITICAL_ISSUE,
            "immediate_fix_needed": $IMMEDIATE_FIX_NEEDED,
            "issue_severity": "$ISSUE_SEVERITY",
            "affected_systems": "$AFFECTED_SYSTEMS"
          }
          EOF
          
          # GitHub Actions ã®å‡ºåŠ›ã«è¨­å®š
          echo "critical_issue=$CRITICAL_ISSUE" >> $GITHUB_OUTPUT
          echo "immediate_fix_needed=$IMMEDIATE_FIX_NEEDED" >> $GITHUB_OUTPUT
          echo "issue_severity=$ISSUE_SEVERITY" >> $GITHUB_OUTPUT
          echo "affected_systems=$AFFECTED_SYSTEMS" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_ISSUE" = true ]; then
            echo "ğŸš¨ CRITICAL ISSUE DETECTED during monitoring"
          else
            echo "âœ… Monitoring completed successfully"
          fi

  # å•é¡Œæ¤œå‡ºæ™‚ã®è‡ªå‹•å¯¾å¿œ
  auto-response:
    needs: companion-monitoring
    runs-on: ubuntu-latest
    if: needs.companion-monitoring.outputs.immediate_fix_needed == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Trigger Auto-Fix Workflow
        run: |
          echo "ğŸš¨ Critical issue detected - triggering auto-fix workflow..."
          
          if command -v gh &> /dev/null; then
            gh workflow run auto-fix-deployment.yml \
              --field force_analysis=true \
              --field fix_mode=emergency 2>/dev/null || echo "Auto-fix trigger failed"
          fi
          
          echo "ğŸ”§ Auto-fix workflow triggered for issue: ${{ needs.companion-monitoring.outputs.affected_systems }}"

  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€šçŸ¥
  artifact-download-notification:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.action == 'completed'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check for Artifacts
        id: check-artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“¦ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ã‚’æ¤œçŸ¥: ${{ github.event.workflow_run.name }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®å­˜åœ¨ç¢ºèª
          ARTIFACT_COUNT=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts --jq '.total_count')
          
          if [ "$ARTIFACT_COUNT" -gt 0 ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo "âœ… $ARTIFACT_COUNT å€‹ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            
            # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæƒ…å ±ã‚’å–å¾—
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts --jq '.artifacts[] | "- \(.name) (\(.size_in_bytes/1048576 | round)MB)"')
            echo "artifacts<<EOF" >> $GITHUB_OUTPUT
            echo "$ARTIFACTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
          
      - name: Create Download Notification Issue
        if: steps.check-artifacts.outputs.has_artifacts == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‹ã‚‰å®‰å…¨ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ç”Ÿæˆ
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          PROJECT_NAME=$(echo "$WORKFLOW_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | cut -c1-50)
          
          ISSUE_BODY=$(cat << 'EOF'
          ## ğŸ‰ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†é€šçŸ¥

          ### ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±
          - **åå‰**: ${{ github.event.workflow_run.name }}
          - **Runç•ªå·**: ${{ github.event.workflow_run.run_number }}
          - **Run ID**: ${{ github.event.workflow_run.id }}
          - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ
          - **å®Œäº†æ™‚åˆ»**: ${{ github.event.workflow_run.updated_at }}

          ### ğŸ“¦ ç”Ÿæˆã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ
          ${{ steps.check-artifacts.outputs.artifacts }}

          ### ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•

          #### æ–¹æ³•1: è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          ```bash
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ
          ./scripts/download-workflow-artifacts.sh
          ```

          #### æ–¹æ³•2: GitHub CLIã§ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          ```bash
          # å…¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          gh run download ${{ github.event.workflow_run.id }} -D projects/run-${{ github.event.workflow_run.run_number }}-PROJECT_NAME
          ```

          #### æ–¹æ³•3: ç‰¹å®šã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã¿
          ```bash
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
          gh run view ${{ github.event.workflow_run.id }}
          
          # ç‰¹å®šã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          gh run download ${{ github.event.workflow_run.id }} -n "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå"
          ```

          ---
          *ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã¯ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚*
          EOF
          )
          
          # PROJECT_NAMEã‚’ç½®æ›
          ISSUE_BODY=$(echo "$ISSUE_BODY" | sed "s/PROJECT_NAME/${PROJECT_NAME}/g")
          
          # Issueã‚’ä½œæˆ
          gh issue create \
            --title "ğŸ“¥ [è‡ªå‹•é€šçŸ¥] ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæº–å‚™å®Œäº†: ${{ github.event.workflow_run.name }} #${{ github.event.workflow_run.run_number }}" \
            --body "$ISSUE_BODY" \
            --label "download-ready,auto-generated" || echo "Issueä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜ã®å¯èƒ½æ€§ï¼‰"