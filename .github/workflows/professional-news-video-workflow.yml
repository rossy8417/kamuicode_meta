name: "æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"

on:
  workflow_dispatch:
    inputs:
      video_title:
        description: "å‹•ç”»ã®ã‚¿ã‚¤ãƒˆãƒ«"
        required: true
        default: "ä»Šæ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹"
        type: string
      
      duration:
        description: "å‹•ç”»ã®é•·ã•"
        required: true
        default: "60s"
        type: choice
        options:
          - "15s"
          - "30s" 
          - "60s"
          - "90s"
          - "3min"
          - "5min"
          - "10min"
          - "15min"
          - "30min"
      
      target_platform:
        description: "é…ä¿¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ "
        required: true
        default: "youtube"
        type: choice
        options:
          - "youtube"
          - "instagram"
          - "tiktok"
          - "twitter"
          - "linkedin"
          - "web"
          - "broadcast"
      
      content_type:
        description: "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç¨®é¡"
        required: true
        default: "news"
        type: choice
        options:
          - "promotional"
          - "educational"
          - "entertainment"
          - "documentary"
          - "tutorial"
          - "news"
          - "music_video"
      
      visual_style:
        description: "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«"
        required: true
        default: "documentary"
        type: choice
        options:
          - "cinematic"
          - "anime"
          - "documentary"
          - "corporate"
          - "vlog"
          - "artistic"
          - "minimalist"
      
      narration_voice:
        description: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°"
        required: true
        default: "female_professional"
        type: choice
        options:
          - "male_professional"
          - "female_professional"
          - "male_casual"
          - "female_casual"
          - "ai_neutral"
          - "child"
          - "elderly"
      
      news_topic:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯ï¼ˆå®Ÿè¡Œæ™‚æŒ‡å®šï¼‰"
        required: true
        default: "æœ€æ–°æŠ€è¡“å‹•å‘"
        type: string
      
      news_period:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†æœŸé–“"
        required: false
        default: "24h"
        type: choice
        options:
          - "6h"
          - "12h"
          - "24h"
          - "48h"
          - "1week"
      
      news_category:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼"
        required: false
        default: "technology"
        type: choice
        options:
          - "general"
          - "business"
          - "entertainment"
          - "health"
          - "science"
          - "sports"
          - "technology"

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: 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

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.create-project.outputs.project_dir }}
      timestamp: ${{ steps.create-project.outputs.timestamp }}
      scene_count: ${{ steps.create-project.outputs.scene_count }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        id: create-project
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/news-video-${TIMESTAMP}"
          
          mkdir -p "$PROJECT_DIR"/{metadata,logs,media/{images,videos,audio},final}
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "scene_count=12" >> $GITHUB_OUTPUT
          
          echo "## ğŸ¬ æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: $PROJECT_DIR" >> $GITHUB_STEP_SUMMARY
          echo "- **é–‹å§‹æ™‚åˆ»**: $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
          echo "- **äºˆå®šã‚·ãƒ¼ãƒ³æ•°**: 12" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  phase1-news-collection:
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      news_data_path: ${{ steps.collect-news.outputs.news_data_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åé›†ãƒ»ä¿¡é ¼æ€§è©•ä¾¡
        id: collect-news
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          NEWS_TOPIC="${{ inputs.news_topic }}"
          NEWS_PERIOD="${{ inputs.news_period }}"
          NEWS_CATEGORY="${{ inputs.news_category }}"
          
          COLLECTION_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åé›†ã‚¿ã‚¹ã‚¯:
          - ãƒˆãƒ”ãƒƒã‚¯: ${NEWS_TOPIC}
          - æœŸé–“: ${NEWS_PERIOD}
          - ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${NEWS_CATEGORY}
          
          è¤‡æ•°ã®ä¿¡é ¼æ€§ã®é«˜ã„æƒ…å ±æºï¼ˆNewsAPIã€Redditã€arXivç­‰ï¼‰ã‹ã‚‰æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’åé›†ã—ã€ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãã ã•ã„:
          1. æœ€ä½3ã¤ã®ç•°ãªã‚‹æƒ…å ±æºã‹ã‚‰åé›†
          2. ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢70%ä»¥ä¸Šã®æƒ…å ±ã®ã¿æ¡ç”¨
          3. æƒ…å ±æºURLã¨ç™ºä¿¡æ—¥æ™‚ã‚’æ˜è¨˜
          4. çµæœã‚’${PROJECT_DIR}/metadata/news_data.json ã«ä¿å­˜
          5. 60ç§’å‹•ç”»ç”¨ã«è¦ç´„ã•ã‚ŒãŸå†…å®¹ã‚‚å«ã‚ã‚‹"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__external-newsapi-search__newsapi_search,mcp__external-reddit-search__reddit_search,WebSearch,Write" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$COLLECTION_PROMPT"
          
          echo "news_data_path=${PROJECT_DIR}/metadata/news_data.json" >> $GITHUB_OUTPUT
          
          echo "## ğŸ“° Phase 1: ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åé›†" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡ãƒˆãƒ”ãƒƒã‚¯**: ${NEWS_TOPIC}" >> $GITHUB_STEP_SUMMARY
          if [ -f "${PROJECT_DIR}/metadata/news_data.json" ]; then
            echo "- **åé›†çµæœ**: âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **åé›†çµæœ**: âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Phase1 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase1-news-data
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  phase2-script-creation:
    runs-on: ubuntu-latest
    needs: [setup, phase1-news-collection]
    outputs:
      script_path: ${{ steps.create-script.outputs.script_path }}
      narration_path: ${{ steps.create-script.outputs.narration_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Phase1 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase1-news-data
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹æ§‹æˆãƒ»å°æœ¬ä½œæˆ
        id: create-script
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          NEWS_DATA_PATH="${{ needs.phase1-news-collection.outputs.news_data_path }}"
          DURATION="${{ inputs.duration }}"
          
          if [ ! -f "$NEWS_DATA_PATH" ]; then
            echo "âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $NEWS_DATA_PATH"
            echo '{"error": "news data not found"}' > "${PROJECT_DIR}/metadata/news_data.json"
            NEWS_DATA_PATH="${PROJECT_DIR}/metadata/news_data.json"
          fi
          
          SCRIPT_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹å°æœ¬ä½œæˆã‚¿ã‚¹ã‚¯:
          åé›†ã•ã‚ŒãŸãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±: $(cat "$NEWS_DATA_PATH")
          
          ${DURATION}å‹•ç”»ç”¨ã«ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„:
          
          è¦ä»¶:
          1. è¦–è´è€…å¿ƒç†ã‚’è€ƒæ…®ã—ãŸæ§‹æˆï¼ˆæœ€åˆã®8ç§’ã§80%ã®è¦–è´ç¶™ç¶šï¼‰
          2. æƒ…å ±éšå±¤åŒ–ï¼ˆé‡è¦åº¦é †é…ç½®ï¼‰
          3. æ„Ÿæƒ…çš„ã‚¢ãƒ¼ã‚¯ï¼ˆSetupâ†’Conflictâ†’Resolutionï¼‰ã®é©ç”¨
          4. 5W1Hã®å®Œå…¨ãªæç¤º
          5. è‡ªç„¶ãªæ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          6. 12ã‚·ãƒ¼ãƒ³åˆ†ã®è©³ç´°ãªæ§‹æˆ
          
          å‡ºåŠ›:
          - ${PROJECT_DIR}/metadata/script.md: å°æœ¬
          - ${PROJECT_DIR}/metadata/scene_breakdown.json: ã‚·ãƒ¼ãƒ³åˆ¥è©³ç´°æ§‹æˆ
          - ${PROJECT_DIR}/metadata/narration_text.txt: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write" \
            --max-turns 30 \
            --permission-mode "acceptEdits" \
            -p "$SCRIPT_PROMPT"
          
          echo "script_path=${PROJECT_DIR}/metadata/script.md" >> $GITHUB_OUTPUT
          echo "narration_path=${PROJECT_DIR}/metadata/narration_text.txt" >> $GITHUB_OUTPUT
          
          echo "## ğŸ“ Phase 2: ãƒ‹ãƒ¥ãƒ¼ã‚¹æ§‹æˆãƒ»å°æœ¬ä½œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
          if [ -f "${PROJECT_DIR}/metadata/script.md" ]; then
            echo "- **å°æœ¬**: âœ… ä½œæˆæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **å°æœ¬**: âš ï¸ æœªä½œæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "${PROJECT_DIR}/metadata/narration_text.txt" ]; then
            echo "- **ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿**: âœ… ä½œæˆæ¸ˆã¿" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸç¨¿**: âš ï¸ æœªä½œæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Phase2 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase2-script-data
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  phase3-parallel-assets:
    runs-on: ubuntu-latest
    needs: [setup, phase2-script-creation]
    outputs:
      narration_audio_path: ${{ steps.narration.outputs.audio_path }}
      anchor_character_path: ${{ steps.character.outputs.character_path }}
      studio_background_path: ${{ steps.background.outputs.background_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Phase2 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-script-data
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆ
        id: narration
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          NARRATION_PATH="${{ needs.phase2-script-creation.outputs.narration_path }}"
          VOICE_TYPE="${{ inputs.narration_voice }}"
          
          if [ ! -f "$NARRATION_PATH" ]; then
            echo "âš ï¸ ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚"
            echo "æœ¬æ—¥ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚" > "${PROJECT_DIR}/metadata/narration_text.txt"
            NARRATION_PATH="${PROJECT_DIR}/metadata/narration_text.txt"
          fi
          
          NARRATION_TEXT=$(cat "$NARRATION_PATH")
          
          AUDIO_PROMPT="ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆ:
          ãƒ†ã‚­ã‚¹ãƒˆ: ${NARRATION_TEXT}
          éŸ³å£°ã‚¿ã‚¤ãƒ—: ${VOICE_TYPE}
          
          è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼éŸ³å£°
          2. éŸ³è³ªåŸºæº–: -14 LUFSã€48kHz
          3. æ¨©å¨æ€§ã¨è¦ªã—ã¿ã‚„ã™ã•ã®ãƒãƒ©ãƒ³ã‚¹
          4. æ˜ç­ãªç™ºéŸ³ã¨é©åˆ‡ãªé–“ã®å–ã‚Šæ–¹
          
          å‡ºåŠ›: ${PROJECT_DIR}/media/audio/narration.mp3"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_submit,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_status,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_result,Bash,Write" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$AUDIO_PROMPT"
          
          AUDIO_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" | head -1)
          if [ -n "$AUDIO_FILE" ]; then
            echo "audio_path=$AUDIO_FILE" >> $GITHUB_OUTPUT
            echo "âœ… ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”ŸæˆæˆåŠŸ: $AUDIO_FILE"
          else
            echo "audio_path=${PROJECT_DIR}/media/audio/narration.mp3" >> $GITHUB_OUTPUT
            echo "âš ï¸ ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆå¤±æ•—"
          fi
      
      - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
        id: character
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          CHARACTER_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ:
          
          è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚¢ãƒ³ã‚«ãƒ¼
          2. ä¿¡é ¼æ€§ã‚’è¡¨ç¾ã™ã‚‹å¤–è¦³ï¼ˆã‚¹ãƒ¼ãƒ„ã€æ•´ã£ãŸé«ªå‹ã€çŸ¥çš„ãªè¡¨æƒ…ï¼‰
          3. é«˜è§£åƒåº¦ï¼ˆæœ€ä½512x512ã®é¡”éƒ¨åˆ†ï¼‰
          4. æ—¥æœ¬äººã€30-40ä»£ã€æ€§åˆ¥ã¯å•ã‚ãš
          5. ä¸€è²«ã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç‰¹å¾´ï¼ˆseedå€¤å›ºå®šï¼‰
          
          å‡ºåŠ›: ${PROJECT_DIR}/media/images/anchor_character.png"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$CHARACTER_PROMPT"
          
          CHARACTER_FILE=$(find "${PROJECT_DIR}/media/images" -name "*anchor*" -o -name "*character*" | head -1)
          if [ -n "$CHARACTER_FILE" ]; then
            echo "character_path=$CHARACTER_FILE" >> $GITHUB_OUTPUT
            echo "âœ… ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”ŸæˆæˆåŠŸ: $CHARACTER_FILE"
          else
            echo "character_path=${PROJECT_DIR}/media/images/anchor_character.png" >> $GITHUB_OUTPUT
            echo "âš ï¸ ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆå¤±æ•—"
          fi
      
      - name: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”Ÿæˆ
        id: background
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          BACKGROUND_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”Ÿæˆ:
          
          è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯
          2. ãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ï¼ˆä¿¡é ¼æ„Ÿã®ã‚ã‚‹ãƒ–ãƒ«ãƒ¼ç³»ï¼‰åŸºèª¿
          3. æƒ…å ±ã®è¦–èªæ€§ã‚’é«˜ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³
          4. é«˜è§£åƒåº¦ã€1920x1080æ¨å¥¨
          5. ãƒ­ã‚´ãƒ»ãƒãƒ£ãƒ¼ãƒˆç”¨ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿
          
          å‡ºåŠ›: ${PROJECT_DIR}/media/images/studio_background.png"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$BACKGROUND_PROMPT"
          
          BACKGROUND_FILE=$(find "${PROJECT_DIR}/media/images" -name "*studio*" -o -name "*background*" | head -1)
          if [ -n "$BACKGROUND_FILE" ]; then
            echo "background_path=$BACKGROUND_FILE" >> $GITHUB_OUTPUT
            echo "âœ… ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ç”ŸæˆæˆåŠŸ: $BACKGROUND_FILE"
          else
            echo "background_path=${PROJECT_DIR}/media/images/studio_background.png" >> $GITHUB_OUTPUT
            echo "âš ï¸ ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ç”Ÿæˆå¤±æ•—"
          fi
          
          echo "## ğŸ­ Phase 3: ä¸¦åˆ—ã‚¢ã‚»ãƒƒãƒˆç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°**: ${{ steps.narration.outputs.audio_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼**: ${{ steps.character.outputs.character_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯**: ${{ steps.background.outputs.background_path }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Phase3 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase3-assets
          path: ${{ needs.setup.outputs.project_dir }}/media/

  phase4-scene-videos:
    runs-on: ubuntu-latest
    needs: [setup]  # Phase1ã¨ä¸¦åˆ—å®Ÿè¡Œã—ã¦æ—©æœŸã«MCPæ¥ç¶šã‚’åˆ©ç”¨
    strategy:
      max-parallel: 12
      matrix:
        scene: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
    outputs:
      scene_videos_ready: ${{ steps.generate-scene.outputs.video_ready }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Phase3 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3-assets
          path: ${{ needs.setup.outputs.project_dir }}/media/
      
      - name: Download Phase2 Script Data
        uses: actions/download-artifact@v4
        with:
          name: phase2-script-data
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: ã‚·ãƒ¼ãƒ³{{ matrix.scene }}å‹•ç”»ç”Ÿæˆï¼ˆç”»åƒâ†’I2Vç›´åˆ—å‡¦ç†ï¼‰
        id: generate-scene
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_NUM="${{ matrix.scene }}"
          VISUAL_STYLE="${{ inputs.visual_style }}"
          
          # MCPæ¥ç¶šã¯æœ€åˆã®12åˆ†é–“ã®ã¿æœ‰åŠ¹
          # Phase1-3ã§ç´„10åˆ†ä½¿ç”¨æ¸ˆã¿ãªã®ã§ã€Phase4ã§ã¯ä½¿ç”¨ä¸å¯
          # TODO: Phase4ã‚’Phase2ã¨ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã‚ˆã†æ§‹é€ ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
          USE_MCP=true
          echo "âš ï¸ Phase4: MCPæ¥ç¶šè©¦è¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒªã‚¹ã‚¯ã‚ã‚Šï¼‰"
          
          if [ "$USE_MCP" = "true" ]; then
            SCENE_PROMPT="ã‚·ãƒ¼ãƒ³${SCENE_NUM}å‹•ç”»ç”Ÿæˆ:
            
            1. ã¾ãšã€ã‚·ãƒ¼ãƒ³${SCENE_NUM}ç”¨ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:
               - ãƒ‹ãƒ¥ãƒ¼ã‚¹å†…å®¹ã«å¿œã˜ãŸæ˜ åƒï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ã€è³‡æ–™æ˜ åƒã€ã‚¤ãƒ³ãƒ•ã‚©ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç­‰ï¼‰
               - ã‚¹ã‚¿ã‚¤ãƒ«: ${VISUAL_STYLE}
               - ä¸€è²«ã—ãŸè¦–è¦šã‚¹ã‚¿ã‚¤ãƒ«ç¶­æŒ
               - è§£åƒåº¦: 1920x1080
               - å‡ºåŠ›: ${PROJECT_DIR}/media/images/scene${SCENE_NUM}_image.png
            
            2. ç”Ÿæˆç›´å¾Œã«åŒä¸€å‡¦ç†å†…ã§I2Vå¤‰æ›ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼ˆURLæœŸé™åˆ‡ã‚Œå¯¾ç­–ï¼‰:
               - ç”Ÿæˆã—ãŸç”»åƒã‚’ä½¿ç”¨
               - 6-8ç§’ã®å‹•ç”»
               - 30fpsã€é«˜å“è³ªè¨­å®š
               - å‡ºåŠ›: ${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_video.mp4
            
            é‡è¦: ç”»åƒç”Ÿæˆâ†’I2Vå¤‰æ›ã‚’åŒä¸€å®Ÿè¡Œå†…ã§é€£ç¶šå®Ÿè¡Œã™ã‚‹ã“ã¨"
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_submit,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_status,mcp__i2v-kamui-hailuo-02-pro__hailuo_02_result,mcp__i2v-kamui-veo3-fast__veo3_fast_submit,mcp__i2v-kamui-veo3-fast__veo3_fast_status,mcp__i2v-kamui-veo3-fast__veo3_fast_result,Write,Bash" \
              --max-turns 80 \
              --permission-mode "acceptEdits" \
              -p "$SCENE_PROMPT"
          else
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ç”Ÿæˆ
            echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ã‚’ç”Ÿæˆ"
            mkdir -p "${PROJECT_DIR}/media/videos"
            
            # FFmpegã§ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å‹•ç”»ç”Ÿæˆ
            ffmpeg -f lavfi -i color=c=blue:size=1920x1080:duration=6 \
              -vf "drawtext=fontfile=/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf:text='Scene ${SCENE_NUM}':fontsize=72:fontcolor=white:x=(w-text_w)/2:y=(h-text_h)/2" \
              -c:v libx264 -pix_fmt yuv420p \
              "${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_video.mp4" 2>/dev/null || true
          fi
          
          # ç”Ÿæˆçµæœã®æ¤œè¨¼
          VIDEO_FILE="${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_video.mp4"
          if [ -f "$VIDEO_FILE" ] && [ -s "$VIDEO_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$VIDEO_FILE" 2>/dev/null || echo 0)
            if [ "$FILE_SIZE" -gt 300000 ]; then
              echo "video_ready=true" >> $GITHUB_OUTPUT
              echo "âœ… ã‚·ãƒ¼ãƒ³${SCENE_NUM}å‹•ç”»ç”ŸæˆæˆåŠŸ: $VIDEO_FILE (${FILE_SIZE} bytes)"
            else
              echo "video_ready=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ ã‚·ãƒ¼ãƒ³${SCENE_NUM}å‹•ç”»ã‚µã‚¤ã‚ºä¸è¶³: $VIDEO_FILE (${FILE_SIZE} bytes)"
            fi
          else
            echo "video_ready=false" >> $GITHUB_OUTPUT
            echo "âŒ ã‚·ãƒ¼ãƒ³${SCENE_NUM}å‹•ç”»ç”Ÿæˆå¤±æ•—: $VIDEO_FILE"
          fi
      
      - name: Upload Scene {{ matrix.scene }} Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scene-${{ matrix.scene }}-video
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/scene${{ matrix.scene }}_video.mp4

  phase5-audio-processing:
    runs-on: ubuntu-latest
    needs: [setup, phase3-parallel-assets, phase4-scene-videos]
    outputs:
      lipsync_video_path: ${{ steps.lipsync.outputs.video_path }}
      bgm_audio_path: ${{ steps.bgm.outputs.audio_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Assets
        uses: actions/download-artifact@v4
        with:
          name: phase3-assets
          path: ${{ needs.setup.outputs.project_dir }}/media/
      
      - name: Download Scene Videos
        uses: actions/download-artifact@v4
        with:
          pattern: scene-*-video
          merge-multiple: true
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/
      
      - name: ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‡¦ç†
        id: lipsync
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          ANCHOR_CHARACTER="${{ needs.phase3-parallel-assets.outputs.anchor_character_path }}"
          NARRATION_AUDIO="${{ needs.phase3-parallel-assets.outputs.narration_audio_path }}"
          
          # ã‚¢ãƒ³ã‚«ãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒç¢ºèª
          if [ ! -f "$ANCHOR_CHARACTER" ]; then
            ANCHOR_CHARACTER=$(find "${PROJECT_DIR}/media/images" -name "*anchor*" -o -name "*character*" | head -1)
          fi
          
          # ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç¢ºèª
          if [ ! -f "$NARRATION_AUDIO" ]; then
            NARRATION_AUDIO=$(find "${PROJECT_DIR}/media/audio" -name "*.mp3" -o -name "*.wav" | head -1)
          fi
          
          if [ -f "$ANCHOR_CHARACTER" ] && [ -f "$NARRATION_AUDIO" ]; then
            LIPSYNC_PROMPT="ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‡¦ç†:
            ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ: ${ANCHOR_CHARACTER}
            éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: ${NARRATION_AUDIO}
            
            è¦ä»¶:
            1. éŸ³ç´ è§£æã«ã‚ˆã‚‹è‡ªç„¶ãªå£ã®å‹•ã
            2. éŸ³å£°ã¨å£ã®å‹•ãã®ã‚ºãƒ¬<200ms
            3. è‡ªç„¶ãªè¡¨æƒ…å¤‰åŒ–
            4. éŸ³ç´ èªè­˜ç²¾åº¦>90%
            
            å‡ºåŠ›: ${PROJECT_DIR}/media/videos/anchor_lipsync.mp4"
            
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__v2v-kamui-creatify-lipsync__lipsync_submit,mcp__v2v-kamui-creatify-lipsync__lipsync_status,mcp__v2v-kamui-creatify-lipsync__lipsync_result,mcp__v2v-kamui-pixverse-lipsync__pixverse_lipsync_submit,mcp__v2v-kamui-pixverse-lipsync__pixverse_lipsync_status,mcp__v2v-kamui-pixverse-lipsync__pixverse_lipsync_result,Write,Bash" \
              --max-turns 60 \
              --permission-mode "acceptEdits" \
              -p "$LIPSYNC_PROMPT"
          else
            echo "âš ï¸ ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ç”¨ç´ æä¸è¶³: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼=${ANCHOR_CHARACTER}, éŸ³å£°=${NARRATION_AUDIO}"
          fi
          
          LIPSYNC_VIDEO=$(find "${PROJECT_DIR}/media/videos" -name "*lipsync*" -o -name "*anchor*" | head -1)
          if [ -n "$LIPSYNC_VIDEO" ]; then
            echo "video_path=$LIPSYNC_VIDEO" >> $GITHUB_OUTPUT
            echo "âœ… ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”ŸæˆæˆåŠŸ: $LIPSYNC_VIDEO"
          else
            echo "video_path=" >> $GITHUB_OUTPUT
            echo "âš ï¸ ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”Ÿæˆå¤±æ•—"
          fi
      
      - name: BGMãƒ»åŠ¹æœéŸ³è¿½åŠ 
        id: bgm
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          BGM_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„BGMç”Ÿæˆ:
          
          è¦ä»¶:
          1. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã«é©ã—ãŸBGM
          2. æ¨©å¨æ€§ã‚’æ¼”å‡ºã—ã¤ã¤ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é‚ªé­”ã«ãªã‚‰ãªã„
          3. 60ç§’é•·ã€ãƒ«ãƒ¼ãƒ—å¯¾å¿œ
          4. -18dB ãƒ¬ãƒ™ãƒ«ï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³-3dBã¨ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
          5. å“æ ¼ã‚ã‚‹BGMé¸æŠ
          
          å‡ºåŠ›: ${PROJECT_DIR}/media/audio/news_bgm.mp3"
          
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2m-google-lyria__lyria_generate,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$BGM_PROMPT"
          
          BGM_FILE=$(find "${PROJECT_DIR}/media/audio" -name "*bgm*" -o -name "*background*" | head -1)
          if [ -n "$BGM_FILE" ]; then
            echo "audio_path=$BGM_FILE" >> $GITHUB_OUTPUT
            echo "âœ… BGMç”ŸæˆæˆåŠŸ: $BGM_FILE"
          else
            echo "audio_path=" >> $GITHUB_OUTPUT
            echo "âš ï¸ BGMç”Ÿæˆå¤±æ•—"
          fi
          
          echo "## ğŸµ Phase 5: éŸ³å£°å‡¦ç†" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»**: ${{ steps.lipsync.outputs.video_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BGM**: ${{ steps.bgm.outputs.audio_path }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Phase5 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase5-audio-processing
          path: ${{ needs.setup.outputs.project_dir }}/media/

  phase6-final-editing:
    runs-on: ubuntu-latest
    needs: [setup, phase3-parallel-assets, phase4-scene-videos, phase5-audio-processing]
    outputs:
      final_video_path: ${{ steps.final-edit.outputs.video_path }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: phase*
          merge-multiple: true
          path: ${{ needs.setup.outputs.project_dir }}/
      
      - name: Download Scene Videos
        uses: actions/download-artifact@v4
        with:
          pattern: scene-*-video
          merge-multiple: true
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/
      
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: æœ€çµ‚å‹•ç”»ç·¨é›†ãƒ»çµ±åˆ
        id: final-edit
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          VIDEO_TITLE="${{ inputs.video_title }}"
          DURATION="${{ inputs.duration }}"
          
          EDITING_PROMPT="æœ€çµ‚å‹•ç”»ç·¨é›†ãƒ»çµ±åˆ:
          
          ç´ æåˆ†æ:
          - ã‚·ãƒ¼ãƒ³å‹•ç”»: ${PROJECT_DIR}/media/videos/scene*_video.mp4 (12ã‚·ãƒ¼ãƒ³ã€å„6-8ç§’)
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°: ${PROJECT_DIR}/media/audio/narration.mp3 (60ç§’)
          - BGM: ${PROJECT_DIR}/media/audio/news_bgm.mp3
          - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»: ${PROJECT_DIR}/media/videos/anchor_lipsync.mp4
          
          ç·¨é›†è¦ä»¶:
          1. 60ç§’Â±5ç§’ã®æ­£ç¢ºãªå°º
          2. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„å“è³ª
          3. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ»ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¿½åŠ 
          4. æƒ…å ±æºè¡¨ç¤ºã€å­—å¹•è¿½åŠ 
          5. éŸ³å£°ãƒ¬ãƒ™ãƒ«èª¿æ•´ï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³-3dBã€BGM-18dBï¼‰
          6. 1920x1080ã€30fpsã€YouTubeæœ€é©åŒ–
          
          æœ€çµ‚å‡ºåŠ›: ${PROJECT_DIR}/final/news_video_final.mp4
          
          FFmpegã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆã¨å®Ÿè¡Œã‚‚å«ã‚ã¦å®Œå…¨ãªç·¨é›†å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚"
          
          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 60 \
            --permission-mode "acceptEdits" \
            -p "$EDITING_PROMPT"
          
          # æœ€çµ‚å‹•ç”»ã®æ¤œè¨¼ã¨é…ç½®
          FINAL_VIDEO=$(find "${PROJECT_DIR}" -name "*final*.mp4" -o -name "*news_video*.mp4" | head -1)
          
          if [ -n "$FINAL_VIDEO" ] && [ -f "$FINAL_VIDEO" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒŠãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
            mkdir -p "${PROJECT_DIR}/final"
            cp "$FINAL_VIDEO" "${PROJECT_DIR}/final/news_video_final.mp4"
            echo "video_path=${PROJECT_DIR}/final/news_video_final.mp4" >> $GITHUB_OUTPUT
            echo "âœ… æœ€çµ‚å‹•ç”»ç”ŸæˆæˆåŠŸ: ${PROJECT_DIR}/final/news_video_final.mp4"
            
            # å‹•ç”»æƒ…å ±å–å¾—
            if command -v ffprobe >/dev/null 2>&1; then
              DURATION_ACTUAL=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "${PROJECT_DIR}/final/news_video_final.mp4" 2>/dev/null || echo "ä¸æ˜")
              FILE_SIZE=$(stat -c%s "${PROJECT_DIR}/final/news_video_final.mp4" 2>/dev/null || echo 0)
              FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
              
              echo "## ğŸ¬ Phase 6: æœ€çµ‚å‹•ç”»ç·¨é›†ãƒ»çµ±åˆ" >> $GITHUB_STEP_SUMMARY
              echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
              echo "- **æœ€çµ‚å‹•ç”»**: ${PROJECT_DIR}/final/news_video_final.mp4" >> $GITHUB_STEP_SUMMARY
              echo "- **å‹•ç”»é•·**: ${DURATION_ACTUAL}ç§’" >> $GITHUB_STEP_SUMMARY
              echo "- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${FILE_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ğŸ¬ Phase 6: æœ€çµ‚å‹•ç”»ç·¨é›†ãƒ»çµ±åˆ" >> $GITHUB_STEP_SUMMARY
              echo "- **Status**: âœ… å®Œäº†" >> $GITHUB_STEP_SUMMARY
              echo "- **æœ€çµ‚å‹•ç”»**: ${PROJECT_DIR}/final/news_video_final.mp4" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "video_path=" >> $GITHUB_OUTPUT
            echo "âŒ æœ€çµ‚å‹•ç”»ç”Ÿæˆå¤±æ•—"
            
            echo "## ğŸ¬ Phase 6: æœ€çµ‚å‹•ç”»ç·¨é›†ãƒ»çµ±åˆ" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âš ï¸ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "- **æœ€çµ‚å‹•ç”»**: ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Final Video
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: final-news-video
          path: ${{ needs.setup.outputs.project_dir }}/final/

  summary-report:
    runs-on: ubuntu-latest
    needs: [setup, phase1-news-collection, phase2-script-creation, phase3-parallel-assets, phase4-scene-videos, phase5-audio-processing, phase6-final-editing]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Final Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: final-*
          merge-multiple: true
          path: ${{ needs.setup.outputs.project_dir }}/final/
      
      - name: æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          
          echo "## ğŸ¯ æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆæ™‚åˆ»**: $TIMESTAMP" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: $PROJECT_DIR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          
          # Phase 1
          if [ "${{ needs.phase1-news-collection.result }}" = "success" ]; then
            echo "- **Phase 1 (ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 1 (ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Phase 2
          if [ "${{ needs.phase2-script-creation.result }}" = "success" ]; then
            echo "- **Phase 2 (å°æœ¬ä½œæˆ)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 2 (å°æœ¬ä½œæˆ)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Phase 3
          if [ "${{ needs.phase3-parallel-assets.result }}" = "success" ]; then
            echo "- **Phase 3 (ã‚¢ã‚»ãƒƒãƒˆç”Ÿæˆ)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 3 (ã‚¢ã‚»ãƒƒãƒˆç”Ÿæˆ)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Phase 4
          if [ "${{ needs.phase4-scene-videos.result }}" = "success" ]; then
            echo "- **Phase 4 (ã‚·ãƒ¼ãƒ³å‹•ç”»ç”Ÿæˆ)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 4 (ã‚·ãƒ¼ãƒ³å‹•ç”»ç”Ÿæˆ)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Phase 5
          if [ "${{ needs.phase5-audio-processing.result }}" = "success" ]; then
            echo "- **Phase 5 (éŸ³å£°å‡¦ç†)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 5 (éŸ³å£°å‡¦ç†)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Phase 6
          if [ "${{ needs.phase6-final-editing.result }}" = "success" ]; then
            echo "- **Phase 6 (æœ€çµ‚ç·¨é›†)**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Phase 6 (æœ€çµ‚ç·¨é›†)**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æœ€çµ‚å‹•ç”»ã®è©³ç´°
          FINAL_VIDEO="${PROJECT_DIR}/final/news_video_final.mp4"
          if [ -f "$FINAL_VIDEO" ]; then
            echo "### ğŸ¬ æœ€çµ‚æˆæœç‰©" >> $GITHUB_STEP_SUMMARY
            echo "- **æœ€çµ‚å‹•ç”»**: âœ… ç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: \`$FINAL_VIDEO\`" >> $GITHUB_STEP_SUMMARY
            
            FILE_SIZE=$(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0)
            FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
            echo "- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${FILE_SIZE_MB}MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ¬ æœ€çµ‚æˆæœç‰©" >> $GITHUB_STEP_SUMMARY
            echo "- **æœ€çµ‚å‹•ç”»**: âŒ ç”Ÿæˆå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "å…¨ã¦ã®ä¸­é–“ç”Ÿæˆç‰©ã¨ãƒ­ã‚°ã¯ GitHub Actions Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™:" >> $GITHUB_STEP_SUMMARY
          echo "- \`final-news-video\`: æœ€çµ‚å‹•ç”»" >> $GITHUB_STEP_SUMMARY
          echo "- \`phase*\`: å„ãƒ•ã‚§ãƒ¼ã‚ºã®ä¸­é–“æˆæœç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- \`scene-*-video\`: å€‹åˆ¥ã‚·ãƒ¼ãƒ³å‹•ç”»" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          mkdir -p "${PROJECT_DIR}/logs"
          {
            echo "# æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°"
            echo "å®Ÿè¡Œæ™‚åˆ»: $TIMESTAMP"
            echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.workflow }}"
            echo "å®Ÿè¡ŒID: ${{ github.run_id }}"
            echo ""
            echo "## å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"
            echo "- video_title: ${{ inputs.video_title }}"
            echo "- duration: ${{ inputs.duration }}"
            echo "- target_platform: ${{ inputs.target_platform }}"
            echo "- content_type: ${{ inputs.content_type }}"
            echo "- visual_style: ${{ inputs.visual_style }}"
            echo "- narration_voice: ${{ inputs.narration_voice }}"
            echo "- news_topic: ${{ inputs.news_topic }}"
            echo "- news_period: ${{ inputs.news_period }}"
            echo "- news_category: ${{ inputs.news_category }}"
            echo ""
            echo "## å®Ÿè¡Œçµæœ"
            echo "Phase 1 (ãƒ‹ãƒ¥ãƒ¼ã‚¹åé›†): ${{ needs.phase1-news-collection.result }}"
            echo "Phase 2 (å°æœ¬ä½œæˆ): ${{ needs.phase2-script-creation.result }}"
            echo "Phase 3 (ã‚¢ã‚»ãƒƒãƒˆç”Ÿæˆ): ${{ needs.phase3-parallel-assets.result }}"
            echo "Phase 4 (ã‚·ãƒ¼ãƒ³å‹•ç”»ç”Ÿæˆ): ${{ needs.phase4-scene-videos.result }}"
            echo "Phase 5 (éŸ³å£°å‡¦ç†): ${{ needs.phase5-audio-processing.result }}"
            echo "Phase 6 (æœ€çµ‚ç·¨é›†): ${{ needs.phase6-final-editing.result }}"
          } > "${PROJECT_DIR}/logs/execution_log_${TIMESTAMP}.md"
      
      - name: Upload Execution Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: ${{ needs.setup.outputs.project_dir }}/logs/