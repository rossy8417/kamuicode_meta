name: News Video Generation Workflow

on:
  workflow_dispatch:
    inputs:
      topic:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šAIæŠ€è¡“ã€æ°—å€™å¤‰å‹•ã€çµŒæ¸ˆå‹•å‘ãªã©ï¼‰"
        required: true
        type: string
        default: "æœ€æ–°ã®AIæŠ€è¡“å‹•å‘"
      
      time_period:
        description: "æœŸé–“æŒ‡å®š"
        required: true
        type: choice
        options:
          - "ç›´è¿‘1é€±é–“"
          - "ç›´è¿‘1ãƒ¶æœˆ"
          - "ç›´è¿‘3ãƒ¶æœˆ"
        default: "ç›´è¿‘1é€±é–“"
      
      category:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼"
        required: true
        type: choice
        options:
          - "ãƒ†ã‚¯ãƒŽãƒ­ã‚¸ãƒ¼"
          - "æ”¿æ²»"
          - "çµŒæ¸ˆ"
          - "ç¤¾ä¼š"
          - "ã‚¨ãƒ³ã‚¿ãƒ¡"
          - "ã‚¹ãƒãƒ¼ãƒ„"
          - "ç§‘å­¦"
          - "å¥åº·"
        default: "ãƒ†ã‚¯ãƒŽãƒ­ã‚¸ãƒ¼"
      
      video_duration:
        description: "å‹•ç”»ã®é•·ã•ï¼ˆç§’ï¼‰"
        required: true
        type: choice
        options:
          - "30"
          - "60"
          - "90"
        default: "60"
      
      anchor_style:
        description: "ã‚¢ãƒ³ã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«"
        required: true
        type: choice
        options:
          - "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å¥³æ€§"
          - "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ç”·æ€§"
          - "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«å¥³æ€§"
          - "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ç”·æ€§"
        default: "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å¥³æ€§"

  push:
    paths-ignore:
      - '.github/workflows/**'

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  setup:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      calculated_scene_count: ${{ steps.calculate.outputs.scene_count }}
      matrix_scenes: ${{ steps.calculate.outputs.matrix_scenes }}
      workflow_start: ${{ steps.setup.outputs.workflow_start }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup project environment
        id: setup
        run: |
          PROJECT_DIR="/home/runner/work/kamuicode_meta/kamuicode_meta/projects/news-video-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$PROJECT_DIR/media/images"
          mkdir -p "$PROJECT_DIR/media/videos"
          mkdir -p "$PROJECT_DIR/media/audio"
          mkdir -p "$PROJECT_DIR/metadata"
          mkdir -p "$PROJECT_DIR/logs"
          mkdir -p "$PROJECT_DIR/final"
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "workflow_start=$(date -Iseconds)" >> $GITHUB_OUTPUT
          
          echo "âœ… Project directory created: $PROJECT_DIR"

      - name: Calculate scene parameters
        id: calculate
        run: |
          DURATION="${{ github.event.inputs.video_duration }}"
          SCENE_COUNT=$((DURATION / 5))
          
          # Generate matrix array
          SCENES=""
          for i in $(seq 1 $SCENE_COUNT); do
            if [ -z "$SCENES" ]; then
              SCENES="$i"
            else
              SCENES="$SCENES, $i"
            fi
          done
          MATRIX_SCENES="[$SCENES]"
          
          echo "scene_count=$SCENE_COUNT" >> $GITHUB_OUTPUT
          echo "matrix_scenes=$MATRIX_SCENES" >> $GITHUB_OUTPUT
          
          echo "âœ… Calculated: $SCENE_COUNT scenes, matrix: $MATRIX_SCENES"

  news_research:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      news_data: ${{ steps.research.outputs.news_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Conduct news research
        id: research
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          RESEARCH_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±åŽé›†ã¨åˆ†æžã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          ãƒˆãƒ”ãƒƒã‚¯: ${{ github.event.inputs.topic }}
          æœŸé–“: ${{ github.event.inputs.time_period }}
          ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${{ github.event.inputs.category }}

          æ‰‹é †:
          1. WebSearchãƒ„ãƒ¼ãƒ«ã§è¤‡æ•°ã®ä¿¡é ¼æ€§ã®é«˜ã„æ—¥æœ¬èªžãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚½ãƒ¼ã‚¹ï¼ˆNHKã€æœæ—¥æ–°èžã€èª­å£²æ–°èžã€æ¯Žæ—¥æ–°èžã€Reuters Japanç­‰ï¼‰ã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’æ¤œç´¢
          2. åŽé›†ã—ãŸæƒ…å ±ã®ä¿¡é ¼æ€§è©•ä¾¡ã¨äº‹å®Ÿç¢ºèª
          3. ${{ github.event.inputs.video_duration }}ç§’å‹•ç”»ç”¨ã®æ§‹æˆæ¡ˆä½œæˆ
          4. çµæžœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«: ${PROJECT_DIR}/metadata/news_research.json ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          5. lsã‚³ãƒžãƒ³ãƒ‰ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          å‡ºåŠ›å½¢å¼:
          {
            \"topic\": \"ãƒˆãƒ”ãƒƒã‚¯\",
            \"sources\": [\"æƒ…å ±æº1\", \"æƒ…å ±æº2\"],
            \"key_facts\": [\"äº‹å®Ÿ1\", \"äº‹å®Ÿ2\"],
            \"reliability_score\": 85,
            \"composition_plan\": \"æ§‹æˆæ¡ˆæ¦‚è¦\"
          }"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$RESEARCH_PROMPT"

          # Verify research results
          ls -la "$PROJECT_DIR/metadata/"
          
          if [ -f "$PROJECT_DIR/metadata/news_research.json" ]; then
            NEWS_DATA=$(cat "$PROJECT_DIR/metadata/news_research.json")
            echo "news_data=$NEWS_DATA" >> $GITHUB_OUTPUT
            echo "âœ… News research completed"
          else
            echo "âš ï¸ Research file not found, creating fallback data"
            echo "news_data={\"topic\":\"${{ github.event.inputs.topic }}\",\"status\":\"fallback\"}" >> $GITHUB_OUTPUT
          fi

      - name: Upload research artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: news-research
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  script_creation:
    needs: [setup, news_research]
    runs-on: ubuntu-latest
    timeout-minutes: 8
    outputs:
      script_data: ${{ steps.script.outputs.script_data }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download research artifacts
        uses: actions/download-artifact@v4
        with:
          name: news-research
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Create news script
        id: script
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_COUNT="${{ needs.setup.outputs.calculated_scene_count }}"
          
          SCRIPT_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã‚·ãƒŠãƒªã‚ªä½œæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          å…¥åŠ›æƒ…å ±:
          - ç ”ç©¶ãƒ‡ãƒ¼ã‚¿: ${PROJECT_DIR}/metadata/news_research.json
          - å‹•ç”»é•·: ${{ github.event.inputs.video_duration }}ç§’
          - ã‚·ãƒ¼ãƒ³æ•°: ${SCENE_COUNT}å€‹ï¼ˆ5ç§’/ã‚·ãƒ¼ãƒ³ï¼‰

          æ‰‹é †:
          1. ç ”ç©¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆReadãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          2. ${SCENE_COUNT}ã‚·ãƒ¼ãƒ³åˆ†ã®è©³ç´°ã‚·ãƒŠãƒªã‚ªä½œæˆ
          3. å„ã‚·ãƒ¼ãƒ³ã®ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          4. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°æœ¬ä½œæˆï¼ˆæ—¥æœ¬èªžã€è‡ªç„¶ãªè©±ã—æ–¹ï¼‰
          5. çµæžœã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰:
             - ${PROJECT_DIR}/metadata/script.json
             - ${PROJECT_DIR}/metadata/narration.txt
          6. lsã‚³ãƒžãƒ³ãƒ‰ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          å‡ºåŠ›å½¢å¼:
          script.json: {
            \"scenes\": [
              {\"scene_id\": 1, \"duration\": 5, \"text\": \"ã‚·ãƒ¼ãƒ³1ã®å†…å®¹\", \"image_prompt\": \"ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\"},
              ...
            ],
            \"total_duration\": ${{ github.event.inputs.video_duration }}
          }"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$SCRIPT_PROMPT"

          # Verify script creation
          ls -la "$PROJECT_DIR/metadata/"
          
          if [ -f "$PROJECT_DIR/metadata/script.json" ]; then
            SCRIPT_DATA=$(cat "$PROJECT_DIR/metadata/script.json")
            echo "script_data=$SCRIPT_DATA" >> $GITHUB_OUTPUT
            echo "âœ… Script creation completed"
          else
            echo "âš ï¸ Script file not found"
            echo "script_data={\"status\":\"error\"}" >> $GITHUB_OUTPUT
          fi

      - name: Upload script artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: news-script
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  generate_narration:
    needs: [setup, script_creation]
    runs-on: ubuntu-latest
    timeout-minutes: 6
    outputs:
      narration_file: ${{ steps.narration.outputs.narration_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download script artifacts
        uses: actions/download-artifact@v4
        with:
          name: news-script
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate narration audio
        id: narration
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          AUDIO_PATH="${PROJECT_DIR}/media/audio/narration.mp3"
          
          TTS_PROMPT="æ—¥æœ¬èªžãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          æ‰‹é †:
          1. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°æœ¬ã‚’èª­ã¿è¾¼ã¿: ${PROJECT_DIR}/metadata/narration.txt
          2. MCP TTS ã‚µãƒ¼ãƒ“ã‚¹ã§æ—¥æœ¬èªžéŸ³å£°ç”Ÿæˆï¼ˆãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼éŸ³è³ªï¼‰
          3. ç”Ÿæˆã—ãŸéŸ³å£°ã‚’${AUDIO_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          4. ls -laã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          éŸ³å£°è¨­å®š:
          - è¨€èªž: æ—¥æœ¬èªž
          - éŸ³è³ª: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼é¢¨ã€æ˜Žçž­
          - é•·ã•: ${{ github.event.inputs.video_duration }}ç§’ç¨‹åº¦
          - ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ: MP3"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-*,Read,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$TTS_PROMPT"

          # Verify audio generation
          ls -la "$PROJECT_DIR/media/audio/"
          
          AUDIO_FILE=$(find "$PROJECT_DIR" -name "*.mp3" -type f 2>/dev/null | head -1)
          if [ -n "$AUDIO_FILE" ] && [ -f "$AUDIO_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo 0)
            if [ "$FILE_SIZE" -gt 50000 ]; then
              echo "âœ… Narration generated: $AUDIO_FILE (${FILE_SIZE} bytes)"
              echo "narration_file=$AUDIO_FILE" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Audio file too small: ${FILE_SIZE} bytes"
              echo "narration_file=" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ No audio file found"
            echo "narration_file=" >> $GITHUB_OUTPUT
          fi

      - name: Upload narration artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: narration-audio
          path: ${{ needs.setup.outputs.project_dir }}/media/audio/

  generate_anchor:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 6
    outputs:
      anchor_image: ${{ steps.anchor.outputs.anchor_image }}
      anchor_url: ${{ steps.anchor.outputs.anchor_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate news anchor
        id: anchor
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SAVE_PATH="${PROJECT_DIR}/media/images/anchor.png"
          URL_PATH="${PROJECT_DIR}/media/images/anchor-url.txt"
          
          ANCHOR_STYLE="${{ github.event.inputs.anchor_style }}"
          
          case "$ANCHOR_STYLE" in
            "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å¥³æ€§")
              ANCHOR_PROMPT="Professional Japanese female news anchor, wearing business suit, sitting at news desk, neutral expression, professional lighting, green screen background, high quality portrait, broadcast journalism style"
              ;;
            "ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ç”·æ€§")
              ANCHOR_PROMPT="Professional Japanese male news anchor, wearing business suit and tie, sitting at news desk, neutral expression, professional lighting, green screen background, high quality portrait, broadcast journalism style"
              ;;
            "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«å¥³æ€§")
              ANCHOR_PROMPT="Casual Japanese female presenter, wearing smart casual outfit, sitting at modern desk, friendly expression, natural lighting, green screen background, high quality portrait"
              ;;
            *)
              ANCHOR_PROMPT="Casual Japanese male presenter, wearing smart casual shirt, sitting at modern desk, friendly expression, natural lighting, green screen background, high quality portrait"
              ;;
          esac

          GENERATION_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${ANCHOR_PROMPT}

          æ‰‹é †:
          1. ä¸Šè¨˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§MCPç”»åƒç”Ÿæˆãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼ˆseedå€¤42ã§å›ºå®šï¼‰
          2. ç”Ÿæˆã—ãŸç”»åƒã‚’${SAVE_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          3. Google Cloud Storage URLã‚’${URL_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          4. ls -la ${PROJECT_DIR}/media/images/ ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          é‡è¦: ä¸€è²«æ€§ã®ãŸã‚å¿…ãšseedå€¤42ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$GENERATION_PROMPT"

          # Immediate URL download (prevent expiration)
          ls -la "${PROJECT_DIR}/media/images/"
          [ -f "$URL_PATH" ] && curl -L -o "$SAVE_PATH" "$(cat $URL_PATH)"

          # Multi-pattern file search
          ANCHOR_IMAGE=$(find "$PROJECT_DIR" -name "*anchor*.png" -type f 2>/dev/null | head -1)
          [ -z "$ANCHOR_IMAGE" ] && ANCHOR_IMAGE=$(find "$PROJECT_DIR" -name "*.png" -mmin -2 -type f 2>/dev/null | head -1)
          [ -z "$ANCHOR_IMAGE" ] && ANCHOR_IMAGE=$(find "$PROJECT_DIR" -name "*.png" -type f 2>/dev/null | head -1)

          # File validation
          if [ -n "$ANCHOR_IMAGE" ] && [ -f "$ANCHOR_IMAGE" ]; then
            FILE_SIZE=$(stat -c%s "$ANCHOR_IMAGE" 2>/dev/null || echo 0)
            if [ "$FILE_SIZE" -gt 10000 ]; then
              echo "âœ… Anchor image generated: $ANCHOR_IMAGE (${FILE_SIZE} bytes)"
              echo "anchor_image=$ANCHOR_IMAGE" >> $GITHUB_OUTPUT
              
              if [ -f "$URL_PATH" ]; then
                ANCHOR_URL=$(cat "$URL_PATH")
                echo "anchor_url=$ANCHOR_URL" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ Image file too small: ${FILE_SIZE} bytes"
              echo "anchor_image=" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ No anchor image found"
            echo "anchor_image=" >> $GITHUB_OUTPUT
          fi

      - name: Upload anchor artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: anchor-image
          path: ${{ needs.setup.outputs.project_dir }}/media/images/

  generate_scenes:
    needs: [setup, script_creation]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        scene: ${{ fromJson(needs.setup.outputs.matrix_scenes) }}
    outputs:
      failed_scenes: ${{ steps.track.outputs.failed_scenes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download script artifacts
        uses: actions/download-artifact@v4
        with:
          name: news-script
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate scene image and video
        id: generate
        continue-on-error: true
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_NUM="${{ matrix.scene }}"
          
          # Step 1: Generate background image
          SAVE_PATH="${PROJECT_DIR}/media/images/scene${SCENE_NUM}.png"
          URL_PATH="${PROJECT_DIR}/media/images/scene${SCENE_NUM}-url.txt"
          
          IMAGE_PROMPT="ã‚·ãƒ¼ãƒ³${SCENE_NUM}ã®èƒŒæ™¯ç”»åƒç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          æ‰‹é †:
          1. ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿: ${PROJECT_DIR}/metadata/script.json
          2. ã‚·ãƒ¼ãƒ³${SCENE_NUM}ã®ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
          3. MCPç”»åƒç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§èƒŒæ™¯ç”»åƒç”Ÿæˆï¼ˆäººç‰©ã‚’å«ã¾ãªã„èƒŒæ™¯ã®ã¿ï¼‰
          4. ç”Ÿæˆã—ãŸç”»åƒã‚’${SAVE_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          5. Google Cloud Storage URLã‚’${URL_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          6. ls -la ${PROJECT_DIR}/media/images/ ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          é‡è¦: èƒŒæ™¯ç”»åƒã«ã¯äººç‰©ã‚’å«ã‚ãšã€ãƒ‹ãƒ¥ãƒ¼ã‚¹å†…å®¹ã«é–¢é€£ã—ãŸèƒŒæ™¯ã®ã¿ç”Ÿæˆã—ã¦ãã ã•ã„"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Read,Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$IMAGE_PROMPT"

          # Immediate URL download (prevent expiration)
          ls -la "${PROJECT_DIR}/media/images/"
          [ -f "$URL_PATH" ] && curl -L -o "$SAVE_PATH" "$(cat $URL_PATH)"

          # Multi-pattern file search for image
          IMAGE=$(find "$PROJECT_DIR" -name "*scene${SCENE_NUM}*.png" -type f 2>/dev/null | head -1)
          [ -z "$IMAGE" ] && IMAGE=$(find "$PROJECT_DIR" -name "*.png" -mmin -2 -type f 2>/dev/null | head -1)
          [ -z "$IMAGE" ] && IMAGE=$(find "$PROJECT_DIR" -name "*.png" -type f 2>/dev/null | head -1)

          # Validate image
          if [ -f "$IMAGE" ] && [ $(stat -c%s "$IMAGE" 2>/dev/null || echo 0) -gt 10000 ]; then
            echo "âœ… Scene ${SCENE_NUM} image generated: $IMAGE"
            
            # Step 2: Immediately convert to video (URL expiration prevention)
            VIDEO_PATH="${PROJECT_DIR}/media/videos/scene${SCENE_NUM}.mp4"
            
            # Check for Google URL first
            URL_FILE="${PROJECT_DIR}/media/images/scene${SCENE_NUM}-url.txt"
            if [ -f "$URL_FILE" ]; then
              IMAGE_URL=$(cat "$URL_FILE")
              if curl -IfsS --max-time 5 "$IMAGE_URL" >/dev/null 2>&1; then
                IMAGE_REF="$IMAGE_URL"
                echo "âœ… Using Google URL for video conversion"
              else
                IMAGE_REF="$IMAGE"
                echo "âš ï¸ URL expired, using local path"
              fi
            else
              IMAGE_REF="$IMAGE"
            fi
            
            VIDEO_PROMPT="èƒŒæ™¯ç”»åƒã‹ã‚‰å‹•ç”»å¤‰æ›ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            å…¥åŠ›ç”»åƒ: ${IMAGE_REF}
            
            æ‰‹é †:
            1. ä¸Šè¨˜ç”»åƒã‚’6-8ç§’ã®å‹•ç”»ã«å¤‰æ›ï¼ˆMCP I2Vãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
            2. ç”Ÿæˆã—ãŸå‹•ç”»ã‚’${VIDEO_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
            3. ls -la ${PROJECT_DIR}/media/videos/ ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

            è¨­å®š:
            - é•·ã•: 6-8ç§’
            - è§£åƒåº¦: 1920x1080
            - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ: 30fps
            - è‡ªç„¶ãªå‹•ã"

            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-*,Write,Bash" \
              --max-turns 80 \
              --permission-mode "bypassPermissions" \
              -p "$VIDEO_PROMPT"

            # Verify video generation
            ls -la "$PROJECT_DIR/media/videos/"
            
            VIDEO=$(find "$PROJECT_DIR" -name "*scene${SCENE_NUM}*.mp4" -type f 2>/dev/null | head -1)
            [ -z "$VIDEO" ] && VIDEO=$(find "$PROJECT_DIR" -name "*.mp4" -mmin -2 -type f 2>/dev/null | head -1)
            
            if [ -f "$VIDEO" ] && [ $(stat -c%s "$VIDEO" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "âœ… Scene ${SCENE_NUM} video generated: $VIDEO"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Scene ${SCENE_NUM} video generation failed"
              echo "status=failed" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Scene ${SCENE_NUM} image generation failed"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Track failures
        id: track
        if: always()
        run: |
          if [ "${{ steps.generate.outputs.status }}" = "failed" ]; then
            echo "failed_scenes=${{ matrix.scene }}" >> $GITHUB_OUTPUT
          else
            echo "failed_scenes=" >> $GITHUB_OUTPUT
          fi

      - name: Upload scene artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scene-${{ matrix.scene }}-artifacts
          path: |
            ${{ needs.setup.outputs.project_dir }}/media/images/scene${{ matrix.scene }}*
            ${{ needs.setup.outputs.project_dir }}/media/videos/scene${{ matrix.scene }}*

  recover_failed_scenes:
    needs: [setup, generate_scenes]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always() && needs.generate_scenes.outputs.failed_scenes != ''
    strategy:
      fail-fast: false
      matrix:
        scene: ${{ fromJson(needs.generate_scenes.outputs.failed_scenes) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download script artifacts
        uses: actions/download-artifact@v4
        with:
          name: news-script
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Recovery attempt
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_NUM="${{ matrix.scene }}"
          
          echo "ðŸ”„ Attempting recovery for scene ${SCENE_NUM}"
          
          # Simplified fallback generation
          FALLBACK_PROMPT="ã‚·ãƒ¼ãƒ³${SCENE_NUM}ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”Ÿæˆï¼š

          æ‰‹é †:
          1. ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹èƒŒæ™¯ç”»åƒã‚’ç”Ÿæˆï¼ˆnewspaper background, minimalist, no peopleï¼‰
          2. ${PROJECT_DIR}/media/images/scene${SCENE_NUM}_fallback.png ã«ä¿å­˜
          3. çŸ­ã„å‹•ç”»ã«å¤‰æ›ï¼ˆ4-5ç§’ï¼‰
          4. ${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_fallback.mp4 ã«ä¿å­˜
          5. ä¿å­˜ç¢ºèª"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,mcp__i2v-*,Write,Bash" \
            --max-turns 60 \
            --permission-mode "bypassPermissions" \
            -p "$FALLBACK_PROMPT"

      - name: Upload recovery artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scene-${{ matrix.scene }}-recovery
          path: |
            ${{ needs.setup.outputs.project_dir }}/media/images/scene${{ matrix.scene }}*
            ${{ needs.setup.outputs.project_dir }}/media/videos/scene${{ matrix.scene }}*

  create_lipsync:
    needs: [setup, generate_anchor, generate_narration]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      lipsync_video: ${{ steps.lipsync.outputs.lipsync_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: anchor-image
          path: ${{ needs.setup.outputs.project_dir }}/media/images/

      - name: Download narration
        uses: actions/download-artifact@v4
        with:
          name: narration-audio
          path: ${{ needs.setup.outputs.project_dir }}/media/audio/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate lipsync video
        id: lipsync
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Find anchor image and audio
          ANCHOR_IMAGE=$(find "$PROJECT_DIR" -name "*anchor*.png" -type f 2>/dev/null | head -1)
          NARRATION_AUDIO=$(find "$PROJECT_DIR" -name "*.mp3" -type f 2>/dev/null | head -1)
          
          if [ -n "$ANCHOR_IMAGE" ] && [ -n "$NARRATION_AUDIO" ]; then
            LIPSYNC_PATH="${PROJECT_DIR}/media/videos/anchor_lipsync.mp4"
            
            LIPSYNC_PROMPT="ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            ç”»åƒ: ${ANCHOR_IMAGE}
            éŸ³å£°: ${NARRATION_AUDIO}
            
            æ‰‹é †:
            1. ä¸Šè¨˜ã®ç”»åƒã¨éŸ³å£°ã§ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’ç”Ÿæˆï¼ˆMCP Lipsyncãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
            2. ç”Ÿæˆã—ãŸå‹•ç”»ã‚’${LIPSYNC_PATH}ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
            3. ls -la ${PROJECT_DIR}/media/videos/ ã§ä¿å­˜ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

            è¨­å®š:
            - éŸ³å£°ã«åˆã‚ã›ãŸè‡ªç„¶ãªãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯
            - é«˜å“è³ªãªå£ã®å‹•ã
            - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªä»•ä¸ŠãŒã‚Š"

            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__v2v-*,Write,Bash" \
              --max-turns 60 \
              --permission-mode "bypassPermissions" \
              -p "$LIPSYNC_PROMPT"

            # Verify lipsync video
            LIPSYNC_VIDEO=$(find "$PROJECT_DIR" -name "*lipsync*.mp4" -type f 2>/dev/null | head -1)
            if [ -f "$LIPSYNC_VIDEO" ] && [ $(stat -c%s "$LIPSYNC_VIDEO" 2>/dev/null || echo 0) -gt 500000 ]; then
              echo "âœ… Lipsync video generated: $LIPSYNC_VIDEO"
              echo "lipsync_video=$LIPSYNC_VIDEO" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Lipsync video generation failed"
              echo "lipsync_video=" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Missing anchor image or narration audio"
            echo "lipsync_video=" >> $GITHUB_OUTPUT
          fi

      - name: Upload lipsync artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lipsync-video
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/

  create_editing_plan:
    needs: [setup, generate_scenes, create_lipsync]
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: always()
    outputs:
      editing_plan: ${{ steps.plan.outputs.editing_plan }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all scene artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: scene-*-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/
          merge-multiple: true

      - name: Download lipsync artifacts
        uses: actions/download-artifact@v4
        with:
          name: lipsync-video
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Create editing plan
        id: plan
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          PLAN_PROMPT="å‹•ç”»ç·¨é›†è¨ˆç”»ä½œæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          åˆ©ç”¨å¯èƒ½ãªç´ æã‚’åˆ†æž:
          - èƒŒæ™¯å‹•ç”»: ${PROJECT_DIR}/media/videos/scene*.mp4
          - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»: ${PROJECT_DIR}/media/videos/anchor_lipsync.mp4
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°: ${PROJECT_DIR}/media/audio/narration.mp3

          æ‰‹é †:
          1. å…¨ã¦ã®åˆ©ç”¨å¯èƒ½ãªç´ æã‚’ls -laã§ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          2. å„ç´ æã®è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆffprobeã‚³ãƒžãƒ³ãƒ‰ç­‰ï¼‰
          3. ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªç·¨é›†è¨ˆç”»ã‚’ä½œæˆ:
             - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ§‹é€ ï¼ˆ60ç§’æ§‹æˆï¼‰
             - ã‚¢ãƒ³ã‚«ãƒ¼ã¨èƒŒæ™¯ã®åˆæˆæ–¹å¼ï¼ˆPiPé…ç½®ã¾ãŸã¯ã‚¯ãƒ­ãƒžã‚­ãƒ¼ï¼‰
             - ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³è¨­è¨ˆ
             - éŸ³éŸ¿ãƒŸãƒƒã‚¯ã‚¹è¨ˆç”»
          4. FFmpegã‚³ãƒžãƒ³ãƒ‰åˆ—ã‚’ç”Ÿæˆ
          5. ç·¨é›†è¨ˆç”»ã‚’${PROJECT_DIR}/metadata/editing_plan.json ã«ä¿å­˜ï¼ˆWriteãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰

          é‡è¦: å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã—ã€ç¾å®Ÿçš„ãªç·¨é›†è¨ˆç”»ã‚’ä½œæˆã—ã¦ãã ã•ã„"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Write,Bash" \
            --max-turns 40 \
            --permission-mode "bypassPermissions" \
            -p "$PLAN_PROMPT"

          # Verify editing plan
          if [ -f "$PROJECT_DIR/metadata/editing_plan.json" ]; then
            PLAN_DATA=$(cat "$PROJECT_DIR/metadata/editing_plan.json")
            echo "editing_plan=$PLAN_DATA" >> $GITHUB_OUTPUT
            echo "âœ… Editing plan created"
          else
            echo "âš ï¸ Editing plan creation failed"
            echo "editing_plan={\"status\":\"failed\"}" >> $GITHUB_OUTPUT
          fi

      - name: Upload editing plan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: editing-plan
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  final_video_composition:
    needs: [setup, create_editing_plan]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*"
          path: ${{ needs.setup.outputs.project_dir }}/
          merge-multiple: true

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code SDK
        run: npm install -g @anthropic-ai/claude-code

      - name: Compose final video
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          FINAL_VIDEO="${PROJECT_DIR}/final/news_video_final.mp4"
          mkdir -p "${PROJECT_DIR}/final"
          
          COMPOSITION_PROMPT="æœ€çµ‚å‹•ç”»åˆæˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

          æ‰‹é †:
          1. ç·¨é›†è¨ˆç”»ã‚’èª­ã¿è¾¼ã¿: ${PROJECT_DIR}/metadata/editing_plan.json
          2. åˆ©ç”¨å¯èƒ½ãªå…¨ç´ æã‚’ç¢ºèªï¼ˆBashãƒ„ãƒ¼ãƒ«ä½¿ç”¨ï¼‰
          3. ç·¨é›†è¨ˆç”»ã«åŸºã¥ãFFmpegã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:
             - èƒŒæ™¯å‹•ç”»ã®é€£çµ
             - ã‚¢ãƒ³ã‚«ãƒ¼å‹•ç”»ã®åˆæˆï¼ˆPiPé…ç½®ï¼‰
             - éŸ³å£°ãƒŸãƒƒã‚¯ã‚¹
             - ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„é¢¨ã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¿½åŠ 
          4. æœ€çµ‚å‹•ç”»ã‚’${FINAL_VIDEO}ã«å‡ºåŠ›
          5. å“è³ªç¢ºèªï¼ˆè§£åƒåº¦ã€é•·ã•ã€éŸ³é‡ãƒ¬ãƒ™ãƒ«ç­‰ï¼‰

          ç›®æ¨™å“è³ª:
          - 1920x1080, 30fps
          - ${{ github.event.inputs.video_duration }}ç§’
          - éŸ³å£° -14LUFS
          - ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„å“è³ª"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write,Bash" \
            --max-turns 60 \
            --permission-mode "bypassPermissions" \
            -p "$COMPOSITION_PROMPT"

          # Verify final video
          ls -la "$PROJECT_DIR/final/"
          
          FINAL_VIDEO_FILE=$(find "$PROJECT_DIR" -name "*final*.mp4" -type f 2>/dev/null | head -1)
          if [ -f "$FINAL_VIDEO_FILE" ]; then
            FILE_SIZE=$(stat -c%s "$FINAL_VIDEO_FILE" 2>/dev/null || echo 0)
            echo "âœ… Final video created: $FINAL_VIDEO_FILE (${FILE_SIZE} bytes)"
            
            # Quality check with ffprobe
            if command -v ffprobe >/dev/null 2>&1; then
              DURATION=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$FINAL_VIDEO_FILE" 2>/dev/null || echo "unknown")
              RESOLUTION=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width,height -of csv="s=x:p=0" "$FINAL_VIDEO_FILE" 2>/dev/null || echo "unknown")
              echo "ðŸ“Š Video info: Duration=${DURATION}s, Resolution=${RESOLUTION}"
            fi
          else
            echo "âš ï¸ Final video not found"
          fi

      - name: Generate summary report
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          echo "# News Video Generation Report" > "$PROJECT_DIR/final/report.md"
          echo "" >> "$PROJECT_DIR/final/report.md"
          echo "## Parameters" >> "$PROJECT_DIR/final/report.md"
          echo "- Topic: ${{ github.event.inputs.topic }}" >> "$PROJECT_DIR/final/report.md"
          echo "- Duration: ${{ github.event.inputs.video_duration }}s" >> "$PROJECT_DIR/final/report.md"
          echo "- Category: ${{ github.event.inputs.category }}" >> "$PROJECT_DIR/final/report.md"
          echo "- Anchor Style: ${{ github.event.inputs.anchor_style }}" >> "$PROJECT_DIR/final/report.md"
          echo "- Generated: \$(date)" >> "$PROJECT_DIR/final/report.md"
          echo "" >> "$PROJECT_DIR/final/report.md"
          echo "## Generated Files" >> "$PROJECT_DIR/final/report.md"
          echo "\`\`\`" >> "$PROJECT_DIR/final/report.md"
          find "$PROJECT_DIR" -type f -name "*.mp4" -o -name "*.png" -o -name "*.mp3" -o -name "*.json" | sort >> "$PROJECT_DIR/final/report.md"
          echo "\`\`\`" >> "$PROJECT_DIR/final/report.md"

      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-news-video
          path: ${{ needs.setup.outputs.project_dir }}/final/

      - name: Add summary to GitHub
        if: always()
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          echo "## ðŸ“º News Video Generation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic**: ${{ github.event.inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration**: ${{ github.event.inputs.video_duration }}s" >> $GITHUB_STEP_SUMMARY
          echo "**Category**: ${{ github.event.inputs.category }}" >> $GITHUB_STEP_SUMMARY
          echo "**Anchor**: ${{ github.event.inputs.anchor_style }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count generated files
          IMAGES=$(find "$PROJECT_DIR" -name "*.png" -type f 2>/dev/null | wc -l)
          VIDEOS=$(find "$PROJECT_DIR" -name "*.mp4" -type f 2>/dev/null | wc -l)
          AUDIO=$(find "$PROJECT_DIR" -name "*.mp3" -type f 2>/dev/null | wc -l)
          
          echo "**Generated Content**:" >> $GITHUB_STEP_SUMMARY
          echo "- Images: $IMAGES files" >> $GITHUB_STEP_SUMMARY
          echo "- Videos: $VIDEOS files" >> $GITHUB_STEP_SUMMARY
          echo "- Audio: $AUDIO files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Final video info
          FINAL_VIDEO=$(find "$PROJECT_DIR" -name "*final*.mp4" -type f 2>/dev/null | head -1)
          if [ -f "$FINAL_VIDEO" ]; then
            SIZE=$(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0)
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "**Final Video**: âœ… Generated (${SIZE_MB}MB)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Final Video**: âŒ Not generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at**: $(date)" >> $GITHUB_STEP_SUMMARY
