name: "🎓 Test AI Education Video Generation"
run-name: "🎓 AI Education Video | ${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      topic:
        description: "Educational topic"
        required: true
        default: "機械学習の基礎"
      language:
        description: "Language for narration"
        required: true
        default: "ja"
        type: choice
        options:
          - ja
          - en

permissions:
  contents: write
  actions: write

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  setup:
    name: "🚀 Setup & Planning"
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      plan_path: ${{ steps.plan.outputs.plan_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Project Directory
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/ai-education-$TIMESTAMP"
          mkdir -p "$PROJECT_DIR"/{content,media,final}
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "✅ Created project directory: $PROJECT_DIR"

      - name: Create Educational Content Plan
        id: plan
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          
          # Create educational content structure
          cat > "$PROJECT_DIR/content/lesson-plan.json" << 'EOF'
          {
            "topic": "${{ inputs.topic }}",
            "language": "${{ inputs.language }}",
            "duration": "3-5 minutes",
            "sections": [
              {
                "title": "Introduction",
                "duration": "30s",
                "content": "Welcome and topic introduction"
              },
              {
                "title": "Core Concepts",
                "duration": "2min",
                "content": "Main educational content"
              },
              {
                "title": "Examples",
                "duration": "1min",
                "content": "Practical examples"
              },
              {
                "title": "Summary",
                "duration": "30s",
                "content": "Key takeaways"
              }
            ]
          }
          EOF
          
          echo "plan_path=$PROJECT_DIR/content/lesson-plan.json" >> $GITHUB_OUTPUT
          echo "✅ Created lesson plan"

  generate_content:
    name: "📝 Generate Educational Content"
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      script_path: ${{ steps.script.outputs.script_path }}
      prompts_path: ${{ steps.prompts.outputs.prompts_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Claude Code SDK
        uses: claude-ai/claude-code-sdk@v1
        with:
          oauth-token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Generate Narration Script
        id: script
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Simulate narration generation (in real workflow, would use Claude Code SDK)
          cat > "$PROJECT_DIR/content/narration.txt" << 'EOF'
          こんにちは！今日は${{ inputs.topic }}について学んでいきましょう。
          
          機械学習とは、コンピュータがデータから学習し、
          明示的にプログラムされていなくても予測や判断を行える技術です。
          
          主な学習方法には以下があります：
          1. 教師あり学習 - ラベル付きデータから学習
          2. 教師なし学習 - パターンを自動発見
          3. 強化学習 - 試行錯誤から最適解を学習
          
          実際の応用例として、画像認識、音声認識、推薦システムなどがあります。
          
          今日学んだポイントをまとめると：
          - 機械学習はデータから学ぶ技術
          - 様々な学習方法がある
          - 実世界で幅広く活用されている
          
          ご視聴ありがとうございました！
          EOF
          
          echo "script_path=$PROJECT_DIR/content/narration.txt" >> $GITHUB_OUTPUT

      - name: Generate Visual Prompts
        id: prompts
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Create image generation prompts
          cat > "$PROJECT_DIR/content/visual-prompts.json" << 'EOF'
          {
            "scenes": [
              {
                "id": "intro",
                "prompt": "Modern educational banner with AI and machine learning icons, professional blue gradient background"
              },
              {
                "id": "concept",
                "prompt": "Infographic showing machine learning process: data input, algorithm, output predictions, clean minimal design"
              },
              {
                "id": "types",
                "prompt": "Three-panel comparison of supervised, unsupervised, and reinforcement learning with simple icons"
              },
              {
                "id": "examples",
                "prompt": "Collage of real-world ML applications: face recognition, voice assistant, recommendation system"
              }
            ]
          }
          EOF
          
          echo "prompts_path=$PROJECT_DIR/content/visual-prompts.json" >> $GITHUB_OUTPUT

  create_media:
    name: "🎨 Create Media Assets"
    runs-on: ubuntu-latest
    needs: [setup, generate_content]
    outputs:
      images_created: ${{ steps.images.outputs.count }}
      audio_path: ${{ steps.audio.outputs.audio_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Simulate Image Generation
        id: images
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # In real workflow, would use MCP image generation
          # For now, create placeholder images
          for i in 1 2 3 4; do
            touch "$PROJECT_DIR/media/scene-$i.png"
            echo "✅ Created placeholder image: scene-$i.png"
          done
          
          echo "count=4" >> $GITHUB_OUTPUT

      - name: Simulate Audio Generation
        id: audio
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # In real workflow, would use MCP TTS
          # For now, create placeholder audio
          touch "$PROJECT_DIR/media/narration.mp3"
          echo "✅ Created placeholder audio: narration.mp3"
          
          echo "audio_path=$PROJECT_DIR/media/narration.mp3" >> $GITHUB_OUTPUT

  create_video:
    name: "🎬 Create Final Video"
    runs-on: ubuntu-latest
    needs: [setup, create_media]
    outputs:
      video_path: ${{ steps.video.outputs.video_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Simulate Video Creation
        id: video
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # In real workflow, would use video generation and editing
          # For now, create placeholder video
          touch "$PROJECT_DIR/final/educational-video.mp4"
          echo "✅ Created placeholder video: educational-video.mp4"
          
          # Create summary
          cat > "$PROJECT_DIR/final/summary.md" << 'EOF'
          # AI Education Video Generation Summary
          
          ## Topic: ${{ inputs.topic }}
          
          ### Generated Assets:
          - 4 educational images
          - 1 narration audio file
          - 1 final video (3-5 minutes)
          
          ### Content Sections:
          1. Introduction (30s)
          2. Core Concepts (2min)
          3. Examples (1min)
          4. Summary (30s)
          
          ### Status: ✅ Complete
          EOF
          
          echo "video_path=$PROJECT_DIR/final/educational-video.mp4" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-education-video
          path: ${{ needs.setup.outputs.project_dir }}/

  summary:
    name: "📊 Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [setup, generate_content, create_media, create_video]
    steps:
      - name: Generate Summary
        run: |
          echo "# 🎓 AI Education Video Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Topic: ${{ inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "## Language: ${{ inputs.language }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Content Planning: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Script Generation: Complete" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Media Creation: ${{ needs.create_media.outputs.images_created }} images" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Video Assembly: Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "- Project: ${{ needs.setup.outputs.project_dir }}" >> $GITHUB_STEP_SUMMARY
          echo "- Video: ${{ needs.create_video.outputs.video_path }}" >> $GITHUB_STEP_SUMMARY