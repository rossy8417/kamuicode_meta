name: Dynamic Question Generator
run-name: ü§ñ Generating dynamic stepback questions for Issue #${{ github.event.issue.number }}

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: IssueÊ§úË®º„Å®Ë¶ÅÊ±ÇÊäΩÂá∫
  validate-issue-format:
    runs-on: ubuntu-latest
    # „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±ÇIssue„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
    if: contains(github.event.issue.title, 'Workflow Request')
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      request_summary: ${{ steps.validate.outputs.request_summary }}
    
    steps:
      - name: Validate Issue Format
        id: validate
        run: |
          echo "üîç Validating Issue format and extracting basic info..."
          
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # IssueÂΩ¢Âºè„ÅÆÂü∫Êú¨Ê§úË®º
          if echo "$ISSUE_TITLE" | grep -q "Workflow Request"; then
            echo "‚úÖ Valid workflow request Issue detected"
            
            # Âü∫Êú¨ÁöÑ„Å™Ë¶ÅÊ±Ç„Çµ„Éû„É™„Éº„ÇíÊäΩÂá∫ÔºàÊúÄÂàù„ÅÆ200ÊñáÂ≠óÔºâ
            SUMMARY=$(echo "$ISSUE_BODY" | head -5 | tr '\n' ' ' | cut -c1-200)
            echo "üìù Request summary: $SUMMARY"
            
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "request_summary=$SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Not a workflow request Issue - skipping"
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

  extract-user-request:
    needs: validate-issue-format
    runs-on: ubuntu-latest
    if: needs.validate-issue-format.outputs.is_valid == 'true'
    outputs:
      request_file: ${{ steps.extract.outputs.request_file }}
      workflow_type: ${{ steps.extract.outputs.workflow_type }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Extract and Structure User Request
        id: extract
        run: |
          echo "üì• Extracting detailed user request from Issue..."
          
          mkdir -p .meta/dynamic-requests
          
          ISSUE_BODY="${{ github.event.issue.body }}"
          REQUEST_ID="req-$(date +%Y%m%d-%H%M%S)-${{ github.event.issue.number }}"
          REQUEST_FILE=".meta/dynamic-requests/${REQUEST_ID}.md"
          
          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„ÅÆÊé®Ê∏¨
          if echo "$ISSUE_BODY" | grep -qi "video\|ÂãïÁîª"; then
            WORKFLOW_TYPE="video-generation"
          elif echo "$ISSUE_BODY" | grep -qi "image\|ÁîªÂÉè"; then
            WORKFLOW_TYPE="image-generation"
          elif echo "$ISSUE_BODY" | grep -qi "audio\|music\|Èü≥Ê•Ω\|Èü≥Â£∞"; then
            WORKFLOW_TYPE="audio-generation"
          else
            WORKFLOW_TYPE="custom"
          fi
          
          # ÊßãÈÄ†Âåñ„Åï„Çå„Åü„É™„ÇØ„Ç®„Çπ„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > "$REQUEST_FILE" << EOF
          # Dynamic Workflow Request
          
          **Issue Number:** #${{ github.event.issue.number }}
          **Workflow Type:** $WORKFLOW_TYPE
          **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Original User Request
          
          $ISSUE_BODY
          
          ## Analysis Metadata
          - Request ID: $REQUEST_ID
          - Estimated complexity: TBD
          - Required clarifications: TBD
          EOF
          
          echo "‚úÖ User request extracted and structured"
          echo "üìÅ Request file: $REQUEST_FILE"
          echo "üéØ Workflow type: $WORKFLOW_TYPE"
          
          echo "request_file=$REQUEST_FILE" >> $GITHUB_OUTPUT
          echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT
          
      - name: Upload Request Data
        uses: actions/upload-artifact@v4
        with:
          name: request-data-${{ github.event.issue.number }}
          path: .meta/dynamic-requests/
          retention-days: 7

  generate-dynamic-questions:
    needs: [extract-user-request]
    runs-on: ubuntu-latest
    outputs:
      questions_generated: ${{ steps.generate.outputs.questions_generated }}
      questions_file: ${{ steps.generate.outputs.questions_file }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Request Data
        uses: actions/download-artifact@v4
        with:
          name: request-data-${{ github.event.issue.number }}
          path: .meta/dynamic-requests/
        
      - name: Generate Dynamic Stepback Questions
        id: generate
        run: |
          echo "ü§ñ Generating dynamic stepback questions..."
          
          mkdir -p .meta/dynamic-questions
          
          # REQUEST_FILE„ÅåÁõ∏ÂØæ„Éë„Çπ„ÅßÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Éï„Ç°„Ç§„É´„ÇíÂÜçÊ§úÁ¥¢
          REQUEST_FILE="${{ needs.extract-user-request.outputs.request_file }}"
          if [ ! -f "$REQUEST_FILE" ]; then
            echo "üîç Searching for request file in downloaded artifacts..."
            REQUEST_FILE=$(find .meta/dynamic-requests -name "*.md" | head -1)
            if [ -z "$REQUEST_FILE" ]; then
              echo "‚ùå No request file found in artifacts"
              exit 1
            fi
            echo "üìÅ Found request file: $REQUEST_FILE"
          fi
          
          WORKFLOW_TYPE="${{ needs.extract-user-request.outputs.workflow_type }}"
          
          # Áµ±Âêà„ÉÜ„Çπ„Éà„ÅÆ„Åü„ÇÅ„ÄÅÂõ∫ÂÆöË≥™Âïè„ÇíÁîüÊàêÔºàÂ∞ÜÊù•ÁöÑ„Å´Claude CodeÁµ±Âêà‰∫àÂÆöÔºâ
          echo "üß† Generating contextual questions for $WORKFLOW_TYPE workflow..."
          
          cat > .meta/dynamic-questions/generated-questions.md << 'EOF'
          ## üìã „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË©≥Á¥∞Âåñ„ÅÆ„Åü„ÇÅ„ÅÆË≥™Âïè
          
          „Çà„ÇäÊ≠£Á¢∫„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ‰ª•‰∏ã„ÅÆË≥™Âïè„Å´„ÅäÁ≠î„Åà„Åè„Å†„Åï„ÅÑÔºö
          
          **Q1: Âá∫ÂäõÂìÅË≥™„ÉªÂΩ¢Âºè„Å´„Å§„ÅÑ„Å¶**
          ÁîªÂÉè„ÄÅÂãïÁîª„ÄÅÈü≥Ê•Ω„ÅÆÂìÅË≥™Ë®≠ÂÆö„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          - ÁîªÂÉèËß£ÂÉèÂ∫¶: 1920x1080 / 1280x720 / „Ç´„Çπ„Çø„É†
          - ÂãïÁîªÂìÅË≥™: È´òÂìÅË≥™ÔºàÊôÇÈñìÈáçË¶ñ„Åõ„ÅöÔºâ / „Éê„É©„É≥„Çπ / È´òÈÄüÁîüÊàê
          - Èü≥Ê•ΩÂìÅË≥™: È´òÂìÅË≥™ / Ê®ôÊ∫ñ / ËªΩÈáè
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          **Q2: Âá¶ÁêÜ„Éï„É≠„Éº„ÉªÁµ±ÂêàÊñπÊ≥ï„Å´„Å§„ÅÑ„Å¶**
          ÂêÑÊÆµÈöé„ÅÆÂá∫Âäõ„Çí„Å©„ÅÆ„Çà„ÅÜ„Å´ÈÄ£Êê∫„Åï„Åõ„Çã„Åã„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          - ÁîªÂÉè‚ÜíÂãïÁîª: ÁîªÂÉè„Çí„Éô„Éº„Çπ„Å´ÂãïÁîªÁîüÊàê / Áã¨Á´ã„Åó„Å¶ÂãïÁîª‰ΩúÊàê
          - ÂãïÁîª„Å®Èü≥Ê•Ω„ÅÆÁµ±Âêà: Ëá™ÂãïÁµ±Âêà / ÂÄãÂà•„Éï„Ç°„Ç§„É´Êèê‰æõ
          - Âá¶ÁêÜÈ†ÜÂ∫è: È†ÜÊ¨°ÂÆüË°å / ‰∏¶ÂàóÂá¶ÁêÜÂèØËÉΩ
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          **Q3: ÊäÄË°ì‰ªïÊßò„ÉªÂà∂Á¥Ñ„Å´„Å§„ÅÑ„Å¶**
          ÂÆüË°åÊôÇÈñì„ÇÑ„Çµ„Éº„Éì„ÇπÈÅ∏Êäû„ÅÆÂÑ™ÂÖàÂ∫¶„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          - ÂÆüË°åÊôÇÈñì: ÂìÅË≥™ÈáçË¶ñÔºàÊôÇÈñì‰∏çÂïèÔºâ / 60ÂàÜ‰ª•ÂÜÖ / 30ÂàÜ‰ª•ÂÜÖ
          - MCP„Çµ„Éº„Éì„Çπ: ÁâπÂÆö„Çµ„Éº„Éì„ÇπÂ∏åÊúõ / Êé®Â•®Ë®≠ÂÆö / È´òÈÄüÈáçË¶ñ
          - „Ç®„É©„ÉºÂá¶ÁêÜ: Âé≥ÂØÜÔºàÂÅúÊ≠¢Ôºâ / ÂØõÂÆπÔºàÁ∂ôÁ∂öÔºâ / Ëá™Âãï„É™„Éà„É©„Ç§
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          **Q4: „Ç≥„É≥„ÉÜ„É≥„ÉÑË©≥Á¥∞„Å´„Å§„ÅÑ„Å¶**
          ÁîüÊàê„Åô„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂÖ∑‰ΩìÁöÑ„Å™„Çπ„Çø„Ç§„É´„ÇÑÁâπÂæ¥„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          - ÁîªÂÉè„Çπ„Çø„Ç§„É´: „É™„Ç¢„É´Á≥ª / „Ç¢„Éã„É°Á≥ª / ÊäΩË±°Á≥ª
          - ÂãïÁîª„ÅÆÈï∑„Åï: Áü≠Á∑®(3-5Áßí) / Ê®ôÊ∫ñ(8-10Áßí) / Èï∑Á∑®(15Áßí+)
          - Èü≥Ê•Ω„Ç∏„É£„É≥„É´: ÊåáÂÆö„ÅÇ„Çä / „É†„Éº„ÉâÈáçË¶ñ / „Åä„Åæ„Åã„Åõ
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          ---
          
          ### üìù ÂõûÁ≠îÂæå„ÅÆÊâãÈ†Ü
          1. ‰∏äË®ò„ÅÆË≥™Âïè„Å´ÂõûÁ≠î„ÇíË®òÂÖ•
          2. „Åì„ÅÆIssue„ÅÆÊú¨Êñá„ÇíÁ∑®ÈõÜ„Åó„Å¶ÂõûÁ≠î„ÇíËøΩÂä†
          3. ÂõûÁ≠îÂÆå‰∫ÜÂæå„ÄÅ„Äå**start**„Äç„Å®„Ç≥„É°„É≥„Éà„Åó„Å¶„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„ÇíÈñãÂßã
          
          ü§ñ *Generated by Dynamic Stepback Question System v6*
          EOF
          
          echo "‚úÖ Dynamic questions generated successfully"
          echo "questions_generated=true" >> $GITHUB_OUTPUT
          echo "questions_file=.meta/dynamic-questions/generated-questions.md" >> $GITHUB_OUTPUT
          
          # ÁîüÊàê„Åï„Çå„ÅüË≥™Âïè„ÅÆÁ¢∫Ë™ç
          QUESTION_COUNT=$(grep -c "^**Q[0-9]" .meta/dynamic-questions/generated-questions.md || echo "0")
          echo "üìä Generated $QUESTION_COUNT dynamic questions"
          
      - name: Upload Generation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dynamic-questions-${{ github.run_number }}
          path: .meta/dynamic-questions/
          retention-days: 30

  update-issue-body:
    needs: [generate-dynamic-questions]
    runs-on: ubuntu-latest
    if: needs.generate-dynamic-questions.outputs.questions_generated == 'true'
    outputs:
      update_success: ${{ steps.update.outputs.update_success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Question Data
        uses: actions/download-artifact@v4
        with:
          name: dynamic-questions-${{ github.run_number }}
          path: .meta/dynamic-questions/
        
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
        env:
          GITHUB_TOKEN: ${{ github.token }}
        
      - name: Update Issue with Dynamic Questions
        id: update
        run: |
          echo "üìù Updating Issue #${{ github.event.issue.number }} with generated questions..."
          
          QUESTIONS_FILE="${{ needs.generate-dynamic-questions.outputs.questions_file }}"
          
          if [ ! -f "$QUESTIONS_FILE" ]; then
            echo "‚ùå Questions file not found"
            exit 1
          fi
          
          # ÁèæÂú®„ÅÆIssueÊú¨Êñá„ÇíÂèñÂæó
          CURRENT_BODY=$(gh issue view ${{ github.event.issue.number }} --json body --jq '.body')
          
          # ÂãïÁöÑË≥™Âïè„Çí Issue Êú¨Êñá„Å´ËøΩÂä†
          cat > .meta/updated-issue-body.md << EOF
          $CURRENT_BODY
          
          ---
          
          EOF
          
          cat "$QUESTIONS_FILE" >> .meta/updated-issue-body.md
          
          # IssueÊú¨Êñá„ÇíÊõ¥Êñ∞
          if gh issue edit ${{ github.event.issue.number }} --body-file .meta/updated-issue-body.md; then
            echo "‚úÖ Issue updated with dynamic questions"
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to update Issue"
            echo "update_success=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

  add-response-labels:
    needs: [update-issue-body]
    runs-on: ubuntu-latest
    if: needs.update-issue-body.outputs.update_success == 'true'
    
    steps:
      - name: Add Awaiting Response Labels
        run: |
          echo "üè∑Ô∏è Adding response labels to Issue #${{ github.event.issue.number }}..."
          
          # GitHub CLI„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          
          # ÂÆå‰∫ÜÈÄöÁü•„Ç≥„É°„É≥„Éà
          gh issue comment ${{ github.event.issue.number }} \
            --body "ü§ñ **ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™Âïè„ÇíÁîüÊàê„Åó„Åæ„Åó„ÅüÔºÅ**

          „ÅÇ„Å™„Åü„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±Ç„ÇíÂàÜÊûê„Åó„ÄÅÊúÄÈÅ©Âåñ„ÅÆ„Åü„ÇÅ„ÅÆË©≥Á¥∞Ë≥™Âïè„Çí‰∏äË®ò„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ

          **üìù Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó:**
          1. ‰∏äË®ò„ÅÆË≥™Âïè„Å´Ë©≥Á¥∞„Å™ÂõûÁ≠î„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          2. ÂõûÁ≠îÂÆå‰∫ÜÂæå„ÄÅ„Äå**start**„Äç„Å®„Ç≥„É°„É≥„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          3. Ëá™ÂãïÁöÑ„Å´„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô

          üéØ **„Çà„ÇäË©≥Á¥∞„Å™ÂõûÁ≠î„Çí„ÅÑ„Åü„Å†„Åè„Åª„Å©„ÄÅÁ≤æÂØÜ„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åß„Åç„Åæ„Åô„ÄÇ**

          ---
          ü§ñ *Dynamic Question Generator v6*" \
            2>/dev/null || echo "‚ö†Ô∏è Failed to post completion comment"
        env:
          GITHUB_TOKEN: ${{ github.token }}