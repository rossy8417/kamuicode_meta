name: Dynamic Question Generator
run-name: ü§ñ Generating dynamic stepback questions for Issue #${{ github.event.issue.number }}

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: IssueÊ§úË®º„Å®Ë¶ÅÊ±ÇÊäΩÂá∫
  validate-issue-format:
    runs-on: ubuntu-latest
    # „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±ÇIssue„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
    if: contains(github.event.issue.title, 'Workflow Request')
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      request_summary: ${{ steps.validate.outputs.request_summary }}
    
    steps:
      - name: Validate Issue Format
        id: validate
        run: |
          echo "üîç Validating Issue format and extracting basic info..."
          
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # IssueÂΩ¢Âºè„ÅÆÂü∫Êú¨Ê§úË®º
          if echo "$ISSUE_TITLE" | grep -q "Workflow Request"; then
            echo "‚úÖ Valid workflow request Issue detected"
            
            # Âü∫Êú¨ÁöÑ„Å™Ë¶ÅÊ±Ç„Çµ„Éû„É™„Éº„ÇíÊäΩÂá∫ÔºàÊúÄÂàù„ÅÆ200ÊñáÂ≠óÔºâ
            SUMMARY=$(echo "$ISSUE_BODY" | head -5 | tr '\n' ' ' | cut -c1-200)
            echo "üìù Request summary: $SUMMARY"
            
            echo "is_valid=true" >> $GITHUB_OUTPUT
            echo "request_summary=$SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Not a workflow request Issue - skipping"
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

  extract-user-request:
    needs: validate-issue-format
    runs-on: ubuntu-latest
    if: needs.validate-issue-format.outputs.is_valid == 'true'
    outputs:
      request_file: ${{ steps.extract.outputs.request_file }}
      workflow_type: ${{ steps.extract.outputs.workflow_type }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Extract and Structure User Request
        id: extract
        run: |
          echo "üì• Extracting detailed user request from Issue..."
          
          mkdir -p .meta/dynamic-requests
          
          ISSUE_BODY="${{ github.event.issue.body }}"
          REQUEST_ID="req-$(date +%Y%m%d-%H%M%S)-${{ github.event.issue.number }}"
          REQUEST_FILE=".meta/dynamic-requests/${REQUEST_ID}.md"
          
          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„ÅÆÊé®Ê∏¨
          if echo "$ISSUE_BODY" | grep -qi "video\|ÂãïÁîª"; then
            WORKFLOW_TYPE="video-generation"
          elif echo "$ISSUE_BODY" | grep -qi "image\|ÁîªÂÉè"; then
            WORKFLOW_TYPE="image-generation"
          elif echo "$ISSUE_BODY" | grep -qi "audio\|music\|Èü≥Ê•Ω\|Èü≥Â£∞"; then
            WORKFLOW_TYPE="audio-generation"
          else
            WORKFLOW_TYPE="custom"
          fi
          
          # ÊßãÈÄ†Âåñ„Åï„Çå„Åü„É™„ÇØ„Ç®„Çπ„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
          cat > "$REQUEST_FILE" << EOF
          # Dynamic Workflow Request
          
          **Issue Number:** #${{ github.event.issue.number }}
          **Workflow Type:** $WORKFLOW_TYPE
          **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## Original User Request
          
          $ISSUE_BODY
          
          ## Analysis Metadata
          - Request ID: $REQUEST_ID
          - Estimated complexity: TBD
          - Required clarifications: TBD
          EOF
          
          echo "‚úÖ User request extracted and structured"
          echo "üìÅ Request file: $REQUEST_FILE"
          echo "üéØ Workflow type: $WORKFLOW_TYPE"
          
          echo "request_file=$REQUEST_FILE" >> $GITHUB_OUTPUT
          echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT

  check-mcp-config:
    needs: extract-user-request
    runs-on: ubuntu-latest
    outputs:
      mcp_ready: ${{ steps.check.outputs.mcp_ready }}
      required_services: ${{ steps.check.outputs.required_services }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check MCP Configuration
        id: check
        run: |
          echo "üîß Checking MCP configuration for AI generation services..."
          
          WORKFLOW_TYPE="${{ needs.extract-user-request.outputs.workflow_type }}"
          
          # MCP„ÅåÂøÖË¶Å„Å™„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if [[ "$WORKFLOW_TYPE" =~ ^(video|image|audio) ]]; then
            echo "üéØ AI generation workflow detected - checking MCP config"
            
            # MCPË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
            if [ -f ".claude/mcp-kamuicode.json" ]; then
              echo "‚úÖ MCP configuration found"
              
              # Âà©Áî®ÂèØËÉΩ„Å™„Çµ„Éº„Éì„Çπ„ÇíÁ¢∫Ë™ç
              SERVICES=$(jq -r '.mcpServers | keys[]' .claude/mcp-kamuicode.json 2>/dev/null | tr '\n' ',' | sed 's/,$//')
              echo "üìã Available MCP services: $SERVICES"
              
              echo "mcp_ready=true" >> $GITHUB_OUTPUT
              echo "required_services=$SERVICES" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è MCP configuration not found - AI generation may be limited"
              echo "mcp_ready=false" >> $GITHUB_OUTPUT
              echo "required_services=none" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ÑπÔ∏è Text-only workflow - MCP not required"
            echo "mcp_ready=true" >> $GITHUB_OUTPUT
            echo "required_services=none" >> $GITHUB_OUTPUT
          fi

  generate-dynamic-questions:
    needs: [extract-user-request, check-mcp-config]
    runs-on: ubuntu-latest
    outputs:
      questions_generated: ${{ steps.generate.outputs.questions_generated }}
      questions_file: ${{ steps.generate.outputs.questions_file }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Generate Dynamic Stepback Questions
        id: generate
        run: |
          echo "ü§ñ Generating dynamic stepback questions with AI..."
          
          mkdir -p .meta/dynamic-questions
          
          REQUEST_FILE="${{ needs.extract-user-request.outputs.request_file }}"
          WORKFLOW_TYPE="${{ needs.extract-user-request.outputs.workflow_type }}"
          
          if [ ! -f "$REQUEST_FILE" ]; then
            echo "‚ùå Request file not found: $REQUEST_FILE"
            exit 1
          fi
          
          # ÂãïÁöÑË≥™ÂïèÁîüÊàê„Éó„É≠„É≥„Éó„Éà„ÅÆÊ∫ñÂÇô
          cat > .meta/dynamic-questions/generation-prompt.md << 'EOF'
          # Dynamic Stepback Question Generation
          
          ‰ª•‰∏ã„ÅÆ„É¶„Éº„Ç∂„Éº„ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±Ç„ÇíÂàÜÊûê„Åó„ÄÅ„Çà„ÇäÁ≤æÂØÜ„Å™„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„ÅÆ„Åü„ÇÅ„Å´ÂøÖË¶Å„Å™ÂÖ∑‰ΩìÁöÑË≥™Âïè„Çí3-5ÂÄãÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          ## ÂàÜÊûêÂØæË±°„ÅÆ„É¶„Éº„Ç∂„ÉºË¶ÅÊ±Ç
          EOF
          
          cat "$REQUEST_FILE" >> .meta/dynamic-questions/generation-prompt.md
          
          cat >> .meta/dynamic-questions/generation-prompt.md << 'EOF'
          
          ## Ë≥™ÂïèÁîüÊàêÊåáÁ§∫
          
          ‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„Åã„Çâ„ÄÅ„É¶„Éº„Ç∂„ÉºË¶ÅÊ±Ç„ÅÆ‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÊÉÖÂ†±„ÇÑÊõñÊòß„Å™ÈÉ®ÂàÜ„ÇíÁâπÂÆö„Åó„ÄÅÂÖ∑‰ΩìÁöÑ„Å™Ë≥™Âïè„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          1. **Âá∫ÂäõÂìÅË≥™„ÉªÂΩ¢Âºè** - Ëß£ÂÉèÂ∫¶„ÄÅÂìÅË≥™Ë®≠ÂÆö„ÄÅ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè
          2. **Âá¶ÁêÜ„Éï„É≠„Éº„ÉªÈ†ÜÂ∫è** - Âá¶ÁêÜÈ†ÜÂ∫è„ÄÅ‰æùÂ≠òÈñ¢‰øÇ„ÄÅ‰∏¶ÂàóÂá¶ÁêÜ
          3. **ÊäÄË°ì‰ªïÊßò„ÉªÂà∂Á¥Ñ** - MCP„Çµ„Éº„Éì„Çπ„ÄÅÂÆüË°åÊôÇÈñì„ÄÅ„É™„ÇΩ„Éº„Çπ
          4. **„Ç≥„É≥„ÉÜ„É≥„ÉÑ‰ªïÊßò** - „Çπ„Çø„Ç§„É´„ÄÅÈï∑„Åï„ÄÅ„ÉÜ„Éº„Éû
          5. **Áµ±Âêà„ÉªÈÄ£Êê∫** - Âá∫ÂäõÊ¥ªÁî®ÊñπÊ≥ï„ÄÅÊúÄÁµÇÊàêÊûúÁâ©ÊßãÊàê
          
          ## ÂøÖÈ†àÂá∫ÂäõÂΩ¢Âºè
          
          ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßË≥™Âïè„ÇíÁîüÊàê„Åó„ÄÅÂøÖ„Åö„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          ```bash
          mkdir -p .meta/dynamic-questions
          cat > .meta/dynamic-questions/generated-questions.md << 'EOFQ'
          ## üìã „ÉØ„Éº„ÇØ„Éï„É≠„ÉºË©≥Á¥∞Âåñ„ÅÆ„Åü„ÇÅ„ÅÆË≥™Âïè
          
          „Çà„ÇäÊ≠£Á¢∫„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ‰ª•‰∏ã„ÅÆË≥™Âïè„Å´„ÅäÁ≠î„Åà„Åè„Å†„Åï„ÅÑÔºö
          
          **Q1: [„Ç´„ÉÜ„Ç¥„É™Âêç]**
          [ÂÖ∑‰ΩìÁöÑ„Å™Ë≥™ÂïèÊñá]
          - ÈÅ∏ÊäûËÇ¢„ÇÑ„Ç¨„Ç§„Éâ„ÇíÂê´„ÇÅ„Çã
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          **Q2: [„Ç´„ÉÜ„Ç¥„É™Âêç]**
          [ÂÖ∑‰ΩìÁöÑ„Å™Ë≥™ÂïèÊñá]
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          **Q3: [„Ç´„ÉÜ„Ç¥„É™Âêç]**
          [ÂÖ∑‰ΩìÁöÑ„Å™Ë≥™ÂïèÊñá]
          **ÂõûÁ≠îÔºö**Ôºà„Åì„Åì„Å´Ë©≥Á¥∞„Çí„ÅäÊõ∏„Åç„Åè„Å†„Åï„ÅÑÔºâ
          
          [ÂøÖË¶Å„Å´Âøú„Åò„Å¶Q4, Q5„ÇíËøΩÂä†]
          
          ---
          
          ### üìù ÂõûÁ≠îÂæå„ÅÆÊâãÈ†Ü
          1. ‰∏äË®ò„ÅÆË≥™Âïè„Å´ÂõûÁ≠î„ÇíË®òÂÖ•
          2. „Åì„ÅÆIssue„ÅÆÊú¨Êñá„ÇíÁ∑®ÈõÜ„Åó„Å¶ÂõûÁ≠î„ÇíËøΩÂä†
          3. ÂõûÁ≠îÂÆå‰∫ÜÂæå„ÄÅ„Äå**start**„Äç„Å®„Ç≥„É°„É≥„Éà„Åó„Å¶„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„ÇíÈñãÂßã
          
          ü§ñ *Generated by Dynamic Stepback Question System*
          EOFQ
          ```
          
          ÈáçË¶Å: ÁîüÊàê„Åó„ÅüË≥™Âïè„ÅØÂøÖ„Åö‰∏äË®ò„ÅÆÂΩ¢Âºè„Åß .meta/dynamic-questions/generated-questions.md „Å´‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          EOF
          
          # Claude Code „ÅßÂãïÁöÑË≥™ÂïèÁîüÊàê„ÇíÂÆüË°å
          echo "üß† Executing Claude Code for dynamic question generation..."
          
          if claude --continue "$(cat .meta/dynamic-questions/generation-prompt.md)" --output-format text; then
            echo "‚úÖ Dynamic question generation completed"
            
            # ÁîüÊàê„Åï„Çå„ÅüË≥™Âïè„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
            if [ -f ".meta/dynamic-questions/generated-questions.md" ]; then
              echo "‚úÖ Generated questions file created successfully"
              echo "questions_generated=true" >> $GITHUB_OUTPUT
              echo "questions_file=.meta/dynamic-questions/generated-questions.md" >> $GITHUB_OUTPUT
              
              # ÁîüÊàê„Åï„Çå„ÅüË≥™Âïè„ÅÆÊ¶ÇË¶Å„ÇíË°®Á§∫
              QUESTION_COUNT=$(grep -c "^**Q[0-9]" .meta/dynamic-questions/generated-questions.md || echo "0")
              echo "üìä Generated $QUESTION_COUNT dynamic questions"
            else
              echo "‚ùå Generated questions file not found"
              echo "questions_generated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Claude Code dynamic question generation failed"
            echo "questions_generated=false" >> $GITHUB_OUTPUT
          fi

  update-issue-body:
    needs: [generate-dynamic-questions]
    runs-on: ubuntu-latest
    if: needs.generate-dynamic-questions.outputs.questions_generated == 'true'
    outputs:
      update_success: ${{ steps.update.outputs.update_success }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
        env:
          GITHUB_TOKEN: ${{ github.token }}
        
      - name: Update Issue with Dynamic Questions
        id: update
        run: |
          echo "üìù Updating Issue #${{ github.event.issue.number }} with generated questions..."
          
          QUESTIONS_FILE="${{ needs.generate-dynamic-questions.outputs.questions_file }}"
          
          if [ ! -f "$QUESTIONS_FILE" ]; then
            echo "‚ùå Questions file not found"
            exit 1
          fi
          
          # ÁèæÂú®„ÅÆIssueÊú¨Êñá„ÇíÂèñÂæó
          CURRENT_BODY=$(gh issue view ${{ github.event.issue.number }} --json body --jq '.body')
          
          # ÂãïÁöÑË≥™Âïè„Çí Issue Êú¨Êñá„Å´ËøΩÂä†
          cat > .meta/updated-issue-body.md << EOF
          $CURRENT_BODY
          
          ---
          
          EOF
          
          cat "$QUESTIONS_FILE" >> .meta/updated-issue-body.md
          
          # IssueÊú¨Êñá„ÇíÊõ¥Êñ∞
          if gh issue edit ${{ github.event.issue.number }} --body-file .meta/updated-issue-body.md; then
            echo "‚úÖ Issue updated with dynamic questions"
            echo "update_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to update Issue"
            echo "update_success=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

  add-response-labels:
    needs: [update-issue-body]
    runs-on: ubuntu-latest
    if: needs.update-issue-body.outputs.update_success == 'true'
    
    steps:
      - name: Add Awaiting Response Labels
        run: |
          echo "üè∑Ô∏è Adding response labels to Issue #${{ github.event.issue.number }}..."
          
          # GitHub CLI„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          
          # „É©„Éô„É´ËøΩÂä†
          if gh issue edit ${{ github.event.issue.number }} \
             --add-label "dynamic-questions,awaiting-user-response,stepback-analysis"; then
            echo "‚úÖ Labels added successfully"
          else
            echo "‚ö†Ô∏è Failed to add labels (labels may not exist)"
          fi
          
          # ÂÆå‰∫ÜÈÄöÁü•„Ç≥„É°„É≥„Éà
          gh issue comment ${{ github.event.issue.number }} \
            --body "ü§ñ **ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™Âïè„ÇíÁîüÊàê„Åó„Åæ„Åó„ÅüÔºÅ**

          „ÅÇ„Å™„Åü„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºË¶ÅÊ±Ç„ÇíÂàÜÊûê„Åó„ÄÅÊúÄÈÅ©Âåñ„ÅÆ„Åü„ÇÅ„ÅÆË©≥Á¥∞Ë≥™Âïè„Çí‰∏äË®ò„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ

          **üìù Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó:**
          1. ‰∏äË®ò„ÅÆË≥™Âïè„Å´Ë©≥Á¥∞„Å™ÂõûÁ≠î„ÇíË®òÂÖ•„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          2. ÂõûÁ≠îÂÆå‰∫ÜÂæå„ÄÅ„Äå**start**„Äç„Å®„Ç≥„É°„É≥„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          3. Ëá™ÂãïÁöÑ„Å´„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅåÁîüÊàê„Åï„Çå„Åæ„Åô

          üéØ **„Çà„ÇäË©≥Á¥∞„Å™ÂõûÁ≠î„Çí„ÅÑ„Åü„Å†„Åè„Åª„Å©„ÄÅÁ≤æÂØÜ„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åß„Åç„Åæ„Åô„ÄÇ**

          ---
          ü§ñ *Dynamic Question Generator v1.0*" \
            2>/dev/null || echo "‚ö†Ô∏è Failed to post completion comment"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          
      - name: Upload Generation Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dynamic-questions-${{ github.run_number }}
          path: .meta/dynamic-questions/
          retention-days: 30