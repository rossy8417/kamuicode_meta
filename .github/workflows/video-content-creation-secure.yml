name: "Video Content Creation Secure MCP"
run-name: "ðŸŽ¥ Secure MCP: ${{ github.event.inputs.video_concept }}"

on:
  workflow_dispatch:
    inputs:
      video_concept:
        description: 'å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ»ãƒ†ãƒ¼ãƒž'
        required: true
        default: 'ã‚»ã‚­ãƒ¥ã‚¢MCPãƒ†ã‚¹ãƒˆ - AIã¨ãƒ­ãƒœãƒƒãƒˆã®å”åŠ›'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  # æ–¹æ³•1: GitHub Secretsã‚’ä½¿ç”¨
  secure-mcp-with-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create MCP config from secrets
        run: |
          mkdir -p .claude
          
          # Secretsã‹ã‚‰URLã‚’å–å¾—ã—ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
          cat > .claude/mcp-config.json << EOF
          {
            "mcpServers": {
              "t2i-google-imagen3": {
                "type": "http",
                "url": "${{ secrets.MCP_T2I_GOOGLE_URL }}",
                "description": "Google Imagen 3 Text-to-Image Generation"
              },
              "i2v-fal-hailuo-02-pro": {
                "type": "http",
                "url": "${{ secrets.MCP_I2V_FAL_URL }}",
                "description": "Fal.ai Hailuo-02 Pro Image-to-Video Generation"
              }
            }
          }
          EOF
          
          chmod 600 .claude/mcp-config.json
          
      - name: Test MCP with hidden URLs
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Generate a test image using MCP service t2i-google-imagen3.
            Prompt: "${{ github.event.inputs.video_concept }}"
            Aspect ratio: 1:1
            Save result to test-result.json
          system_prompt: |
            You are Claude Code in CI/CD. All MCP tools are pre-authorized.
          mcp_config: ".claude/mcp-config.json"
          allowed_tools: "View,mcp__t2i-google-imagen3__*,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # æ–¹æ³•2: ãƒªãƒã‚¸ãƒˆãƒªã®.claude/mcp-kamuicode.jsonã‚’ä½¿ç”¨
  secure-mcp-with-repo-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Use repository MCP config
        run: |
          # ãƒªãƒã‚¸ãƒˆãƒªã«æ—¢ã«ã‚ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          echo "ðŸ“ Using existing MCP config from repository"
          ls -la .claude/
          
      - name: Test with repo config
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Generate a test image using available MCP services.
            Save to generated/test-repo-config.json
          system_prompt: |
            You are Claude Code in CI/CD. All MCP tools are pre-authorized.
          mcp_config: ".claude/mcp-kamuicode.json"  # ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šã‚’ä½¿ç”¨
          allowed_tools: "View,mcp__*,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # æ–¹æ³•3: ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨
  secure-mcp-with-env:
    runs-on: ubuntu-latest
    env:
      MCP_BASE_URL: ${{ secrets.MCP_BASE_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create MCP config with env vars
        run: |
          mkdir -p .claude
          
          # ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦è¨­å®šã‚’ç”Ÿæˆ
          cat > .claude/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "t2i-google-imagen3": {
                "type": "http",
                "url": "${MCP_BASE_URL}/t2i/google/imagen",
                "description": "Google Imagen 3"
              }
            }
          }
          EOF
          
          # ç’°å¢ƒå¤‰æ•°ã‚’å±•é–‹
          envsubst < .claude/mcp-config.json > .claude/mcp-config-expanded.json
          mv .claude/mcp-config-expanded.json .claude/mcp-config.json
          chmod 600 .claude/mcp-config.json
          
      - name: Test with env vars
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Generate a test image. Save to test-env.json
          system_prompt: |
            You are Claude Code in CI/CD. All MCP tools are pre-authorized.
          mcp_config: ".claude/mcp-config.json"
          allowed_tools: "View,mcp__*,Write"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secure-mcp-test-${{ github.run_number }}
          path: |
            generated/
            *.json
          retention-days: 7