name: "Kyoto Food Trend News - Test"
run-name: "ğŸœ Test: Claude Code Web Search"

on:
  workflow_dispatch:

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  test-web-search:
    name: "ğŸ” Test Web Search with Claude Code"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Project Directory
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/test-web-search-$TIMESTAMP"
          mkdir -p "$PROJECT_DIR"/{logs,metadata}
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Execute Web Search
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          
          # Claude Code CLIã‚’ä½¿ç”¨ã—ã¦WebSearchã‚’å®Ÿè¡Œ
          PROMPT="äº¬éƒ½ã§æµè¡Œã£ã¦ã„ã‚‹é£Ÿã¹ç‰©ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«ã¤ã„ã¦èª¿ã¹ã¦ãã ã•ã„ã€‚
          
          ä»¥ä¸‹ã®æƒ…å ±ã‚’åé›†ã—ã¦ãã ã•ã„ï¼š
          1. 2024-2025å¹´ã«äº¬éƒ½ã§è©±é¡Œã®é£Ÿã¹ç‰©ãƒ»ã‚°ãƒ«ãƒ¡ãƒˆãƒ¬ãƒ³ãƒ‰
          2. äººæ°—ã®åº—èˆ—ã‚„æ–™ç†
          3. SNSã§è©±é¡Œã«ãªã£ã¦ã„ã‚‹äº¬éƒ½ã‚°ãƒ«ãƒ¡
          
          èª¿æŸ»çµæœã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          - $PROJECT_DIR/metadata/trend-summary.mdï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ã®ã¾ã¨ã‚ï¼‰
          - $PROJECT_DIR/metadata/sources.txtï¼ˆå‚ç…§ã—ãŸURLä¸€è¦§ï¼‰
          - $PROJECT_DIR/metadata/content-plan.mdï¼ˆå‹•ç”»æ§‹æˆæ¡ˆï¼‰"
          
          npx @anthropic-ai/claude-code \
            -p "$PROMPT" \
            --allowedTools "WebSearch,Write" \
            --permission-mode "acceptEdits"
      
      - name: Check Results
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          echo "=== Generated Files ==="
          ls -la "$PROJECT_DIR/metadata/"
          
          if [ -f "$PROJECT_DIR/metadata/trend-summary.md" ]; then
            echo "=== Trend Summary ==="
            head -20 "$PROJECT_DIR/metadata/trend-summary.md"
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: web-search-results
          path: ${{ steps.setup.outputs.project_dir }}/