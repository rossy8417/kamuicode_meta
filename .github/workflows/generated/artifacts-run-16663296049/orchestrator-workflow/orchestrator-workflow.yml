name: orchestrator-earthquake-news-video-generation

on:
  workflow_dispatch:
    inputs:
      concept:
        description: 'åœ°éœ‡ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ'
        required: true
        type: string
        default: 'æœ€æ–°åœ°éœ‡æƒ…å ±ã®æ—¥æœ¬èªãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ï¼ˆ1åˆ†ã€å­—å¹•ä»˜ãï¼‰'
      earthquake_region:
        description: 'åœ°éœ‡ç™ºç”Ÿåœ°åŸŸï¼ˆæ¤œç´¢å¯¾è±¡åœ°åŸŸï¼‰'
        required: false
        type: string
        default: 'æ—¥æœ¬å…¨å›½'
      search_timeframe:
        description: 'æƒ…å ±åé›†æœŸé–“'
        required: false
        type: choice
        options:
          - 'past 24 hours'
          - 'past 12 hours'
          - 'past 6 hours'
          - 'past 3 hours'
        default: 'past 24 hours'
      video_duration:
        description: 'å‹•ç”»æ™‚é–“ï¼ˆç§’ï¼‰'
        required: false
        type: string
        default: '60'
      image_model:
        description: 'ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: true
        type: choice
        options:
          - t2i-google-imagen3
          - t2i-fal-imagen4-ultra
          - t2i-fal-imagen4-fast
          - t2i-fal-flux-schnell
        default: t2i-google-imagen3
      video_model:
        description: 'å‹•ç”»ç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: true
        type: choice
        options:
          - i2v-fal-bytedance-seedance-v1-lite
          - i2v-fal-hailuo-02-pro
          - t2v-fal-veo3-fast
        default: i2v-fal-bytedance-seedance-v1-lite
      audio_model:
        description: 'éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: true
        type: choice
        options:
          - t2s-fal-minimax-speech-02-turbo
          - t2s-google
        default: t2s-fal-minimax-speech-02-turbo
      bgm_model:
        description: 'BGMç”Ÿæˆãƒ¢ãƒ‡ãƒ«'
        required: true
        type: choice
        options:
          - t2m-google-lyria
        default: t2m-google-lyria

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # ã‚¹ãƒ†ãƒƒãƒ—1: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup placeholder
        run: echo "Setup completed for earthquake news video generation"

  # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
  create-branch:
    needs: setup
    uses: ./.github/workflows/module-setup-branch.yml
    with:
      concept: ${{ inputs.concept }}
      project_prefix: "earthquake-news"

  # ã‚¹ãƒ†ãƒƒãƒ—3: åœ°éœ‡æƒ…å ±æ¤œç´¢æˆ¦ç•¥ä¼ç”»
  search-planning:
    needs: [create-branch]
    uses: ./.github/workflows/module-planning-ccsdk.yml
    with:
      concept: "åœ°éœ‡æƒ…å ±æ¤œç´¢æˆ¦ç•¥ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®š"
      planning_type: "information_search_strategy"
      target_region: ${{ inputs.earthquake_region }}
      timeframe: ${{ inputs.search_timeframe }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—4: åœ°éœ‡é–¢é€£ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ä¼ç”»ï¼ˆä¸¦è¡Œï¼‰
  visual-planning:
    needs: [create-branch]
    uses: ./.github/workflows/module-planning-ccsdk.yml
    with:
      concept: "åœ°éœ‡ãƒ‹ãƒ¥ãƒ¼ã‚¹ç”»åƒã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚³ãƒ³ã‚»ãƒ—ãƒˆä¼ç”»"
      planning_type: "visual_concept_planning"
      target_style: "news_broadcast_graphics"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿æ§‹æˆä¼ç”»ï¼ˆä¸¦è¡Œï¼‰
  script-planning:
    needs: [create-branch]
    uses: ./.github/workflows/module-planning-ccsdk.yml
    with:
      concept: "1åˆ†æ—¥æœ¬èªãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿æ§‹æˆè¨ˆç”»"
      planning_type: "news_script_structure"
      target_duration: ${{ inputs.video_duration }}
      language: "Japanese"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—6: åœ°éœ‡æƒ…å ±Webæ¤œç´¢å®Ÿè¡Œ
  earthquake-info-search:
    needs: [create-branch, search-planning]
    uses: ./.github/workflows/module-web-search-earthquake-info.yml
    with:
      concept: ${{ inputs.concept }}
      search_keywords: ${{ needs.search-planning.outputs.search_keywords }}
      target_region: ${{ inputs.earthquake_region }}
      timeframe: ${{ inputs.search_timeframe }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—7: åœ°éœ‡æƒ…å ±åˆ†æãƒ»æ§‹é€ åŒ–
  earthquake-info-analysis:
    needs: [create-branch, earthquake-info-search]
    uses: ./.github/workflows/module-data-analysis-earthquake.yml
    with:
      concept: ${{ inputs.concept }}
      earthquake_data: ${{ needs.earthquake-info-search.outputs.earthquake_data }}
      analysis_type: "information_prioritization"
      structure_type: "news_format"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—8: æ—¥æœ¬èªãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ç”Ÿæˆ
  news-script-generation:
    needs: [create-branch, earthquake-info-analysis, script-planning]
    uses: ./.github/workflows/module-news-script-generation-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      earthquake_info: ${{ needs.earthquake-info-analysis.outputs.structured_info }}
      script_structure: ${{ needs.script-planning.outputs.script_structure }}
      target_duration: ${{ inputs.video_duration }}
      language: "Japanese"
      style: "news_broadcaster"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—9: éœ‡æºåœ°ãƒãƒƒãƒ—ç”»åƒç”Ÿæˆï¼ˆä¸¦è¡Œï¼‰
  epicenter-map-generation:
    needs: [create-branch, earthquake-info-analysis, visual-planning]
    uses: ./.github/workflows/module-image-generation-kc-multi-model-ccsdk.yml
    with:
      concept: "åœ°éœ‡éœ‡æºåœ°ãƒãƒƒãƒ—"
      model-type: ${{ inputs.image_model }}
      image-prompt: "Professional news-style earthquake epicenter map showing ${{ needs.earthquake-info-analysis.outputs.epicenter_location }} with impact zones, Japanese geography, seismic intensity visualization, news broadcast graphic style"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      video_index: "epicenter"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—10: åœ°éœ‡ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç”»åƒç”Ÿæˆï¼ˆä¸¦è¡Œï¼‰
  earthquake-impact-generation:
    needs: [create-branch, visual-planning]
    uses: ./.github/workflows/module-image-generation-kc-multi-model-ccsdk.yml
    with:
      concept: "åœ°éœ‡ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«"
      model-type: ${{ inputs.image_model }}
      image-prompt: "Earthquake impact visualization showing seismic waves, building safety concepts, infrastructure resilience, professional news graphics style, informative and serious tone"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      video_index: "impact"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—11: å‹•ç”»ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ§‹æˆè¨ˆç”»
  video-sequence-planning:
    needs: [create-branch, epicenter-map-generation, earthquake-impact-generation, news-script-generation]
    uses: ./.github/workflows/module-video-composition-planning-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      image_urls: |
        epicenter: ${{ needs.epicenter-map-generation.outputs.image-url }}
        impact: ${{ needs.earthquake-impact-generation.outputs.image-url }}
      script_content: ${{ needs.news-script-generation.outputs.news_script }}
      target_duration: ${{ inputs.video_duration }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—12: å‹•ç”»ç”Ÿæˆ
  video-generation:
    needs: [create-branch, video-sequence-planning]
    uses: ./.github/workflows/module-video-generation-kc-multi-model-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      model-type: ${{ inputs.video_model }}
      video-prompt: ${{ needs.video-sequence-planning.outputs.video_composition_plan }}
      image-url: ${{ needs.epicenter-map-generation.outputs.image-url }}
      duration: ${{ inputs.video_duration }}
      resolution: "1920x1080"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      video_index: "main"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—13: æ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆï¼ˆä¸¦è¡Œï¼‰
  narration-audio-generation:
    needs: [create-branch, news-script-generation]
    uses: ./.github/workflows/module-audio-generation-kc-multi-model-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      model-type: ${{ inputs.audio_model }}
      text-prompt: ${{ needs.news-script-generation.outputs.news_script }}
      voice-settings: '{"voice_style": "news_announcer", "language": "ja-JP", "speed": "normal", "emotion": "professional"}'
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      audio_index: "narration"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—14: BGMç”Ÿæˆï¼ˆä¸¦è¡Œï¼‰
  bgm-generation:
    needs: [create-branch, narration-audio-generation]
    uses: ./.github/workflows/module-bgm-generation-kc-multi-model-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      model-type: ${{ inputs.bgm_model }}
      bgm-prompt: "Professional news broadcast background music, serious and informative tone suitable for earthquake news, subtle orchestral elements, 60 seconds duration"
      duration: ${{ inputs.video_duration }}
      style: "news_broadcast_background"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      bgm_index: "news"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—15: å­—å¹•ç”Ÿæˆãƒ»åŒæœŸ
  subtitle-generation:
    needs: [create-branch, news-script-generation, narration-audio-generation]
    uses: ./.github/workflows/module-subtitle-generation-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      script_text: ${{ needs.news-script-generation.outputs.news_script }}
      audio_url: ${{ needs.narration-audio-generation.outputs.audio-url }}
      language: "Japanese"
      subtitle_style: "news_broadcast"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      subtitle_index: "main"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—16: éŸ³å£°ãƒŸã‚­ã‚·ãƒ³ã‚°
  audio-mixing:
    needs: [create-branch, narration-audio-generation, bgm-generation]
    uses: ./.github/workflows/module-audio-mixing-ffmpeg-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      narration_audio: ${{ needs.narration-audio-generation.outputs.audio-url }}
      bgm_audio: ${{ needs.bgm-generation.outputs.audio-url }}
      mixing_style: "news_broadcast"
      output_duration: ${{ inputs.video_duration }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      audio_index: "mixed"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—17: å‹•ç”»ãƒ»éŸ³å£°åˆæˆ
  video-audio-composition:
    needs: [create-branch, video-generation, audio-mixing]
    uses: ./.github/workflows/module-video-audio-composition-ffmpeg-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      video_url: ${{ needs.video-generation.outputs.video-url }}
      audio_url: ${{ needs.audio-mixing.outputs.audio-url }}
      sync_method: "precise_alignment"
      output_resolution: "1920x1080"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      video_index: "composed"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—18: å­—å¹•ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  subtitle-overlay:
    needs: [create-branch, video-audio-composition, subtitle-generation]
    uses: ./.github/workflows/module-subtitle-overlay-ffmpeg-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      video-url: ${{ needs.video-audio-composition.outputs.video-url }}
      subtitle-srt-content: ${{ needs.subtitle-generation.outputs.subtitle-srt-content }}
      target-language: "japanese"
      font_style: "news_broadcast_japanese"
      position: "bottom_center"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      video_index: "final"
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—19: æœ€çµ‚å“è³ªãƒã‚§ãƒƒã‚¯
  quality-verification:
    needs: [create-branch, subtitle-overlay]
    uses: ./.github/workflows/module-video-quality-analysis-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      video_url: ${{ needs.subtitle-overlay.outputs.video-url }}
      check_criteria: "duration,resolution,audio_quality,subtitle_readability,content_accuracy"
      target_duration: ${{ inputs.video_duration }}
      target_resolution: "1920x1080"
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—20: æˆæœç‰©ä¿å­˜ãƒ»æ•´ç†
  deliverables-organization:
    needs: [create-branch, subtitle-overlay, quality-verification, news-script-generation, narration-audio-generation, subtitle-generation]
    if: always() && needs.quality-verification.result == 'success'
    uses: ./.github/workflows/module-deliverables-save-ccsdk.yml
    with:
      concept: ${{ inputs.concept }}
      final_video_url: ${{ needs.subtitle-overlay.outputs.video-url }}
      narration_audio_url: ${{ needs.narration-audio-generation.outputs.audio-url }}
      subtitle_srt_content: ${{ needs.subtitle-generation.outputs.subtitle-srt-content }}
      news_script: ${{ needs.news-script-generation.outputs.news_script }}
      quality_report: ${{ needs.quality-verification.outputs.quality_report }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      github_pat: ${{ secrets.PAT_TOKEN }}

  # ã‚¹ãƒ†ãƒƒãƒ—21: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
  create-pr:
    needs: [create-branch, deliverables-organization]
    if: always() && needs.deliverables-organization.result == 'success'
    uses: ./.github/workflows/module-create-pr.yml
    with:
      concept: ${{ inputs.concept }}
      branch-name: ${{ needs.create-branch.outputs.branch-name }}
      folder-name: ${{ needs.create-branch.outputs.folder-name }}
      pr_title: "ğŸš¨ åœ°éœ‡ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»: ${{ inputs.concept }}"
      pr_description: |
        ## åœ°éœ‡ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”Ÿæˆå®Œäº†

        ### ğŸ“º ç”Ÿæˆå†…å®¹
        - **å‹•ç”»æ™‚é–“**: ${{ inputs.video_duration }}ç§’
        - **è§£åƒåº¦**: 1920x1080
        - **è¨€èª**: æ—¥æœ¬èªï¼ˆå­—å¹•ä»˜ãï¼‰
        - **å¯¾è±¡åœ°åŸŸ**: ${{ inputs.earthquake_region }}
        - **æƒ…å ±åé›†æœŸé–“**: ${{ inputs.search_timeframe }}

        ### ğŸ¥ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
        - æœ€çµ‚å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ« (MP4)
        - æ—¥æœ¬èªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£° (WAV)
        - æ—¥æœ¬èªå­—å¹•ãƒ•ã‚¡ã‚¤ãƒ« (SRT)
        - ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ãƒ†ã‚­ã‚¹ãƒˆ (TXT)
        - å“è³ªãƒ¬ãƒãƒ¼ãƒˆ (JSON)

        ### ğŸ”§ ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«
        - **ç”»åƒç”Ÿæˆ**: ${{ inputs.image_model }}
        - **å‹•ç”»ç”Ÿæˆ**: ${{ inputs.video_model }}
        - **éŸ³å£°ç”Ÿæˆ**: ${{ inputs.audio_model }}
        - **BGMç”Ÿæˆ**: ${{ inputs.bgm_model }}

        ### âœ… å“è³ªç¢ºèªæ¸ˆã¿
        å“è³ªãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ãŸã€æ”¾é€å“è³ªã®åœ°éœ‡ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã§ã™ã€‚
    secrets:
      github_pat: ${{ secrets.PAT_TOKEN }}