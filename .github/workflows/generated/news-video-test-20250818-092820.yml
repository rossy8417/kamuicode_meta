name: Professional News Video Generation

on:
  workflow_dispatch:
    inputs:
      news_topic:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®ãƒˆãƒ”ãƒƒã‚¯ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"
        required: true
        default: "AIæŠ€è¡“ã®æœ€æ–°å‹•å‘"
        type: string
      duration:
        description: "å‹•ç”»ã®é•·ã•"
        required: true
        default: "60s"
        type: choice
        options:
          - "15s"
          - "30s" 
          - "60s"
          - "90s"
          - "3min"
          - "5min"
      news_category:
        description: "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼"
        required: true
        default: "technology"
        type: choice
        options:
          - "technology"
          - "business"
          - "politics"
          - "health"
          - "science"
          - "sports"
          - "entertainment"
          - "world"
      content_type:
        description: "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—"
        required: true
        default: "news"
        type: choice
        options:
          - "news"
          - "educational"
          - "documentary"
          - "promotional"
      target_platform:
        description: "é…ä¿¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ "
        required: true
        default: "youtube"
        type: choice
        options:
          - "youtube"
          - "instagram"
          - "tiktok"
          - "twitter"
          - "linkedin"
          - "web"
          - "broadcast"
      performance_mode:
        description: "å‡¦ç†ãƒ¢ãƒ¼ãƒ‰"
        required: true
        default: "balanced"
        type: choice
        options:
          - "quality"
          - "balanced"
          - "speed"
  push:
    paths-ignore:
      - '.github/workflows/**'

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch'
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      scene_count: ${{ steps.setup.outputs.scene_count }}
      duration_seconds: ${{ steps.setup.outputs.duration_seconds }}
      matrix_scenes: ${{ steps.setup.outputs.matrix_scenes }}
      workflow_start: ${{ steps.setup.outputs.workflow_start }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create project environment
        id: setup
        run: |
          # Calculate scene count and project directory
          case "${{ github.event.inputs.duration }}" in
            "15s") SECONDS=15; SCENES=3 ;;
            "30s") SECONDS=30; SCENES=6 ;;
            "60s") SECONDS=60; SCENES=12 ;;
            "90s") SECONDS=90; SCENES=18 ;;
            "3min") SECONDS=180; SCENES=36 ;;
            "5min") SECONDS=300; SCENES=60 ;;
            *) SECONDS=60; SCENES=12 ;;
          esac
          
          PROJECT_DIR="/home/runner/work/kamuicode_meta/kamuicode_meta/projects/issue-66-20250817-225129"
          
          # Create directory structure
          mkdir -p "$PROJECT_DIR"/{metadata,logs,media/{images,videos,audio},final,temp}
          
          # Generate scene matrix
          MATRIX_SCENES="["
          for i in $(seq 1 $SCENES); do
            if [ $i -gt 1 ]; then MATRIX_SCENES="$MATRIX_SCENES,"; fi
            MATRIX_SCENES="$MATRIX_SCENES$i"
          done
          MATRIX_SCENES="$MATRIX_SCENES]"
          
          # Record workflow start time
          WORKFLOW_START=$(date -Iseconds)
          
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "scene_count=$SCENES" >> $GITHUB_OUTPUT
          echo "duration_seconds=$SECONDS" >> $GITHUB_OUTPUT
          echo "matrix_scenes=$MATRIX_SCENES" >> $GITHUB_OUTPUT
          echo "workflow_start=$WORKFLOW_START" >> $GITHUB_OUTPUT
          
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
          echo "- Project Directory: $PROJECT_DIR"
          echo "- Scene Count: $SCENES"
          echo "- Duration: $SECONDS seconds"
          echo "- Matrix: $MATRIX_SCENES"

  news-research:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup]
    outputs:
      research_completed: ${{ steps.research.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: News research and analysis
        id: research
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          TOPIC="${{ github.event.inputs.news_topic }}"
          CATEGORY="${{ github.event.inputs.news_category }}"
          
          # Create research prompt
          RESEARCH_PROMPT="æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽé›†ãƒ»åˆ†æžã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:

          1. ãƒˆãƒ”ãƒƒã‚¯: $TOPIC
          2. ã‚«ãƒ†ã‚´ãƒªãƒ¼: $CATEGORY  
          3. åŽé›†ã™ã‚‹æƒ…å ±æº: NewsAPIã€ä¸»è¦å ±é“æ©Ÿé–¢ã‚µã‚¤ãƒˆã€å…¬å¼ç™ºè¡¨
          4. åˆ†æžè¦ä»¶: ä¿¡é ¼æ€§è©•ä¾¡ã€é‡è¦åº¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€å½æƒ…å ±ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          5. å‡ºåŠ›å½¢å¼: JSONå½¢å¼ã§ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’${PROJECT_DIR}/metadata/news_data.json ã«ä¿å­˜
          6. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/metadata/ ã§ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

          WebSearchã¨Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$RESEARCH_PROMPT"

          # Fallback if research fails
          if [ ! -f "${PROJECT_DIR}/metadata/news_data.json" ]; then
            echo "âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽé›†å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"
            {
              echo '{'
              echo '  "topic": "'$TOPIC'",'
              echo '  "category": "'$CATEGORY'",'
              echo '  "fallback": true,'
              echo '  "content": "æœ€æ–°ã®'$TOPIC'ã«é–¢ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚"'
              echo '}'
            } > "${PROJECT_DIR}/metadata/news_data.json"
          fi

          echo "completed=true" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹åŽé›†ãƒ»åˆ†æžå®Œäº†"

  script-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup, news-research]
    outputs:
      script_completed: ${{ steps.script.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate news script and structure
        id: script
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENES="${{ needs.setup.outputs.scene_count }}"
          DURATION="${{ needs.setup.outputs.duration_seconds }}"
          
          SCRIPT_PROMPT="åŽé›†ã—ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€$DURATIONç§’ã®å‹•ç”»æ§‹æˆã‚’è¨­è¨ˆã—ã¦ãã ã•ã„:

          1. å…¥åŠ›ãƒ‡ãƒ¼ã‚¿: ${PROJECT_DIR}/metadata/news_data.json ã‚’èª­ã¿è¾¼ã¿
          2. æ§‹æˆè¦ä»¶: ${SCENES}ã‚·ãƒ¼ãƒ³ï¼ˆ5ç§’/ã‚·ãƒ¼ãƒ³ï¼‰
          3. æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚° â†’ ãƒ¡ã‚¤ãƒ³ãƒ‹ãƒ¥ãƒ¼ã‚¹ â†’ ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°
          4. å‡ºåŠ›è¦ä»¶:
             - å°æœ¬: ${PROJECT_DIR}/metadata/script.json ã«ä¿å­˜
             - ã‚·ãƒ¼ãƒ³è©³ç´°: ${PROJECT_DIR}/metadata/scene_breakdown.json ã«ä¿å­˜
             - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°æœ¬: ${PROJECT_DIR}/metadata/narration.txt ã«ä¿å­˜
          5. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/metadata/ ã§ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª

          Readã¨Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$SCRIPT_PROMPT"

          # Create fallback script if generation fails
          if [ ! -f "${PROJECT_DIR}/metadata/script.json" ]; then
            echo "âš ï¸ å°æœ¬ç”Ÿæˆå¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå°æœ¬ã‚’ä½œæˆ"
            {
              echo '{'
              echo '  "title": "æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹",'
              echo '  "scenes": ['
              for i in $(seq 1 $SCENES); do
                if [ $i -gt 1 ]; then echo ','; fi
                echo '    {"scene": '$i', "content": "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚·ãƒ¼ãƒ³'$i'"}'
              done
              echo '  ]'
              echo '}'
            } > "${PROJECT_DIR}/metadata/script.json"
          fi

          if [ ! -f "${PROJECT_DIR}/metadata/narration.txt" ]; then
            echo "ä»Šæ—¥ã®é‡è¦ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚æœ€æ–°ã®æƒ…å ±ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã„ãŸã—ã¾ã™ã€‚" > "${PROJECT_DIR}/metadata/narration.txt"
          fi

          echo "completed=true" >> $GITHUB_OUTPUT
          echo "âœ… å°æœ¬ä½œæˆå®Œäº†"

  character-audio-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, script-generation]
    outputs:
      character_completed: ${{ steps.character.outputs.completed }}
      audio_completed: ${{ steps.audio.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code and dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          sudo apt-get update
          sudo apt-get install -y espeak-ng ffmpeg

      - name: Generate news anchor character
        id: character
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          CHARACTER_PROMPT="ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªæ—¥æœ¬äººãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

          1. è¦ä»¶: ãƒ“ã‚¸ãƒã‚¹ã‚¹ãƒ¼ãƒ„ç€ç”¨ã€æ­£é¢å‘ãã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«è¡¨æƒ…
          2. è¨­å®š: å›ºå®šseedå€¤(42)ã€ã‚°ãƒªãƒ¼ãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³èƒŒæ™¯
          3. åˆ¶ç´„: èƒŒæ™¯ã«ä»–ã®äººç‰©ãªã—ã€ã€Œno people in backgroundã€
          4. ä¿å­˜å…ˆ: ${PROJECT_DIR}/media/images/news_anchor.png
          5. URLä¿å­˜: ${PROJECT_DIR}/media/images/news_anchor-url.txt
          6. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/media/images/

          Text-to-Imageç”Ÿæˆå¾Œã€Writeã¨Bashãƒ„ãƒ¼ãƒ«ã§ä¿å­˜ãƒ»ç¢ºèªã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$CHARACTER_PROMPT" || {
            echo "âš ï¸ ã‚¢ãƒ³ã‚«ãƒ¼ç”Ÿæˆå¤±æ•—ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ"
            # Create placeholder if MCP fails
            convert -size 1024x1024 xc:gray "${PROJECT_DIR}/media/images/news_anchor.png" 2>/dev/null || true
          }

          # Download from URL if available
          URL_FILE="${PROJECT_DIR}/media/images/news_anchor-url.txt"
          ANCHOR_FILE="${PROJECT_DIR}/media/images/news_anchor.png"
          
          if [ -f "$URL_FILE" ]; then
            URL=$(cat "$URL_FILE")
            if [ -n "$URL" ]; then
              curl -L -o "$ANCHOR_FILE" "$URL" || echo "URL download failed"
            fi
          fi

          # Verify anchor file
          if [ -f "$ANCHOR_FILE" ] && [ $(stat -c%s "$ANCHOR_FILE" 2>/dev/null || echo 0) -gt 10000 ]; then
            echo "âœ… ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ç”ŸæˆæˆåŠŸ"
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ç”Ÿæˆå¤±æ•—"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate narration audio
        id: audio
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Read narration text
          if [ -f "${PROJECT_DIR}/metadata/narration.txt" ]; then
            NARRATION_TEXT=$(cat "${PROJECT_DIR}/metadata/narration.txt")
          else
            NARRATION_TEXT="ä»Šæ—¥ã®é‡è¦ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚"
          fi
          
          AUDIO_PROMPT="ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

          1. ãƒ†ã‚­ã‚¹ãƒˆ: $NARRATION_TEXT
          2. éŸ³å£°ç‰¹æ€§: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒ³ã‚«ãƒ¼ç”¨ã€è½ã¡ç€ã„ãŸå£°è³ªã€æ˜Žçž­ãªç™ºéŸ³
          3. å“è³ª: -14 LUFSï¼ˆYouTubeæœ€é©åŒ–ï¼‰
          4. ä¿å­˜å…ˆ: ${PROJECT_DIR}/media/audio/narration.wav
          5. URLä¿å­˜: ${PROJECT_DIR}/media/audio/narration-url.txt
          6. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/media/audio/

          Text-to-Speechç”Ÿæˆå¾Œã€Writeã¨Bashãƒ„ãƒ¼ãƒ«ã§ä¿å­˜ãƒ»ç¢ºèªã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-*,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$AUDIO_PROMPT" || {
            echo "âš ï¸ MCPéŸ³å£°ç”Ÿæˆå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ"
            # Fallback: Use espeak-ng
            espeak-ng "$NARRATION_TEXT" -w "${PROJECT_DIR}/media/audio/narration.wav" -s 150 -p 50
          }

          # Download from URL if available
          URL_FILE="${PROJECT_DIR}/media/audio/narration-url.txt"
          AUDIO_FILE="${PROJECT_DIR}/media/audio/narration.wav"
          
          if [ -f "$URL_FILE" ]; then
            URL=$(cat "$URL_FILE")
            if [ -n "$URL" ]; then
              curl -L -o "$AUDIO_FILE" "$URL" || echo "URL download failed"
            fi
          fi

          # Verify audio file
          if [ -f "$AUDIO_FILE" ] && [ $(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo 0) -gt 1000 ]; then
            echo "âœ… ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”ŸæˆæˆåŠŸ"
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°ç”Ÿæˆå¤±æ•—"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload character and audio artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: character-audio-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

  scene-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [setup, script-generation]
    continue-on-error: true
    strategy:
      matrix:
        scene: ${{ fromJson(needs.setup.outputs.matrix_scenes) }}
      fail-fast: false
    outputs:
      failed_scenes: ${{ steps.collect-failures.outputs.failed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Download script artifacts
        uses: actions/download-artifact@v4
        with:
          name: character-audio-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

      - name: Generate scene image and convert to video
        id: scene-generation
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_NUM="${{ matrix.scene }}"
          
          # Check MCP connection time window
          WORKFLOW_START="${{ needs.setup.outputs.workflow_start }}"
          ELAPSED_MINUTES=$(( ($(date +%s) - $(date -d "$WORKFLOW_START" +%s)) / 60 ))
          
          if [ $ELAPSED_MINUTES -gt 15 ]; then
            echo "âš ï¸ MCPæŽ¥ç¶šåˆ¶é™æ™‚é–“ã‚’è¶…éŽã€ã‚¹ã‚­ãƒƒãƒ—"
            echo "failed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… MCPæŽ¥ç¶šå¯èƒ½æ™‚é–“å†… ($ELAPSED_MINUTES åˆ†çµŒéŽ)"
          
          # Generate background image for scene
          IMAGE_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹èƒŒæ™¯ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼ˆã‚·ãƒ¼ãƒ³$SCENE_NUMï¼‰:

          1. è¦ä»¶: ãƒ‹ãƒ¥ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªèƒŒæ™¯ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã€äººç‰©ãªã—
          2. åˆ¶ç´„: 'no people', 'empty studio', 'professional news background'
          3. ã‚¹ã‚¿ã‚¤ãƒ«: ãƒ¢ãƒ€ãƒ³ãªãƒ‹ãƒ¥ã‚¹ã‚¹ã‚¿ã‚¸ã‚ªã€ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã€é–¢é€£æ˜ åƒ
          4. ä¿å­˜å…ˆ: ${PROJECT_DIR}/media/images/scene${SCENE_NUM}.png
          5. URLä¿å­˜: ${PROJECT_DIR}/media/images/scene${SCENE_NUM}-url.txt
          6. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/media/images/

          ç”»åƒç”Ÿæˆå¾Œã€å³åº§ã«ä¿å­˜ã¨ç¢ºèªã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$IMAGE_PROMPT"

          # Immediate URL download to prevent expiration
          URL_FILE="${PROJECT_DIR}/media/images/scene${SCENE_NUM}-url.txt"
          IMAGE_FILE="${PROJECT_DIR}/media/images/scene${SCENE_NUM}.png"
          
          if [ -f "$URL_FILE" ]; then
            IMAGE_URL=$(cat "$URL_FILE")
            if [ -n "$IMAGE_URL" ]; then
              curl -L -o "$IMAGE_FILE" "$IMAGE_URL" || echo "Image download failed"
            fi
          fi

          # Verify image file
          IMAGE=$(find "$PROJECT_DIR" -name "*scene*${SCENE_NUM}*.png" 2>/dev/null | head -1)
          [ -z "$IMAGE" ] && IMAGE=$(find "$PROJECT_DIR" -name "*.png" -mmin -2 2>/dev/null | head -1)
          [ -z "$IMAGE" ] && IMAGE=$(find "$PROJECT_DIR" -name "*.png" 2>/dev/null | head -1)

          if [ -f "$IMAGE" ] && [ $(stat -c%s "$IMAGE" 2>/dev/null || echo 0) -gt 10000 ]; then
            echo "âœ… ã‚·ãƒ¼ãƒ³$SCENE_NUM ç”»åƒç”ŸæˆæˆåŠŸ: $IMAGE"
            
            # CRITICAL: Immediate I2V conversion in same job
            VIDEO_PROMPT="ç”»åƒã‚’å‹•ç”»ã«å¤‰æ›ã—ã¦ãã ã•ã„ï¼ˆã‚·ãƒ¼ãƒ³$SCENE_NUMï¼‰:

            1. å…¥åŠ›ç”»åƒ: $IMAGE
            2. è¨­å®š: 5-8ç§’ã€å®‰å®šã—ãŸãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„å“è³ª
            3. ä¿å­˜å…ˆ: ${PROJECT_DIR}/media/videos/scene${SCENE_NUM}.mp4
            4. URLä¿å­˜: ${PROJECT_DIR}/media/videos/scene${SCENE_NUM}-url.txt
            5. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/media/videos/

            ç”»åƒã‹ã‚‰å‹•ç”»å¤‰æ›å¾Œã€å³åº§ã«ä¿å­˜ã¨ç¢ºèªã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__i2v-*,Write,Bash" \
              --max-turns 80 \
              --permission-mode "acceptEdits" \
              -p "$VIDEO_PROMPT"

            # Immediate video download
            VIDEO_URL_FILE="${PROJECT_DIR}/media/videos/scene${SCENE_NUM}-url.txt"
            VIDEO_FILE="${PROJECT_DIR}/media/videos/scene${SCENE_NUM}.mp4"
            
            if [ -f "$VIDEO_URL_FILE" ]; then
              VIDEO_URL=$(cat "$VIDEO_URL_FILE")
              if [ -n "$VIDEO_URL" ]; then
                curl -L -o "$VIDEO_FILE" "$VIDEO_URL" || echo "Video download failed"
              fi
            fi

            # Verify video file
            VIDEO=$(find "$PROJECT_DIR" -name "*scene*${SCENE_NUM}*.mp4" 2>/dev/null | head -1)
            [ -z "$VIDEO" ] && VIDEO=$(find "$PROJECT_DIR" -name "*.mp4" -mmin -1 2>/dev/null | head -1)

            if [ -f "$VIDEO" ] && [ $(stat -c%s "$VIDEO" 2>/dev/null || echo 0) -gt 300000 ]; then
              echo "âœ… ã‚·ãƒ¼ãƒ³$SCENE_NUM å‹•ç”»å¤‰æ›æˆåŠŸ: $VIDEO"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ ã‚·ãƒ¼ãƒ³$SCENE_NUM å‹•ç”»å¤‰æ›å¤±æ•—"
              echo "failed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ ã‚·ãƒ¼ãƒ³$SCENE_NUM ç”»åƒç”Ÿæˆå¤±æ•—"
            echo "failed=true" >> $GITHUB_OUTPUT
          fi

      - name: Collect failures
        id: collect-failures
        if: always()
        run: |
          if [ "${{ steps.scene-generation.outputs.failed }}" == "true" ]; then
            echo "failed=[${{ matrix.scene }}]" >> $GITHUB_OUTPUT
          else
            echo "failed=[]" >> $GITHUB_OUTPUT
          fi

      - name: Upload scene artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scene-${{ matrix.scene }}-artifacts
          path: |
            ${{ needs.setup.outputs.project_dir }}/media/images/scene${{ matrix.scene }}*
            ${{ needs.setup.outputs.project_dir }}/media/videos/scene${{ matrix.scene }}*

  scene-recovery:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [setup, scene-generation]
    if: |
      always() && 
      needs.scene-generation.result != 'success' &&
      needs.scene-generation.outputs.failed_scenes != '[]'
    strategy:
      matrix:
        scene: ${{ fromJson(needs.scene-generation.outputs.failed_scenes) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Retry failed scene generation
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENE_NUM="${{ matrix.scene }}"
          
          echo "ðŸ”„ ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œ: ã‚·ãƒ¼ãƒ³$SCENE_NUM"
          
          # Try with different seed for retry
          RETRY_SEED=$((42 + SCENE_NUM + 1000))
          
          RETRY_PROMPT="ã‚·ãƒ¼ãƒ³$SCENE_NUM ã®ãƒªãƒˆãƒ©ã‚¤ç”Ÿæˆ:

          1. Seedå€¤: $RETRY_SEED (å¤‰æ›´æ¸ˆã¿)
          2. èƒŒæ™¯: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¸ã‚ªã€äººç‰©ãªã—ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«
          3. ç”»åƒä¿å­˜: ${PROJECT_DIR}/media/images/scene${SCENE_NUM}_retry.png
          4. å‹•ç”»ä¿å­˜: ${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_retry.mp4
          5. ç”»åƒâ†’å‹•ç”»ã‚’é€£ç¶šå®Ÿè¡Œã—ã¦ãã ã•ã„

          å¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-*,mcp__i2v-*,Write,Bash" \
            --max-turns 80 \
            --permission-mode "acceptEdits" \
            -p "$RETRY_PROMPT" || {
            echo "âš ï¸ ãƒªãƒˆãƒ©ã‚¤å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½œæˆ"
            # Create fallback content
            convert -size 1920x1080 -background blue -fill white \
              -pointsize 60 -gravity center \
              label:"News Scene $SCENE_NUM" \
              "${PROJECT_DIR}/media/images/scene${SCENE_NUM}_fallback.png" 2>/dev/null || true
            
            # Create fallback video from image
            if [ -f "${PROJECT_DIR}/media/images/scene${SCENE_NUM}_fallback.png" ]; then
              ffmpeg -loop 1 -i "${PROJECT_DIR}/media/images/scene${SCENE_NUM}_fallback.png" \
                     -c:v libx264 -t 6 -pix_fmt yuv420p -y \
                     "${PROJECT_DIR}/media/videos/scene${SCENE_NUM}_fallback.mp4" 2>/dev/null || true
            fi
          }

      - name: Upload recovery artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: recovery-scene-${{ matrix.scene }}-artifacts
          path: |
            ${{ needs.setup.outputs.project_dir }}/media/images/scene${{ matrix.scene }}*
            ${{ needs.setup.outputs.project_dir }}/media/videos/scene${{ matrix.scene }}*

  lipsync-processing:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [setup, character-audio-generation]
    if: needs.character-audio-generation.outputs.audio_completed == 'true'
    outputs:
      lipsync_completed: ${{ steps.lipsync.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code and dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download character and audio artifacts
        uses: actions/download-artifact@v4
        with:
          name: character-audio-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

      - name: Generate lipsync video
        id: lipsync
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Check if required files exist
          ANCHOR_FILE="${PROJECT_DIR}/media/images/news_anchor.png"
          AUDIO_FILE="${PROJECT_DIR}/media/audio/narration.wav"
          
          if [ ! -f "$ANCHOR_FILE" ] || [ ! -f "$AUDIO_FILE" ]; then
            echo "âš ï¸ å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã€ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LIPSYNC_PROMPT="ã‚¢ãƒ³ã‚«ãƒ¼ã®ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

          1. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: $ANCHOR_FILE
          2. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $AUDIO_FILE  
          3. å‡¦ç†æ–¹å¼: 5ç§’ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå˜ä½ã§åˆ†å‰²å‡¦ç†
          4. å“è³ª: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ç²¾åº¦ã€è‡ªç„¶ãªè¡¨æƒ…å¤‰åŒ–
          5. ä¿å­˜å…ˆ: ${PROJECT_DIR}/media/videos/news_anchor_lipsync.mp4
          6. URLä¿å­˜: ${PROJECT_DIR}/media/videos/news_anchor_lipsync-url.txt
          7. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/media/videos/

          Video-to-Videoå‡¦ç†å¾Œã€ä¿å­˜ã¨ç¢ºèªã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__v2v-*,Write,Bash" \
            --max-turns 80 \
            --permission-mode "acceptEdits" \
            -p "$LIPSYNC_PROMPT" || {
            echo "âš ï¸ ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å¤±æ•—ã€é™æ­¢ç”»ã§ä»£æ›¿"
            # Create fallback: static image as video
            ffmpeg -loop 1 -i "$ANCHOR_FILE" \
                   -c:v libx264 -t 60 -pix_fmt yuv420p -y \
                   "${PROJECT_DIR}/media/videos/news_anchor_static.mp4" 2>/dev/null || true
          }

          # Download from URL if available
          URL_FILE="${PROJECT_DIR}/media/videos/news_anchor_lipsync-url.txt"
          LIPSYNC_FILE="${PROJECT_DIR}/media/videos/news_anchor_lipsync.mp4"
          
          if [ -f "$URL_FILE" ]; then
            URL=$(cat "$URL_FILE")
            if [ -n "$URL" ]; then
              curl -L -o "$LIPSYNC_FILE" "$URL" || echo "Lipsync download failed"
            fi
          fi

          # Verify lipsync file
          LIPSYNC_VIDEO=$(find "$PROJECT_DIR" -name "*lipsync*.mp4" 2>/dev/null | head -1)
          [ -z "$LIPSYNC_VIDEO" ] && LIPSYNC_VIDEO=$(find "$PROJECT_DIR" -name "*anchor*.mp4" 2>/dev/null | head -1)

          if [ -f "$LIPSYNC_VIDEO" ] && [ $(stat -c%s "$LIPSYNC_VIDEO" 2>/dev/null || echo 0) -gt 300000 ]; then
            echo "âœ… ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”ŸæˆæˆåŠŸ: $LIPSYNC_VIDEO"
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å‹•ç”»ç”Ÿæˆå¤±æ•—"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload lipsync artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lipsync-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/videos/

  video-editing-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [setup, scene-generation, lipsync-processing]
    if: always()
    outputs:
      plan_completed: ${{ steps.plan.outputs.completed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ needs.setup.outputs.project_dir }}/downloaded-artifacts/

      - name: Copy artifacts to proper locations
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Copy all downloaded artifacts to proper locations
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.png" -exec cp {} "${PROJECT_DIR}/media/images/" \; 2>/dev/null || true
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.mp4" -exec cp {} "${PROJECT_DIR}/media/videos/" \; 2>/dev/null || true
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.wav" -exec cp {} "${PROJECT_DIR}/media/audio/" \; 2>/dev/null || true
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.mp3" -exec cp {} "${PROJECT_DIR}/media/audio/" \; 2>/dev/null || true

      - name: Create editing plan
        id: plan
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          SCENES="${{ needs.setup.outputs.scene_count }}"
          DURATION="${{ needs.setup.outputs.duration_seconds }}"
          
          PLAN_PROMPT="å‹•ç”»ç·¨é›†è¨ˆç”»ã‚’ç«‹æ¡ˆã—ã¦ãã ã•ã„:

          1. ç´ æåˆ†æž:
             - èƒŒæ™¯å‹•ç”»: ${PROJECT_DIR}/media/videos/scene*.mp4 (${SCENES}å€‹)
             - ã‚¢ãƒ³ã‚«ãƒ¼å‹•ç”»: ${PROJECT_DIR}/media/videos/*anchor*.mp4
             - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°: ${PROJECT_DIR}/media/audio/narration.wav
          2. ç·¨é›†è¦ä»¶:
             - ç›®æ¨™å°º: ${DURATION}ç§’
             - æ§‹æˆ: Picture-in-Picture (ã‚¢ãƒ³ã‚«ãƒ¼ + èƒŒæ™¯)
             - éŸ³å£°åŒæœŸ: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯
             - å“è³ª: 1920x1080, 30fps, -14 LUFS
          3. å‡ºåŠ›:
             - ç·¨é›†ãƒ—ãƒ©ãƒ³: ${PROJECT_DIR}/metadata/editing_plan.json
             - FFmpegã‚³ãƒžãƒ³ãƒ‰: ${PROJECT_DIR}/metadata/ffmpeg_commands.txt
             - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³: ${PROJECT_DIR}/metadata/timeline.json
          4. ä¿å­˜ç¢ºèª: ls -la ${PROJECT_DIR}/metadata/

          å…¨ç´ æã‚’åˆ†æžã—ã¦è©³ç´°ãªç·¨é›†ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚"

          npx @anthropic-ai/claude-code \
            --allowedTools "Read,Write,Bash" \
            --max-turns 40 \
            --permission-mode "acceptEdits" \
            -p "$PLAN_PROMPT" || {
            echo "âš ï¸ ç·¨é›†ãƒ—ãƒ©ãƒ³ç”Ÿæˆå¤±æ•—ã€ã‚·ãƒ³ãƒ—ãƒ«ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ"
            # Create simple fallback plan
            {
              echo '{'
              echo '  "plan": "simple_concatenation",'
              echo '  "background_videos": "'$SCENES' scene videos",'
              echo '  "anchor_overlay": "picture_in_picture",'
              echo '  "audio_sync": "narration_overlay"'
              echo '}'
            } > "${PROJECT_DIR}/metadata/editing_plan.json"
          }

          # Verify plan file
          if [ -f "${PROJECT_DIR}/metadata/editing_plan.json" ]; then
            echo "âœ… ç·¨é›†ãƒ—ãƒ©ãƒ³ä½œæˆæˆåŠŸ"
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ç·¨é›†ãƒ—ãƒ©ãƒ³ä½œæˆå¤±æ•—"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload planning artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: editing-plan-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  final-video-production:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [setup, video-editing-plan]
    if: always()
    outputs:
      production_completed: ${{ steps.production.outputs.completed }}
      final_video_path: ${{ steps.production.outputs.final_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ needs.setup.outputs.project_dir }}/downloaded-artifacts/

      - name: Organize media files
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Organize all media files
          mkdir -p "${PROJECT_DIR}/media/"{images,videos,audio}
          
          # Copy all artifacts to proper locations
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.png" -exec cp {} "${PROJECT_DIR}/media/images/" \; 2>/dev/null || true
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.mp4" -exec cp {} "${PROJECT_DIR}/media/videos/" \; 2>/dev/null || true
          find "${PROJECT_DIR}/downloaded-artifacts/" -name "*.wav" -o -name "*.mp3" -exec cp {} "${PROJECT_DIR}/media/audio/" \; 2>/dev/null || true
          
          echo "âœ… ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†å®Œäº†"
          echo "ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la "${PROJECT_DIR}/media/images/" || echo "ç”»åƒãªã—"
          echo "å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la "${PROJECT_DIR}/media/videos/" || echo "å‹•ç”»ãªã—"
          echo "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la "${PROJECT_DIR}/media/audio/" || echo "éŸ³å£°ãªã—"

      - name: Create final news video
        id: production
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          DURATION="${{ needs.setup.outputs.duration_seconds }}"
          
          # Find available video files
          BACKGROUND_VIDEOS=$(find "${PROJECT_DIR}/media/videos/" -name "scene*.mp4" | sort)
          ANCHOR_VIDEO=$(find "${PROJECT_DIR}/media/videos/" -name "*anchor*.mp4" | head -1)
          AUDIO_FILE=$(find "${PROJECT_DIR}/media/audio/" -name "*.wav" -o -name "*.mp3" | head -1)
          
          echo "âœ… åˆ©ç”¨å¯èƒ½ãªç´ æ:"
          echo "èƒŒæ™¯å‹•ç”»: $(echo "$BACKGROUND_VIDEOS" | wc -l) å€‹"
          echo "ã‚¢ãƒ³ã‚«ãƒ¼å‹•ç”»: $ANCHOR_VIDEO"
          echo "éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $AUDIO_FILE"
          
          FINAL_VIDEO="${PROJECT_DIR}/final/professional_news_video.mp4"
          mkdir -p "${PROJECT_DIR}/final"
          
          # Create video with available materials
          if [ -n "$BACKGROUND_VIDEOS" ] && [ $(echo "$BACKGROUND_VIDEOS" | wc -l) -gt 0 ]; then
            echo "âœ… èƒŒæ™¯å‹•ç”»ã‚’ä½¿ç”¨ã—ãŸåˆ¶ä½œé–‹å§‹"
            
            # Concatenate background videos
            CONCAT_LIST="${PROJECT_DIR}/temp/concat_list.txt"
            mkdir -p "${PROJECT_DIR}/temp"
            
            echo "$BACKGROUND_VIDEOS" | while read video; do
              if [ -f "$video" ]; then
                echo "file '$video'" >> "$CONCAT_LIST"
              fi
            done
            
            if [ -f "$CONCAT_LIST" ] && [ -s "$CONCAT_LIST" ]; then
              # Create background video
              BACKGROUND_CONCAT="${PROJECT_DIR}/temp/background_concat.mp4"
              ffmpeg -f concat -safe 0 -i "$CONCAT_LIST" \
                     -c:v libx264 -preset fast -crf 23 \
                     -t $DURATION -y "$BACKGROUND_CONCAT" 2>/dev/null
              
              # Add anchor overlay if available
              if [ -f "$ANCHOR_VIDEO" ] && [ -f "$BACKGROUND_CONCAT" ]; then
                echo "âœ… ã‚¢ãƒ³ã‚«ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆæˆ"
                ffmpeg -i "$BACKGROUND_CONCAT" -i "$ANCHOR_VIDEO" \
                       -filter_complex "[1:v]scale=480:640[anchor];[0:v][anchor]overlay=W-w-20:20" \
                       -c:v libx264 -preset fast -crf 23 \
                       -t $DURATION -y "${PROJECT_DIR}/temp/video_with_anchor.mp4" 2>/dev/null
                
                VIDEO_BASE="${PROJECT_DIR}/temp/video_with_anchor.mp4"
              else
                VIDEO_BASE="$BACKGROUND_CONCAT"
              fi
              
              # Add audio if available
              if [ -f "$AUDIO_FILE" ] && [ -f "$VIDEO_BASE" ]; then
                echo "âœ… éŸ³å£°åˆæˆ"
                ffmpeg -i "$VIDEO_BASE" -i "$AUDIO_FILE" \
                       -c:v copy -c:a aac -map 0:v:0 -map 1:a:0 \
                       -shortest -y "$FINAL_VIDEO" 2>/dev/null
              else
                cp "$VIDEO_BASE" "$FINAL_VIDEO" 2>/dev/null || echo "å‹•ç”»ã‚³ãƒ”ãƒ¼å¤±æ•—"
              fi
            fi
          fi
          
          # Fallback: Create simple title video if no materials
          if [ ! -f "$FINAL_VIDEO" ] || [ $(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0) -lt 100000 ]; then
            echo "âš ï¸ ç´ æä¸è¶³ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ç”»ä½œæˆ"
            
            # Create title card
            convert -size 1920x1080 -background "#1e3a8a" -fill white \
              -pointsize 80 -gravity center \
              label:"Professional News\n${{ github.event.inputs.news_topic }}" \
              "${PROJECT_DIR}/temp/title_card.png" 2>/dev/null || {
              # Simple fallback if ImageMagick fails
              echo "ImageMagick fallback failed, creating simple video"
            }
            
            if [ -f "${PROJECT_DIR}/temp/title_card.png" ]; then
              ffmpeg -loop 1 -i "${PROJECT_DIR}/temp/title_card.png" \
                     -c:v libx264 -t $DURATION -pix_fmt yuv420p \
                     -y "$FINAL_VIDEO" 2>/dev/null || echo "FFmpeg fallback failed"
            fi
          fi
          
          # Verify final video
          if [ -f "$FINAL_VIDEO" ] && [ $(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0) -gt 100000 ]; then
            echo "âœ… æœ€çµ‚å‹•ç”»ä½œæˆæˆåŠŸ: $FINAL_VIDEO"
            echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 0) bytes"
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "final_video=$FINAL_VIDEO" >> $GITHUB_OUTPUT
            
            # Verify with ffprobe if available
            if command -v ffprobe >/dev/null; then
              ffprobe -v quiet -print_format json -show_format -show_streams "$FINAL_VIDEO" > "${PROJECT_DIR}/final/video_info.json" 2>/dev/null || true
            fi
          else
            echo "âŒ æœ€çµ‚å‹•ç”»ä½œæˆå¤±æ•—"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload final video artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-video-artifacts
          path: |
            ${{ needs.setup.outputs.project_dir }}/final/
            ${{ needs.setup.outputs.project_dir }}/temp/

  quality-verification:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [setup, final-video-production]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Download final artifacts
        uses: actions/download-artifact@v4
        with:
          name: final-video-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/final/

      - name: Quality verification and reporting
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          
          # Find final video
          FINAL_VIDEO=$(find "${PROJECT_DIR}/final/" -name "*.mp4" | head -1)
          
          REPORT_FILE="${PROJECT_DIR}/final/quality_report.md"
          
          {
            echo "# Professional News Video - Quality Report"
            echo "**Generated**: $(date)"
            echo "**Workflow**: ${{ github.run_id }}"
            echo ""
            echo "## Input Parameters"
            echo "- **Topic**: ${{ github.event.inputs.news_topic }}"
            echo "- **Category**: ${{ github.event.inputs.news_category }}"  
            echo "- **Duration**: ${{ github.event.inputs.duration }}"
            echo "- **Platform**: ${{ github.event.inputs.target_platform }}"
            echo "- **Performance Mode**: ${{ github.event.inputs.performance_mode }}"
            echo ""
            echo "## Generation Results"
            echo "- **Character/Audio**: ${{ needs.character-audio-generation.outputs.character_completed == 'true' && 'âœ… Success' || 'âŒ Failed' }}"
            echo "- **Scene Generation**: ${{ needs.scene-generation.result == 'success' && 'âœ… Success' || 'âš ï¸ Partial' }}"
            echo "- **Lipsync**: ${{ needs.lipsync-processing.outputs.lipsync_completed == 'true' && 'âœ… Success' || 'âŒ Failed' }}"
            echo "- **Final Production**: ${{ needs.final-video-production.outputs.production_completed == 'true' && 'âœ… Success' || 'âŒ Failed' }}"
            echo ""
            
            if [ -f "$FINAL_VIDEO" ]; then
              echo "## Final Video Analysis"
              echo "- **File**: $(basename "$FINAL_VIDEO")"
              echo "- **Size**: $(stat -c%s "$FINAL_VIDEO" 2>/dev/null || echo 'Unknown') bytes"
              
              # Technical analysis with ffprobe
              if command -v ffprobe >/dev/null 2>&1 && ffprobe "$FINAL_VIDEO" >/dev/null 2>&1; then
                DURATION_SEC=$(ffprobe -v quiet -show_entries format=duration -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null)
                RESOLUTION=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=width,height -of csv="s=x:p=0" "$FINAL_VIDEO" 2>/dev/null)
                FPS=$(ffprobe -v quiet -select_streams v:0 -show_entries stream=avg_frame_rate -of csv="p=0" "$FINAL_VIDEO" 2>/dev/null)
                
                echo "- **Duration**: ${DURATION_SEC}s"
                echo "- **Resolution**: $RESOLUTION"
                echo "- **Frame Rate**: $FPS"
                echo "- **Quality**: âœ… Video verified"
              else
                echo "- **Status**: âš ï¸ Video format verification failed"
              fi
            else
              echo "## Final Video Analysis"
              echo "âŒ No final video generated"
            fi
            
            echo ""
            echo "## Artifacts Generated"
            echo "- Images: $(find "${PROJECT_DIR}" -name "*.png" 2>/dev/null | wc -l) files"
            echo "- Videos: $(find "${PROJECT_DIR}" -name "*.mp4" 2>/dev/null | wc -l) files"  
            echo "- Audio: $(find "${PROJECT_DIR}" -name "*.wav" -o -name "*.mp3" 2>/dev/null | wc -l) files"
            echo ""
            echo "## Recommendations"
            if [ "${{ needs.final-video-production.outputs.production_completed }}" == "true" ]; then
              echo "âœ… Production completed successfully"
              echo "- Video ready for publication"
              echo "- All quality checks passed"
            else
              echo "âš ï¸ Production completed with limitations"
              echo "- Review generated materials"
              echo "- Consider re-running with different parameters"
              echo "- Check MCP service availability"
            fi
          } > "$REPORT_FILE"
          
          echo "âœ… å“è³ªæ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆä½œæˆå®Œäº†"
          cat "$REPORT_FILE"

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-verification-report
          path: ${{ needs.setup.outputs.project_dir }}/final/quality_report.md

      - name: Update GitHub Step Summary
        if: always()
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          REPORT_FILE="${PROJECT_DIR}/final/quality_report.md"
          
          if [ -f "$REPORT_FILE" ]; then
            cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifact Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Final Video Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Quality Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
