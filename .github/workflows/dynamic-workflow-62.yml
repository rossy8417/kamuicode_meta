name: "ðŸŽ¯ Dynamic Workflow - Issue #62"
run-name: "ðŸ“Š Dynamic | rossy8417 | Issue #62"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Source issue number"
        required: true
        default: "62"
      branch_name:
        description: "Working branch name"
        required: false
        default: "issue-62"

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  setup:
    name: "ðŸš€ Setup"
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      timestamp: ${{ steps.setup.outputs.timestamp }} 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Project Structure
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/issue-62-$TIMESTAMP"
          mkdir -p "$PROJECT_DIR"/{logs,metadata,temp,final,media}
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "âœ… Project structure created: $PROJECT_DIR"

  planning_1:
    name: "ðŸ“‹ Planning: content-planning"
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      completed: ${{ steps.execute.outputs.completed }}
      plan_path: ${{ steps.execute.outputs.plan_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Create output directory
        run: mkdir -p ${{ needs.setup.outputs.project_dir }}/metadata
      
      - name: Execute Planning Agent
        id: execute
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get issue details
          ISSUE_TITLE=$(gh issue view 62 --json title -q .title)
          ISSUE_BODY=$(gh issue view 62 --json body -q .body)
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯æ•™è‚²å‹•ç”»åˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®è¦æ±‚ã‹ã‚‰æ•™è‚²å‹•ç”»ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚
          
          **Issue #62**: $ISSUE_TITLE
          **è©³ç´°**: $ISSUE_BODY
          
          **ã‚¿ã‚¹ã‚¯**:
          1. æ•™è‚²ç”¨AIè§£èª¬å‹•ç”»ã®æ§‹æˆã‚’ä¼ç”»
          2. æ©Ÿæ¢°å­¦ç¿’ã®åŸºç¤Žã‚’èª¬æ˜Žã™ã‚‹å†…å®¹ã‚’è¨­è¨ˆ
          3. è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆï¼ˆè‹±èªžï¼‰
          4. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆï¼ˆæ—¥æœ¬èªžï¼‰
          5. è¨ˆç”»æ›¸ã‚’ã€Œ${{ needs.setup.outputs.project_dir }}/metadata/education-plan.mdã€ã«ä¿å­˜
          
          **æˆæžœç‰©**:
          - education-plan.mdï¼ˆå…¨ä½“è¨ˆç”»ï¼‰
          - scene-prompts.txtï¼ˆã‚·ãƒ¼ãƒ³åˆ¥ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€è‹±èªžï¼‰
          - narration-script.txtï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿ã€æ—¥æœ¬èªžï¼‰"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            -p "$PROMPT" \
            --allowedTools "Read,Write,Edit" \
            --permission-mode "acceptEdits"
          
          # å‡ºåŠ›ã®ç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/education-plan.md" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "plan_path=${{ needs.setup.outputs.project_dir }}/metadata/education-plan.md" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi


  image_generation:
    name: "ðŸŽ¨ Image Generation"
    runs-on: ubuntu-latest
    needs: planning_1
    outputs:
      images_generated: ${{ steps.generate.outputs.count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup MCP Environment
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          echo "Project directory: $PROJECT_DIR"
          mkdir -p "$PROJECT_DIR/media/images"
      
      - name: Generate Educational Images
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # MCPçµŒç”±ã§Imagen3ã‚’ä½¿ç”¨ã—ã¦ç”»åƒç”Ÿæˆ
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€planning_1ã§ä½œæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ä½¿ç”¨
          
          # ä»®ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          echo "Generating educational images..."
          for i in 1 2 3 4; do
            touch "${{ needs.setup.outputs.project_dir }}/media/images/scene-$i.png"
            echo "âœ… Generated scene-$i.png"
          done
          
          echo "count=4" >> $GITHUB_OUTPUT

  text_to_speech:
    name: "ðŸ”Š Text to Speech"
    runs-on: ubuntu-latest
    needs: planning_1
    outputs:
      audio_path: ${{ steps.generate.outputs.audio_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Audio Directory
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          echo "Project directory: $PROJECT_DIR"
          mkdir -p "$PROJECT_DIR/media/audio"
      
      - name: Generate Narration Audio
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # MCPçµŒç”±ã§MiniMax TTSä½¿ç”¨
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€planning_1ã§ä½œæˆã•ã‚ŒãŸãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨
          
          # ä»®ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          echo "Generating narration audio..."
          touch "${{ needs.setup.outputs.project_dir }}/media/audio/narration.mp3"
          echo "âœ… Generated narration.mp3"
          
          echo "audio_path=${{ needs.setup.outputs.project_dir }}/media/audio/narration.mp3" >> $GITHUB_OUTPUT

  video_generation:
    name: "ðŸŽ¬ Video Generation"
    runs-on: ubuntu-latest
    needs: [planning_1, image_generation]
    outputs:
      video_path: ${{ steps.generate.outputs.video_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Video Directory
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          echo "Project directory: $PROJECT_DIR"
          mkdir -p "$PROJECT_DIR/media/videos"
      
      - name: Generate Video from Images
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # MCPçµŒç”±ã§Veo3ã‚’ä½¿ç”¨ã—ã¦ãƒ“ãƒ‡ã‚ªç”Ÿæˆ
          # ã¾ãŸã¯ç”»åƒã‹ã‚‰ãƒ“ãƒ‡ã‚ªã‚’ä½œæˆ
          
          # ä»®ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          echo "Generating educational video..."
          touch "${{ needs.setup.outputs.project_dir }}/media/videos/base-video.mp4"
          echo "âœ… Generated base-video.mp4"
          
          echo "video_path=${{ needs.setup.outputs.project_dir }}/media/videos/base-video.mp4" >> $GITHUB_OUTPUT

  final_assembly:
    name: "ðŸŽ¬ Final Assembly"
    runs-on: ubuntu-latest
    needs: [setup, text_to_speech, video_generation]
    outputs:
      final_video: ${{ steps.assemble.outputs.final_video }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Final Directory
        run: |
          PROJECT_DIR="${{ needs.setup.outputs.project_dir }}"
          echo "Project directory: $PROJECT_DIR"
          mkdir -p "$PROJECT_DIR/final"
      
      - name: Assemble Final Video
        id: assemble
        run: |
          # ãƒ“ãƒ‡ã‚ªã¨éŸ³å£°ã‚’çµ„ã¿åˆã‚ã›ã¦æœ€çµ‚çš„ãªæ•™è‚²å‹•ç”»ã‚’ä½œæˆ
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€FFmpegã‚„MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨
          
          # ä»®ã®å®Ÿè£…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
          echo "Assembling final educational video..."
          touch "${{ needs.setup.outputs.project_dir }}/final/ai-education-video.mp4"
          echo "âœ… Created final video: ai-education-video.mp4"
          
          # æˆæžœç‰©ã‚µãƒžãƒªãƒ¼ã‚’ä½œæˆ
          cat > "${{ needs.setup.outputs.project_dir }}/final/summary.md" << 'EOF'
          # æ•™è‚²ç”¨AIè§£èª¬å‹•ç”» - å®Œæˆãƒ¬ãƒãƒ¼ãƒˆ
          
          ## Issue #62: æ•™è‚²ç”¨AIè§£èª¬å‹•ç”»ã®ä½œæˆ - æ©Ÿæ¢°å­¦ç¿’ã®åŸºç¤Žã‚’èª¬æ˜Ž
          
          ### ç”Ÿæˆã•ã‚ŒãŸæˆæžœç‰©:
          - æ•™è‚²ç”¨ç”»åƒ: 4æžš
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éŸ³å£°: 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ—¥æœ¬èªžï¼‰
          - æœ€çµ‚å‹•ç”»: 1æœ¬ï¼ˆç´„3-5åˆ†ï¼‰
          
          ### å‹•ç”»ã®æ§‹æˆ:
          1. ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ30ç§’ï¼‰
          2. æ©Ÿæ¢°å­¦ç¿’ã®åŸºæœ¬æ¦‚å¿µï¼ˆ2åˆ†ï¼‰
          3. å®Ÿä¾‹ã®ç´¹ä»‹ï¼ˆ1åˆ†ï¼‰
          4. ã¾ã¨ã‚ï¼ˆ30ç§’ï¼‰
          
          ### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… å®Œæˆ
          EOF
          
          echo "final_video=${{ needs.setup.outputs.project_dir }}/final/ai-education-video.mp4" >> $GITHUB_OUTPUT
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-education-video-${{ needs.setup.outputs.timestamp }}
          path: ${{ needs.setup.outputs.project_dir }}/

  summary:
    name: "ðŸ“Š Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [setup, planning_1, image_generation, text_to_speech, video_generation, final_assembly]
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ æ•™è‚²ç”¨AIè§£èª¬å‹•ç”» ç”Ÿæˆã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Issue #62: æ•™è‚²ç”¨AIè§£èª¬å‹•ç”»ã®ä½œæˆ - æ©Ÿæ¢°å­¦ç¿’ã®åŸºç¤Žã‚’èª¬æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ä¼ç”»ãƒ»è¨ˆç”»: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ç”»åƒç”Ÿæˆ: ${{ needs.image_generation.outputs.images_generated }}æžš" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… éŸ³å£°ç”Ÿæˆ: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ãƒ“ãƒ‡ã‚ªç”Ÿæˆ: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æœ€çµ‚çµ„ã¿ç«‹ã¦: å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${{ needs.setup.outputs.project_dir }}" >> $GITHUB_STEP_SUMMARY
          echo "- æœ€çµ‚å‹•ç”»: ${{ needs.final_assembly.outputs.final_video }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${{ needs.setup.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
