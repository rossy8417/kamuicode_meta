name: "Simple Test Workflow"
run-name: "🧪 Test: ${{ github.event.inputs.test_concept || 'Simple Test' }}"

on:
  workflow_dispatch:
    inputs:
      test_concept:
        description: 'テストコンセプト'
        required: true
        default: 'シンプルなテストワークフロー'
        type: string

permissions:
  contents: write
  issues: read
  actions: read
  pull-requests: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  PROJECT_DIR: projects/test-${{ github.run_number }}
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  # Phase 1: Setup
  setup-test:
    runs-on: ubuntu-latest
    outputs:
      setup_ready: ${{ steps.setup.outputs.setup_ready }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Simple Setup
        id: setup
        run: |
          echo "🧪 Running simple test..."
          echo "Concept: ${{ inputs.test_concept }}"
          
          # Create test directory
          mkdir -p "${{ env.PROJECT_DIR }}"
          echo "Test started at $(date)" > "${{ env.PROJECT_DIR }}/test.log"
          
          echo "setup_ready=true" >> $GITHUB_OUTPUT
          echo "✅ Setup completed"

  # Phase 2: Test Meta Logic
  test-meta-logic:
    runs-on: ubuntu-latest
    needs: setup-test
    if: needs.setup-test.outputs.setup_ready == 'true'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Test Meta Workflow Logic
        run: |
          echo "🔍 Testing meta workflow generation logic..."
          
          # Simulate issue extraction
          echo "Extracting requirements from concept: ${{ inputs.test_concept }}"
          
          # Simulate workflow generation
          echo "Generating workflow structure..."
          mkdir -p "${{ env.PROJECT_DIR }}/generated"
          
          cat > "${{ env.PROJECT_DIR }}/generated/test-workflow.yml" << 'EOF'
          name: Generated Test Workflow
          on:
            workflow_dispatch:
          jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - name: Test Step
                  run: echo "Generated workflow test"
          EOF
          
          echo "✅ Meta logic test completed"

  # Phase 3: Success Report  
  report-success:
    runs-on: ubuntu-latest
    needs: [setup-test, test-meta-logic]
    
    steps:
      - name: Report Success
        run: |
          echo "🎉 All tests passed!"
          echo "- Setup: ✅"
          echo "- Meta Logic: ✅" 
          echo "- Generated Files: ✅"
          echo ""
          echo "This workflow successfully demonstrates:"
          echo "1. Simple workflow_dispatch trigger"
          echo "2. Basic job dependency chain"
          echo "3. File generation simulation"
          echo "4. Meta workflow pattern without complexity"