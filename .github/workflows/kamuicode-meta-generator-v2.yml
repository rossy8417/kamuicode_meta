name: Kamuicode Meta Generator v2 (Composite Workflow Optimized)
run-name: ${{ github.actor }} generates workflow for "${{ github.event.issue.title || github.event.inputs.description }}" ðŸ¤–âœ¨

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      workflow_type:
        description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - image-generation
          - video-generation
          - audio-generation  
          - news-article
          - news-video
          - social-integration
          - custom
      description:
        description: 'ç”Ÿæˆã—ãŸã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®èª¬æ˜Ž'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Step 1: è¦æ±‚åˆ†æž
  analyze-request:
    runs-on: ubuntu-latest
    outputs:
      workflow_type: ${{ steps.analyze.outputs.workflow_type }}
      request_file: ${{ steps.analyze.outputs.request_file }}
      composite_detected: ${{ steps.analyze.outputs.composite_detected }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Analyze Request with Composite Detection
        id: analyze
        run: |
          echo "ðŸ“‹ Starting enhanced request analysis..."
          
          mkdir -p .meta/requests
          
          if [ "${{ github.event_name }}" == "issues" ]; then
            TITLE="${{ github.event.issue.title }}"
            BODY="${{ github.event.issue.body }}"
            REQUEST_ID="issue-${{ github.event.issue.number }}"
          else
            TITLE="${{ github.event.inputs.description }}"
            BODY="${{ github.event.inputs.description }}"
            REQUEST_ID="manual-$(date +%Y%m%d-%H%M%S)"
          fi
          
          # è¤‡åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ¤œå‡º
          COMPOSITE_DETECTED="false"
          COMPOSITE_TYPE="single"
          
          if echo "$TITLE $BODY" | grep -qi "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼.*å‹•ç”».*éŸ³æ¥½\|story.*video.*music\|BGM.*å‹•ç”»\|ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³.*å‹•ç”»\|ãƒ†ã‚­ã‚¹ãƒˆ.*ç”»åƒ.*å‹•ç”».*éŸ³æ¥½"; then
            COMPOSITE_DETECTED="true"
            COMPOSITE_TYPE="story-video-audio"
            WORKFLOW_TYPE="video-generation"
            echo "âœ… Detected composite workflow: Story â†’ Image â†’ Video â†’ Audio"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.workflow_type }}" ]; then
            WORKFLOW_TYPE="${{ github.event.inputs.workflow_type }}"
            echo "âœ… Using manually specified workflow type: $WORKFLOW_TYPE"
          else
            # åŸºæœ¬çš„ãªãƒ†ã‚­ã‚¹ãƒˆè§£æž
            if echo "$TITLE $BODY" | grep -qi "ç”»åƒ\|image"; then
              WORKFLOW_TYPE="image-generation"
            elif echo "$TITLE $BODY" | grep -qi "å‹•ç”»\|video"; then
              WORKFLOW_TYPE="video-generation"
            elif echo "$TITLE $BODY" | grep -qi "éŸ³å£°\|audio"; then
              WORKFLOW_TYPE="audio-generation"
            else
              WORKFLOW_TYPE="custom"
            fi
            echo "ðŸ“Š Text analysis result: $WORKFLOW_TYPE"
          fi
          
          # è¦æ±‚ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > .meta/requests/${REQUEST_ID}.md << EOF
          # Workflow Generation Request
          
          ## Type: ${WORKFLOW_TYPE}
          ## Composite: ${COMPOSITE_TYPE}
          ## Title: ${TITLE}
          
          ## Description:
          ${BODY}
          
          ## Metadata:
          - Request ID: ${REQUEST_ID}
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Source: ${{ github.event_name }}
          - Composite Detected: ${COMPOSITE_DETECTED}
          EOF
          
          echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT
          echo "request_file=.meta/requests/${REQUEST_ID}.md" >> $GITHUB_OUTPUT
          echo "composite_detected=$COMPOSITE_DETECTED" >> $GITHUB_OUTPUT
          
          echo "âœ… Request analysis completed: Type=$WORKFLOW_TYPE, Composite=$COMPOSITE_DETECTED"

  # Step 2: è¤‡åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¯¾å¿œã‚¿ã‚¹ã‚¯åˆ†è§£
  decompose-tasks:
    needs: [analyze-request]
    runs-on: ubuntu-latest
    outputs:
      task_count: ${{ steps.decompose.outputs.task_count }}
      complexity: ${{ steps.decompose.outputs.complexity }}
      composite_type: ${{ steps.decompose.outputs.composite_type }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Enhanced Composite Task Decomposition
        id: decompose
        run: |
          echo "ðŸŽ¯ Starting enhanced task decomposition..."
          
          WORKFLOW_TYPE="${{ needs.analyze-request.outputs.workflow_type }}"
          REQUEST_FILE="${{ needs.analyze-request.outputs.request_file }}"
          COMPOSITE_DETECTED="${{ needs.analyze-request.outputs.composite_detected }}"
          
          mkdir -p .meta/tasks
          
          echo "ðŸ“‹ Processing: Type=$WORKFLOW_TYPE, Composite=$COMPOSITE_DETECTED"
          
          # è¦æ±‚å†…å®¹ã®èª­ã¿è¾¼ã¿
          if [ -f "$REQUEST_FILE" ]; then
            REQUEST_CONTENT=$(cat "$REQUEST_FILE")
            echo "âœ… Request content loaded"
          else
            echo "âŒ Request file not found: $REQUEST_FILE"
            exit 1
          fi
          
          # è¤‡åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¤å®šã¨ã‚¿ã‚¹ã‚¯åˆ†è§£
          if [ "$COMPOSITE_DETECTED" = "true" ] && echo "$REQUEST_CONTENT" | grep -qi "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼.*å‹•ç”».*éŸ³æ¥½\|story.*video.*music\|BGM.*å‹•ç”»\|ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³.*å‹•ç”»"; then
            # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ â†’ ç”»åƒ â†’ å‹•ç”» â†’ éŸ³æ¥½ â†’ ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
            COMPOSITE_TYPE="story-video-audio"
            cat > .meta/tasks/task-plan.json << EOF
          {
            "workflow_type": "composite-story-video-audio",
            "complexity_level": 4,
            "estimated_duration_minutes": 60,
            "composite_type": "$COMPOSITE_TYPE",
            "tasks": [
              {
                "id": "task-001", 
                "name": "Story Text Processing",
                "description": "Process and optimize story text for image generation",
                "type": "text_processing",
                "dependencies": [],
                "mcp_service": "none",
                "stage": 1
              },
              {
                "id": "task-002",
                "name": "Text-to-Image Generation", 
                "description": "Generate high-quality images from story text using T2I MCP services",
                "type": "ai_generation",
                "dependencies": ["task-001"],
                "mcp_service": "t2i-fal-imagen4-ultra",
                "fallback_services": ["t2i-fal-imagen4-fast", "t2i-google-imagen3"],
                "stage": 2
              },
              {
                "id": "task-003",
                "name": "Image-to-Video Generation",
                "description": "Convert generated images to video using I2V MCP services", 
                "type": "ai_generation",
                "dependencies": ["task-002"],
                "mcp_service": "i2v-fal-hailuo-02-pro",
                "stage": 3
              },
              {
                "id": "task-004", 
                "name": "Background Music Generation",
                "description": "Generate BGM that matches the video mood using T2M services",
                "type": "ai_generation", 
                "dependencies": ["task-001"],
                "mcp_service": "t2m-google-lyria",
                "stage": 3
              },
              {
                "id": "task-005",
                "name": "Narration Audio Generation", 
                "description": "Generate narration voice from story text using V2A services",
                "type": "ai_generation",
                "dependencies": ["task-001", "task-003"], 
                "mcp_service": "v2a-fal-metavoice-v1",
                "stage": 4
              },
              {
                "id": "task-006",
                "name": "Final Video Composition",
                "description": "Combine video, BGM, and narration into final output",
                "type": "media_processing",
                "dependencies": ["task-003", "task-004", "task-005"],
                "stage": 5
              }
            ],
            "execution_flow": [
              {"stage": 1, "parallel": false, "tasks": ["task-001"]},
              {"stage": 2, "parallel": false, "tasks": ["task-002"]}, 
              {"stage": 3, "parallel": true, "tasks": ["task-003", "task-004"]},
              {"stage": 4, "parallel": false, "tasks": ["task-005"]},
              {"stage": 5, "parallel": false, "tasks": ["task-006"]}
            ],
            "templates_required": ["video-content-creation.yml", "audio-music-creation.yml"],
            "composite_mode": true
          }
          EOF
            
            TASK_COUNT=6
            COMPLEXITY=4
            
          else
            # å˜ä¸€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å ´åˆ
            COMPOSITE_TYPE="single"
            cat > .meta/tasks/task-plan.json << EOF
          {
            "workflow_type": "$WORKFLOW_TYPE",
            "complexity_level": 2,
            "estimated_duration_minutes": 30,
            "composite_type": "single",
            "tasks": [
              {
                "id": "task-001",
                "name": "Template-Based Workflow Generation",
                "description": "Generate $WORKFLOW_TYPE workflow from existing template",
                "type": "template_generation",
                "dependencies": [],
                "stage": 1
              }
            ],
            "execution_flow": [
              {"stage": 1, "parallel": false, "tasks": ["task-001"]}
            ],
            "templates_required": ["$WORKFLOW_TYPE.yml"],
            "composite_mode": false
          }
          EOF
            
            TASK_COUNT=1
            COMPLEXITY=2
          fi
          
          echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
          echo "complexity=$COMPLEXITY" >> $GITHUB_OUTPUT
          echo "composite_type=$COMPOSITE_TYPE" >> $GITHUB_OUTPUT
          
          echo "âœ… Enhanced task decomposition complete: $TASK_COUNT tasks, complexity level $COMPLEXITY, type: $COMPOSITE_TYPE"

  # Step 3: è¤‡åˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆ
  generate-workflow:
    needs: [analyze-request, decompose-tasks]
    runs-on: ubuntu-latest
    outputs:
      workflow_file: ${{ steps.generate.outputs.workflow_file }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Generate Composite Workflow
        id: generate
        run: |
          echo "ðŸš€ Generating composite-aware workflow..."
          
          WORKFLOW_TYPE="${{ needs.analyze-request.outputs.workflow_type }}"
          COMPOSITE_TYPE="${{ needs.decompose-tasks.outputs.composite_type }}"
          REQUEST_FILE="${{ needs.analyze-request.outputs.request_file }}"
          
          mkdir -p generated/workflows/staging
          
          REQUEST_ID="$(echo '$REQUEST_FILE' | sed 's/.*\///' | sed 's/\.md$//')"
          GENERATED_FILE="generated/workflows/staging/${REQUEST_ID}-${WORKFLOW_TYPE}.yml"
          
          if [ "$COMPOSITE_TYPE" = "story-video-audio" ]; then
            echo "ðŸŽ¬ Creating composite story-video-audio workflow..."
            
            # è¤‡åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
            cat > "$GENERATED_FILE" << 'EOF'
          name: Generated Composite Story-to-Video-Audio Workflow
          on:
            workflow_dispatch:
              inputs:
                story_text:
                  description: 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ'
                  required: true
                  type: string
                style:
                  description: 'ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«'
                  required: true
                  type: choice
                  options:
                    - photorealistic
                    - anime
                    - digital_art
                  default: photorealistic
                music_mood:
                  description: 'éŸ³æ¥½ã®ãƒ ãƒ¼ãƒ‰'
                  required: true
                  type: choice
                  options:
                    - upbeat
                    - calm
                    - dramatic
                    - mysterious
                  default: calm
                
          permissions:
            contents: write
            
          jobs:
            story-to-image:
              runs-on: ubuntu-latest
              outputs:
                image_path: $${{ steps.generate.outputs.image_path }}
              steps:
                - uses: actions/checkout@v4
                - name: Generate Image from Story
                  id: generate
                  run: |
                    echo "ðŸŽ¨ Generating image from story text..."
                    # T2I MCP service integration here
                    echo "image_path=generated_image.png" >> $$GITHUB_OUTPUT
                    
            image-to-video:
              needs: story-to-image
              runs-on: ubuntu-latest
              outputs:
                video_path: $${{ steps.convert.outputs.video_path }}
              steps:
                - uses: actions/checkout@v4
                - name: Convert Image to Video
                  id: convert
                  run: |
                    echo "ðŸŽ¬ Converting image to video..."
                    # I2V MCP service integration here
                    echo "video_path=generated_video.mp4" >> $$GITHUB_OUTPUT
                    
            generate-bgm:
              runs-on: ubuntu-latest
              outputs:
                bgm_path: $${{ steps.music.outputs.bgm_path }}
              steps:
                - uses: actions/checkout@v4
                - name: Generate Background Music
                  id: music
                  run: |
                    echo "ðŸŽµ Generating background music..."
                    # T2M MCP service integration here  
                    echo "bgm_path=generated_bgm.mp3" >> $$GITHUB_OUTPUT
                    
            generate-narration:
              needs: [story-to-image, image-to-video]
              runs-on: ubuntu-latest
              outputs:
                narration_path: $${{ steps.voice.outputs.narration_path }}
              steps:
                - uses: actions/checkout@v4
                - name: Generate Narration
                  id: voice
                  run: |
                    echo "ðŸ—£ï¸ Generating narration audio..."
                    # V2A MCP service integration here
                    echo "narration_path=generated_narration.mp3" >> $$GITHUB_OUTPUT
                    
            compose-final-video:
              needs: [image-to-video, generate-bgm, generate-narration]
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Compose Final Video
                  run: |
                    echo "ðŸŽžï¸ Composing final video with audio..."
                    echo "Video: $${{ needs.image-to-video.outputs.video_path }}"
                    echo "BGM: $${{ needs.generate-bgm.outputs.bgm_path }}"
                    echo "Narration: $${{ needs.generate-narration.outputs.narration_path }}"
                    # Final composition logic here
                    
                - name: Upload Final Video
                  uses: actions/upload-artifact@v4
                  with:
                    name: final-story-video
                    path: final_video.mp4
          EOF
            
          else
            echo "ðŸ“ Creating single workflow..."
            # åŸºæœ¬çš„ãªå˜ä¸€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ
            PRIMARY_TEMPLATE="meta/examples/${WORKFLOW_TYPE}.yml"
            if [ -f "$PRIMARY_TEMPLATE" ]; then
              cp "$PRIMARY_TEMPLATE" "$GENERATED_FILE"
            else
              echo "âš ï¸ Template not found, creating basic workflow"
              cat > "$GENERATED_FILE" << EOF
          name: Generated $WORKFLOW_TYPE Workflow  
          on:
            workflow_dispatch:
              inputs:
                input_text:
                  description: 'Input for generation'
                  required: true
                  type: string
          jobs:
            generate:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Generate Content
                  run: echo "Generating $WORKFLOW_TYPE content..."
          EOF
            fi
          fi
          
          echo "workflow_file=$GENERATED_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Workflow generated: $GENERATED_FILE"
          
      - name: Commit Generated Workflow
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          git commit -m "feat: Generate composite workflow for ${{ needs.analyze-request.outputs.workflow_type }}

          Composite type: ${{ needs.decompose-tasks.outputs.composite_type }}
          Task count: ${{ needs.decompose-tasks.outputs.task_count }}
          Complexity: ${{ needs.decompose-tasks.outputs.complexity }}
          
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
          
          git pull --rebase origin main || echo "Rebase failed"
          git push origin main || echo "Push failed"