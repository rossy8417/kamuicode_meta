name: Dynamic Stepback Question Generator
run-name: ðŸ¤– Analyzing request and generating custom questions for Issue #${{ github.event.issue.number }}

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Issueä½œæˆæ™‚ã®å‹•çš„è³ªå•ç”Ÿæˆ
  generate-stepback-questions:
    runs-on: ubuntu-latest
    # workflow-request ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã€ã¾ãŸã¯ Workflow Request ãŒã‚¿ã‚¤ãƒˆãƒ«ã«å«ã¾ã‚Œã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.title, 'Workflow Request') || contains(github.event.issue.title, '[Workflow Request]')
    outputs:
      questions_generated: ${{ steps.generate.outputs.questions_generated }}
      issue_updated: ${{ steps.update.outputs.issue_updated }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Analyze User Request and Generate Custom Questions
        id: generate
        run: |
          echo "ðŸ¤– Analyzing user request for Issue #${{ github.event.issue.number }}..."
          
          mkdir -p .meta/dynamic-questions
          
          # Issueå†…å®¹ã‚’å–å¾—
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          echo "ðŸ“‹ Issue Title: $ISSUE_TITLE"
          echo "ðŸ“ Issue Body length: ${#ISSUE_BODY} characters"
          
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«æ•´ç†
          cat > .meta/dynamic-questions/user-request.md << EOF
          # User Request Analysis
          
          **Title:** $ISSUE_TITLE
          
          **Body:** 
          $ISSUE_BODY
          EOF
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          PROMPT_FILE="meta/prompts/stepback-question-generator.md"
          if [ ! -f "$PROMPT_FILE" ]; then
            echo "âŒ Prompt file not found: $PROMPT_FILE"
            exit 1
          fi
          
          echo "âœ… Using prompt file: $PROMPT_FILE"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã‚’ç½®æ›
          cat "$PROMPT_FILE" | sed "s|{{USER_REQUEST}}|$(cat .meta/dynamic-questions/user-request.md)|g" > .meta/dynamic-questions/full-prompt.md
          
          echo "ðŸ§  Executing Claude Code with dynamic question generation prompt..."
          
          # Claude Code ã§å‹•çš„è³ªå•ç”Ÿæˆå®Ÿè¡Œ
          CLAUDE_SUCCESS=false
          if command -v claude &> /dev/null; then
            if claude --continue "$(cat .meta/dynamic-questions/full-prompt.md)" --output-format text 2>.meta/dynamic-questions/claude-error.log; then
              CLAUDE_SUCCESS=true
              echo "âœ… Claude Code question generation completed"
            else
              echo "âŒ Claude Code failed:"
              cat .meta/dynamic-questions/claude-error.log || echo "No error details"
            fi
          else
            echo "âš ï¸ Claude Code not available"
          fi
          
          # ç”Ÿæˆã•ã‚ŒãŸè³ªå•ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          if [ "$CLAUDE_SUCCESS" = "true" ] && [ -f ".meta/dynamic-questions/generated-questions.md" ]; then
            echo "âœ… Dynamic questions generated successfully"
            
            # ç”Ÿæˆã•ã‚ŒãŸè³ªå•ã®å†…å®¹ã‚’ç¢ºèª
            QUESTIONS_CONTENT=$(cat .meta/dynamic-questions/generated-questions.md)
            QUESTION_COUNT=$(echo "$QUESTIONS_CONTENT" | grep -c "**Q[0-9]" || echo "0")
            
            echo "ðŸ“Š Generated $QUESTION_COUNT questions"
            echo "ðŸ“‹ Questions preview:"
            echo "$QUESTIONS_CONTENT" | head -20
            
            if [ "$QUESTION_COUNT" -gt "0" ]; then
              echo "questions_generated=true" >> $GITHUB_OUTPUT
              echo "question_count=$QUESTION_COUNT" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ No valid questions found in generated content"
              echo "questions_generated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Question generation failed - creating fallback questions"
            
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è³ªå•ã‚’ç”Ÿæˆ
            cat > .meta/dynamic-questions/generated-questions.md << 'EOF'
          ## ðŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°åŒ–ã®ãŸã‚ã®è³ªå•ï¼ˆåŸºæœ¬ç‰ˆï¼‰
          
          ã‚ˆã‚Šæ­£ç¢ºã§æœ€é©åŒ–ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®è³ªå•ã«ãŠç­”ãˆãã ã•ã„ï¼š
          
          **Q1: å‡ºåŠ›å“è³ªãƒ»å½¢å¼**
          ç”Ÿæˆã™ã‚‹ç”»åƒ/å‹•ç”»/éŸ³å£°ã®å“è³ªè¨­å®šã‚„å½¢å¼ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
          - ç”»åƒè§£åƒåº¦ï¼š1920x1080 / 1280x720 / ãã®ä»–ï¼ˆã€€ã€€ã€€ï¼‰
          - å“è³ªå„ªå…ˆåº¦ï¼šæœ€é«˜å“è³ª / ãƒãƒ©ãƒ³ã‚¹ / é«˜é€Ÿå‡¦ç†
          å›žç­”ï¼šï¼ˆã“ã“ã«è©³ç´°ã‚’ãŠæ›¸ããã ã•ã„ï¼‰
          
          **Q2: å‡¦ç†ãƒ•ãƒ­ãƒ¼ãƒ»é †åº**
          è¤‡æ•°ã®ãƒ¡ãƒ‡ã‚£ã‚¢ç”ŸæˆãŒã‚ã‚‹å ´åˆã®å‡¦ç†æ–¹æ³•ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
          - å‡¦ç†é †åºï¼šç‰¹å®šã®é †åºãŒå¿…è¦ / ä¸¦åˆ—å‡¦ç†å¯èƒ½ / ãŠä»»ã›
          - ä¾å­˜é–¢ä¿‚ï¼šå‰æ®µéšŽã®å‡ºåŠ›ã‚’æ¬¡ã§ä½¿ç”¨ / ç‹¬ç«‹ã—ã¦ç”Ÿæˆ
          å›žç­”ï¼šï¼ˆã“ã“ã«è©³ç´°ã‚’ãŠæ›¸ããã ã•ã„ï¼‰
          
          **Q3: æŠ€è¡“ä»•æ§˜ãƒ»åˆ¶ç´„**
          æŠ€è¡“çš„ãªè¦ä»¶ã‚„åˆ¶ç´„ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
          - å®Ÿè¡Œæ™‚é–“ï¼šå“è³ªé‡è¦–ï¼ˆæ™‚é–“ä¸å•ï¼‰ / 60åˆ†ä»¥å†… / 30åˆ†ä»¥å†…
          - MCPã‚µãƒ¼ãƒ“ã‚¹ï¼šç‰¹å®šã‚µãƒ¼ãƒ“ã‚¹å¸Œæœ› / æŽ¨å¥¨è¨­å®šã§OK
          å›žç­”ï¼šï¼ˆã“ã“ã«è©³ç´°ã‚’ãŠæ›¸ããã ã•ã„ï¼‰
          
          ---
          
          ### ðŸ“ å›žç­”å¾Œã®æ‰‹é †
          1. ä¸Šè¨˜ã®è³ªå•ã«å›žç­”ã‚’è¨˜å…¥
          2. ã“ã®Issueã®æœ¬æ–‡ã‚’ç·¨é›†ã—ã¦ã€å›žç­”éƒ¨åˆ†ã‚’è¿½åŠ 
          3. Issueä¿å­˜å¾Œã€è‡ªå‹•çš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã™
          
          ðŸ¤– *Generated by Dynamic Stepback Question System (Fallback)*
          EOF
            
            echo "questions_generated=true" >> $GITHUB_OUTPUT
            echo "question_count=3" >> $GITHUB_OUTPUT
          fi

      - name: Update Issue with Generated Questions
        id: update
        run: |
          echo "ðŸ“ Updating Issue #${{ github.event.issue.number }} with generated questions..."
          
          if [ ! -f ".meta/dynamic-questions/generated-questions.md" ]; then
            echo "âŒ Generated questions file not found"
            exit 1
          fi
          
          # ç¾åœ¨ã®Issueæœ¬æ–‡ã‚’å–å¾—
          CURRENT_BODY="${{ github.event.issue.body }}"
          
          # ç”Ÿæˆã•ã‚ŒãŸè³ªå•ã‚’èª­ã¿è¾¼ã¿
          GENERATED_QUESTIONS=$(cat .meta/dynamic-questions/generated-questions.md)
          
          # Issueæœ¬æ–‡ã®ã€Œè©³ç´°ç¢ºèªè³ªå•ï¼ˆè‡ªå‹•ç”Ÿæˆå¾…ã¡ï¼‰ã€éƒ¨åˆ†ã‚’ç½®æ›
          # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æŽ¢ã—ã¦ç½®æ›
          if echo "$CURRENT_BODY" | grep -q "è©³ç´°ç¢ºèªè³ªå•ï¼ˆè‡ªå‹•ç”Ÿæˆå¾…ã¡ï¼‰"; then
            echo "âœ… Found placeholder section - replacing with generated questions"
            
            # ç½®æ›å‡¦ç†ï¼ˆè¤‡é›‘ãªã®ã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼‰
            echo "$CURRENT_BODY" > .meta/dynamic-questions/current-body.md
            
            # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼éƒ¨åˆ†ã‚’ç½®æ›
            sed -i '/## ðŸ“‹ è©³ç´°ç¢ºèªè³ªå•ï¼ˆè‡ªå‹•ç”Ÿæˆå¾…ã¡ï¼‰/,/ðŸ”„ \*\*å‡¦ç†çŠ¶æ³:\*\*/c\
          '$GENERATED_QUESTIONS'' .meta/dynamic-questions/current-body.md
            
            UPDATED_BODY=$(cat .meta/dynamic-questions/current-body.md)
            
            # GitHub CLI ã§Issueæœ¬æ–‡ã‚’æ›´æ–°
            if command -v gh &> /dev/null; then
              echo "ðŸ“¤ Updating Issue body with generated questions..."
              
              # Issue body ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ›´æ–°
              echo "$UPDATED_BODY" > .meta/dynamic-questions/new-body.md
              
              if gh issue edit ${{ github.event.issue.number }} --body-file .meta/dynamic-questions/new-body.md 2>/dev/null; then
                echo "âœ… Issue #${{ github.event.issue.number }} updated successfully"
                
                # ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                gh issue edit ${{ github.event.issue.number }} \
                  --add-label "stepback-questions,awaiting-user-response,dynamic-generated" \
                  2>/dev/null || echo "âš ï¸ Failed to add labels"
                
                echo "issue_updated=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ Failed to update Issue body"
                echo "issue_updated=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ GitHub CLI not available"
              echo "issue_updated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Placeholder section not found in Issue body"
            echo "issue_updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Completion Comment
        if: steps.update.outputs.issue_updated == 'true'
        run: |
          echo "ðŸ’¬ Posting completion notification..."
          
          if command -v gh &> /dev/null; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "ðŸ¤– **AIåˆ†æžå®Œäº† - ã‚«ã‚¹ã‚¿ãƒ è³ªå•ã‚’ç”Ÿæˆã—ã¾ã—ãŸ**

          ã‚ãªãŸã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¦æ±‚ã‚’åˆ†æžã—ã€æœ€é©åŒ–ã®ãŸã‚ã«å¿…è¦ãªè©³ç´°ç¢ºèªè³ªå•ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚

          **ðŸ“Š ç”Ÿæˆçµæžœ:**
          - è³ªå•æ•°: ${{ steps.generate.outputs.question_count }}å€‹
          - åˆ†æžæ–¹å¼: å‹•çš„ã‚«ã‚¹ã‚¿ãƒ ç”Ÿæˆ
          - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: \`meta/prompts/stepback-question-generator.md\`

          **ðŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
          1. **Issueæœ¬æ–‡ã‚’ç¢ºèª** â†’ ç”Ÿæˆã•ã‚ŒãŸè³ªå•ã‚’ã”è¦§ãã ã•ã„
          2. **Issueæœ¬æ–‡ã‚’ç·¨é›†** â†’ ã€ŒEditã€ãƒœã‚¿ãƒ³ã§è³ªå•ã«å›žç­”
          3. **Issueä¿å­˜** â†’ è‡ªå‹•çš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”ŸæˆãŒé–‹å§‹ã•ã‚Œã¾ã™

          **â±ï¸ äºˆæƒ³æ™‚é–“:** è³ªå•å›žç­”å¾Œã€5-10åˆ†ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆå®Œäº†

          ---

          ðŸŽ¯ **é‡è¦:** è³ªå•ã«å›žç­”ã„ãŸã ãã¾ã§ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆã¯é–‹å§‹ã•ã‚Œã¾ã›ã‚“ã€‚
          ã‚ˆã‚Šè©³ç´°ãªå›žç­”ã»ã©ã€æœ€é©åŒ–ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

          ðŸ¤– *Dynamic Stepback Question Generator v4*" \
              2>/dev/null || echo "âš ï¸ Failed to post comment"
          fi
          
          echo "âœ… Dynamic stepback question generation completed"

      - name: Prevent Main Workflow Execution
        run: |
          echo "ðŸ›‘ Blocking main workflow execution until user response"
          
          # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒžãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
          mkdir -p .meta/workflow-control
          cat > .meta/workflow-control/waiting-for-stepback-response.json << EOF
          {
            "issue_number": ${{ github.event.issue.number }},
            "status": "waiting_for_user_response",
            "questions_generated": true,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "next_trigger": "issue_edited_with_answers"
          }
          EOF
          
          echo "ðŸ“‹ Main workflow execution blocked - waiting for user answers"