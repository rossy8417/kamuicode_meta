name: Test Claude Code Integration
run-name: ðŸ§ª Testing GitHub Actions â†” Claude Code Integration

on:
  workflow_dispatch:
    inputs:
      test_prompt:
        description: 'Test prompt for Claude Code'
        required: false
        default: 'Create a simple task analysis for video generation workflow'
      complexity_level:
        description: 'Complexity level (1-10)'
        required: false
        default: '5'

permissions:
  contents: write
  actions: read

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: GitHub ActionsåˆæœŸå‡¦ç†
  initial-analysis:
    runs-on: ubuntu-latest
    outputs:
      should_use_claude: ${{ steps.analyze.outputs.should_use_claude }}
      initial_data: ${{ steps.analyze.outputs.initial_data }}
      complexity_score: ${{ steps.analyze.outputs.complexity_score }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Initial Static Analysis
        id: analyze
        run: |
          echo "ðŸ” GitHub ActionsåˆæœŸåˆ†æžé–‹å§‹..."
          
          mkdir -p test-results/phase1
          
          # å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®åˆ†æž
          TEST_PROMPT="${{ inputs.test_prompt }}"
          COMPLEXITY="${{ inputs.complexity_level }}"
          
          echo "ðŸ“ Test Prompt: $TEST_PROMPT"
          echo "ðŸ“Š Complexity Level: $COMPLEXITY"
          
          # è¤‡é›‘åº¦ã«ã‚ˆã‚‹åˆ¤å®š
          if [ "$COMPLEXITY" -gt 3 ]; then
            echo "ðŸ§  è¤‡é›‘åº¦ãŒé«˜ã„ãŸã‚ã€Claude Codeåˆ†æžã‚’ä½¿ç”¨"
            echo "should_use_claude=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“‹ è¤‡é›‘åº¦ãŒä½Žã„ãŸã‚ã€é™çš„å‡¦ç†ã®ã¿ä½¿ç”¨"
            echo "should_use_claude=false" >> $GITHUB_OUTPUT
          fi
          
          # åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
          echo "# Initial Analysis Data" > test-results/phase1/initial-data.md
          echo "" >> test-results/phase1/initial-data.md
          echo "**Test Prompt**: $TEST_PROMPT" >> test-results/phase1/initial-data.md
          echo "**Complexity**: $COMPLEXITY/10" >> test-results/phase1/initial-data.md
          echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-results/phase1/initial-data.md
          echo "**GitHub Run ID**: ${{ github.run_id }}" >> test-results/phase1/initial-data.md
          
          echo "initial_data=test-results/phase1/initial-data.md" >> $GITHUB_OUTPUT
          echo "complexity_score=$COMPLEXITY" >> $GITHUB_OUTPUT
          
          echo "âœ… GitHub ActionsåˆæœŸåˆ†æžå®Œäº†"
          
      - name: Upload Initial Analysis
        uses: actions/upload-artifact@v4
        with:
          name: initial-analysis-${{ github.run_number }}
          path: test-results/phase1/
          retention-days: 1

  # Phase 2: Claude Codeåˆ†æžï¼ˆæ¡ä»¶ä»˜ãï¼‰
  claude-analysis:
    needs: initial-analysis
    runs-on: ubuntu-latest
    if: needs.initial-analysis.outputs.should_use_claude == 'true'
    outputs:
      claude_analysis_completed: ${{ steps.claude-result.outputs.completed }}
      claude_result_file: ${{ steps.claude-result.outputs.result_file }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Initial Analysis
        uses: actions/download-artifact@v4
        with:
          name: initial-analysis-${{ github.run_number }}
          path: test-results/phase1/
          
      - name: Prepare Claude Code Input
        run: |
          echo "ðŸŽ¯ Claude Codeå…¥åŠ›ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­..."
          
          mkdir -p test-results/phase2
          
          # Claude Codeç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
          cat > test-results/phase2/claude-prompt.md << 'EOF'
# Claude Code Integration Test

ã‚ãªãŸã¯GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§Claude Codeã¨ã®çµ±åˆã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

## å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
EOF
          cat test-results/phase1/initial-data.md >> test-results/phase2/claude-prompt.md
          
          cat >> test-results/phase2/claude-prompt.md << 'EOF'

## ã‚¿ã‚¹ã‚¯
ä»¥ä¸‹ã®è¦æ±‚ã«åŸºã¥ã„ã¦ã€è©³ç´°ãªã‚¿ã‚¹ã‚¯åˆ†æžã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

1. **å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®åˆ†æž**
2. **æŽ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆ¦ç•¥ã®ææ¡ˆ**
3. **å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¨MCPã‚µãƒ¼ãƒ“ã‚¹ã®ç‰¹å®š**
4. **å®Ÿè¡Œæ™‚é–“ã®è¦‹ç©ã‚‚ã‚Š**

## å‡ºåŠ›è¦æ±‚
çµæžœã‚’ä»¥ä¸‹ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„: `./claude-analysis-result.json`

```json
{
  "analysis_completed": true,
  "input_analysis": "å…¥åŠ›ã®åˆ†æžçµæžœ",
  "recommended_strategy": "æŽ¨å¥¨æˆ¦ç•¥",
  "required_tools": ["tool1", "tool2"],
  "mcp_services": ["service1", "service2"],
  "estimated_duration_minutes": 30,
  "complexity_assessment": "é«˜/ä¸­/ä½Ž",
  "additional_recommendations": "è¿½åŠ ã®æŽ¨å¥¨äº‹é …"
}
```

ã“ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚Šã€GitHub Actionsã¨Claude Codeã®çµ±åˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
EOF
          
          echo "âœ… Claude Codeå…¥åŠ›æº–å‚™å®Œäº†"
          
      - name: Execute Claude Code Analysis
        uses: anthropics/claude-code-base-action@beta
        env:
          CLAUDE_CODE_CI_MODE: "true"
          CLAUDE_CODE_AUTO_APPROVE_MCP: "true"
        with:
          prompt_file: "test-results/phase2/claude-prompt.md"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          max_turns: "10"
          allowed_tools: "Read,Write,Bash"
          
      - name: Process Claude Code Results
        id: claude-result
        run: |
          echo "ðŸ” Claude Codeçµæžœã®å‡¦ç†ä¸­..."
          
          if [ -f "./claude-analysis-result.json" ]; then
            echo "âœ… Claude Codeåˆ†æžçµæžœã‚’å–å¾—"
            
            # çµæžœã‚’test-resultsã«ç§»å‹•
            cp claude-analysis-result.json test-results/phase2/
            
            # çµæžœã®æ¤œè¨¼
            if jq empty test-results/phase2/claude-analysis-result.json 2>/dev/null; then
              echo "âœ… JSONå½¢å¼ãŒæ­£ã—ã„"
              
              STRATEGY=$(jq -r '.recommended_strategy' test-results/phase2/claude-analysis-result.json)
              DURATION=$(jq -r '.estimated_duration_minutes' test-results/phase2/claude-analysis-result.json)
              
              echo "ðŸ“‹ æŽ¨å¥¨æˆ¦ç•¥: $STRATEGY"
              echo "â±ï¸ æŽ¨å®šæ™‚é–“: $DURATION åˆ†"
              
              echo "completed=true" >> $GITHUB_OUTPUT
              echo "result_file=test-results/phase2/claude-analysis-result.json" >> $GITHUB_OUTPUT
            else
              echo "âŒ JSONå½¢å¼ãŒç„¡åŠ¹"
              echo "completed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Claude Codeåˆ†æžçµæžœãŒè¦‹ã¤ã‹ã‚‰ãªã„"
            echo "completed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Claude Analysis Results
        if: steps.claude-result.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: claude-analysis-${{ github.run_number }}
          path: test-results/phase2/
          retention-days: 1

  # Phase 3: GitHub Actionsæœ€çµ‚å‡¦ç†ï¼ˆè‡ªå‹•å¾©å¸°ï¼‰
  final-processing:
    needs: [initial-analysis, claude-analysis]
    runs-on: ubuntu-latest
    if: always()  # Claude Codeå¤±æ•—æ™‚ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.run_number }}"
          merge-multiple: true
          path: test-results/final/
          
      - name: Final Integration and Summary
        run: |
          echo "ðŸŽ¯ GitHub Actionsæœ€çµ‚å‡¦ç†ï¼ˆè‡ªå‹•å¾©å¸°å®Œäº†ï¼‰"
          
          mkdir -p test-results/summary
          
          # ã‚µãƒžãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          echo "# Claude Code Integration Test Summary" > test-results/summary/test-summary.md
          echo "" >> test-results/summary/test-summary.md
          echo "**Test Run**: ${{ github.run_id }}" >> test-results/summary/test-summary.md
          echo "**Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-results/summary/test-summary.md
          echo "" >> test-results/summary/test-summary.md
          
          # å„ãƒ•ã‚§ãƒ¼ã‚ºã®çµæžœã‚’ã¾ã¨ã‚
          echo "## Phase 1: GitHub ActionsåˆæœŸåˆ†æž" >> test-results/summary/test-summary.md
          echo "- âœ… å®Œäº†" >> test-results/summary/test-summary.md
          echo "- è¤‡é›‘åº¦: ${{ needs.initial-analysis.outputs.complexity_score }}/10" >> test-results/summary/test-summary.md
          echo "- Claude Codeä½¿ç”¨åˆ¤å®š: ${{ needs.initial-analysis.outputs.should_use_claude }}" >> test-results/summary/test-summary.md
          echo "" >> test-results/summary/test-summary.md
          
          echo "## Phase 2: Claude Codeåˆ†æž" >> test-results/summary/test-summary.md
          if [ "${{ needs.initial-analysis.outputs.should_use_claude }}" = "true" ]; then
            if [ "${{ needs.claude-analysis.outputs.claude_analysis_completed }}" = "true" ]; then
              echo "- âœ… å®Œäº†" >> test-results/summary/test-summary.md
              
              # Claude Codeçµæžœã®è©³ç´°ã‚’è¿½åŠ 
              if [ -f "test-results/final/claude-analysis-result.json" ]; then
                echo "- æŽ¨å¥¨æˆ¦ç•¥: $(jq -r '.recommended_strategy' test-results/final/claude-analysis-result.json)" >> test-results/summary/test-summary.md
                echo "- è¤‡é›‘åº¦è©•ä¾¡: $(jq -r '.complexity_assessment' test-results/final/claude-analysis-result.json)" >> test-results/summary/test-summary.md
                echo "- æŽ¨å®šæ™‚é–“: $(jq -r '.estimated_duration_minutes' test-results/final/claude-analysis-result.json)åˆ†" >> test-results/summary/test-summary.md
              fi
            else
              echo "- âŒ å¤±æ•—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰" >> test-results/summary/test-summary.md
            fi
          else
            echo "- â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆè¤‡é›‘åº¦ãŒä½Žã„ãŸã‚ï¼‰" >> test-results/summary/test-summary.md
          fi
          echo "" >> test-results/summary/test-summary.md
          
          echo "## Phase 3: GitHub Actionsæœ€çµ‚å‡¦ç†" >> test-results/summary/test-summary.md
          echo "- âœ… è‡ªå‹•å¾©å¸°å®Œäº†" >> test-results/summary/test-summary.md
          echo "- çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ" >> test-results/summary/test-summary.md
          echo "" >> test-results/summary/test-summary.md
          
          echo "## çµè«–" >> test-results/summary/test-summary.md
          echo "GitHub Actions â†” Claude Code ã®å¾€å¾©çµ±åˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚" >> test-results/summary/test-summary.md
          
          echo "ðŸ“‹ ãƒ†ã‚¹ãƒˆã‚µãƒžãƒªãƒ¼å®Œæˆ"
          cat test-results/summary/test-summary.md
          
      - name: Commit Test Results (Optional)
        run: |
          if [ -d "test-results" ]; then
            echo "ðŸ’¾ ãƒ†ã‚¹ãƒˆçµæžœã‚’ä¿å­˜ä¸­..."
            
            # çµæžœã‚’commitç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ•´ç†
            mkdir -p generated/test-results/claude-integration/
            cp -r test-results/* generated/test-results/claude-integration/
            
            echo "âœ… ãƒ†ã‚¹ãƒˆçµæžœã‚’ generated/test-results/claude-integration/ ã«ä¿å­˜"
          fi

  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆClaude Codeå¤±æ•—æ™‚ã®ä»£æ›¿ï¼‰
  fallback-processing:
    needs: initial-analysis
    runs-on: ubuntu-latest
    if: needs.initial-analysis.outputs.should_use_claude == 'false'
    
    steps:
      - name: Static Fallback Processing
        run: |
          echo "ðŸ“‹ é™çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Ÿè¡Œä¸­..."
          
          mkdir -p test-results/fallback
          
          # é™çš„ãªåˆ†æžçµæžœã‚’ç”Ÿæˆ
          cat > test-results/fallback/static-result.json << 'EOF'
{
  "analysis_completed": true,
  "method": "static_fallback",
  "input_analysis": "Static analysis based on complexity level",
  "recommended_strategy": "template-based-approach",
  "required_tools": ["basic-tools"],
  "mcp_services": [],
  "estimated_duration_minutes": 15,
  "complexity_assessment": "ä½Ž",
  "additional_recommendations": "Simple workflow recommended for low complexity tasks"
}
EOF
          
          echo "âœ… é™çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Œäº†"
          echo "ðŸ’¡ ã“ã®çµæžœã¯Claude Codeåˆ†æžãªã—ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"