name: "Meta Workflow Executor v11 with Domain Templates"
run-name: "üöÄ Meta Workflow v11 | Issue #${{ inputs.issue_number }} | ${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number for workflow generation request'
        required: true
        default: '60'

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  # ===========================================
  # PHASE 1: ISSUE VALIDATION & DOMAIN DETECTION
  # ===========================================
  
  validate-and-detect:
    name: "üîç Issue Validation & Domain Detection"
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.extract.outputs.issue_number }}
      issue_title: ${{ steps.extract.outputs.issue_title }}
      primary_domain: ${{ steps.detect.outputs.primary_domain }}
      detected_domains: ${{ steps.detect.outputs.detected_domains }}
      domain_count: ${{ steps.detect.outputs.domain_count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          pip install pyyaml
        
      - name: Extract Issue Information
        id: extract
        run: |
          echo "üîç Analyzing Issue #${{ inputs.issue_number }}..."
          
          # Get issue details using GitHub CLI
          ISSUE_DATA=$(gh issue view ${{ inputs.issue_number }} --json title,body,number --jq '{title: .title, body: .body, number: .number}')
          
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')
          ISSUE_NUMBER=$(echo "$ISSUE_DATA" | jq -r '.number')
          
          # Save to artifacts for next jobs
          mkdir -p artifacts
          echo "$ISSUE_TITLE" > artifacts/issue_title.txt
          echo "$ISSUE_BODY" > artifacts/issue_body.txt
          echo "$ISSUE_NUMBER" > artifacts/issue_number.txt
          
          # Combine title and body for domain detection
          echo -e "$ISSUE_TITLE\n\n$ISSUE_BODY" > artifacts/issue_content.txt
          
          # Output minimal data
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Issue #$ISSUE_NUMBER validated: $ISSUE_TITLE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Detect Domain from Issue
        id: detect
        run: |
          echo "üéØ Detecting domain from issue content..."
          
          python scripts/domain-template-loader.py \
            --action detect \
            --issue artifacts/issue_content.txt \
            --output artifacts/domain_detection.json
          
          # Extract results
          PRIMARY_DOMAIN=$(jq -r '.primary_domain' artifacts/domain_detection.json)
          DETECTED_DOMAINS=$(jq -c '.detected_domains' artifacts/domain_detection.json)
          DOMAIN_COUNT=$(jq '.detected_domains | length' artifacts/domain_detection.json)
          
          echo "primary_domain=$PRIMARY_DOMAIN" >> $GITHUB_OUTPUT
          echo "detected_domains=$DETECTED_DOMAINS" >> $GITHUB_OUTPUT
          echo "domain_count=$DOMAIN_COUNT" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Primary domain detected: $PRIMARY_DOMAIN"
          echo "üìä Total domains detected: $DOMAIN_COUNT"
          
      - name: Upload Issue and Domain Data
        uses: actions/upload-artifact@v4
        with:
          name: issue-domain-data
          path: artifacts/

  # ===========================================
  # PHASE 2: DOMAIN TEMPLATE LOADING
  # ===========================================
  
  load-domain-templates:
    name: "üìö Load Domain Templates"
    runs-on: ubuntu-latest
    needs: ['validate-and-detect']
    if: needs.validate-and-detect.outputs.primary_domain != 'null'
    outputs:
      template_summary: ${{ steps.load.outputs.template_summary }}
      chunk_count: ${{ steps.load.outputs.chunk_count }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          pip install pyyaml
          
      - name: Download Issue Data
        uses: actions/download-artifact@v4
        with:
          name: issue-domain-data
          path: artifacts/
          
      - name: Load Primary Domain Template
        id: load
        run: |
          PRIMARY_DOMAIN="${{ needs.validate-and-detect.outputs.primary_domain }}"
          echo "üìö Loading template for domain: $PRIMARY_DOMAIN"
          
          # Get domain summary
          python scripts/domain-template-loader.py \
            --action summary \
            --domain "$PRIMARY_DOMAIN" \
            --output artifacts/domain_summary.json
          
          # Split template into chunks
          python scripts/domain-template-loader.py \
            --action split \
            --domain "$PRIMARY_DOMAIN" \
            --output artifacts/template_chunks.json
          
          # Extract summary info
          TEMPLATE_SUMMARY=$(jq -c '.' artifacts/domain_summary.json)
          CHUNK_COUNT=$(jq '.total_chunks' artifacts/template_chunks.json)
          
          echo "template_summary=$TEMPLATE_SUMMARY" >> $GITHUB_OUTPUT
          echo "chunk_count=$CHUNK_COUNT" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Template loaded with $CHUNK_COUNT chunks"
          
      - name: Upload Template Data
        uses: actions/upload-artifact@v4
        with:
          name: domain-template-data
          path: artifacts/

  # ===========================================
  # PHASE 3: PROFESSIONAL TASK DECOMPOSITION
  # ===========================================
  
  professional-task-decomposition:
    name: "üß† Professional Task Decomposition"
    runs-on: ubuntu-latest
    needs: ['validate-and-detect', 'load-domain-templates']
    outputs:
      task_count: ${{ steps.decompose.outputs.task_count }}
      dependency_groups: ${{ steps.decompose.outputs.dependency_groups }}
      estimated_duration: ${{ steps.decompose.outputs.estimated_duration }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install Dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          pip install pyyaml
          
      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          
      - name: Professional Task Decomposition with Domain Knowledge
        id: decompose
        run: |
          echo "üß† Starting professional task decomposition..."
          
          # Load domain summary
          DOMAIN_SUMMARY=$(cat artifacts/domain-template-data/domain_summary.json)
          ISSUE_CONTENT=$(cat artifacts/issue-domain-data/issue_content.txt)
          
          # Create decomposition prompt with domain expertise
          cat > decomposition_prompt.txt << 'EOF'
          „ÅÇ„Å™„Åü„ÅØ${{ needs.validate-and-detect.outputs.primary_domain }}„Éâ„É°„Ç§„É≥„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ
          
          ‰ª•‰∏ã„ÅÆ„Éâ„É°„Ç§„É≥ÊÉÖÂ†±„ÇíÂü∫„Å´„ÄÅ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™Ë¶ñÁÇπ„Åß„Çø„Çπ„ÇØ„ÇíÂàÜËß£„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          „Éâ„É°„Ç§„É≥ÊÉÖÂ†±Ôºö
          ```json
          ${DOMAIN_SUMMARY}
          ```
          
          „É¶„Éº„Ç∂„Éº„ÅÆ„É™„ÇØ„Ç®„Çπ„ÉàÔºö
          ```
          ${ISSUE_CONTENT}
          ```
          
          ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß„Çø„Çπ„ÇØ„ÇíÂàÜËß£„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          1. Â∞ÇÈñÄÂÆ∂Ë¶ñÁÇπ„Åß„ÅÆË¶ÅÊ±ÇÂàÜÊûê
          2. ÂøÖË¶Å„Å™„Çø„Çπ„ÇØ„ÅÆÊ¥ó„ÅÑÂá∫„ÅóÔºà„Éó„É≠„ÅÆÂÆüÂãô„Éï„É≠„Éº„Å´Âü∫„Å•„ÅèÔºâ
          3. „Çø„Çπ„ÇØÈñì„ÅÆ‰æùÂ≠òÈñ¢‰øÇÔºà„Éá„Éº„Çø„Éï„É≠„Éº„Éô„Éº„ÇπÔºâ
          4. ‰∏¶ÂàóÂÆüË°åÂèØËÉΩ„Å™„Çø„Çπ„ÇØ„Ç∞„É´„Éº„Éó
          5. ÂêÑ„Çø„Çπ„ÇØ„ÅÆÊé®ÂÆöÊâÄË¶ÅÊôÇÈñì
          6. ‰ΩøÁî®„Åô„Çã„Éü„Éã„Éû„É´„É¶„Éã„ÉÉ„Éà
          7. Â∞ÇÈñÄÁöÑ„Å™Âà∂Á¥ÑÊù°‰ª∂„ÅÆËÄÉÊÖÆ
          
          Âá∫ÂäõÂΩ¢ÂºèÔºö
          ```json
          {
            "professional_analysis": "Â∞ÇÈñÄÂÆ∂Ë¶ñÁÇπ„Åß„ÅÆÂàÜÊûê",
            "tasks": [
              {
                "id": "task-1",
                "name": "„Çø„Çπ„ÇØÂêç",
                "description": "Ë©≥Á¥∞Ë™¨Êòé",
                "minimal_units": ["unit1", "unit2"],
                "dependencies": [],
                "estimated_duration": "5ÂàÜ",
                "professional_notes": "Â∞ÇÈñÄÁöÑ„Å™Ê≥®ÊÑèÁÇπ"
              }
            ],
            "dependency_groups": [
              {
                "group": 1,
                "parallel_tasks": ["task-1", "task-2"],
                "can_start": "immediately"
              }
            ],
            "total_estimated_duration": "30ÂàÜ",
            "domain_specific_constraints": []
          }
          ```
          EOF
          
          # Replace variables in prompt
          export DOMAIN_SUMMARY
          export ISSUE_CONTENT
          envsubst < decomposition_prompt.txt > final_prompt.txt
          
          # Execute Claude Code for task decomposition
          npx @anthropic-ai/claude-code \
            -p "$(cat final_prompt.txt)" \
            --allowedTools "Write" \
            --permission-mode "acceptEdits" \
            --outputFile "artifacts/professional_task_decomposition.json" \
            --autoApprove
          
          # Extract results
          if [ -f "artifacts/professional_task_decomposition.json" ]; then
            TASK_COUNT=$(jq '.tasks | length' artifacts/professional_task_decomposition.json)
            DEPENDENCY_GROUPS=$(jq -c '.dependency_groups' artifacts/professional_task_decomposition.json)
            ESTIMATED_DURATION=$(jq -r '.total_estimated_duration' artifacts/professional_task_decomposition.json)
            
            echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
            echo "dependency_groups=$DEPENDENCY_GROUPS" >> $GITHUB_OUTPUT
            echo "estimated_duration=$ESTIMATED_DURATION" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Decomposed into $TASK_COUNT tasks"
            echo "‚è±Ô∏è Estimated duration: $ESTIMATED_DURATION"
          else
            echo "‚ùå Task decomposition failed"
            exit 1
          fi
          
      - name: Upload Task Decomposition
        uses: actions/upload-artifact@v4
        with:
          name: task-decomposition
          path: artifacts/professional_task_decomposition.json

  # ===========================================
  # PHASE 4: CONSTRAINT-AWARE WORKFLOW GENERATION
  # ===========================================
  
  generate-professional-workflow:
    name: "‚ö° Generate Professional Workflow"
    runs-on: ubuntu-latest
    needs: ['validate-and-detect', 'load-domain-templates', 'professional-task-decomposition']
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      workflow_name: ${{ steps.generate.outputs.workflow_name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Environment
        run: |
          npm install -g @anthropic-ai/claude-code
          pip install pyyaml
          
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          
      - name: Generate Professional Workflow
        id: generate
        run: |
          echo "‚ö° Generating professional workflow..."
          
          # Prepare all necessary data
          ISSUE_NUMBER="${{ needs.validate-and-detect.outputs.issue_number }}"
          PRIMARY_DOMAIN="${{ needs.validate-and-detect.outputs.primary_domain }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Create generation directory
          PROJECT_DIR="projects/issue-${ISSUE_NUMBER}-${TIMESTAMP}"
          mkdir -p "$PROJECT_DIR/generated-workflow"
          
          # Load template chunks progressively
          CHUNKS=$(jq -r '.chunks[].id' artifacts/domain-template-data/template_chunks.json)
          
          # Create comprehensive generation prompt
          cat > generation_prompt.txt << 'EOF'
          „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™GitHub Actions„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          „Çø„Çπ„ÇØÂàÜËß£ÁµêÊûúÔºö
          ```json
          $(cat artifacts/task-decomposition/professional_task_decomposition.json)
          ```
          
          „Éâ„É°„Ç§„É≥: $PRIMARY_DOMAIN
          
          ÈáçË¶Å„Å™Âà∂Á¥Ñ:
          1. uses: „Åß„É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„ÇíÂèÇÁÖß„Åó„Å™„ÅÑ
          2. ÂÖ®„Å¶„ÅÆ„Éë„Çπ„ÅØ${{ needs.setup.outputs.project_dir }}„Çí‰ΩøÁî®
          3. MCP‰ΩøÁî®ÊôÇ„ÅØ--mcp-config„ÇíÂøÖ„ÅöÂê´„ÇÅ„Çã
          4. „Ç∏„Éß„ÉñÈñì„ÅÆ„Éï„Ç°„Ç§„É´ÂÖ±Êúâ„ÅØartifacts„Çí‰ΩøÁî®
          5. ÂêÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅØ21000ÊñáÂ≠ó‰ª•ÂÜÖ
          
          Â∞ÇÈñÄÁöÑ„Å™ÂìÅË≥™Âü∫Ê∫ñ„Å´Âæì„Å£„Å¶„ÄÅÂÆüÂãô„Åß‰Ωø„Åà„Çã„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          Âá∫Âäõ„Éï„Ç°„Ç§„É´: $PROJECT_DIR/generated-workflow/workflow.yml
          EOF
          
          # Execute workflow generation
          npx @anthropic-ai/claude-code \
            -p "$(cat generation_prompt.txt)" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Write,Read,MultiEdit" \
            --permission-mode "acceptEdits" \
            --autoApprove
          
          # Verify workflow was created
          WORKFLOW_PATH="$PROJECT_DIR/generated-workflow/workflow.yml"
          if [ -f "$WORKFLOW_PATH" ]; then
            WORKFLOW_NAME="professional-workflow-${PRIMARY_DOMAIN}-${TIMESTAMP}"
            
            echo "workflow_path=$WORKFLOW_PATH" >> $GITHUB_OUTPUT
            echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Workflow generated: $WORKFLOW_NAME"
          else
            echo "‚ùå Workflow generation failed"
            exit 1
          fi
          
      - name: Upload Generated Workflow
        uses: actions/upload-artifact@v4
        with:
          name: generated-workflow
          path: projects/

  # ===========================================
  # PHASE 5: VALIDATION & DEPLOYMENT
  # ===========================================
  
  validate-and-deploy:
    name: "‚úÖ Validate & Deploy"
    runs-on: ubuntu-latest
    needs: ['generate-professional-workflow']
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Download Generated Workflow
        uses: actions/download-artifact@v4
        with:
          name: generated-workflow
          path: projects/
          
      - name: Validate Workflow
        run: |
          echo "‚úÖ Validating generated workflow..."
          
          # Use workflow with inputs if available, otherwise use original
          if [ "${{ needs.generate-professional-inputs.outputs.inputs_generated }}" == "true" ]; then
            WORKFLOW_PATH="${{ needs.generate-professional-inputs.outputs.workflow_path_with_inputs }}"
          else
            WORKFLOW_PATH="${{ needs.generate-professional-workflow.outputs.workflow_path }}"
          fi
          
          # YAML syntax validation
          python -c "import yaml; yaml.safe_load(open('$WORKFLOW_PATH'))"
          echo "‚úÖ YAML syntax valid"
          
          # GitHub Actions structure validation
          if grep -q "^name:" "$WORKFLOW_PATH" && \
             grep -q "^on:" "$WORKFLOW_PATH" && \
             grep -q "^jobs:" "$WORKFLOW_PATH"; then
            echo "‚úÖ GitHub Actions structure valid"
          else
            echo "‚ùå Invalid GitHub Actions structure"
            exit 1
          fi
          
      - name: Deploy Workflow
        run: |
          echo "üöÄ Deploying workflow..."
          
          # Use workflow with inputs if available, otherwise use original
          if [ "${{ needs.generate-professional-inputs.outputs.inputs_generated }}" == "true" ]; then
            WORKFLOW_PATH="${{ needs.generate-professional-inputs.outputs.workflow_path_with_inputs }}"
          else
            WORKFLOW_PATH="${{ needs.generate-professional-workflow.outputs.workflow_path }}"
          fi
          WORKFLOW_NAME="${{ needs.generate-professional-workflow.outputs.workflow_name }}"
          
          # Deploy to generated workflows directory
          DEPLOY_PATH=".github/workflows/generated/${WORKFLOW_NAME}.yml"
          mkdir -p .github/workflows/generated
          cp "$WORKFLOW_PATH" "$DEPLOY_PATH"
          
          # Commit and push
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add "$DEPLOY_PATH"
          git commit -m "üöÄ Deploy professional workflow: $WORKFLOW_NAME
          
          Generated from Issue #${{ needs.validate-and-detect.outputs.issue_number }}
          Domain: ${{ needs.validate-and-detect.outputs.primary_domain }}
          
          This workflow includes professional domain expertise and constraints."
          
          git push
          
          echo "‚úÖ Workflow deployed to: $DEPLOY_PATH"
          
      - name: Update Issue
        run: |
          ISSUE_NUMBER="${{ needs.validate-and-detect.outputs.issue_number }}"
          WORKFLOW_NAME="${{ needs.generate-professional-workflow.outputs.workflow_name }}"
          DOMAIN="${{ needs.validate-and-detect.outputs.primary_domain }}"
          
          gh issue comment $ISSUE_NUMBER --body "## ‚úÖ Professional Workflow Generated!
          
          **Workflow Name**: \`$WORKFLOW_NAME\`
          **Domain**: $DOMAIN
          **Status**: Successfully deployed
          
          ### üìã Summary:
          - Applied professional domain expertise
          - Incorporated domain-specific constraints
          - Optimized task dependencies
          - Validated and deployed
          
          ### üöÄ Next Steps:
          1. Review the generated workflow
          2. Trigger manually if needed
          3. Monitor execution results
          
          ---
          *Generated by Meta Workflow v11 with Domain Templates*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}