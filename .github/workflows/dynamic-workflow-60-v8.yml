name: "ðŸŽ¯ Dynamic Workflow - Issue #60 (v5)"
run-name: "ðŸ“Š Dynamic v5 | rossy8417 | Issue #60"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Source issue number"
        required: true
        default: "60"
      branch_name:
        description: "Working branch name"
        required: false
        default: "issue-60"
      topic:
        description: "Topic for video generation"
        required: true
        default: "äº¬éƒ½ã®é£Ÿã¹ç‰©ãƒˆãƒ¬ãƒ³ãƒ‰"

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  setup:
    name: "ðŸš€ Setup"
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      timestamp: ${{ steps.setup.outputs.timestamp }} 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Project Structure
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="projects/issue-60-$TIMESTAMP"
          mkdir -p "$PROJECT_DIR"/{logs,metadata,temp,final,media}
          echo "project_dir=$PROJECT_DIR" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "âœ… Project structure created: $PROJECT_DIR"

  research_1:
    name: "ðŸ” Research: web-search"
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      completed: ${{ steps.execute.outputs.completed }}
      summary_path: ${{ steps.execute.outputs.summary_path }}
      sources_path: ${{ steps.execute.outputs.sources_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Create output directory
        run: mkdir -p ${{ needs.setup.outputs.project_dir }}/metadata
      
      - name: Execute Web Search
        id: execute
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          PROMPT="ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªã§Webæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          
          **æ¤œç´¢ã‚¯ã‚¨ãƒª**: ${{ inputs.topic }} æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ 2025å¹´
          **æœ€å¤§çµæžœæ•°**: 10
          **è¨€èªž**: japanese
          
          ã‚¿ã‚¹ã‚¯ï¼š
          1. WebSearchãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æœ€æ–°ã®æƒ…å ±ã‚’æ¤œç´¢
          2. ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è¦ç´„ã—ã¦æä¾›ã—ã¦ãã ã•ã„ã€‚
          3. æ¤œç´¢çµæžœã‚’ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼š
             - ${{ needs.setup.outputs.project_dir }}/metadata/search-summary.mdï¼ˆæ¤œç´¢çµæžœã®ã¾ã¨ã‚ï¼‰
             - ${{ needs.setup.outputs.project_dir }}/metadata/sources.txtï¼ˆå‚ç…§ã—ãŸURLã®ãƒªã‚¹ãƒˆï¼‰
             - ${{ needs.setup.outputs.project_dir }}/metadata/search-metadata.jsonï¼ˆæ¤œç´¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼šã‚¯ã‚¨ãƒªã€å®Ÿè¡Œæ—¥æ™‚ã€çµæžœæ•°ãªã©ï¼‰
          
          æ³¨æ„äº‹é …ï¼š
          - ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‚’å„ªå…ˆã—ã¦ãã ã•ã„
          - æœ€æ–°ã®æƒ…å ±ã‚’é‡è¦–ã—ã¦ãã ã•ã„
          - æ¤œç´¢è¨€èªžã«å¿œã˜ã¦é©åˆ‡ãªçµæžœã‚’é¸æŠžã—ã¦ãã ã•ã„
          - å®Ÿéš›ã®æ¤œç´¢çµæžœã§ã‚ã‚‹ã“ã¨ã‚’æ˜Žç¢ºã«ã™ã‚‹ãŸã‚ã€æ¤œç´¢æ—¥æ™‚ã¨ã‚½ãƒ¼ã‚¹URLã‚’å¿…ãšè¨˜è¼‰ã—ã¦ãã ã•ã„"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            -p "$PROMPT" \
            --allowedTools "WebSearch,Write" \
            --permission-mode "acceptEdits"
          
          # å‡ºåŠ›ã®ç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/search-summary.md" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "summary_path=${{ needs.setup.outputs.project_dir }}/metadata/search-summary.md" >> $GITHUB_OUTPUT
            echo "sources_path=${{ needs.setup.outputs.project_dir }}/metadata/sources.txt" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Web search failed - no summary file found"
            exit 1
          fi
      
      - name: Upload Research Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: research-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  planning_1:
    name: "ðŸ“‹ Planning: content-planning"
    runs-on: ubuntu-latest
    needs: [setup, research_1]
    outputs:
      completed: ${{ steps.execute.outputs.completed }}
      video_plan_path: ${{ steps.execute.outputs.video_plan_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code SDK
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Download Research Artifacts
        uses: actions/download-artifact@v4
        with:
          name: research-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: Create output directory
        run: mkdir -p ${{ needs.setup.outputs.project_dir }}/metadata
      
      - name: Execute Planning Agent
        id: execute
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ§‹ç¯‰
          PROMPT="ã‚ãªãŸã¯å‹•ç”»åˆ¶ä½œã®å°‚é–€ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚Webæ¤œç´¢çµæžœã‚’åŸºã«ã€å‹•ç”»ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          **æ¤œç´¢çµæžœ**: ${{ needs.setup.outputs.project_dir }}/metadata/search-summary.md ã‚’å‚ç…§
          **ãƒ†ãƒ¼ãƒž**: ${{ inputs.topic }}ã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ç´¹ä»‹å‹•ç”»
          **ç”Ÿæˆã™ã‚‹å‹•ç”»æ•°**: 1

          **ã‚¿ã‚¹ã‚¯**:
          1. æ¤œç´¢çµæžœã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æž
          2. ${{ inputs.topic }}ã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç´¹ä»‹ã™ã‚‹å‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä¼ç”»
          3. å‹•ç”»ç”¨ã®é«˜å“è³ªãªç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆï¼ˆè‹±èªžï¼‰
          4. ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿ã‚’ä½œæˆï¼ˆæ—¥æœ¬èªžã€30ç§’ç¨‹åº¦ï¼‰
          5. è¨ˆç”»æ›¸ã‚’ã€Œ${{ needs.setup.outputs.project_dir }}/metadata/video-plan.mdã€ã«ä¿å­˜
          6. ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š
             - ${{ needs.setup.outputs.project_dir }}/metadata/image-prompt-1.txtï¼ˆç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€è‹±èªžã€1è¡Œï¼‰
             - ${{ needs.setup.outputs.project_dir }}/metadata/video-concept-1.txtï¼ˆå‹•ç”»ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼‰
             - ${{ needs.setup.outputs.project_dir }}/metadata/narration-script-1.txtï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿ï¼‰

          **é‡è¦**: 
          - æ¤œç´¢çµæžœã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å¿…ãšåæ˜ ã•ã›ã‚‹
          - ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯è‹±èªžã§ä½œæˆ
          - ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯è‡ªç„¶ã§è¦ªã—ã¿ã‚„ã™ã„æ—¥æœ¬èªžã§
          - txtãƒ•ã‚¡ã‚¤ãƒ«ã¯æ©Ÿæ¢°å‡¦ç†ç”¨ï¼ˆé©åˆ‡ãªæ”¹è¡Œã§ï¼‰"
          
          # Claude Code CLIã®å®Ÿè¡Œ
          npx @anthropic-ai/claude-code \
            -p "$PROMPT" \
            --allowedTools "Read,Write,Edit" \
            --permission-mode "acceptEdits"
          
          # å‡ºåŠ›ã®ç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/video-plan.md" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "video_plan_path=${{ needs.setup.outputs.project_dir }}/metadata/video-plan.md" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Upload Planning Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: planning-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/

  image_generation:
    name: "ðŸŽ¨ image-generation"
    runs-on: ubuntu-latest
    needs: [setup, planning_1]
    outputs:
      completed: ${{ steps.generate.outputs.completed }}
      image_path: ${{ steps.generate.outputs.image_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Download Planning Artifacts
        uses: actions/download-artifact@v4
        with:
          name: planning-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: Generate Image
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/image-prompt-1.txt" ]; then
            IMAGE_PROMPT=$(cat "${{ needs.setup.outputs.project_dir }}/metadata/image-prompt-1.txt")
          else
            IMAGE_PROMPT="${{ inputs.topic }} trending food items, photorealistic, high quality"
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "${{ needs.setup.outputs.project_dir }}/media"
          
          # Claude Code CLIã§MCPçµŒç”±ã§ç”»åƒç”Ÿæˆ
          CLAUDE_PROMPT="Generate an image using t2i-google-imagen3 with the following requirements:
          
          **Prompt**: $IMAGE_PROMPT
          **Aspect Ratio**: 16:9
          **Quality**: high
          
          Steps:
          1. Use mcp__t2i-google-imagen3__imagen_t2i to start image generation
          2. Save the image URL to ${{ needs.setup.outputs.project_dir }}/media/image-url.txt
          3. Download the image to ${{ needs.setup.outputs.project_dir }}/media/image.png using curl
          
          Important: Make sure to wait for the generation to complete before downloading."
          
          npx @anthropic-ai/claude-code \
            -p "$CLAUDE_PROMPT" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,Bash,Write" \
            --permission-mode "acceptEdits"
          
          # çµæžœç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/media/image-url.txt" ]; then
            IMAGE_URL=$(cat "${{ needs.setup.outputs.project_dir }}/media/image-url.txt")
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "image_path=${{ needs.setup.outputs.project_dir }}/media/image.png" >> $GITHUB_OUTPUT
            echo "âœ… Image generated successfully"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Image generation failed"
            exit 1
          fi
      
      - name: Upload Image Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: image-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

  text_to_speech:
    name: "ðŸŽ¤ text-to-speech"
    runs-on: ubuntu-latest
    needs: [setup, planning_1]
    outputs:
      completed: ${{ steps.generate.outputs.completed }}
      audio_path: ${{ steps.generate.outputs.audio_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Download Planning Artifacts
        uses: actions/download-artifact@v4
        with:
          name: planning-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: Generate Speech
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          # ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŽŸç¨¿ã‚’èª­ã¿è¾¼ã‚€
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/narration-script-1.txt" ]; then
            NARRATION_TEXT=$(cat "${{ needs.setup.outputs.project_dir }}/metadata/narration-script-1.txt")
          else
            NARRATION_TEXT="${{ inputs.topic }}ã®æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚"
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "${{ needs.setup.outputs.project_dir }}/media"
          
          # Claude Code CLIã§MCPçµŒç”±ã§éŸ³å£°ç”Ÿæˆ
          CLAUDE_PROMPT="Generate narration audio using Text-to-Speech:
          
          **Text**: $NARRATION_TEXT
          **Voice**: Professional Japanese female voice (Wise_Woman or similar)
          **Language**: Japanese
          
          Steps:
          1. Use mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_submit to generate speech
          2. Monitor status with mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_status
          3. Get result with mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_result
          4. Save the audio URL to ${{ needs.setup.outputs.project_dir }}/media/narration-url.txt
          5. Download the audio to ${{ needs.setup.outputs.project_dir }}/media/narration.mp3 using curl
          
          Make sure to wait for generation to complete before downloading."
          
          npx @anthropic-ai/claude-code \
            -p "$CLAUDE_PROMPT" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_submit,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_status,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_result,Bash,Write" \
            --permission-mode "acceptEdits"
          
          # çµæžœç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/media/narration.mp3" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "audio_path=${{ needs.setup.outputs.project_dir }}/media/narration.mp3" >> $GITHUB_OUTPUT
            echo "âœ… Audio generated successfully"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Audio generation failed"
            exit 1
          fi
      
      - name: Upload Audio Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audio-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

  video_generation:
    name: "ðŸŽ¬ video-generation"
    runs-on: ubuntu-latest
    needs: [setup, planning_1, image_generation]
    outputs:
      completed: ${{ steps.generate.outputs.completed }}
      video_path: ${{ steps.generate.outputs.video_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Download Planning Artifacts
        uses: actions/download-artifact@v4
        with:
          name: planning-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/metadata/
      
      - name: Download Image Artifacts
        uses: actions/download-artifact@v4
        with:
          name: image-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/
      
      - name: Generate Video
        id: generate
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          # ãƒ“ãƒ‡ã‚ªã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
          if [ -f "${{ needs.setup.outputs.project_dir }}/metadata/video-concept-1.txt" ]; then
            VIDEO_CONCEPT=$(cat "${{ needs.setup.outputs.project_dir }}/metadata/video-concept-1.txt")
          else
            VIDEO_CONCEPT="${{ inputs.topic }} trending showcase with dynamic camera movements"
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "${{ needs.setup.outputs.project_dir }}/media"
          
          # ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ç¢ºèª
          IMAGE_PATH="${{ needs.setup.outputs.project_dir }}/media/image.png"
          if [ ! -f "$IMAGE_PATH" ]; then
            echo "âŒ Image not found at $IMAGE_PATH"
            echo "Files in media directory:"
            ls -la "${{ needs.setup.outputs.project_dir }}/media/"
            exit 1
          fi
          
          # ç”»åƒURLã‚’èª­ã¿è¾¼ã‚€
          IMAGE_URL=""
          if [ -f "${{ needs.setup.outputs.project_dir }}/media/image-url.txt" ]; then
            IMAGE_URL=$(cat "${{ needs.setup.outputs.project_dir }}/media/image-url.txt")
            echo "âœ… Image URL found: $IMAGE_URL"
          else
            echo "âŒ Image URL file not found"
            exit 1
          fi
          
          # Claude Code CLIã§MCPçµŒç”±ã§ç”»åƒã‹ã‚‰å‹•ç”»ç”Ÿæˆï¼ˆi2vï¼‰
          CLAUDE_PROMPT="Generate a video from the image using i2v-fal-hailuo-02-pro:
          
          **Image URL**: $IMAGE_URL
          **Motion Prompt**: $VIDEO_CONCEPT
          
          Steps:
          1. Use mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit with:
             - image_url: $IMAGE_URL
             - prompt: $VIDEO_CONCEPT
          2. Monitor status with mcp__i2v-fal-hailuo-02-pro__hailuo_02_status
          3. Get result with mcp__i2v-fal-hailuo-02-pro__hailuo_02_result
          4. Save video URL to ${{ needs.setup.outputs.project_dir }}/media/video-url.txt
          5. Download the video file to ${{ needs.setup.outputs.project_dir }}/media/
          6. After download, rename the file to video.mp4 if needed:
             - Use 'mv' command to rename any downloaded video file to video.mp4
             - Example: mv *.mp4 video.mp4
          
          IMPORTANT: The final video MUST be named video.mp4 in the media directory."
          
          npx @anthropic-ai/claude-code \
            -p "$CLAUDE_PROMPT" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,Bash,Write" \
            --permission-mode "acceptEdits"
          
          # çµæžœç¢ºèªã¨ãƒ•ã‚¡ã‚¤ãƒ«åä¿®æ­£
          cd "${{ needs.setup.outputs.project_dir }}/media"
          
          # video.mp4ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ä»–ã®mp4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ 
          if [ ! -f "video.mp4" ]; then
            # æœ€åˆã«è¦‹ã¤ã‹ã£ãŸmp4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’video.mp4ã«ãƒªãƒãƒ¼ãƒ 
            for file in *.mp4; do
              if [ -f "$file" ] && [ "$file" != "video.mp4" ]; then
                mv "$file" "video.mp4"
                echo "âœ… Renamed $file to video.mp4"
                break
              fi
            done
          fi
          
          # æœ€çµ‚ç¢ºèª
          if [ -f "video.mp4" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "video_path=${{ needs.setup.outputs.project_dir }}/media/video.mp4" >> $GITHUB_OUTPUT
            echo "âœ… Video generated successfully"
            ls -la video.mp4
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Video generation failed - no video.mp4 found"
            echo "Files in media directory:"
            ls -la
            exit 1
          fi
      
      - name: Upload Video Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: video-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/

  post_production:
    name: "ðŸŽžï¸ Post Production"
    runs-on: ubuntu-latest
    needs: [setup, text_to_speech, video_generation]
    outputs:
      completed: ${{ steps.lipsync.outputs.completed }}
      final_video_path: ${{ steps.lipsync.outputs.final_video_path }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Claude Code
        run: |
          npm init -y
          npm install @anthropic-ai/claude-code
      
      - name: Download Audio Artifacts
        uses: actions/download-artifact@v4
        with:
          name: audio-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/
      
      - name: Download Video Artifacts
        uses: actions/download-artifact@v4
        with:
          name: video-artifacts
          path: ${{ needs.setup.outputs.project_dir }}/media/
      
      - name: Apply Lipsync
        id: lipsync
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_CI_MODE: true
          CLAUDE_CODE_AUTO_APPROVE_MCP: true
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p "${{ needs.setup.outputs.project_dir }}/final"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "Checking downloaded files..."
          ls -la "${{ needs.setup.outputs.project_dir }}/media/"
          
          # Claude Code CLIã§MCPçµŒç”±ã§ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯
          CLAUDE_PROMPT="Apply lipsync to video:
          
          **Video Path**: ${{ needs.setup.outputs.project_dir }}/media/video.mp4
          **Audio Path**: ${{ needs.setup.outputs.project_dir }}/media/narration.mp3
          
          Steps:
          1. Upload files and use mcp__v2v-fal-creatify-lipsync__lipsync_submit
          2. Monitor status with mcp__v2v-fal-creatify-lipsync__lipsync_status
          3. Get result with mcp__v2v-fal-creatify-lipsync__lipsync_result
          4. Download the final video to ${{ needs.setup.outputs.project_dir }}/final/final-video.mp4
          
          IMPORTANT: Ensure the output video includes the audio track."
          
          npx @anthropic-ai/claude-code \
            -p "$CLAUDE_PROMPT" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__v2v-fal-creatify-lipsync__lipsync_submit,mcp__v2v-fal-creatify-lipsync__lipsync_status,mcp__v2v-fal-creatify-lipsync__lipsync_result,Bash,Write" \
            --permission-mode "acceptEdits"
          
          # çµæžœç¢ºèª
          if [ -f "${{ needs.setup.outputs.project_dir }}/final/final-video.mp4" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "final_video_path=${{ needs.setup.outputs.project_dir }}/final/final-video.mp4" >> $GITHUB_OUTPUT
            echo "âœ… Final video created successfully"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "âŒ Lipsync failed"
            exit 1
          fi
      
      - name: Upload Final Video
        uses: actions/upload-artifact@v4
        with:
          name: final-video
          path: ${{ needs.setup.outputs.project_dir }}/final/

  summary:
    name: "ðŸ“Š Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [setup, research_1, planning_1, image_generation, text_to_speech, video_generation, post_production]
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ¯ Workflow Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Issue**: #${{ github.event.inputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Topic**: ${{ inputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: ${{ needs.setup.outputs.project_dir }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generated Assets" >> $GITHUB_STEP_SUMMARY
          echo "- **Final Video**: ${{ needs.post_production.outputs.final_video_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.image_generation.outputs.image_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Audio**: ${{ needs.text_to_speech.outputs.audio_path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Raw Video**: ${{ needs.video_generation.outputs.video_path }}" >> $GITHUB_STEP_SUMMARY