name: Meta Workflow Executor v7
run-name: ðŸš€ Executing 3-approach meta workflow for Issue #${{ github.event.issue.number }}

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: å›žç­”å‡¦ç†ãƒ»åˆ†æž
  validate-comment-trigger:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'start')
    outputs:
      should_execute: ${{ steps.validate.outputs.should_execute }}
      issue_author: ${{ steps.validate.outputs.issue_author }}
      comment_author: ${{ steps.validate.outputs.comment_author }}
    
    steps:
      - name: Validate Start Comment Trigger
        id: validate
        run: |
          echo "ðŸ” Validating start comment trigger..."
          
          COMMENT_USER="${{ github.event.comment.user.login }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          echo "ðŸ“‹ Validation Info:"
          echo "   - Comment by: $COMMENT_USER"
          echo "   - Issue author: $ISSUE_AUTHOR"
          echo "   - Comment starts with 'start': $(echo "$COMMENT_BODY" | grep -q '^start' && echo 'YES' || echo 'NO')"
          
          # Issueä½œæˆè€…æœ¬äººã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯
          if [ "$COMMENT_USER" = "$ISSUE_AUTHOR" ] && echo "$COMMENT_BODY" | grep -q '^start'; then
            echo "âœ… Valid start trigger from Issue author"
            echo "should_execute=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Invalid trigger - must be Issue author with 'start' comment"
            echo "should_execute=false" >> $GITHUB_OUTPUT
          fi
          
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_author=$COMMENT_USER" >> $GITHUB_OUTPUT

  extract-stepback-answers:
    needs: validate-comment-trigger
    runs-on: ubuntu-latest
    if: needs.validate-comment-trigger.outputs.should_execute == 'true'
    outputs:
      answers_extracted: ${{ steps.extract.outputs.answers_extracted }}
      stepback_answers: ${{ steps.extract.outputs.stepback_answers }}
      workflow_type: ${{ steps.extract.outputs.workflow_type }}
    
    steps:
      - name: Extract Stepback Answers from Issue
        id: extract
        run: |
          echo "ðŸ“ Extracting stepback answers from Issue #${{ github.event.issue.number }}..."
          
          mkdir -p .meta/stepback-analysis
          
          # Issueæœ¬æ–‡ã‚’å®‰å…¨ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          cat > .meta/stepback-analysis/issue-body.txt << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
          ISSUE_BODY=$(cat .meta/stepback-analysis/issue-body.txt)
          
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—ã®æŽ¨æ¸¬ï¼ˆå…¨examplesã‚¿ã‚¤ãƒ—ã«å¯¾å¿œï¼‰
          if echo "$ISSUE_BODY" | grep -qi "video\|å‹•ç”»\|æ˜ åƒ\|youtube\|ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³"; then
            WORKFLOW_TYPE="video-generation"
          elif echo "$ISSUE_BODY" | grep -qi "3d\|model\|ãƒ¢ãƒ‡ãƒ«\|ç«‹ä½“"; then
            WORKFLOW_TYPE="3d-model-creation"
          elif echo "$ISSUE_BODY" | grep -qi "image\|ç”»åƒ\|ã‚¤ãƒ©ã‚¹ãƒˆ\|å†™çœŸ"; then
            WORKFLOW_TYPE="image-generation"
          elif echo "$ISSUE_BODY" | grep -qi "audio\|music\|éŸ³æ¥½\|éŸ³å£°\|bgm"; then
            WORKFLOW_TYPE="audio-generation"
          elif echo "$ISSUE_BODY" | grep -qi "presentation\|slide\|ãƒ—ãƒ¬ã‚¼ãƒ³\|ã‚¹ãƒ©ã‚¤ãƒ‰\|è³‡æ–™"; then
            WORKFLOW_TYPE="presentation-creation"
          elif echo "$ISSUE_BODY" | grep -qi "data\|analysis\|åˆ†æž\|ãƒ¬ãƒãƒ¼ãƒˆ\|çµ±è¨ˆ\|ã‚°ãƒ©ãƒ•"; then
            WORKFLOW_TYPE="data-analysis"
          elif echo "$ISSUE_BODY" | grep -qi "news\|ãƒ‹ãƒ¥ãƒ¼ã‚¹\|è¨˜äº‹\|è¦ç´„\|ã¾ã¨ã‚"; then
            WORKFLOW_TYPE="news-summarization"
          elif echo "$ISSUE_BODY" | grep -qi "blog\|article\|ãƒ–ãƒ­ã‚°\|åŸ·ç­†\|ã‚³ãƒ³ãƒ†ãƒ³ãƒ„"; then
            WORKFLOW_TYPE="blog-creation"
          elif echo "$ISSUE_BODY" | grep -qi "campaign\|ad\|åºƒå‘Š\|ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³\|ãƒžãƒ«ãƒãƒ¡ãƒ‡ã‚£ã‚¢"; then
            WORKFLOW_TYPE="multimedia-campaign"
          else
            WORKFLOW_TYPE="custom"
          fi
          
          # å›žç­”ã‚’æŠ½å‡ºï¼ˆæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒãƒ³ã‚°ï¼‰
          STEPBACK_ANSWERS=""
          
          # æ§˜ã€…ãªå›žç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
          # ãƒ‘ã‚¿ãƒ¼ãƒ³1: **å›žç­”ï¼š** ã¾ãŸã¯ **å›žç­”:** 
          # ãƒ‘ã‚¿ãƒ¼ãƒ³2: å›žç­”ï¼š ã¾ãŸã¯ å›žç­”:
          # ãƒ‘ã‚¿ãƒ¼ãƒ³3: A: ã¾ãŸã¯ Answer: 
          # ãƒ‘ã‚¿ãƒ¼ãƒ³4: Q1å›žç­”ã€Q2å›žç­” ãªã©
          
          # å„è³ªå•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          ANSWER_COUNT=0
          
          # Q1ã®å›žç­”ã‚’æŠ½å‡º
          Q1_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q1.*æ§‹é€ .*ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£/,/Q2.*å“è³ª.*ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹/p' | grep -A10 -E "å›žç­”ï¼š|å›žç­”:|Answer:|A:" | grep -v "Q2" | grep -v "ã“ã“ã«è©³ç´°" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q1_ANSWER" ] && [ ${#Q1_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q1å›žç­”:** $Q1_ANSWER\n\n"
          fi
          
          # Q2ã®å›žç­”ã‚’æŠ½å‡º
          Q2_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q2.*å“è³ª.*ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹/,/Q3.*ã‚¨ãƒ©ãƒ¼å‡¦ç†/p' | grep -A10 -E "å›žç­”ï¼š|å›žç­”:|Answer:|A:" | grep -v "Q3" | grep -v "ã“ã“ã«è©³ç´°" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q2_ANSWER" ] && [ ${#Q2_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q2å›žç­”:** $Q2_ANSWER\n\n"
          fi
          
          # Q3ã®å›žç­”ã‚’æŠ½å‡º
          Q3_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q3.*ã‚¨ãƒ©ãƒ¼å‡¦ç†/,/Q4.*å‡ºåŠ›.*ä¿å­˜/p' | grep -A10 -E "å›žç­”ï¼š|å›žç­”:|Answer:|A:" | grep -v "Q4" | grep -v "ã“ã“ã«è©³ç´°" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q3_ANSWER" ] && [ ${#Q3_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q3å›žç­”:** $Q3_ANSWER\n\n"
          fi
          
          # Q4ã®å›žç­”ã‚’æŠ½å‡º
          Q4_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q4.*å‡ºåŠ›.*ä¿å­˜/,/Q5.*æ‹¡å¼µæ€§/p' | grep -A10 -E "å›žç­”ï¼š|å›žç­”:|Answer:|A:" | grep -v "Q5" | grep -v "ã“ã“ã«è©³ç´°" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q4_ANSWER" ] && [ ${#Q4_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q4å›žç­”:** $Q4_ANSWER\n\n"
          fi
          
          # Q5ã®å›žç­”ã‚’æŠ½å‡º  
          Q5_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q5.*æ‹¡å¼µæ€§/,/---/p' | grep -A10 -E "å›žç­”ï¼š|å›žç­”:|Answer:|A:" | grep -v "---" | grep -v "ã“ã“ã«è©³ç´°" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q5_ANSWER" ] && [ ${#Q5_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q5å›žç­”:** $Q5_ANSWER\n\n"
          fi
          
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ˆã‚Šè‡ªç”±ãªå½¢å¼ã§ã®å›žç­”æŠ½å‡º
          if [ $ANSWER_COUNT -eq 0 ]; then
            echo "ðŸ”„ Using fallback extraction for flexible input formats..."
            
            # ä»»æ„ã®å½¢å¼ã§æ›¸ã‹ã‚ŒãŸå›žç­”ã‚’æŠ½å‡º
            FLEXIBLE_ANSWERS=$(echo "$ISSUE_BODY" | grep -A3 -B1 -E "T2I|I2V|è¤‡åˆå‡¦ç†|æœ€é«˜å“è³ª|ä¸¦åˆ—å‡¦ç†|ã‚¨ãƒ©ãƒ¼|å³åº§åœæ­¢|URL|ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼|å˜ç‹¬å®Œçµ|è©³ç´°ç›£è¦–" | grep -v "Q[1-5]:" | head -10 | tr '\n' ' ')
            
            if [ -n "$FLEXIBLE_ANSWERS" ] && [ ${#FLEXIBLE_ANSWERS} -gt 50 ]; then
              ANSWER_COUNT=1
              STEPBACK_ANSWERS="**æŸ”è»ŸæŠ½å‡ºå›žç­”:** $FLEXIBLE_ANSWERS\n\n"
              echo "âœ… Flexible extraction successful: ${#FLEXIBLE_ANSWERS} characters found"
            fi
          fi
          
          echo "ðŸ“Š Analysis Results:"
          echo "   - Workflow Type: $WORKFLOW_TYPE"
          echo "   - Stepback Answers Length: ${#STEPBACK_ANSWERS}"
          echo "   - Answers Found: $ANSWER_COUNT"
          
          if [ ${#STEPBACK_ANSWERS} -gt 50 ]; then
            echo "âœ… Sufficient stepback answers found - proceeding with workflow generation"
            
            # åˆ†æžçµæžœã‚’ä¿å­˜
            cat > .meta/stepback-analysis/analysis-result.md << EOF
          # Stepback Answer Analysis Result
          
          ## Original Request
          $(echo "$ISSUE_BODY" | head -20)
          
          ## Stepback Answers
          $STEPBACK_ANSWERS
          
          ## Metadata
          - Workflow Type: $WORKFLOW_TYPE
          - Issue Number: ${{ github.event.issue.number }}
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Answer Count: $ANSWER_COUNT
          EOF
            
            echo "answers_extracted=true" >> $GITHUB_OUTPUT
            echo "stepback_answers<<EOF" >> $GITHUB_OUTPUT
            echo -e "$STEPBACK_ANSWERS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT
          else
            echo "âŒ Insufficient stepback answers found"
            echo "answers_extracted=false" >> $GITHUB_OUTPUT
          fi

  analyze-requirements:
    needs: extract-stepback-answers
    runs-on: ubuntu-latest
    if: needs.extract-stepback-answers.outputs.answers_extracted == 'true'
    outputs:
      clarity_score: ${{ steps.analyze.outputs.clarity_score }}
      enhanced_request: ${{ steps.analyze.outputs.enhanced_request }}
      analysis_ready: ${{ steps.analyze.outputs.analysis_ready }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Analyze Requirements with Stepback Integration
        id: analyze
        run: |
          echo "ðŸ” Analyzing requirements with stepback answers integration..."
          
          mkdir -p .meta/requirement-analysis
          
          # ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒƒã‚¯å›žç­”ã‚’çµ±åˆã—ãŸè¦æ±‚åˆ†æž
          cat > .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          # Enhanced Requirement Analysis with Stepback Answers
          
          ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒƒã‚¯è³ªå•å›žç­”ã‚’åˆ†æžã—ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆã®ãŸã‚ã®è©³ç´°è¦æ±‚ã‚’æ•´ç†ã—ã¦ãã ã•ã„ã€‚
          
          ## Stepback Answers
          EOF
          
          echo "${{ needs.extract-stepback-answers.outputs.stepback_answers }}" >> .meta/requirement-analysis/analysis-prompt.md
          
          cat >> .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          
          ## åˆ†æžæŒ‡ç¤º
          
          ä¸Šè¨˜ã®å›žç­”ã‹ã‚‰ä»¥ä¸‹ã‚’æŠ½å‡ºãƒ»åˆ†æžã—ã¦ãã ã•ã„ï¼š
          
          1. **æ˜Žç¢ºåº¦ã‚¹ã‚³ã‚¢**: è¦æ±‚ã®æ˜Žç¢ºåº¦ã‚’1-10ã§è©•ä¾¡
          2. **æŠ€è¡“ä»•æ§˜**: å“è³ªè¨­å®šã€å½¢å¼ã€å‡¦ç†é †åºã®è¦æ±‚
          3. **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä»•æ§˜**: ã‚¹ã‚¿ã‚¤ãƒ«ã€é•·ã•ã€ã‚¸ãƒ£ãƒ³ãƒ«ã®è¦æ±‚
          4. **çµ±åˆè¦æ±‚**: å‡ºåŠ›é–“ã®é€£æºæ–¹æ³•ã€æœ€çµ‚æˆæžœç‰©
          5. **åˆ¶ç´„æ¡ä»¶**: æ™‚é–“ã€ãƒªã‚½ãƒ¼ã‚¹ã€æŠ€è¡“çš„åˆ¶ç´„
          
          ## å¿…é ˆå‡ºåŠ›
          
          ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          ```bash
          mkdir -p .meta/requirement-analysis
          cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
          {
            "clarity_score": 1-10,
            "workflow_type": "æŽ¨æ¸¬ã•ã‚Œã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—",
            "quality_requirements": {
              "image_resolution": "è¦æ±‚ã•ã‚Œã‚‹è§£åƒåº¦",
              "video_quality": "è¦æ±‚ã•ã‚Œã‚‹å‹•ç”»å“è³ª",
              "audio_quality": "è¦æ±‚ã•ã‚Œã‚‹éŸ³å£°å“è³ª"
            },
            "content_specifications": {
              "style": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¿ã‚¤ãƒ«",
              "duration": "å‹•ç”»ã‚„éŸ³å£°ã®é•·ã•",
              "genre": "ã‚¸ãƒ£ãƒ³ãƒ«ã‚„ãƒ†ãƒ¼ãƒž"
            },
            "processing_requirements": {
              "sequence": "å‡¦ç†é †åºã®è¦æ±‚",
              "parallel_processing": "ä¸¦åˆ—å‡¦ç†ã®å¯å¦",
              "integration_method": "çµ±åˆæ–¹æ³•"
            },
            "constraints": {
              "time_limit": "æ™‚é–“åˆ¶ç´„",
              "resource_limit": "ãƒªã‚½ãƒ¼ã‚¹åˆ¶ç´„"
            }
          }
          EOFJSON
          ```
          
          é‡è¦: å¿…ãšä¸Šè¨˜ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          EOF
          
          # Claude Code ã§è¦æ±‚åˆ†æžå®Ÿè¡Œ
          echo "ðŸ§  Executing Claude Code requirement analysis..."
          
          # Claude Codeå®Ÿè¡Œå‰ã«å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºå®Ÿã«ä½œæˆ
          mkdir -p .meta/requirement-analysis
          
          # Claude Codeã«ã‚ˆã‚Šè©³ç´°ãªæŒ‡ç¤ºã‚’è¿½åŠ 
          cat >> .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          
          ## CRITICAL: File Creation Instructions
          
          This task MUST create the JSON file `.meta/requirement-analysis/enhanced-requirements.json` in the current working directory.
          
          Please use the Write tool to create this file with the following structure:
          
          ```json
          {
            "clarity_score": <number 1-10>,
            "workflow_type": "<inferred workflow type>",
            "quality_requirements": {
              "image_resolution": "<requested resolution>",
              "video_quality": "<requested video quality>",
              "audio_quality": "<requested audio quality>"
            },
            "content_specifications": {
              "style": "<content style>",
              "duration": "<video/audio duration>",
              "genre": "<genre or theme>"
            },
            "processing_requirements": {
              "sequence": "<processing order requirements>",
              "parallel_processing": "<parallel processing capability>",
              "integration_method": "<integration method>"
            },
            "constraints": {
              "time_limit": "<time constraints>",
              "resource_limit": "<resource constraints>"
            }
          }
          ```
          
          YOU MUST create this file using the Write tool. This is mandatory for the workflow to continue.
          EOF
          
          if claude --continue "$(cat .meta/requirement-analysis/analysis-prompt.md)" --output-format text; then
            echo "âœ… Claude Code requirement analysis completed"
            
            # JSON ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆè¤‡æ•°ã®å ´æ‰€ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
            if [ -f ".meta/requirement-analysis/enhanced-requirements.json" ]; then
              echo "âœ… Enhanced requirements file found in expected location"
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
            elif [ -f "enhanced-requirements.json" ]; then
              echo "âš ï¸ Enhanced requirements file found in current directory, moving to expected location"
              mv "enhanced-requirements.json" ".meta/requirement-analysis/enhanced-requirements.json"
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
            else
              echo "âŒ Enhanced requirements file not found, creating dynamic fallback"
              # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‹•çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ JSON ã‚’ä½œæˆ
              WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
              
              # å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ JSON ç”Ÿæˆ (echoç‰ˆã§YAMLæ§‹æ–‡å®‰å…¨)
              case "$WORKFLOW_TYPE" in
                "video-generation")
                  echo '{"clarity_score":8,"workflow_type":"video-generation","quality_requirements":{"image_resolution":"1920x1080","video_quality":"high","audio_quality":"standard"},"content_specifications":{"style":"photorealistic","duration":"10-15 seconds","genre":"general"},"processing_requirements":{"sequence":"T2Iâ†’I2Vâ†’T2Mâ†’integration","parallel_processing":"partial","integration_method":"composite"},"constraints":{"time_limit":"60 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "3d-model-creation")
                  echo '{"clarity_score":8,"workflow_type":"3d-model-creation","quality_requirements":{"image_resolution":"1920x1080","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"realistic","duration":"none","genre":"3d-model"},"processing_requirements":{"sequence":"T2Iâ†’I2I3Dâ†’optimizationâ†’output","parallel_processing":"none","integration_method":"3d-pipeline"},"constraints":{"time_limit":"30 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "image-generation")
                  echo '{"clarity_score":8,"workflow_type":"image-generation","quality_requirements":{"image_resolution":"1920x1080","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"photorealistic","duration":"none","genre":"general"},"processing_requirements":{"sequence":"T2Iâ†’processingâ†’output","parallel_processing":"none","integration_method":"single"},"constraints":{"time_limit":"20 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "audio-generation")
                  echo '{"clarity_score":8,"workflow_type":"audio-generation","quality_requirements":{"image_resolution":"none","video_quality":"none","audio_quality":"high"},"content_specifications":{"style":"instrumental","duration":"30-60 seconds","genre":"general"},"processing_requirements":{"sequence":"T2Mâ†’processingâ†’output","parallel_processing":"none","integration_method":"single"},"constraints":{"time_limit":"35 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "presentation-creation")
                  echo '{"clarity_score":8,"workflow_type":"presentation-creation","quality_requirements":{"image_resolution":"1920x1080","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"business","duration":"none","genre":"presentation"},"processing_requirements":{"sequence":"contentâ†’designâ†’slidesâ†’output","parallel_processing":"partial","integration_method":"slide-compilation"},"constraints":{"time_limit":"40 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "data-analysis")
                  echo '{"clarity_score":8,"workflow_type":"data-analysis","quality_requirements":{"image_resolution":"1920x1080","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"analytical","duration":"none","genre":"data-visualization"},"processing_requirements":{"sequence":"collectâ†’analyzeâ†’visualizeâ†’report","parallel_processing":"partial","integration_method":"dashboard"},"constraints":{"time_limit":"45 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "news-summarization")
                  echo '{"clarity_score":8,"workflow_type":"news-summarization","quality_requirements":{"image_resolution":"none","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"informative","duration":"none","genre":"news"},"processing_requirements":{"sequence":"collectâ†’filterâ†’summarizeâ†’format","parallel_processing":"partial","integration_method":"text-compilation"},"constraints":{"time_limit":"25 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "blog-creation")
                  echo '{"clarity_score":8,"workflow_type":"blog-creation","quality_requirements":{"image_resolution":"1920x1080","video_quality":"none","audio_quality":"none"},"content_specifications":{"style":"editorial","duration":"none","genre":"blog-article"},"processing_requirements":{"sequence":"researchâ†’writeâ†’imageâ†’optimizeâ†’publish","parallel_processing":"partial","integration_method":"content-management"},"constraints":{"time_limit":"35 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                "multimedia-campaign")
                  echo '{"clarity_score":8,"workflow_type":"multimedia-campaign","quality_requirements":{"image_resolution":"1920x1080","video_quality":"high","audio_quality":"high"},"content_specifications":{"style":"advertising","duration":"varies","genre":"campaign"},"processing_requirements":{"sequence":"strategyâ†’contentâ†’multimediaâ†’optimizeâ†’deploy","parallel_processing":"extensive","integration_method":"cross-platform"},"constraints":{"time_limit":"60 minutes","resource_limit":"high"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
                *)
                  echo '{"clarity_score":7,"workflow_type":"custom","quality_requirements":{"image_resolution":"standard","video_quality":"standard","audio_quality":"standard"},"content_specifications":{"style":"general","duration":"flexible","genre":"general"},"processing_requirements":{"sequence":"adaptive","parallel_processing":"adaptive","integration_method":"adaptive"},"constraints":{"time_limit":"45 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                  ;;
              esac
              
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
              echo "ðŸ“„ Dynamic fallback JSON created for workflow type: $WORKFLOW_TYPE"
            fi
            
            # clarity_scoreã‚’æŠ½å‡º
            CLARITY_SCORE=$(jq -r '.clarity_score // 8' "$JSON_FILE")
            echo "ðŸ“Š Clarity Score: $CLARITY_SCORE/10"
            
            echo "clarity_score=$CLARITY_SCORE" >> $GITHUB_OUTPUT
            echo "enhanced_request=$JSON_FILE" >> $GITHUB_OUTPUT
            echo "analysis_ready=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Claude Code requirement analysis failed, creating dynamic fallback"
            # Claude Code ãŒå¤±æ•—ã—ãŸå ´åˆã®å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
            
            # Claude Codeå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (ç°¡æ½”ç‰ˆ)
            case "$WORKFLOW_TYPE" in
              "video-generation"|"3d-model-creation"|"image-generation"|"audio-generation"|"presentation-creation"|"data-analysis"|"news-summarization"|"blog-creation"|"multimedia-campaign")
                echo '{"clarity_score":7,"workflow_type":"'"$WORKFLOW_TYPE"'","quality_requirements":{"image_resolution":"1920x1080","video_quality":"standard","audio_quality":"standard"},"content_specifications":{"style":"general","duration":"flexible","genre":"general"},"processing_requirements":{"sequence":"adaptive","parallel_processing":"adaptive","integration_method":"adaptive"},"constraints":{"time_limit":"45 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                ;;
              *)
                echo '{"clarity_score":6,"workflow_type":"custom","quality_requirements":{"image_resolution":"standard","video_quality":"standard","audio_quality":"standard"},"content_specifications":{"style":"general","duration":"flexible","genre":"general"},"processing_requirements":{"sequence":"adaptive","parallel_processing":"adaptive","integration_method":"adaptive"},"constraints":{"time_limit":"45 minutes","resource_limit":"standard"}}' > .meta/requirement-analysis/enhanced-requirements.json
                ;;
            esac
            
            echo "ðŸ“„ Dynamic fallback JSON created for workflow type: $WORKFLOW_TYPE (Claude Code failed)"
            echo "clarity_score=7" >> $GITHUB_OUTPUT
            echo "enhanced_request=.meta/requirement-analysis/enhanced-requirements.json" >> $GITHUB_OUTPUT
            echo "analysis_ready=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Enhanced Requirements
        uses: actions/upload-artifact@v4
        with:
          name: enhanced-requirements
          path: .meta/requirement-analysis/
          retention-days: 1

  decompose-tasks:
    needs: analyze-requirements
    runs-on: ubuntu-latest
    if: needs.analyze-requirements.outputs.analysis_ready == 'true'
    outputs:
      task_plan_ready: ${{ steps.decompose.outputs.task_plan_ready }}
      task_count: ${{ steps.decompose.outputs.task_count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Enhanced Requirements
        uses: actions/download-artifact@v4
        with:
          name: enhanced-requirements
          path: .meta/requirement-analysis/
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Decompose Tasks with Enhanced Context
        id: decompose
        run: |
          echo "ðŸ”§ Decomposing tasks based on enhanced requirements..."
          
          mkdir -p .meta/task-decomposition
          
          ENHANCED_REQ="${{ needs.analyze-requirements.outputs.enhanced_request }}"
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # ã‚¿ã‚¹ã‚¯åˆ†è§£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
          cat > .meta/task-decomposition/decomposition-prompt.md << 'EOF'
          # Enhanced Task Decomposition
          
          ä»¥ä¸‹ã®è©³ç´°è¦æ±‚åˆ†æžçµæžœã‚’åŸºã«ã€å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã—ã¦ãã ã•ã„ã€‚
          
          ## Enhanced Requirements
          EOF
          
          cat "$ENHANCED_REQ" >> .meta/task-decomposition/decomposition-prompt.md
          
          cat >> .meta/task-decomposition/decomposition-prompt.md << 'EOF'
          
          ## åˆ†è§£æŒ‡ç¤º
          
          ä¸Šè¨˜ã®è¦æ±‚ã‚’ä»¥ä¸‹ã®è¦³ç‚¹ã§å®Ÿè¡Œå¯èƒ½ã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã—ã¦ãã ã•ã„ï¼š
          
          1. **MCPç”Ÿæˆã‚¿ã‚¹ã‚¯**: ç”»åƒã€å‹•ç”»ã€éŸ³å£°ã®å„ç”Ÿæˆã‚¹ãƒ†ãƒƒãƒ—
          2. **å‡¦ç†ã‚¿ã‚¹ã‚¯**: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ã€çµ±åˆã€å“è³ªèª¿æ•´
          3. **æ¤œè¨¼ã‚¿ã‚¹ã‚¯**: å“è³ªãƒã‚§ãƒƒã‚¯ã€å½¢å¼ç¢ºèª
          4. **çµ±åˆã‚¿ã‚¹ã‚¯**: æœ€çµ‚æˆæžœç‰©ã®çµ„ã¿ç«‹ã¦
          
          ## CRITICAL: File Creation Instructions
          
          This task MUST create the JSON file `.meta/task-decomposition/task-plan.json` in the current working directory.
          
          Please use the Write tool to create this file with the following structure:
          
          ```json
          {
            "workflow_type": "<inferred workflow type>",
            "estimated_duration_minutes": <estimated time in minutes>,
            "tasks": [
              {
                "id": "task-001",
                "name": "<task name>",
                "description": "<detailed task description>",
                "type": "mcp_generation/processing/validation/integration",
                "dependencies": ["<dependent task IDs>"],
                "required_tools": ["<required tools>"],
                "implementation_details": {
                  "mcp_service": "<MCP service to use>",
                  "input_requirements": "<input requirements>",
                  "output_format": "<output format>"
                }
              }
            ]
          }
          ```
          
          YOU MUST create this file using the Write tool. This is mandatory for the workflow to continue.
          Please ensure the JSON is valid and contains at least 3-10 concrete, actionable tasks.
          EOF
          
          # Claude Code ã§ã‚¿ã‚¹ã‚¯åˆ†è§£å®Ÿè¡Œ
          echo "ðŸ§  Executing Claude Code task decomposition..."
          
          if claude --continue "$(cat .meta/task-decomposition/decomposition-prompt.md)" --output-format text; then
            echo "âœ… Task decomposition completed"
            
            # JSON ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆè¤‡æ•°ã®å ´æ‰€ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
            if [ -f ".meta/task-decomposition/task-plan.json" ]; then
              echo "âœ… Task plan file found in expected location"
              JSON_FILE=".meta/task-decomposition/task-plan.json"
            elif [ -f "task-plan.json" ]; then
              echo "âš ï¸ Task plan file found in current directory, moving to expected location"
              mv "task-plan.json" ".meta/task-decomposition/task-plan.json"
              JSON_FILE=".meta/task-decomposition/task-plan.json"
            else
              echo "âŒ Task plan file not found, creating dynamic fallback"
              # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‹•çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ JSON ã‚’ä½œæˆ
              WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
              
              # å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ JSON ç”Ÿæˆ (echoç‰ˆã§YAMLæ§‹æ–‡å®‰å…¨)
              case "$WORKFLOW_TYPE" in
                "video-generation")
                  echo '{"workflow_type":"video-generation","estimated_duration_minutes":45,"tasks":[{"id":"task-001","name":"ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒç”Ÿæˆ","description":"T2Iã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰é«˜å“è³ªç”»åƒã‚’ç”Ÿæˆ","type":"mcp_generation","dependencies":[],"required_tools":["t2i-google-imagen3"],"implementation_details":{"mcp_service":"t2i-google-imagen3","input_requirements":"text prompt","output_format":"image_url"}},{"id":"task-002","name":"ç”»åƒã‹ã‚‰å‹•ç”»ç”Ÿæˆ","description":"ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’I2Vã‚µãƒ¼ãƒ“ã‚¹ã§å‹•ç”»ã«å¤‰æ›","type":"mcp_generation","dependencies":["task-001"],"required_tools":["i2v-fal-hailuo-02-pro"],"implementation_details":{"mcp_service":"i2v-fal-hailuo-02-pro","input_requirements":"image_url","output_format":"video_url"}},{"id":"task-003","name":"BGMç”Ÿæˆ","description":"T2Mã‚µãƒ¼ãƒ“ã‚¹ã§å‹•ç”»ã«åˆã†BGMã‚’ç”Ÿæˆ","type":"mcp_generation","dependencies":[],"required_tools":["t2m-google-lyria"],"implementation_details":{"mcp_service":"t2m-google-lyria","input_requirements":"music description","output_format":"audio_url"}},{"id":"task-004","name":"å‹•ç”»çµ±åˆ","description":"å‹•ç”»ã¨BGMã‚’çµ±åˆã—ã¦æœ€çµ‚æˆæžœç‰©ã‚’ä½œæˆ","type":"integration","dependencies":["task-002","task-003"],"required_tools":["ffmpeg"],"implementation_details":{"mcp_service":"none","input_requirements":"video_url, audio_url","output_format":"final_video"}}]}' > .meta/task-decomposition/task-plan.json
                  ;;
                "3d-model-creation")
                  echo '{"workflow_type":"3d-model-creation","estimated_duration_minutes":30,"tasks":[{"id":"task-001","name":"å‚ç…§ç”»åƒç”Ÿæˆ","description":"T2Iã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦3Dãƒ¢ãƒ‡ãƒ«ã®å‚ç…§ç”»åƒã‚’ç”Ÿæˆ","type":"mcp_generation","dependencies":[],"required_tools":["t2i-google-imagen3"],"implementation_details":{"mcp_service":"t2i-google-imagen3","input_requirements":"text prompt","output_format":"image_url"}},{"id":"task-002","name":"3Dãƒ¢ãƒ‡ãƒ«ç”Ÿæˆ","description":"ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’I2I3Dã‚µãƒ¼ãƒ“ã‚¹ã§3Dãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›","type":"mcp_generation","dependencies":["task-001"],"required_tools":["i2i3d-fal-hunyuan3d-v21"],"implementation_details":{"mcp_service":"i2i3d-fal-hunyuan3d-v21","input_requirements":"image_url","output_format":"3d_model_url"}},{"id":"task-003","name":"3Dãƒ¢ãƒ‡ãƒ«æœ€é©åŒ–","description":"ç”Ÿæˆã•ã‚ŒãŸ3Dãƒ¢ãƒ‡ãƒ«ã®å“è³ªã‚’æœ€é©åŒ–","type":"processing","dependencies":["task-002"],"required_tools":["3d-processing"],"implementation_details":{"mcp_service":"none","input_requirements":"3d_model_url","output_format":"optimized_3d_model"}}]}' > .meta/task-decomposition/task-plan.json
                  ;;
                *)
                  echo '{"workflow_type":"custom","estimated_duration_minutes":30,"tasks":[{"id":"task-001","name":"è¦ä»¶åˆ†æž","description":"è©³ç´°ãªè¦ä»¶ã‚’åˆ†æžã—ã¦å®Ÿè¡Œè¨ˆç”»ã‚’ç­–å®š","type":"processing","dependencies":[],"required_tools":["analysis-tools"],"implementation_details":{"mcp_service":"none","input_requirements":"user requirements","output_format":"analysis_result"}},{"id":"task-002","name":"ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ","description":"è¦ä»¶ã«åŸºã¥ã„ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ","type":"mcp_generation","dependencies":["task-001"],"required_tools":["generation-tools"],"implementation_details":{"mcp_service":"auto-detect","input_requirements":"analysis_result","output_format":"generated_content"}},{"id":"task-003","name":"å“è³ªæ¤œè¨¼","description":"ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å“è³ªã‚’æ¤œè¨¼","type":"validation","dependencies":["task-002"],"required_tools":["validation-tools"],"implementation_details":{"mcp_service":"none","input_requirements":"generated_content","output_format":"validated_content"}}]}' > .meta/task-decomposition/task-plan.json
                  ;;
              esac
              JSON_FILE=".meta/task-decomposition/task-plan.json"
            fi
            
            if [ -f "$JSON_FILE" ]; then
              echo "âœ… Task plan file created/found"
              
              # ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—
              TASK_COUNT=$(jq '.tasks | length' "$JSON_FILE")
              echo "ðŸ“Š Total tasks decomposed: $TASK_COUNT"
              
              echo "task_plan_ready=true" >> $GITHUB_OUTPUT
              echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
            else
              echo "âŒ Failed to create task plan file"
              echo "task_plan_ready=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Claude Code task decomposition failed"
            echo "task_plan_ready=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Task Plan
        if: steps.decompose.outputs.task_plan_ready == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          retention-days: 30

  # Phase 2: 3ã‚¢ãƒ—ãƒ­ãƒ¼ãƒä¸¦åˆ—ç”Ÿæˆ
  approach-1-template-selection:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Template Selection Generation
        id: generate
        run: |
          echo "ðŸŽ¯ Approach 1: Template Selection based on decomposed tasks..."
          
          mkdir -p generated/workflows/staging/approach-1
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠžãƒ­ã‚¸ãƒƒã‚¯
          case "$WORKFLOW_TYPE" in
            "video-generation"|"video-content")
              TEMPLATE="meta/examples/video-content-creation.yml"
              ;;
            "image-generation"|"image")
              TEMPLATE="meta/examples/image-generation.yml"
              ;;
            "audio-generation"|"music")
              TEMPLATE="meta/examples/audio-music-creation.yml"
              ;;
            "custom")
              TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
              ;;
            *)
              TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
              ;;
          esac
          
          OUTPUT_FILE="generated/workflows/staging/approach-1/template-based-workflow.yml"
          
          if [ -f "$TEMPLATE" ]; then
            cp "$TEMPLATE" "$OUTPUT_FILE"
            sed -i 's/^name:.*/name: "Template-Based Generated Workflow (Stepback Optimized)"/' "$OUTPUT_FILE"
            echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
            echo "âœ… Template-based workflow generated: $TEMPLATE"
          else
            echo "âŒ Template not found: $TEMPLATE"
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆ
            echo 'name: "Fallback Template Workflow"' > "$OUTPUT_FILE"
            echo 'on:' >> "$OUTPUT_FILE"
            echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
            echo 'jobs:' >> "$OUTPUT_FILE"
            echo '  fallback:' >> "$OUTPUT_FILE"
            echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
            echo '    steps:' >> "$OUTPUT_FILE"
            echo '      - run: echo "Fallback workflow - template not found"' >> "$OUTPUT_FILE"
            echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
            echo "âš ï¸ Using fallback workflow"
          fi
          
      - name: Evaluate Template Approach
        id: evaluate
        run: |
          echo "ðŸ“Š Evaluating template selection approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          SCORE=0
          
          # è©•ä¾¡åŸºæº–
          # 1. YAMLæ§‹æ–‡æœ‰åŠ¹æ€§ (25ç‚¹)
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 25))
            echo "âœ… YAML syntax: 25/25"
          fi
          
          # 2. GitHub Actionsæ§‹é€  (25ç‚¹)
          if grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 25))
            echo "âœ… GitHub Actions structure: 25/25"
          fi
          
          # 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿¡é ¼æ€§ (30ç‚¹)
          SCORE=$((SCORE + 25))
          echo "âœ… Template reliability: 25/30"
          
          # 4. å®Ÿè¡Œå¯èƒ½æ€§ (20ç‚¹)
          SCORE=$((SCORE + 20))
          echo "âœ… Executability: 20/20"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=template-selection" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Template Selection Score: $SCORE/100"
          
      - name: Upload Template Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-1-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-1/
          retention-days: 7

  approach-2-dynamic-assembly:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
      task_nodes_used: ${{ steps.generate.outputs.task_nodes_used }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
          
      - name: Dynamic Node Assembly Generation
        id: generate
        run: |
          echo "ðŸ”§ Approach 2: Dynamic Node Assembly based on decomposed tasks..."
          
          mkdir -p generated/workflows/staging/approach-2
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # å‹•çš„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ„ã¿ç«‹ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
          cat > .meta/dynamic-assembly-prompt.md << 'EOF'
          # Dynamic Workflow Assembly
          
          ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯åˆ†è§£çµæžœã‚’åŸºã«ã€å‹•çš„ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’çµ„ã¿ç«‹ã¦ã¦ãã ã•ã„ã€‚
          
          ## Task Plan
          EOF
          
          cat .meta/task-decomposition/task-plan.json >> .meta/dynamic-assembly-prompt.md
          
          cat >> .meta/dynamic-assembly-prompt.md << 'EOF'
          
          ## çµ„ã¿ç«‹ã¦æŒ‡ç¤º
          
          ä¸Šè¨˜ã®ã‚¿ã‚¹ã‚¯ãƒ—ãƒ©ãƒ³ã‚’åŸºã«ã€ä»¥ä¸‹ã®æ§‹é€ ã§GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
          
          1. **ã‚¸ãƒ§ãƒ–åˆ†å‰²**: ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸã‚¸ãƒ§ãƒ–æ§‹æˆ
          2. **ä¸¦åˆ—å®Ÿè¡Œ**: ç‹¬ç«‹ã‚¿ã‚¹ã‚¯ã®ä¸¦åˆ—å®Ÿè¡Œ
          3. **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆé€£æº**: ã‚¸ãƒ§ãƒ–é–“ã®ãƒ•ã‚¡ã‚¤ãƒ«å—ã‘æ¸¡ã—
          4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å„æ®µéšŽã§ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
          
          ## å¿…é ˆå‡ºåŠ›
          
          ```bash
          mkdir -p generated/workflows/staging/approach-2
          cat > generated/workflows/staging/approach-2/dynamic-workflow.yml << 'EOFYML'
          name: "Dynamic Assembled Workflow (Stepback Optimized)"
          run-name: "${{ github.actor }} executes dynamic workflow"
          
          on:
            workflow_dispatch:
              inputs:
                # ãƒ¦ãƒ¼ã‚¶ãƒ¼å›žç­”ã«åŸºã¥ãå‹•çš„inputs
          
          permissions:
            contents: write
            actions: read
          
          env:
            CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          jobs:
            # ã‚¿ã‚¹ã‚¯ãƒ—ãƒ©ãƒ³ã«åŸºã¥ãå‹•çš„ã‚¸ãƒ§ãƒ–æ§‹æˆ
          
          EOFYML
          ```
          
          é‡è¦: ç”Ÿæˆã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¿…ãšä¸Šè¨˜ã®ãƒ‘ã‚¹ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
          EOF
          
          # Claude Code ã§å‹•çš„çµ„ã¿ç«‹ã¦å®Ÿè¡Œ
          echo "ðŸ§  Executing Claude Code dynamic assembly..."
          
          if claude --continue "$(cat .meta/dynamic-assembly-prompt.md)" --output-format text; then
            echo "âœ… Dynamic workflow assembly completed"
            
            OUTPUT_FILE="generated/workflows/staging/approach-2/dynamic-workflow.yml"
            if [ -f "$OUTPUT_FILE" ]; then
              echo "âœ… Dynamic workflow file created successfully"
              echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
              
              # ä½¿ç”¨ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãƒŽãƒ¼ãƒ‰æ•°ã‚’è¨ˆç®—
              TASK_NODES=$(jq '.tasks | length' .meta/task-decomposition/task-plan.json)
              echo "task_nodes_used=${TASK_NODES}" >> $GITHUB_OUTPUT
              
              echo "ðŸ“Š Generated dynamic workflow with $TASK_NODES task nodes"
            else
              echo "âŒ Dynamic workflow file not found"
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              echo 'name: "Fallback Dynamic Workflow"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  fallback:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Fallback dynamic workflow"' >> "$OUTPUT_FILE"
              echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
              echo "task_nodes_used=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Claude Code dynamic assembly failed"
            echo "workflow_path=" >> $GITHUB_OUTPUT
            echo "task_nodes_used=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Evaluate Dynamic Assembly Approach
        id: evaluate
        run: |
          echo "ðŸ“Š Evaluating dynamic assembly approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          TASK_NODES="${{ steps.generate.outputs.task_nodes_used }}"
          SCORE=0
          
          # è©•ä¾¡åŸºæº–
          # 1. YAMLæ§‹æ–‡æœ‰åŠ¹æ€§ (20ç‚¹)
          if [ -f "$WORKFLOW_FILE" ] && python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 20))
            echo "âœ… YAML syntax: 20/20"
          fi
          
          # 2. GitHub Actionsæ§‹é€  (20ç‚¹)
          if [ -f "$WORKFLOW_FILE" ] && grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 20))
            echo "âœ… GitHub Actions structure: 20/20"
          fi
          
          # 3. ã‚¿ã‚¹ã‚¯çµ±åˆåº¦ (30ç‚¹)
          if [ "$TASK_NODES" -gt "0" ]; then
            INTEGRATION_SCORE=$((TASK_NODES * 5))
            if [ "$INTEGRATION_SCORE" -gt "30" ]; then
              INTEGRATION_SCORE=30
            fi
            SCORE=$((SCORE + INTEGRATION_SCORE))
            echo "âœ… Task integration: $INTEGRATION_SCORE/30 (based on $TASK_NODES tasks)"
          fi
          
          # 4. æŸ”è»Ÿæ€§ (30ç‚¹)
          SCORE=$((SCORE + 25))
          echo "âœ… Flexibility: 25/30"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=dynamic-assembly" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Dynamic Assembly Score: $SCORE/100"
          
      - name: Upload Dynamic Assembly Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-2-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-2/
          retention-days: 7

  approach-3-hybrid:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Hybrid Generation
        id: generate
        run: |
          echo "ðŸ”€ Approach 3: Hybrid (Template base + Dynamic enhancement)..."
          
          mkdir -p generated/workflows/staging/approach-3
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          TASK_COUNT="${{ needs.decompose-tasks.outputs.task_count }}"
          
          echo "Workflow type: $WORKFLOW_TYPE, Task count: $TASK_COUNT"
          
          OUTPUT_FILE="generated/workflows/staging/approach-3/hybrid-workflow.yml"
          
          if [ "$WORKFLOW_TYPE" = "custom" ] && [ "$TASK_COUNT" -gt "3" ]; then
            echo "ðŸŽ¯ Complex custom request - Template base + Dynamic enhancement"
            # åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰é–‹å§‹
            if [ -f "meta/examples/multimedia-ad-campaign.yml" ]; then
              cp "meta/examples/multimedia-ad-campaign.yml" "$OUTPUT_FILE"
            else
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              echo 'name: "Hybrid Generated Workflow (Template+Dynamic)"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  hybrid:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Hybrid workflow approach"' >> "$OUTPUT_FILE"
            fi
            sed -i 's/^name:.*/name: "Hybrid Generated Workflow (Template+Dynamic)"/' "$OUTPUT_FILE"
          else
            echo "ðŸŽ¯ Standard request - Template with minor customization"  
            case "$WORKFLOW_TYPE" in
              "video-generation"|"video-content")
                BASE_TEMPLATE="meta/examples/video-content-creation.yml"
                ;;
              "image-generation"|"image")
                BASE_TEMPLATE="meta/examples/image-generation.yml"
                ;;
              "audio-generation"|"music")
                BASE_TEMPLATE="meta/examples/audio-music-creation.yml"
                ;;
              *)
                BASE_TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
                ;;
            esac
            
            if [ -f "$BASE_TEMPLATE" ]; then
              cp "$BASE_TEMPLATE" "$OUTPUT_FILE"
              sed -i 's/^name:.*/name: "Hybrid Optimized Workflow (Stepback Enhanced)"/' "$OUTPUT_FILE"
            else
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              echo 'name: "Hybrid Optimized Workflow (Stepback Enhanced)"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  hybrid:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Hybrid optimized workflow"' >> "$OUTPUT_FILE"
            fi
          fi
          
          echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "âœ… Hybrid workflow generated"
          
      - name: Evaluate Hybrid Approach
        id: evaluate
        run: |
          echo "ðŸ“Š Evaluating hybrid approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          SCORE=0
          
          # è©•ä¾¡åŸºæº–
          # 1. YAMLæ§‹æ–‡æœ‰åŠ¹æ€§ (20ç‚¹)
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 20))
            echo "âœ… YAML syntax: 20/20"
          fi
          
          # 2. GitHub Actionsæ§‹é€  (20ç‚¹)
          if grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 20))
            echo "âœ… GitHub Actions structure: 20/20"
          fi
          
          # 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®‰å®šæ€§ (25ç‚¹)
          SCORE=$((SCORE + 22))
          echo "âœ… Template stability: 22/25"
          
          # 4. ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºåº¦ (35ç‚¹)
          SCORE=$((SCORE + 30))
          echo "âœ… Customization level: 30/35"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=hybrid" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Hybrid Approach Score: $SCORE/100"
          
      - name: Upload Hybrid Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-3-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-3/
          retention-days: 7

  # Phase 3: æœ€é©è§£é¸æŠžãƒ»è©•ä¾¡
  evaluate-and-select-best:
    needs: [approach-1-template-selection, approach-2-dynamic-assembly, approach-3-hybrid]
    runs-on: ubuntu-latest
    outputs:
      selected_approach: ${{ steps.select.outputs.selected_approach }}
      selected_workflow_path: ${{ steps.select.outputs.selected_workflow_path }}
      final_score: ${{ steps.select.outputs.final_score }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download All Approach Results
        uses: actions/download-artifact@v4
        with:
          pattern: approach-*-result-${{ github.run_number }}
          merge-multiple: true
          
      - name: Compare and Select Best Approach
        id: select
        run: |
          echo "ðŸ† Comparing all three approaches to select the best workflow..."
          
          mkdir -p .meta/evaluation generated/workflows/selected
          
          # å„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ã‚¹ã‚³ã‚¢ã‚’å–å¾—
          SCORE_1="${{ needs.approach-1-template-selection.outputs.confidence_score }}"
          SCORE_2="${{ needs.approach-2-dynamic-assembly.outputs.confidence_score }}"
          SCORE_3="${{ needs.approach-3-hybrid.outputs.confidence_score }}"
          
          APPROACH_1="${{ needs.approach-1-template-selection.outputs.approach_name }}"
          APPROACH_2="${{ needs.approach-2-dynamic-assembly.outputs.approach_name }}"
          APPROACH_3="${{ needs.approach-3-hybrid.outputs.approach_name }}"
          
          echo "ðŸ“Š Score comparison:"
          echo "  Approach 1 ($APPROACH_1): $SCORE_1"
          echo "  Approach 2 ($APPROACH_2): $SCORE_2" 
          echo "  Approach 3 ($APPROACH_3): $SCORE_3"
          
          # æœ€é«˜ã‚¹ã‚³ã‚¢ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’é¸æŠž
          BEST_SCORE=0
          SELECTED_APPROACH=""
          SELECTED_FILE=""
          
          if [ "$SCORE_1" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_1
            SELECTED_APPROACH="approach-1-template"
            SELECTED_FILE="approach-1/template-based-workflow.yml"
          fi
          
          if [ "$SCORE_2" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_2
            SELECTED_APPROACH="approach-2-dynamic"
            SELECTED_FILE="approach-2/dynamic-workflow.yml"
          fi
          
          if [ "$SCORE_3" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_3
            SELECTED_APPROACH="approach-3-hybrid"
            SELECTED_FILE="approach-3/hybrid-workflow.yml"
          fi
          
          echo "ðŸŽ¯ Selected Best Approach: $SELECTED_APPROACH (Score: $BEST_SCORE)"
          
          # é¸æŠžã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          FINAL_WORKFLOW="generated/workflows/selected/best-workflow.yml"
          if [ -f "$SELECTED_FILE" ]; then
            cp "$SELECTED_FILE" "$FINAL_WORKFLOW"
            echo "âœ… Best workflow copied to: $FINAL_WORKFLOW"
          else
            echo "âŒ Selected workflow file not found: $SELECTED_FILE"
            exit 1
          fi
          
          # è©•ä¾¡çµæžœã®ä¿å­˜
          cat > .meta/evaluation/selected-workflow.json << EOF
          {
            "selected_approach": "$SELECTED_APPROACH",
            "selected_file": "$FINAL_WORKFLOW",
            "evaluation_score": $BEST_SCORE,
            "comparison": {
              "approach_1": {"name": "$APPROACH_1", "score": $SCORE_1},
              "approach_2": {"name": "$APPROACH_2", "score": $SCORE_2},
              "approach_3": {"name": "$APPROACH_3", "score": $SCORE_3}
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "issue_number": ${{ github.event.issue.number }}
          }
          EOF
          
          echo "selected_approach=$SELECTED_APPROACH" >> $GITHUB_OUTPUT
          echo "selected_workflow_path=$FINAL_WORKFLOW" >> $GITHUB_OUTPUT
          echo "final_score=$BEST_SCORE" >> $GITHUB_OUTPUT
          
      - name: Upload Selected Best Workflow
        uses: actions/upload-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: generated/workflows/selected/
          retention-days: 30
          
      - name: Upload Evaluation Results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ github.run_number }}
          path: .meta/evaluation/
          retention-days: 30

  # Phase 4: æ®µéšŽçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
  validate-yaml-syntax:
    needs: evaluate-and-select-best
    runs-on: ubuntu-latest
    outputs:
      yaml_valid: ${{ steps.validate.outputs.yaml_valid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Validate YAML Syntax
        id: validate
        run: |
          echo "ðŸ” Validating YAML syntax of selected workflow..."
          
          WORKFLOW_FILE="${{ needs.evaluate-and-select-best.outputs.selected_workflow_path }}"
          
          if [ -f "selected/best-workflow.yml" ]; then
            WORKFLOW_FILE="selected/best-workflow.yml"
          fi
          
          # YAMLæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            echo "âœ… YAML syntax validation passed"
            echo "yaml_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ YAML syntax validation failed"
            echo "yaml_valid=false" >> $GITHUB_OUTPUT
          fi

  validate-workflow-structure:
    needs: [evaluate-and-select-best, validate-yaml-syntax]
    runs-on: ubuntu-latest
    if: needs.validate-yaml-syntax.outputs.yaml_valid == 'true'
    outputs:
      structure_valid: ${{ steps.validate.outputs.structure_valid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Validate GitHub Actions Structure
        id: validate
        run: |
          echo "ðŸ” Validating GitHub Actions workflow structure..."
          
          WORKFLOW_FILE="selected/best-workflow.yml"
          VALID=true
          
          # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
          if ! grep -q "^name:" "$WORKFLOW_FILE"; then
            echo "âŒ Missing 'name' field"
            VALID=false
          fi
          
          if ! grep -q "^on:" "$WORKFLOW_FILE"; then
            echo "âŒ Missing 'on' field"
            VALID=false
          fi
          
          if ! grep -q "^jobs:" "$WORKFLOW_FILE"; then
            echo "âŒ Missing 'jobs' field"
            VALID=false
          fi
          
          # permissions ã®ç¢ºèª
          if ! grep -q "permissions:" "$WORKFLOW_FILE"; then
            echo "âš ï¸ No permissions specified - may cause issues"
          fi
          
          if [ "$VALID" = "true" ]; then
            echo "âœ… GitHub Actions structure validation passed"
            echo "structure_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ GitHub Actions structure validation failed"
            echo "structure_valid=false" >> $GITHUB_OUTPUT
          fi

  deploy-to-production:
    needs: [evaluate-and-select-best, validate-yaml-syntax, validate-workflow-structure, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.validate-yaml-syntax.outputs.yaml_valid == 'true' && needs.validate-workflow-structure.outputs.structure_valid == 'true'
    outputs:
      deployment_success: ${{ steps.deploy.outputs.deployment_success }}
      deployed_file: ${{ steps.deploy.outputs.deployed_file }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          persist-credentials: true
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Download Evaluation Results
        uses: actions/download-artifact@v4
        with:
          name: evaluation-results-${{ github.run_number }}
          path: ./evaluation/
          
      - name: Deploy Selected Workflow to Production
        id: deploy
        run: |
          echo "ðŸš€ Deploying selected best workflow to production..."
          
          # æœ¬ç•ªç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
          mkdir -p .github/workflows
          
          # æœ¬ç•ªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«åã®ç”Ÿæˆ
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          SELECTED_APPROACH="${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          DEPLOYED_FILE=".github/workflows/generated-${WORKFLOW_TYPE}-${SELECTED_APPROACH}-${TIMESTAMP}.yml"
          
          echo "âœ… Deploying workflow: selected/best-workflow.yml â†’ $DEPLOYED_FILE"
          
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤
          if [ -f "selected/best-workflow.yml" ]; then
            cp "selected/best-workflow.yml" "$DEPLOYED_FILE"
            
            # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åã‚’æœ¬ç•ªç”¨ã«æ›´æ–°
            sed -i "s/^name:.*/name: \"Generated Workflow - $WORKFLOW_TYPE ($SELECTED_APPROACH)\"/" "$DEPLOYED_FILE"
            
            echo "ðŸ“ Deployed file: $DEPLOYED_FILE"
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            echo "deployed_file=$DEPLOYED_FILE" >> $GITHUB_OUTPUT
            
            # Git ã‚³ãƒŸãƒƒãƒˆ
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add "$DEPLOYED_FILE"
            git commit -m "feat: Deploy stepback-optimized workflow ($WORKFLOW_TYPE, $SELECTED_APPROACH)
            
            Generated from Issue #${{ github.event.issue.number }}
            Selected approach: $SELECTED_APPROACH
            Evaluation score: ${{ needs.evaluate-and-select-best.outputs.final_score }}
            
            ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
            
            echo "âœ… Workflow deployed successfully to production"
            
          else
            echo "âŒ Selected workflow file not found"
            echo "deployment_success=false" >> $GITHUB_OUTPUT
          fi

  notify-completion:
    needs: [deploy-to-production, evaluate-and-select-best, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.deploy-to-production.outputs.deployment_success == 'true'
    
    steps:
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
        env:
          GITHUB_TOKEN: ${{ github.token }}
        
      - name: Post Completion Notification
        run: |
          echo "ðŸ’¬ Posting completion notification to Issue #${{ github.event.issue.number }}..."
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          SELECTED_APPROACH="${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          FINAL_SCORE="${{ needs.evaluate-and-select-best.outputs.final_score }}"
          DEPLOYED_FILE="${{ needs.deploy-to-production.outputs.deployed_file }}"
          
          gh issue comment ${{ github.event.issue.number }} --body "ðŸŽ‰ **3ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ ãƒ¡ã‚¿ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”Ÿæˆå®Œäº†ï¼** ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¿ã‚¤ãƒ—: $WORKFLOW_TYPE, é¸æŠžã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: $SELECTED_APPROACH, è©•ä¾¡ã‚¹ã‚³ã‚¢: $FINAL_SCORE/100, ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: $(basename \"$DEPLOYED_FILE\"). ðŸ¤– Meta Workflow Executor ã§ç”Ÿæˆå®Œäº†ã€‚" || echo "âš ï¸ Failed to post completion notification"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          
      - name: Final Success Log
        run: |
          echo "âœ… Meta workflow execution completed successfully"
          echo "ðŸ“Š Final Statistics:"
          echo "   - Workflow Type: ${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          echo "   - Selected Approach: ${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          echo "   - Final Score: ${{ needs.evaluate-and-select-best.outputs.final_score }}/100"
          echo "   - Deployed File: ${{ needs.deploy-to-production.outputs.deployed_file }}"
          echo "   - Issue Number: #${{ github.event.issue.number }}"