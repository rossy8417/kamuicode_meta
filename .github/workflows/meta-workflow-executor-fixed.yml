name: Meta Workflow Executor v7
run-name: üöÄ Executing 3-approach meta workflow for Issue #${{ github.event.issue.number }}

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  actions: read
  pull-requests: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

jobs:
  # Phase 1: ÂõûÁ≠îÂá¶ÁêÜ„ÉªÂàÜÊûê
  validate-comment-trigger:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'start')
    outputs:
      should_execute: ${{ steps.validate.outputs.should_execute }}
      issue_author: ${{ steps.validate.outputs.issue_author }}
      comment_author: ${{ steps.validate.outputs.comment_author }}
    
    steps:
      - name: Validate Start Comment Trigger
        id: validate
        run: |
          echo "üîç Validating start comment trigger..."
          
          COMMENT_USER="${{ github.event.comment.user.login }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          echo "üìã Validation Info:"
          echo "   - Comment by: $COMMENT_USER"
          echo "   - Issue author: $ISSUE_AUTHOR"
          echo "   - Comment starts with 'start': $(echo "$COMMENT_BODY" | grep -q '^start' && echo 'YES' || echo 'NO')"
          
          # Issue‰ΩúÊàêËÄÖÊú¨‰∫∫„ÅÆ„Ç≥„É°„É≥„Éà„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if [ "$COMMENT_USER" = "$ISSUE_AUTHOR" ] && echo "$COMMENT_BODY" | grep -q '^start'; then
            echo "‚úÖ Valid start trigger from Issue author"
            echo "should_execute=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Invalid trigger - must be Issue author with 'start' comment"
            echo "should_execute=false" >> $GITHUB_OUTPUT
          fi
          
          echo "issue_author=$ISSUE_AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_author=$COMMENT_USER" >> $GITHUB_OUTPUT

  extract-stepback-answers:
    needs: validate-comment-trigger
    runs-on: ubuntu-latest
    if: needs.validate-comment-trigger.outputs.should_execute == 'true'
    outputs:
      answers_extracted: ${{ steps.extract.outputs.answers_extracted }}
      stepback_answers: ${{ steps.extract.outputs.stepback_answers }}
      workflow_type: ${{ steps.extract.outputs.workflow_type }}
    
    steps:
      - name: Extract Stepback Answers from Issue
        id: extract
        run: |
          echo "üìù Extracting stepback answers from Issue #${{ github.event.issue.number }}..."
          
          mkdir -p .meta/stepback-analysis
          
          # IssueÊú¨Êñá„ÇíÂÆâÂÖ®„Å´„Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
          cat > .meta/stepback-analysis/issue-body.txt << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          
          # „Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„Åø
          ISSUE_BODY=$(cat .meta/stepback-analysis/issue-body.txt)
          
          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„ÅÆÊé®Ê∏¨ÔºàÂÖ®examples„Çø„Ç§„Éó„Å´ÂØæÂøúÔºâ
          if echo "$ISSUE_BODY" | grep -qi "video\|ÂãïÁîª\|Êò†ÂÉè\|youtube\|„Éó„É≠„É¢„Éº„Ç∑„Éß„É≥"; then
            WORKFLOW_TYPE="video-generation"
          elif echo "$ISSUE_BODY" | grep -qi "3d\|model\|„É¢„Éá„É´\|Á´ã‰Ωì"; then
            WORKFLOW_TYPE="3d-model-creation"
          elif echo "$ISSUE_BODY" | grep -qi "image\|ÁîªÂÉè\|„Ç§„É©„Çπ„Éà\|ÂÜôÁúü"; then
            WORKFLOW_TYPE="image-generation"
          elif echo "$ISSUE_BODY" | grep -qi "audio\|music\|Èü≥Ê•Ω\|Èü≥Â£∞\|bgm"; then
            WORKFLOW_TYPE="audio-generation"
          elif echo "$ISSUE_BODY" | grep -qi "presentation\|slide\|„Éó„É¨„Çº„É≥\|„Çπ„É©„Ç§„Éâ\|Ë≥áÊñô"; then
            WORKFLOW_TYPE="presentation-creation"
          elif echo "$ISSUE_BODY" | grep -qi "data\|analysis\|ÂàÜÊûê\|„É¨„Éù„Éº„Éà\|Áµ±Ë®à\|„Ç∞„É©„Éï"; then
            WORKFLOW_TYPE="data-analysis"
          elif echo "$ISSUE_BODY" | grep -qi "news\|„Éã„É•„Éº„Çπ\|Ë®ò‰∫ã\|Ë¶ÅÁ¥Ñ\|„Åæ„Å®„ÇÅ"; then
            WORKFLOW_TYPE="news-summarization"
          elif echo "$ISSUE_BODY" | grep -qi "blog\|article\|„Éñ„É≠„Ç∞\|Âü∑Á≠Ü\|„Ç≥„É≥„ÉÜ„É≥„ÉÑ"; then
            WORKFLOW_TYPE="blog-creation"
          elif echo "$ISSUE_BODY" | grep -qi "campaign\|ad\|Â∫ÉÂëä\|„Ç≠„É£„É≥„Éö„Éº„É≥\|„Éû„É´„ÉÅ„É°„Éá„Ç£„Ç¢"; then
            WORKFLOW_TYPE="multimedia-campaign"
          else
            WORKFLOW_TYPE="custom"
          fi
          
          # ÂõûÁ≠î„ÇíÊäΩÂá∫ÔºàÊüîËªü„Å™„Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ„É≥„Ç∞Ôºâ
          STEPBACK_ANSWERS=""
          
          # Êßò„ÄÖ„Å™ÂõûÁ≠î„Éë„Çø„Éº„É≥„Å´ÂØæÂøú
          # „Éë„Çø„Éº„É≥1: **ÂõûÁ≠îÔºö** „Åæ„Åü„ÅØ **ÂõûÁ≠î:** 
          # „Éë„Çø„Éº„É≥2: ÂõûÁ≠îÔºö „Åæ„Åü„ÅØ ÂõûÁ≠î:
          # „Éë„Çø„Éº„É≥3: A: „Åæ„Åü„ÅØ Answer: 
          # „Éë„Çø„Éº„É≥4: Q1ÂõûÁ≠î„ÄÅQ2ÂõûÁ≠î „Å™„Å©
          
          # ÂêÑË≥™Âïè„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊäΩÂá∫
          ANSWER_COUNT=0
          
          # Q1„ÅÆÂõûÁ≠î„ÇíÊäΩÂá∫
          Q1_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q1.*ÊßãÈÄ†.*„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£/,/Q2.*ÂìÅË≥™.*„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ/p' | grep -A10 -E "ÂõûÁ≠îÔºö|ÂõûÁ≠î:|Answer:|A:" | grep -v "Q2" | grep -v "„Åì„Åì„Å´Ë©≥Á¥∞" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q1_ANSWER" ] && [ ${#Q1_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q1ÂõûÁ≠î:** $Q1_ANSWER\n\n"
          fi
          
          # Q2„ÅÆÂõûÁ≠î„ÇíÊäΩÂá∫
          Q2_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q2.*ÂìÅË≥™.*„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ/,/Q3.*„Ç®„É©„ÉºÂá¶ÁêÜ/p' | grep -A10 -E "ÂõûÁ≠îÔºö|ÂõûÁ≠î:|Answer:|A:" | grep -v "Q3" | grep -v "„Åì„Åì„Å´Ë©≥Á¥∞" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q2_ANSWER" ] && [ ${#Q2_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q2ÂõûÁ≠î:** $Q2_ANSWER\n\n"
          fi
          
          # Q3„ÅÆÂõûÁ≠î„ÇíÊäΩÂá∫
          Q3_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q3.*„Ç®„É©„ÉºÂá¶ÁêÜ/,/Q4.*Âá∫Âäõ.*‰øùÂ≠ò/p' | grep -A10 -E "ÂõûÁ≠îÔºö|ÂõûÁ≠î:|Answer:|A:" | grep -v "Q4" | grep -v "„Åì„Åì„Å´Ë©≥Á¥∞" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q3_ANSWER" ] && [ ${#Q3_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q3ÂõûÁ≠î:** $Q3_ANSWER\n\n"
          fi
          
          # Q4„ÅÆÂõûÁ≠î„ÇíÊäΩÂá∫
          Q4_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q4.*Âá∫Âäõ.*‰øùÂ≠ò/,/Q5.*Êã°ÂºµÊÄß/p' | grep -A10 -E "ÂõûÁ≠îÔºö|ÂõûÁ≠î:|Answer:|A:" | grep -v "Q5" | grep -v "„Åì„Åì„Å´Ë©≥Á¥∞" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q4_ANSWER" ] && [ ${#Q4_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q4ÂõûÁ≠î:** $Q4_ANSWER\n\n"
          fi
          
          # Q5„ÅÆÂõûÁ≠î„ÇíÊäΩÂá∫  
          Q5_ANSWER=$(echo "$ISSUE_BODY" | sed -n '/Q5.*Êã°ÂºµÊÄß/,/---/p' | grep -A10 -E "ÂõûÁ≠îÔºö|ÂõûÁ≠î:|Answer:|A:" | grep -v "---" | grep -v "„Åì„Åì„Å´Ë©≥Á¥∞" | tail -n +2 | head -5 | tr '\n' ' ')
          if [ -n "$Q5_ANSWER" ] && [ ${#Q5_ANSWER} -gt 10 ]; then
            ANSWER_COUNT=$((ANSWER_COUNT + 1))
            STEPBACK_ANSWERS="${STEPBACK_ANSWERS}**Q5ÂõûÁ≠î:** $Q5_ANSWER\n\n"
          fi
          
          # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Çà„ÇäËá™Áî±„Å™ÂΩ¢Âºè„Åß„ÅÆÂõûÁ≠îÊäΩÂá∫
          if [ $ANSWER_COUNT -eq 0 ]; then
            echo "üîÑ Using fallback extraction for flexible input formats..."
            
            # ‰ªªÊÑè„ÅÆÂΩ¢Âºè„ÅßÊõ∏„Åã„Çå„ÅüÂõûÁ≠î„ÇíÊäΩÂá∫
            FLEXIBLE_ANSWERS=$(echo "$ISSUE_BODY" | grep -A3 -B1 -E "T2I|I2V|Ë§áÂêàÂá¶ÁêÜ|ÊúÄÈ´òÂìÅË≥™|‰∏¶ÂàóÂá¶ÁêÜ|„Ç®„É©„Éº|Âç≥Â∫ßÂÅúÊ≠¢|URL|„Éó„É¨„Éì„É•„Éº|ÂçòÁã¨ÂÆåÁµê|Ë©≥Á¥∞Áõ£Ë¶ñ" | grep -v "Q[1-5]:" | head -10 | tr '\n' ' ')
            
            if [ -n "$FLEXIBLE_ANSWERS" ] && [ ${#FLEXIBLE_ANSWERS} -gt 50 ]; then
              ANSWER_COUNT=1
              STEPBACK_ANSWERS="**ÊüîËªüÊäΩÂá∫ÂõûÁ≠î:** $FLEXIBLE_ANSWERS\n\n"
              echo "‚úÖ Flexible extraction successful: ${#FLEXIBLE_ANSWERS} characters found"
            fi
          fi
          
          echo "üìä Analysis Results:"
          echo "   - Workflow Type: $WORKFLOW_TYPE"
          echo "   - Stepback Answers Length: ${#STEPBACK_ANSWERS}"
          echo "   - Answers Found: $ANSWER_COUNT"
          
          if [ ${#STEPBACK_ANSWERS} -gt 50 ]; then
            echo "‚úÖ Sufficient stepback answers found - proceeding with workflow generation"
            
            # ÂàÜÊûêÁµêÊûú„Çí‰øùÂ≠ò
            cat > .meta/stepback-analysis/analysis-result.md << EOF
          # Stepback Answer Analysis Result
          
          ## Original Request
          $(echo "$ISSUE_BODY" | head -20)
          
          ## Stepback Answers
          $STEPBACK_ANSWERS
          
          ## Metadata
          - Workflow Type: $WORKFLOW_TYPE
          - Issue Number: ${{ github.event.issue.number }}
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Answer Count: $ANSWER_COUNT
          EOF
            
            echo "answers_extracted=true" >> $GITHUB_OUTPUT
            echo "stepback_answers<<EOF" >> $GITHUB_OUTPUT
            echo -e "$STEPBACK_ANSWERS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "workflow_type=$WORKFLOW_TYPE" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Insufficient stepback answers found"
            echo "answers_extracted=false" >> $GITHUB_OUTPUT
          fi

  analyze-requirements:
    needs: extract-stepback-answers
    runs-on: ubuntu-latest
    if: needs.extract-stepback-answers.outputs.answers_extracted == 'true'
    outputs:
      clarity_score: ${{ steps.analyze.outputs.clarity_score }}
      enhanced_request: ${{ steps.analyze.outputs.enhanced_request }}
      analysis_ready: ${{ steps.analyze.outputs.analysis_ready }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Analyze Requirements with Stepback Integration
        id: analyze
        run: |
          echo "üîç Analyzing requirements with stepback answers integration..."
          
          mkdir -p .meta/requirement-analysis
          
          # „Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØÂõûÁ≠î„ÇíÁµ±Âêà„Åó„ÅüË¶ÅÊ±ÇÂàÜÊûê
          cat > .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          # Enhanced Requirement Analysis with Stepback Answers
          
          ‰ª•‰∏ã„ÅÆ„É¶„Éº„Ç∂„Éº„Åã„Çâ„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Éê„ÉÉ„ÇØË≥™ÂïèÂõûÁ≠î„ÇíÂàÜÊûê„Åó„ÄÅ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàê„ÅÆ„Åü„ÇÅ„ÅÆË©≥Á¥∞Ë¶ÅÊ±Ç„ÇíÊï¥ÁêÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          ## Stepback Answers
          EOF
          
          echo "${{ needs.extract-stepback-answers.outputs.stepback_answers }}" >> .meta/requirement-analysis/analysis-prompt.md
          
          cat >> .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          
          ## ÂàÜÊûêÊåáÁ§∫
          
          ‰∏äË®ò„ÅÆÂõûÁ≠î„Åã„Çâ‰ª•‰∏ã„ÇíÊäΩÂá∫„ÉªÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          1. **ÊòéÁ¢∫Â∫¶„Çπ„Ç≥„Ç¢**: Ë¶ÅÊ±Ç„ÅÆÊòéÁ¢∫Â∫¶„Çí1-10„ÅßË©ï‰æ°
          2. **ÊäÄË°ì‰ªïÊßò**: ÂìÅË≥™Ë®≠ÂÆö„ÄÅÂΩ¢Âºè„ÄÅÂá¶ÁêÜÈ†ÜÂ∫è„ÅÆË¶ÅÊ±Ç
          3. **„Ç≥„É≥„ÉÜ„É≥„ÉÑ‰ªïÊßò**: „Çπ„Çø„Ç§„É´„ÄÅÈï∑„Åï„ÄÅ„Ç∏„É£„É≥„É´„ÅÆË¶ÅÊ±Ç
          4. **Áµ±ÂêàË¶ÅÊ±Ç**: Âá∫ÂäõÈñì„ÅÆÈÄ£Êê∫ÊñπÊ≥ï„ÄÅÊúÄÁµÇÊàêÊûúÁâ©
          5. **Âà∂Á¥ÑÊù°‰ª∂**: ÊôÇÈñì„ÄÅ„É™„ÇΩ„Éº„Çπ„ÄÅÊäÄË°ìÁöÑÂà∂Á¥Ñ
          
          ## ÂøÖÈ†àÂá∫Âäõ
          
          ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          ```bash
          mkdir -p .meta/requirement-analysis
          cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
          {
            "clarity_score": 1-10,
            "workflow_type": "Êé®Ê∏¨„Åï„Çå„Çã„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó",
            "quality_requirements": {
              "image_resolution": "Ë¶ÅÊ±Ç„Åï„Çå„ÇãËß£ÂÉèÂ∫¶",
              "video_quality": "Ë¶ÅÊ±Ç„Åï„Çå„ÇãÂãïÁîªÂìÅË≥™",
              "audio_quality": "Ë¶ÅÊ±Ç„Åï„Çå„ÇãÈü≥Â£∞ÂìÅË≥™"
            },
            "content_specifications": {
              "style": "„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„Çø„Ç§„É´",
              "duration": "ÂãïÁîª„ÇÑÈü≥Â£∞„ÅÆÈï∑„Åï",
              "genre": "„Ç∏„É£„É≥„É´„ÇÑ„ÉÜ„Éº„Éû"
            },
            "processing_requirements": {
              "sequence": "Âá¶ÁêÜÈ†ÜÂ∫è„ÅÆË¶ÅÊ±Ç",
              "parallel_processing": "‰∏¶ÂàóÂá¶ÁêÜ„ÅÆÂèØÂê¶",
              "integration_method": "Áµ±ÂêàÊñπÊ≥ï"
            },
            "constraints": {
              "time_limit": "ÊôÇÈñìÂà∂Á¥Ñ",
              "resource_limit": "„É™„ÇΩ„Éº„ÇπÂà∂Á¥Ñ"
            }
          }
          EOFJSON
          ```
          
          ÈáçË¶Å: ÂøÖ„Åö‰∏äË®ò„ÅÆJSON„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          EOF
          
          # Claude Code „ÅßË¶ÅÊ±ÇÂàÜÊûêÂÆüË°å
          echo "üß† Executing Claude Code requirement analysis..."
          
          # Claude CodeÂÆüË°åÂâç„Å´ÂøÖË¶Å„Å™„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÁ¢∫ÂÆü„Å´‰ΩúÊàê
          mkdir -p .meta/requirement-analysis
          
          # Claude Code„Å´„Çà„ÇäË©≥Á¥∞„Å™ÊåáÁ§∫„ÇíËøΩÂä†
          cat >> .meta/requirement-analysis/analysis-prompt.md << 'EOF'
          
          ## CRITICAL: File Creation Instructions
          
          This task MUST create the JSON file `.meta/requirement-analysis/enhanced-requirements.json` in the current working directory.
          
          Please use the Write tool to create this file with the following structure:
          
          ```json
          {
            "clarity_score": <number 1-10>,
            "workflow_type": "<inferred workflow type>",
            "quality_requirements": {
              "image_resolution": "<requested resolution>",
              "video_quality": "<requested video quality>",
              "audio_quality": "<requested audio quality>"
            },
            "content_specifications": {
              "style": "<content style>",
              "duration": "<video/audio duration>",
              "genre": "<genre or theme>"
            },
            "processing_requirements": {
              "sequence": "<processing order requirements>",
              "parallel_processing": "<parallel processing capability>",
              "integration_method": "<integration method>"
            },
            "constraints": {
              "time_limit": "<time constraints>",
              "resource_limit": "<resource constraints>"
            }
          }
          ```
          
          YOU MUST create this file using the Write tool. This is mandatory for the workflow to continue.
          EOF
          
          if claude --continue "$(cat .meta/requirement-analysis/analysis-prompt.md)" --output-format text; then
            echo "‚úÖ Claude Code requirement analysis completed"
            
            # JSON „Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™çÔºàË§áÊï∞„ÅÆÂ†¥ÊâÄ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºâ
            if [ -f ".meta/requirement-analysis/enhanced-requirements.json" ]; then
              echo "‚úÖ Enhanced requirements file found in expected location"
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
            elif [ -f "enhanced-requirements.json" ]; then
              echo "‚ö†Ô∏è Enhanced requirements file found in current directory, moving to expected location"
              mv "enhanced-requirements.json" ".meta/requirement-analysis/enhanced-requirements.json"
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
            else
              echo "‚ùå Enhanced requirements file not found, creating dynamic fallback"
              # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüÂãïÁöÑ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ JSON „Çí‰ΩúÊàê
              WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
              
              case "$WORKFLOW_TYPE" in
                "video-generation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "video-generation",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "high",
    "audio_quality": "standard"
  },
  "content_specifications": {
    "style": "photorealistic",
    "duration": "10-15 seconds",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "T2I‚ÜíI2V‚ÜíT2M‚Üíintegration",
    "parallel_processing": "partial",
    "integration_method": "composite"
  },
  "constraints": {
    "time_limit": "60 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "3d-model-creation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "3d-model-creation",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "realistic",
    "duration": "none",
    "genre": "3d-model"
  },
  "processing_requirements": {
    "sequence": "T2I‚ÜíI2I3D‚Üíoptimization‚Üíoutput",
    "parallel_processing": "none",
    "integration_method": "3d-pipeline"
  },
  "constraints": {
    "time_limit": "30 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "image-generation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "image-generation",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "photorealistic",
    "duration": "none",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "T2I‚Üíprocessing‚Üíoutput",
    "parallel_processing": "none",
    "integration_method": "single"
  },
  "constraints": {
    "time_limit": "20 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "audio-generation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "audio-generation",
  "quality_requirements": {
    "image_resolution": "none",
    "video_quality": "none",
    "audio_quality": "high"
  },
  "content_specifications": {
    "style": "instrumental",
    "duration": "30-60 seconds",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "T2M‚Üíprocessing‚Üíoutput",
    "parallel_processing": "none",
    "integration_method": "single"
  },
  "constraints": {
    "time_limit": "35 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "presentation-creation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "presentation-creation",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "business",
    "duration": "none",
    "genre": "presentation"
  },
  "processing_requirements": {
    "sequence": "content‚Üídesign‚Üíslides‚Üíoutput",
    "parallel_processing": "partial",
    "integration_method": "slide-compilation"
  },
  "constraints": {
    "time_limit": "40 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "data-analysis")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "data-analysis",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "analytical",
    "duration": "none",
    "genre": "data-visualization"
  },
  "processing_requirements": {
    "sequence": "collect‚Üíanalyze‚Üívisualize‚Üíreport",
    "parallel_processing": "partial",
    "integration_method": "dashboard"
  },
  "constraints": {
    "time_limit": "45 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "news-summarization")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "news-summarization",
  "quality_requirements": {
    "image_resolution": "none",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "informative",
    "duration": "none",
    "genre": "news"
  },
  "processing_requirements": {
    "sequence": "collect‚Üífilter‚Üísummarize‚Üíformat",
    "parallel_processing": "partial",
    "integration_method": "text-compilation"
  },
  "constraints": {
    "time_limit": "25 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "blog-creation")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "blog-creation",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "none",
    "audio_quality": "none"
  },
  "content_specifications": {
    "style": "editorial",
    "duration": "none",
    "genre": "blog-article"
  },
  "processing_requirements": {
    "sequence": "research‚Üíwrite‚Üíimage‚Üíoptimize‚Üípublish",
    "parallel_processing": "partial",
    "integration_method": "content-management"
  },
  "constraints": {
    "time_limit": "35 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
                "multimedia-campaign")
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 8,
  "workflow_type": "multimedia-campaign",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "high",
    "audio_quality": "high"
  },
  "content_specifications": {
    "style": "advertising",
    "duration": "varies",
    "genre": "campaign"
  },
  "processing_requirements": {
    "sequence": "strategy‚Üícontent‚Üímultimedia‚Üíoptimize‚Üídeploy",
    "parallel_processing": "extensive",
    "integration_method": "cross-platform"
  },
  "constraints": {
    "time_limit": "60 minutes",
    "resource_limit": "high"
  }
}
EOFJSON
                  ;;
                *)
                  # „Ç´„Çπ„Çø„É†„Åæ„Åü„ÅØ‰∏çÊòé„Å™„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó
                  cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 7,
  "workflow_type": "custom",
  "quality_requirements": {
    "image_resolution": "standard",
    "video_quality": "standard",
    "audio_quality": "standard"
  },
  "content_specifications": {
    "style": "general",
    "duration": "flexible",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "adaptive",
    "parallel_processing": "adaptive",
    "integration_method": "adaptive"
  },
  "constraints": {
    "time_limit": "45 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                  ;;
              esac
              
              JSON_FILE=".meta/requirement-analysis/enhanced-requirements.json"
              echo "üìÑ Dynamic fallback JSON created for workflow type: $WORKFLOW_TYPE"
            fi
            
            # clarity_score„ÇíÊäΩÂá∫
            CLARITY_SCORE=$(jq -r '.clarity_score // 8' "$JSON_FILE")
            echo "üìä Clarity Score: $CLARITY_SCORE/10"
            
            echo "clarity_score=$CLARITY_SCORE" >> $GITHUB_OUTPUT
            echo "enhanced_request=$JSON_FILE" >> $GITHUB_OUTPUT
            echo "analysis_ready=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Claude Code requirement analysis failed, creating dynamic fallback"
            # Claude Code „ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅÆÂãïÁöÑ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
            
            # „Çà„ÇäÂåÖÊã¨ÁöÑ„Å´„Åô„Åπ„Å¶„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó„Å´ÂØæÂøúÔºàclarity_score=7„ÅßÁµ±‰∏ÄÔºâ
            case "$WORKFLOW_TYPE" in
              "video-generation"|"3d-model-creation"|"image-generation"|"audio-generation"|"presentation-creation"|"data-analysis"|"news-summarization"|"blog-creation"|"multimedia-campaign")
                # examples„Å®Âêå„ÅòÊßãÈÄ†„Å†„Åå„ÄÅclarity_score=7„Å´‰∏ã„Åí„Çã
                # „Åô„Åπ„Å¶„ÅÆ„Çø„Ç§„Éó„ÅßÂâç„ÅÆfallback„Å®Âêå„ÅòÊßãÈÄ†„Çí‰ΩøÁî®ÔºàÁ∞°ÊΩîÂåñ„ÅÆ„Åü„ÇÅÔºâ
                cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 7,
  "workflow_type": "'"$WORKFLOW_TYPE"'",
  "quality_requirements": {
    "image_resolution": "1920x1080",
    "video_quality": "standard",
    "audio_quality": "standard"
  },
  "content_specifications": {
    "style": "general",
    "duration": "flexible",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "adaptive",
    "parallel_processing": "adaptive",
    "integration_method": "adaptive"
  },
  "constraints": {
    "time_limit": "45 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                ;;
              *)
                # „Ç´„Çπ„Çø„É†„Åæ„Åü„ÅØ‰∏çÊòé„Å™„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó
                cat > .meta/requirement-analysis/enhanced-requirements.json << 'EOFJSON'
{
  "clarity_score": 6,
  "workflow_type": "custom",
  "quality_requirements": {
    "image_resolution": "standard",
    "video_quality": "standard",
    "audio_quality": "standard"
  },
  "content_specifications": {
    "style": "general",
    "duration": "flexible",
    "genre": "general"
  },
  "processing_requirements": {
    "sequence": "adaptive",
    "parallel_processing": "adaptive",
    "integration_method": "adaptive"
  },
  "constraints": {
    "time_limit": "45 minutes",
    "resource_limit": "standard"
  }
}
EOFJSON
                ;;
            esac
            
            echo "üìÑ Dynamic fallback JSON created for workflow type: $WORKFLOW_TYPE (Claude Code failed)"
            echo "clarity_score=7" >> $GITHUB_OUTPUT
            echo "enhanced_request=.meta/requirement-analysis/enhanced-requirements.json" >> $GITHUB_OUTPUT
            echo "analysis_ready=true" >> $GITHUB_OUTPUT
          fi

  decompose-tasks:
    needs: analyze-requirements
    runs-on: ubuntu-latest
    if: needs.analyze-requirements.outputs.analysis_ready == 'true'
    outputs:
      task_plan_ready: ${{ steps.decompose.outputs.task_plan_ready }}
      task_count: ${{ steps.decompose.outputs.task_count }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
        
      - name: Decompose Tasks with Enhanced Context
        id: decompose
        run: |
          echo "üîß Decomposing tasks based on enhanced requirements..."
          
          mkdir -p .meta/task-decomposition
          
          ENHANCED_REQ="${{ needs.analyze-requirements.outputs.enhanced_request }}"
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # „Çø„Çπ„ÇØÂàÜËß£„Éó„É≠„É≥„Éó„Éà„ÅÆ‰ΩúÊàê
          cat > .meta/task-decomposition/decomposition-prompt.md << 'EOF'
          # Enhanced Task Decomposition
          
          ‰ª•‰∏ã„ÅÆË©≥Á¥∞Ë¶ÅÊ±ÇÂàÜÊûêÁµêÊûú„ÇíÂü∫„Å´„ÄÅÂÆüË°åÂèØËÉΩ„Å™„Çø„Çπ„ÇØ„Å´ÂàÜËß£„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          ## Enhanced Requirements
          EOF
          
          cat "$ENHANCED_REQ" >> .meta/task-decomposition/decomposition-prompt.md
          
          cat >> .meta/task-decomposition/decomposition-prompt.md << 'EOF'
          
          ## ÂàÜËß£ÊåáÁ§∫
          
          ‰∏äË®ò„ÅÆË¶ÅÊ±Ç„Çí‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„ÅßÂÆüË°åÂèØËÉΩ„Çø„Çπ„ÇØ„Å´ÂàÜËß£„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          1. **MCPÁîüÊàê„Çø„Çπ„ÇØ**: ÁîªÂÉè„ÄÅÂãïÁîª„ÄÅÈü≥Â£∞„ÅÆÂêÑÁîüÊàê„Çπ„ÉÜ„ÉÉ„Éó
          2. **Âá¶ÁêÜ„Çø„Çπ„ÇØ**: „Éï„Ç°„Ç§„É´Â§âÊèõ„ÄÅÁµ±Âêà„ÄÅÂìÅË≥™Ë™øÊï¥
          3. **Ê§úË®º„Çø„Çπ„ÇØ**: ÂìÅË≥™„ÉÅ„Çß„ÉÉ„ÇØ„ÄÅÂΩ¢ÂºèÁ¢∫Ë™ç
          4. **Áµ±Âêà„Çø„Çπ„ÇØ**: ÊúÄÁµÇÊàêÊûúÁâ©„ÅÆÁµÑ„ÅøÁ´ã„Å¶
          
          ## ÂøÖÈ†àÂá∫Âäõ
          
          ```bash
          mkdir -p .meta/task-decomposition
          cat > .meta/task-decomposition/task-plan.json << 'EOFJSON'
          {
            "workflow_type": "„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó",
            "estimated_duration_minutes": Êé®ÂÆöÂÆüË°åÊôÇÈñì,
            "tasks": [
              {
                "id": "task-001",
                "name": "„Çø„Çπ„ÇØÂêç",
                "description": "„Çø„Çπ„ÇØ„ÅÆË©≥Á¥∞Ë™¨Êòé",
                "type": "mcp_generation/processing/validation/integration",
                "dependencies": ["‰æùÂ≠ò„Åô„Çã„Çø„Çπ„ÇØID"],
                "required_tools": ["ÂøÖË¶Å„Å™„ÉÑ„Éº„É´"],
                "implementation_details": {
                  "mcp_service": "‰ΩøÁî®„Åô„ÇãMCP„Çµ„Éº„Éì„Çπ",
                  "input_requirements": "ÂÖ•ÂäõË¶Å‰ª∂",
                  "output_format": "Âá∫ÂäõÂΩ¢Âºè"
                }
              }
            ]
          }
          EOFJSON
          ```
          EOF
          
          # Claude Code „Åß„Çø„Çπ„ÇØÂàÜËß£ÂÆüË°å
          echo "üß† Executing Claude Code task decomposition..."
          
          if claude --continue "$(cat .meta/task-decomposition/decomposition-prompt.md)" --output-format text; then
            echo "‚úÖ Task decomposition completed"
            
            if [ -f ".meta/task-decomposition/task-plan.json" ]; then
              echo "‚úÖ Task plan file created"
              
              # „Çø„Çπ„ÇØÊï∞„ÇíÂèñÂæó
              TASK_COUNT=$(jq '.tasks | length' .meta/task-decomposition/task-plan.json)
              echo "üìä Total tasks decomposed: $TASK_COUNT"
              
              echo "task_plan_ready=true" >> $GITHUB_OUTPUT
              echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Task plan file not found"
              echo "task_plan_ready=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Claude Code task decomposition failed"
            echo "task_plan_ready=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Upload Task Plan
        if: steps.decompose.outputs.task_plan_ready == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          retention-days: 30

  # Phase 2: 3„Ç¢„Éó„É≠„Éº„ÉÅ‰∏¶ÂàóÁîüÊàê
  approach-1-template-selection:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Template Selection Generation
        id: generate
        run: |
          echo "üéØ Approach 1: Template Selection based on decomposed tasks..."
          
          mkdir -p generated/workflows/staging/approach-1
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØ
          case "$WORKFLOW_TYPE" in
            "video-generation"|"video-content")
              TEMPLATE="meta/examples/video-content-creation.yml"
              ;;
            "image-generation"|"image")
              TEMPLATE="meta/examples/image-generation.yml"
              ;;
            "audio-generation"|"music")
              TEMPLATE="meta/examples/audio-music-creation.yml"
              ;;
            "custom")
              TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
              ;;
            *)
              TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
              ;;
          esac
          
          OUTPUT_FILE="generated/workflows/staging/approach-1/template-based-workflow.yml"
          
          if [ -f "$TEMPLATE" ]; then
            cp "$TEMPLATE" "$OUTPUT_FILE"
            sed -i 's/^name:.*/name: "Template-Based Generated Workflow (Stepback Optimized)"/' "$OUTPUT_FILE"
            echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
            echo "‚úÖ Template-based workflow generated: $TEMPLATE"
          else
            echo "‚ùå Template not found: $TEMPLATE"
            # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆÂü∫Êú¨„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çí‰ΩúÊàê
            echo 'name: "Fallback Template Workflow"' > "$OUTPUT_FILE"
            echo 'on:' >> "$OUTPUT_FILE"
            echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
            echo 'jobs:' >> "$OUTPUT_FILE"
            echo '  fallback:' >> "$OUTPUT_FILE"
            echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
            echo '    steps:' >> "$OUTPUT_FILE"
            echo '      - run: echo "Fallback workflow - template not found"' >> "$OUTPUT_FILE"
            echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Using fallback workflow"
          fi
          
      - name: Evaluate Template Approach
        id: evaluate
        run: |
          echo "üìä Evaluating template selection approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          SCORE=0
          
          # Ë©ï‰æ°Âü∫Ê∫ñ
          # 1. YAMLÊßãÊñáÊúâÂäπÊÄß (25ÁÇπ)
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 25))
            echo "‚úÖ YAML syntax: 25/25"
          fi
          
          # 2. GitHub ActionsÊßãÈÄ† (25ÁÇπ)
          if grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 25))
            echo "‚úÖ GitHub Actions structure: 25/25"
          fi
          
          # 3. „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ø°È†ºÊÄß (30ÁÇπ)
          SCORE=$((SCORE + 25))
          echo "‚úÖ Template reliability: 25/30"
          
          # 4. ÂÆüË°åÂèØËÉΩÊÄß (20ÁÇπ)
          SCORE=$((SCORE + 20))
          echo "‚úÖ Executability: 20/20"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=template-selection" >> $GITHUB_OUTPUT
          
          echo "üéØ Template Selection Score: $SCORE/100"
          
      - name: Upload Template Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-1-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-1/
          retention-days: 7

  approach-2-dynamic-assembly:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
      task_nodes_used: ${{ steps.generate.outputs.task_nodes_used }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
          
      - name: Dynamic Node Assembly Generation
        id: generate
        run: |
          echo "üîß Approach 2: Dynamic Node Assembly based on decomposed tasks..."
          
          mkdir -p generated/workflows/staging/approach-2
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          
          # ÂãïÁöÑ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁµÑ„ÅøÁ´ã„Å¶„Éó„É≠„É≥„Éó„Éà„ÅÆ‰ΩúÊàê
          cat > .meta/dynamic-assembly-prompt.md << 'EOF'
          # Dynamic Workflow Assembly
          
          ‰ª•‰∏ã„ÅÆ„Çø„Çπ„ÇØÂàÜËß£ÁµêÊûú„ÇíÂü∫„Å´„ÄÅÂãïÁöÑ„Å´„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁµÑ„ÅøÁ´ã„Å¶„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          ## Task Plan
          EOF
          
          cat .meta/task-decomposition/task-plan.json >> .meta/dynamic-assembly-prompt.md
          
          cat >> .meta/dynamic-assembly-prompt.md << 'EOF'
          
          ## ÁµÑ„ÅøÁ´ã„Å¶ÊåáÁ§∫
          
          ‰∏äË®ò„ÅÆ„Çø„Çπ„ÇØ„Éó„É©„É≥„ÇíÂü∫„Å´„ÄÅ‰ª•‰∏ã„ÅÆÊßãÈÄ†„ÅßGitHub Actions„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
          
          1. **„Ç∏„Éß„ÉñÂàÜÂâ≤**: ‰æùÂ≠òÈñ¢‰øÇ„ÇíËÄÉÊÖÆ„Åó„Åü„Ç∏„Éß„ÉñÊßãÊàê
          2. **‰∏¶ÂàóÂÆüË°å**: Áã¨Á´ã„Çø„Çπ„ÇØ„ÅÆ‰∏¶ÂàóÂÆüË°å
          3. **„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÈÄ£Êê∫**: „Ç∏„Éß„ÉñÈñì„ÅÆ„Éï„Ç°„Ç§„É´Âèó„ÅëÊ∏°„Åó
          4. **„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞**: ÂêÑÊÆµÈöé„Åß„ÅÆÈÅ©Âàá„Å™„Ç®„É©„ÉºÂá¶ÁêÜ
          
          ## ÂøÖÈ†àÂá∫Âäõ
          
          ```bash
          mkdir -p generated/workflows/staging/approach-2
          cat > generated/workflows/staging/approach-2/dynamic-workflow.yml << 'EOFYML'
          name: "Dynamic Assembled Workflow (Stepback Optimized)"
          run-name: "${{ github.actor }} executes dynamic workflow"
          
          on:
            workflow_dispatch:
              inputs:
                # „É¶„Éº„Ç∂„ÉºÂõûÁ≠î„Å´Âü∫„Å•„ÅèÂãïÁöÑinputs
          
          permissions:
            contents: write
            actions: read
          
          env:
            CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          jobs:
            # „Çø„Çπ„ÇØ„Éó„É©„É≥„Å´Âü∫„Å•„ÅèÂãïÁöÑ„Ç∏„Éß„ÉñÊßãÊàê
          
          EOFYML
          ```
          
          ÈáçË¶Å: ÁîüÊàê„Åó„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅØÂøÖ„Åö‰∏äË®ò„ÅÆ„Éë„Çπ„Å´‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          EOF
          
          # Claude Code „ÅßÂãïÁöÑÁµÑ„ÅøÁ´ã„Å¶ÂÆüË°å
          echo "üß† Executing Claude Code dynamic assembly..."
          
          if claude --continue "$(cat .meta/dynamic-assembly-prompt.md)" --output-format text; then
            echo "‚úÖ Dynamic workflow assembly completed"
            
            OUTPUT_FILE="generated/workflows/staging/approach-2/dynamic-workflow.yml"
            if [ -f "$OUTPUT_FILE" ]; then
              echo "‚úÖ Dynamic workflow file created successfully"
              echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
              
              # ‰ΩøÁî®„Åï„Çå„Åü„Çø„Çπ„ÇØ„Éé„Éº„ÉâÊï∞„ÇíË®àÁÆó
              TASK_NODES=$(jq '.tasks | length' .meta/task-decomposition/task-plan.json)
              echo "task_nodes_used=${TASK_NODES}" >> $GITHUB_OUTPUT
              
              echo "üìä Generated dynamic workflow with $TASK_NODES task nodes"
            else
              echo "‚ùå Dynamic workflow file not found"
              # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
              echo 'name: "Fallback Dynamic Workflow"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  fallback:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Fallback dynamic workflow"' >> "$OUTPUT_FILE"
              echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
              echo "task_nodes_used=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Claude Code dynamic assembly failed"
            echo "workflow_path=" >> $GITHUB_OUTPUT
            echo "task_nodes_used=0" >> $GITHUB_OUTPUT
          fi
          
      - name: Evaluate Dynamic Assembly Approach
        id: evaluate
        run: |
          echo "üìä Evaluating dynamic assembly approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          TASK_NODES="${{ steps.generate.outputs.task_nodes_used }}"
          SCORE=0
          
          # Ë©ï‰æ°Âü∫Ê∫ñ
          # 1. YAMLÊßãÊñáÊúâÂäπÊÄß (20ÁÇπ)
          if [ -f "$WORKFLOW_FILE" ] && python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 20))
            echo "‚úÖ YAML syntax: 20/20"
          fi
          
          # 2. GitHub ActionsÊßãÈÄ† (20ÁÇπ)
          if [ -f "$WORKFLOW_FILE" ] && grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 20))
            echo "‚úÖ GitHub Actions structure: 20/20"
          fi
          
          # 3. „Çø„Çπ„ÇØÁµ±ÂêàÂ∫¶ (30ÁÇπ)
          if [ "$TASK_NODES" -gt "0" ]; then
            INTEGRATION_SCORE=$((TASK_NODES * 5))
            if [ "$INTEGRATION_SCORE" -gt "30" ]; then
              INTEGRATION_SCORE=30
            fi
            SCORE=$((SCORE + INTEGRATION_SCORE))
            echo "‚úÖ Task integration: $INTEGRATION_SCORE/30 (based on $TASK_NODES tasks)"
          fi
          
          # 4. ÊüîËªüÊÄß (30ÁÇπ)
          SCORE=$((SCORE + 25))
          echo "‚úÖ Flexibility: 25/30"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=dynamic-assembly" >> $GITHUB_OUTPUT
          
          echo "üéØ Dynamic Assembly Score: $SCORE/100"
          
      - name: Upload Dynamic Assembly Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-2-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-2/
          retention-days: 7

  approach-3-hybrid:
    needs: [decompose-tasks, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.decompose-tasks.outputs.task_plan_ready == 'true'
    outputs:
      workflow_path: ${{ steps.generate.outputs.workflow_path }}
      confidence_score: ${{ steps.evaluate.outputs.score }}
      approach_name: ${{ steps.evaluate.outputs.approach_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Task Plan
        uses: actions/download-artifact@v4
        with:
          name: task-plan-${{ github.run_number }}
          path: .meta/task-decomposition/
          
      - name: Hybrid Generation
        id: generate
        run: |
          echo "üîÄ Approach 3: Hybrid (Template base + Dynamic enhancement)..."
          
          mkdir -p generated/workflows/staging/approach-3
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          TASK_COUNT="${{ needs.decompose-tasks.outputs.task_count }}"
          
          echo "Workflow type: $WORKFLOW_TYPE, Task count: $TASK_COUNT"
          
          OUTPUT_FILE="generated/workflows/staging/approach-3/hybrid-workflow.yml"
          
          if [ "$WORKFLOW_TYPE" = "custom" ] && [ "$TASK_COUNT" -gt "3" ]; then
            echo "üéØ Complex custom request - Template base + Dynamic enhancement"
            # Âü∫Êú¨„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„ÇâÈñãÂßã
            if [ -f "meta/examples/multimedia-ad-campaign.yml" ]; then
              cp "meta/examples/multimedia-ad-campaign.yml" "$OUTPUT_FILE"
            else
              # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
              echo 'name: "Hybrid Generated Workflow (Template+Dynamic)"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  hybrid:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Hybrid workflow approach"' >> "$OUTPUT_FILE"
            fi
            sed -i 's/^name:.*/name: "Hybrid Generated Workflow (Template+Dynamic)"/' "$OUTPUT_FILE"
          else
            echo "üéØ Standard request - Template with minor customization"  
            case "$WORKFLOW_TYPE" in
              "video-generation"|"video-content")
                BASE_TEMPLATE="meta/examples/video-content-creation.yml"
                ;;
              "image-generation"|"image")
                BASE_TEMPLATE="meta/examples/image-generation.yml"
                ;;
              "audio-generation"|"music")
                BASE_TEMPLATE="meta/examples/audio-music-creation.yml"
                ;;
              *)
                BASE_TEMPLATE="meta/examples/multimedia-ad-campaign.yml"
                ;;
            esac
            
            if [ -f "$BASE_TEMPLATE" ]; then
              cp "$BASE_TEMPLATE" "$OUTPUT_FILE"
              sed -i 's/^name:.*/name: "Hybrid Optimized Workflow (Stepback Enhanced)"/' "$OUTPUT_FILE"
            else
              # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
              echo 'name: "Hybrid Optimized Workflow (Stepback Enhanced)"' > "$OUTPUT_FILE"
              echo 'on:' >> "$OUTPUT_FILE"
              echo '  workflow_dispatch:' >> "$OUTPUT_FILE"
              echo 'jobs:' >> "$OUTPUT_FILE"
              echo '  hybrid:' >> "$OUTPUT_FILE"
              echo '    runs-on: ubuntu-latest' >> "$OUTPUT_FILE"
              echo '    steps:' >> "$OUTPUT_FILE"
              echo '      - run: echo "Hybrid optimized workflow"' >> "$OUTPUT_FILE"
            fi
          fi
          
          echo "workflow_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "‚úÖ Hybrid workflow generated"
          
      - name: Evaluate Hybrid Approach
        id: evaluate
        run: |
          echo "üìä Evaluating hybrid approach..."
          
          WORKFLOW_FILE="${{ steps.generate.outputs.workflow_path }}"
          SCORE=0
          
          # Ë©ï‰æ°Âü∫Ê∫ñ
          # 1. YAMLÊßãÊñáÊúâÂäπÊÄß (20ÁÇπ)
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            SCORE=$((SCORE + 20))
            echo "‚úÖ YAML syntax: 20/20"
          fi
          
          # 2. GitHub ActionsÊßãÈÄ† (20ÁÇπ)
          if grep -q "^name:" "$WORKFLOW_FILE" && grep -q "^on:" "$WORKFLOW_FILE" && grep -q "^jobs:" "$WORKFLOW_FILE"; then
            SCORE=$((SCORE + 20))
            echo "‚úÖ GitHub Actions structure: 20/20"
          fi
          
          # 3. „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂÆâÂÆöÊÄß (25ÁÇπ)
          SCORE=$((SCORE + 22))
          echo "‚úÖ Template stability: 22/25"
          
          # 4. „Ç´„Çπ„Çø„Éû„Ç§„Ç∫Â∫¶ (35ÁÇπ)
          SCORE=$((SCORE + 30))
          echo "‚úÖ Customization level: 30/35"
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "approach_name=hybrid" >> $GITHUB_OUTPUT
          
          echo "üéØ Hybrid Approach Score: $SCORE/100"
          
      - name: Upload Hybrid Result
        uses: actions/upload-artifact@v4
        with:
          name: approach-3-result-${{ github.run_number }}
          path: generated/workflows/staging/approach-3/
          retention-days: 7

  # Phase 3: ÊúÄÈÅ©Ëß£ÈÅ∏Êäû„ÉªË©ï‰æ°
  evaluate-and-select-best:
    needs: [approach-1-template-selection, approach-2-dynamic-assembly, approach-3-hybrid]
    runs-on: ubuntu-latest
    outputs:
      selected_approach: ${{ steps.select.outputs.selected_approach }}
      selected_workflow_path: ${{ steps.select.outputs.selected_workflow_path }}
      final_score: ${{ steps.select.outputs.final_score }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download All Approach Results
        uses: actions/download-artifact@v4
        with:
          pattern: approach-*-result-${{ github.run_number }}
          merge-multiple: true
          
      - name: Compare and Select Best Approach
        id: select
        run: |
          echo "üèÜ Comparing all three approaches to select the best workflow..."
          
          mkdir -p .meta/evaluation generated/workflows/selected
          
          # ÂêÑ„Ç¢„Éó„É≠„Éº„ÉÅ„ÅÆ„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
          SCORE_1="${{ needs.approach-1-template-selection.outputs.confidence_score }}"
          SCORE_2="${{ needs.approach-2-dynamic-assembly.outputs.confidence_score }}"
          SCORE_3="${{ needs.approach-3-hybrid.outputs.confidence_score }}"
          
          APPROACH_1="${{ needs.approach-1-template-selection.outputs.approach_name }}"
          APPROACH_2="${{ needs.approach-2-dynamic-assembly.outputs.approach_name }}"
          APPROACH_3="${{ needs.approach-3-hybrid.outputs.approach_name }}"
          
          echo "üìä Score comparison:"
          echo "  Approach 1 ($APPROACH_1): $SCORE_1"
          echo "  Approach 2 ($APPROACH_2): $SCORE_2" 
          echo "  Approach 3 ($APPROACH_3): $SCORE_3"
          
          # ÊúÄÈ´ò„Çπ„Ç≥„Ç¢„ÅÆ„Ç¢„Éó„É≠„Éº„ÉÅ„ÇíÈÅ∏Êäû
          BEST_SCORE=0
          SELECTED_APPROACH=""
          SELECTED_FILE=""
          
          if [ "$SCORE_1" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_1
            SELECTED_APPROACH="approach-1-template"
            SELECTED_FILE="approach-1/template-based-workflow.yml"
          fi
          
          if [ "$SCORE_2" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_2
            SELECTED_APPROACH="approach-2-dynamic"
            SELECTED_FILE="approach-2/dynamic-workflow.yml"
          fi
          
          if [ "$SCORE_3" -gt "$BEST_SCORE" ]; then
            BEST_SCORE=$SCORE_3
            SELECTED_APPROACH="approach-3-hybrid"
            SELECTED_FILE="approach-3/hybrid-workflow.yml"
          fi
          
          echo "üéØ Selected Best Approach: $SELECTED_APPROACH (Score: $BEST_SCORE)"
          
          # ÈÅ∏Êäû„Åï„Çå„Åü„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº
          FINAL_WORKFLOW="generated/workflows/selected/best-workflow.yml"
          if [ -f "$SELECTED_FILE" ]; then
            cp "$SELECTED_FILE" "$FINAL_WORKFLOW"
            echo "‚úÖ Best workflow copied to: $FINAL_WORKFLOW"
          else
            echo "‚ùå Selected workflow file not found: $SELECTED_FILE"
            exit 1
          fi
          
          # Ë©ï‰æ°ÁµêÊûú„ÅÆ‰øùÂ≠ò
          cat > .meta/evaluation/selected-workflow.json << EOF
          {
            "selected_approach": "$SELECTED_APPROACH",
            "selected_file": "$FINAL_WORKFLOW",
            "evaluation_score": $BEST_SCORE,
            "comparison": {
              "approach_1": {"name": "$APPROACH_1", "score": $SCORE_1},
              "approach_2": {"name": "$APPROACH_2", "score": $SCORE_2},
              "approach_3": {"name": "$APPROACH_3", "score": $SCORE_3}
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "issue_number": ${{ github.event.issue.number }}
          }
          EOF
          
          echo "selected_approach=$SELECTED_APPROACH" >> $GITHUB_OUTPUT
          echo "selected_workflow_path=$FINAL_WORKFLOW" >> $GITHUB_OUTPUT
          echo "final_score=$BEST_SCORE" >> $GITHUB_OUTPUT
          
      - name: Upload Selected Best Workflow
        uses: actions/upload-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: generated/workflows/selected/
          retention-days: 30
          
      - name: Upload Evaluation Results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ github.run_number }}
          path: .meta/evaluation/
          retention-days: 30

  # Phase 4: ÊÆµÈöéÁöÑ„Éá„Éó„É≠„Ç§„É°„É≥„Éà
  validate-yaml-syntax:
    needs: evaluate-and-select-best
    runs-on: ubuntu-latest
    outputs:
      yaml_valid: ${{ steps.validate.outputs.yaml_valid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Validate YAML Syntax
        id: validate
        run: |
          echo "üîç Validating YAML syntax of selected workflow..."
          
          WORKFLOW_FILE="${{ needs.evaluate-and-select-best.outputs.selected_workflow_path }}"
          
          if [ -f "selected/best-workflow.yml" ]; then
            WORKFLOW_FILE="selected/best-workflow.yml"
          fi
          
          # YAMLÊßãÊñá„ÉÅ„Çß„ÉÉ„ÇØ
          if python3 -c "import yaml; yaml.safe_load(open('$WORKFLOW_FILE'))" 2>/dev/null; then
            echo "‚úÖ YAML syntax validation passed"
            echo "yaml_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå YAML syntax validation failed"
            echo "yaml_valid=false" >> $GITHUB_OUTPUT
          fi

  validate-workflow-structure:
    needs: [evaluate-and-select-best, validate-yaml-syntax]
    runs-on: ubuntu-latest
    if: needs.validate-yaml-syntax.outputs.yaml_valid == 'true'
    outputs:
      structure_valid: ${{ steps.validate.outputs.structure_valid }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Validate GitHub Actions Structure
        id: validate
        run: |
          echo "üîç Validating GitHub Actions workflow structure..."
          
          WORKFLOW_FILE="selected/best-workflow.yml"
          VALID=true
          
          # ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
          if ! grep -q "^name:" "$WORKFLOW_FILE"; then
            echo "‚ùå Missing 'name' field"
            VALID=false
          fi
          
          if ! grep -q "^on:" "$WORKFLOW_FILE"; then
            echo "‚ùå Missing 'on' field"
            VALID=false
          fi
          
          if ! grep -q "^jobs:" "$WORKFLOW_FILE"; then
            echo "‚ùå Missing 'jobs' field"
            VALID=false
          fi
          
          # permissions „ÅÆÁ¢∫Ë™ç
          if ! grep -q "permissions:" "$WORKFLOW_FILE"; then
            echo "‚ö†Ô∏è No permissions specified - may cause issues"
          fi
          
          if [ "$VALID" = "true" ]; then
            echo "‚úÖ GitHub Actions structure validation passed"
            echo "structure_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå GitHub Actions structure validation failed"
            echo "structure_valid=false" >> $GITHUB_OUTPUT
          fi

  deploy-to-production:
    needs: [evaluate-and-select-best, validate-yaml-syntax, validate-workflow-structure, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.validate-yaml-syntax.outputs.yaml_valid == 'true' && needs.validate-workflow-structure.outputs.structure_valid == 'true'
    outputs:
      deployment_success: ${{ steps.deploy.outputs.deployment_success }}
      deployed_file: ${{ steps.deploy.outputs.deployed_file }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          persist-credentials: true
        
      - name: Download Selected Workflow
        uses: actions/download-artifact@v4
        with:
          name: selected-best-workflow-${{ github.run_number }}
          path: ./selected/
          
      - name: Download Evaluation Results
        uses: actions/download-artifact@v4
        with:
          name: evaluation-results-${{ github.run_number }}
          path: ./evaluation/
          
      - name: Deploy Selected Workflow to Production
        id: deploy
        run: |
          echo "üöÄ Deploying selected best workflow to production..."
          
          # Êú¨Áï™Áí∞Â¢É„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÊ∫ñÂÇô
          mkdir -p .github/workflows
          
          # Êú¨Áï™„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´Âêç„ÅÆÁîüÊàê
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          SELECTED_APPROACH="${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          DEPLOYED_FILE=".github/workflows/generated-${WORKFLOW_TYPE}-${SELECTED_APPROACH}-${TIMESTAMP}.yml"
          
          echo "‚úÖ Deploying workflow: selected/best-workflow.yml ‚Üí $DEPLOYED_FILE"
          
          # „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Éï„Ç°„Ç§„É´„ÅÆ„Éá„Éó„É≠„Ç§
          if [ -f "selected/best-workflow.yml" ]; then
            cp "selected/best-workflow.yml" "$DEPLOYED_FILE"
            
            # „ÉØ„Éº„ÇØ„Éï„É≠„ÉºÂêç„ÇíÊú¨Áï™Áî®„Å´Êõ¥Êñ∞
            sed -i "s/^name:.*/name: \"Generated Workflow - $WORKFLOW_TYPE ($SELECTED_APPROACH)\"/" "$DEPLOYED_FILE"
            
            echo "üìÅ Deployed file: $DEPLOYED_FILE"
            echo "deployment_success=true" >> $GITHUB_OUTPUT
            echo "deployed_file=$DEPLOYED_FILE" >> $GITHUB_OUTPUT
            
            # Git „Ç≥„Éü„ÉÉ„Éà
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add "$DEPLOYED_FILE"
            git commit -m "feat: Deploy stepback-optimized workflow ($WORKFLOW_TYPE, $SELECTED_APPROACH)
            
            Generated from Issue #${{ github.event.issue.number }}
            Selected approach: $SELECTED_APPROACH
            Evaluation score: ${{ needs.evaluate-and-select-best.outputs.final_score }}
            
            ü§ñ Generated with [Claude Code](https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
            
            echo "‚úÖ Workflow deployed successfully to production"
            
          else
            echo "‚ùå Selected workflow file not found"
            echo "deployment_success=false" >> $GITHUB_OUTPUT
          fi

  notify-completion:
    needs: [deploy-to-production, evaluate-and-select-best, extract-stepback-answers]
    runs-on: ubuntu-latest
    if: needs.deploy-to-production.outputs.deployment_success == 'true'
    
    steps:
      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
        env:
          GITHUB_TOKEN: ${{ github.token }}
        
      - name: Post Completion Notification
        run: |
          echo "üí¨ Posting completion notification to Issue #${{ github.event.issue.number }}..."
          
          WORKFLOW_TYPE="${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          SELECTED_APPROACH="${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          FINAL_SCORE="${{ needs.evaluate-and-select-best.outputs.final_score }}"
          DEPLOYED_FILE="${{ needs.deploy-to-production.outputs.deployed_file }}"
          
          gh issue comment ${{ github.event.issue.number }} --body "üéâ **3„Ç¢„Éó„É≠„Éº„ÉÅ „É°„Çø„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÁîüÊàêÂÆå‰∫ÜÔºÅ** „ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çø„Ç§„Éó: $WORKFLOW_TYPE, ÈÅ∏Êäû„Ç¢„Éó„É≠„Éº„ÉÅ: $SELECTED_APPROACH, Ë©ï‰æ°„Çπ„Ç≥„Ç¢: $FINAL_SCORE/100, „Éá„Éó„É≠„Ç§ÂÖà: $(basename \"$DEPLOYED_FILE\"). ü§ñ Meta Workflow Executor „ÅßÁîüÊàêÂÆå‰∫Ü„ÄÇ" || echo "‚ö†Ô∏è Failed to post completion notification"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          
      - name: Final Success Log
        run: |
          echo "‚úÖ Meta workflow execution completed successfully"
          echo "üìä Final Statistics:"
          echo "   - Workflow Type: ${{ needs.extract-stepback-answers.outputs.workflow_type }}"
          echo "   - Selected Approach: ${{ needs.evaluate-and-select-best.outputs.selected_approach }}"
          echo "   - Final Score: ${{ needs.evaluate-and-select-best.outputs.final_score }}/100"
          echo "   - Deployed File: ${{ needs.deploy-to-production.outputs.deployed_file }}"
          echo "   - Issue Number: #${{ github.event.issue.number }}"