name: "Professional News Video Creation Workflow"

on:
  workflow_dispatch:
    inputs:
      news_topic:
        description: "„Éã„É•„Éº„ÇπÂãïÁîª„ÅÆ„Éà„Éî„ÉÉ„ÇØÔºà‰æãÔºöAIÊäÄË°ì„ÅÆÈÄ≤Ê≠©„ÄÅÊ∞óÂÄôÂ§âÂãïÂØæÁ≠ñ„Å™„Å©Ôºâ"
        required: true
        default: "AIÊäÄË°ì„ÅÆÊúÄÊñ∞ÂãïÂêë"
      time_period:
        description: "ÂØæË±°ÊúüÈñìÔºà‰æãÔºölast 7 days, last monthÔºâ"
        required: true
        default: "last 7 days"
      video_style:
        description: "ÂãïÁîª„Çπ„Çø„Ç§„É´Ôºàformal/urgent/neutralÔºâ"
        required: false
        default: "formal"

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true
  PROJECT_NAME: "news-video"

jobs:
  # Phase 1: ÊÉÖÂ†±ÂèéÈõÜ„Éï„Çß„Éº„Ç∫
  gather-news-info:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      search_results: ${{ steps.search.outputs.results_file }}
      timestamp: ${{ steps.setup.outputs.timestamp }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Setup project directory
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_DIR="${GITHUB_WORKSPACE}/projects/${PROJECT_NAME}-${TIMESTAMP}"
          mkdir -p "${PROJECT_DIR}"/{metadata,logs,media/{images,videos,audio},final}
          echo "project_dir=${PROJECT_DIR}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "[$(date)] Project setup completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: News information gathering
        id: search
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ steps.setup.outputs.project_dir }}"
          
          SEARCH_PROMPT="ÊåáÂÆö„Åï„Çå„Åü„Éà„Éî„ÉÉ„ÇØ„Äå${{ inputs.news_topic }}„Äç„Å´„Å§„ÅÑ„Å¶„ÄÅ${{ inputs.time_period }}„ÅÆÊúüÈñì„ÅßÊúÄÊñ∞„Éã„É•„Éº„Çπ„ÇíÂèéÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË§áÊï∞„ÅÆ‰ø°È†ºÊÄß„ÅÆÈ´ò„ÅÑÊÉÖÂ†±Ê∫ê„Åã„ÇâÊÉÖÂ†±„ÇíÂèéÈõÜ„Åó„ÄÅÈáçË¶ÅÂ∫¶„Å®„Ç§„É≥„Éë„ÇØ„Éà„Å´Âü∫„Å•„ÅÑ„Å¶ÈÅ∏Âà•„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁµêÊûú„ÅØJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
          
          npx @anthropic-ai/claude-code \
            -p "${SEARCH_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Read" \
            --max-turns 10 \
            --permission-mode "acceptEdits"
            
          # Find and standardize search results file
          RESULTS_FILE=$(find . -name "*search*" -o -name "*news*" -o -name "*results*" | grep -E "\.(json|txt)$" | head -1)
          if [ -z "$RESULTS_FILE" ]; then
            echo '{"error": "No search results file found", "status": "failed"}' > "${PROJECT_DIR}/metadata/search_results.json"
            RESULTS_FILE="${PROJECT_DIR}/metadata/search_results.json"
          else
            cp "$RESULTS_FILE" "${PROJECT_DIR}/metadata/search_results.json"
            RESULTS_FILE="${PROJECT_DIR}/metadata/search_results.json"
          fi
          
          echo "results_file=${RESULTS_FILE}" >> $GITHUB_OUTPUT
          echo "[$(date)] News gathering completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload search results
        uses: actions/upload-artifact@v4
        with:
          name: search-results-${{ steps.setup.outputs.timestamp }}
          path: ${{ steps.setup.outputs.project_dir }}/metadata/
          retention-days: 1

  # Phase 2: „Ç≥„É≥„ÉÜ„É≥„ÉÑ‰ºÅÁîª„Éï„Çß„Éº„Ç∫  
  create-news-script:
    runs-on: ubuntu-latest
    needs: gather-news-info
    timeout-minutes: 15
    outputs:
      script_file: ${{ steps.script.outputs.script_file }}
      scene_count: ${{ steps.script.outputs.scene_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download search results
        uses: actions/download-artifact@v4
        with:
          name: search-results-${{ needs.gather-news-info.outputs.timestamp }}
          path: metadata/
          
      - name: Create script structure
        id: script
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          SCRIPT_PROMPT="ÂèéÈõÜ„Åó„Åü„Éã„É•„Éº„ÇπÊÉÖÂ†±„ÇíÂü∫„Å´„ÄÅ60Áßí„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éã„É•„Éº„ÇπÂãïÁîªÁî®„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- Ë¶ñËÅ¥ËÄÖÂøÉÁêÜ„ÇíËÄÉÊÖÆ„Åó„ÅüÊßãÊàêÔºàÊúÄÂàù„ÅÆ3Áßí„Åß„Éï„ÉÉ„ÇØ„ÄÅÊÑüÊÉÖÁöÑ„Ç¢„Éº„ÇØÊßãÈÄ†Ôºâ
- 60Áßí„Å´ÈÅ©„Åó„ÅüÊñáÂ≠óÊï∞Ôºà150-180Ë™ûÔºâ
- 12„Ç∑„Éº„É≥„ÅÆÊßãÊàêÔºàÂêÑ5ÁßíÔºâ
- ÂêÑ„Ç∑„Éº„É≥„Å´ÁîªÂÉèÁîüÊàêÁî®„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂê´„ÇÅ„Çã
- „Éã„É•„Éº„ÇπÁï™ÁµÑ„ÅÆÊ®©Â®ÅÊÄß„Çí‰øù„Å§„Éà„Éº„É≥

ÂÖ•Âäõ„Éï„Ç°„Ç§„É´: metadata/search_results.json
Âá∫Âäõ: content_plan.jsonÔºà„Ç∑„Éº„É≥ÊßãÊàê„ÄÅ„Éä„É¨„Éº„Ç∑„Éß„É≥„ÄÅÁîªÂÉè„Éó„É≠„É≥„Éó„Éà„ÇíÂê´„ÇÄÔºâ"

          npx @anthropic-ai/claude-code \
            -p "${SCRIPT_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Read,Write,Edit" \
            --max-turns 15 \
            --permission-mode "acceptEdits"
            
          # Find script file
          SCRIPT_FILE=$(find . -name "*content*" -o -name "*script*" -o -name "*plan*" | grep "\.json$" | head -1)
          if [ -z "$SCRIPT_FILE" ]; then
            echo '{"error": "Script generation failed"}' > content_plan.json
            SCRIPT_FILE="content_plan.json"
          fi
          
          # Extract scene count
          SCENE_COUNT=$(jq -r '.scenes | length // 12' "$SCRIPT_FILE" 2>/dev/null || echo "12")
          
          # Copy to project directory
          mkdir -p "${PROJECT_DIR}/metadata"
          cp "$SCRIPT_FILE" "${PROJECT_DIR}/metadata/content_plan.json"
          
          echo "script_file=${PROJECT_DIR}/metadata/content_plan.json" >> $GITHUB_OUTPUT
          echo "scene_count=${SCENE_COUNT}" >> $GITHUB_OUTPUT
          echo "[$(date)] Script creation completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload script
        uses: actions/upload-artifact@v4
        with:
          name: script-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/metadata/content_plan.json
          retention-days: 1

  # Phase 3: ‰∏¶ÂàóÁ¥†ÊùêÁîüÊàê„Éï„Çß„Éº„Ç∫
  generate-narration:
    runs-on: ubuntu-latest
    needs: [gather-news-info, create-news-script]
    timeout-minutes: 10
    outputs:
      audio_file: ${{ steps.narration.outputs.audio_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download script
        uses: actions/download-artifact@v4
        with:
          name: script-${{ needs.gather-news-info.outputs.timestamp }}
          path: ./
          
      - name: Generate professional narration
        id: narration
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          NARRATION_PROMPT="„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éó„É©„É≥„Åã„ÇâÊó•Êú¨Ë™û„Éä„É¨„Éº„Ç∑„Éß„É≥Èü≥Â£∞„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- „Éã„É•„Éº„Çπ„Ç≠„É£„Çπ„Çø„ÉºÈ¢®„ÅÆÊ®©Â®ÅÁöÑ„ÅßËêΩ„Å°ÁùÄ„ÅÑ„Åü„Éà„Éº„É≥
- 60Áßí„ÅÆÈï∑„Åï„Å´Ë™øÊï¥
- -14LUFSÂü∫Ê∫ñ„Åß„ÅÆÈü≥Â£∞„É¨„Éô„É´Ê≠£Ë¶èÂåñ
- ÈÅ©Âàá„Å™Èñì„ÅÆÈÖçÁΩÆ„Å®„Ç§„É≥„Éà„Éç„Éº„Ç∑„Éß„É≥

ÂÖ•Âäõ: content_plan.json
Âá∫Âäõ: „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™Êó•Êú¨Ë™ûÈü≥Â£∞„Éï„Ç°„Ç§„É´"

          npx @anthropic-ai/claude-code \
            -p "${NARRATION_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_submit,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_status,mcp__t2s-fal-minimax-speech-02-turbo__minimax_speech_02_turbo_result,Read,Write" \
            --max-turns 15 \
            --permission-mode "acceptEdits"
            
          # Find generated audio file
          AUDIO_FILE=$(find . -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
          if [ -z "$AUDIO_FILE" ]; then
            echo "No audio file generated" >&2
            exit 1
          fi
          
          # Copy to project directory
          mkdir -p "${PROJECT_DIR}/media/audio"
          cp "$AUDIO_FILE" "${PROJECT_DIR}/media/audio/narration.mp3"
          
          echo "audio_file=${PROJECT_DIR}/media/audio/narration.mp3" >> $GITHUB_OUTPUT
          echo "[$(date)] Narration generation completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload narration
        uses: actions/upload-artifact@v4
        with:
          name: narration-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/audio/
          retention-days: 1

  generate-background-images-batch1:
    runs-on: ubuntu-latest
    needs: [gather-news-info, create-news-script]
    timeout-minutes: 15
    outputs:
      images_generated: ${{ steps.images.outputs.images_count }}
      batch_complete: ${{ steps.images.outputs.batch_complete }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download script
        uses: actions/download-artifact@v4
        with:
          name: script-${{ needs.gather-news-info.outputs.timestamp }}
          path: ./
          
      - name: Generate news background images (Batch 1)
        id: images
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          IMAGES_PROMPT="„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éó„É©„É≥„ÅÆÊúÄÂàù„ÅÆ6„Ç∑„Éº„É≥Áî®„ÅÆËÉåÊôØÁîªÂÉè„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éã„É•„Éº„ÇπÁï™ÁµÑ„Çπ„Çø„Ç§„É´
- 1920x1080Ëß£ÂÉèÂ∫¶
- ÈùíÁ≥ªÔºà‰ø°È†ºÊÄßÔºâ„Å®Ëµ§Á≥ªÔºàÁ∑äÊÄ•ÊÄßÔºâ„ÅÆ„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà
- Rule of thirds„Å´Âü∫„Å•„ÅÑ„ÅüÊßãÂõ≥
- „Éã„É•„Éº„ÇπÁï™ÁµÑ„ÅÆÊ®©Â®ÅÊÄß„ÇíË°®Áèæ

ÂÖ•Âäõ: content_plan.jsonÔºà„Ç∑„Éº„É≥1-6Ôºâ
Âá∫Âäõ: 6Êûö„ÅÆÈ´òÂìÅË≥™ËÉåÊôØÁîªÂÉè"

          npx @anthropic-ai/claude-code \
            -p "${IMAGES_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result,Read,Write" \
            --max-turns 20 \
            --permission-mode "acceptEdits"
            
          # Count generated images
          IMAGE_COUNT=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
          
          # Copy images to project directory
          mkdir -p "${PROJECT_DIR}/media/images"
          for img in *.png *.jpg *.jpeg 2>/dev/null; do
            if [ -f "$img" ]; then
              cp "$img" "${PROJECT_DIR}/media/images/"
            fi
          done
          
          echo "images_count=${IMAGE_COUNT}" >> $GITHUB_OUTPUT
          echo "batch_complete=true" >> $GITHUB_OUTPUT
          echo "[$(date)] Batch 1 images generated: ${IMAGE_COUNT}" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload batch 1 images
        uses: actions/upload-artifact@v4
        with:
          name: images-batch1-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/images/
          retention-days: 1

  convert-videos-batch1:
    runs-on: ubuntu-latest
    needs: [gather-news-info, generate-background-images-batch1]
    timeout-minutes: 20
    outputs:
      videos_count: ${{ steps.convert.outputs.videos_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download batch 1 images
        uses: actions/download-artifact@v4
        with:
          name: images-batch1-${{ needs.gather-news-info.outputs.timestamp }}
          path: images/
          
      - name: Convert images to videos (Batch 1)
        id: convert
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          CONVERT_PROMPT="ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÂãïÁöÑ„Å™ËÉåÊôØÂãïÁîª„Å´Â§âÊèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇURLÊúüÈôêÂØæÁ≠ñ„Å®„Åó„Å¶Âç≥Â∫ß„Å´Âá¶ÁêÜÂÆüË°å„ÄÇ

Ë¶Å‰ª∂:
- ÂêÑÂãïÁîª5-8Áßí„ÅÆÈï∑„Åï
- 1920x1080@30fps
- „Çπ„É†„Éº„Ç∫„Å™„Ç´„É°„É©„ÉØ„Éº„ÇØ
- „Éã„É•„Éº„ÇπÁï™ÁµÑ„Å´ÈÅ©„Åó„ÅüÂãï„ÅçÔºàsubtle motionÔºâ
- ÊúüÈôêÂàá„Çå„ÇíÈò≤„Åê„Åü„ÇÅËøÖÈÄü„Å™Âá¶ÁêÜ

ÂÖ•Âäõ: images/„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÁîªÂÉè„Éï„Ç°„Ç§„É´
Âá∫Âäõ: ÂØæÂøú„Åô„ÇãÂãïÁîª„Éï„Ç°„Ç§„É´"

          npx @anthropic-ai/claude-code \
            -p "${CONVERT_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_submit,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_status,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_result,Read,Write" \
            --max-turns 25 \
            --permission-mode "acceptEdits"
            
          # Count generated videos
          VIDEO_COUNT=$(find . -name "*.mp4" | wc -l)
          
          # Copy videos to project directory
          mkdir -p "${PROJECT_DIR}/media/videos"
          for video in *.mp4 2>/dev/null; do
            if [ -f "$video" ]; then
              cp "$video" "${PROJECT_DIR}/media/videos/"
            fi
          done
          
          echo "videos_count=${VIDEO_COUNT}" >> $GITHUB_OUTPUT
          echo "[$(date)] Batch 1 videos converted: ${VIDEO_COUNT}" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload batch 1 videos
        uses: actions/upload-artifact@v4
        with:
          name: videos-batch1-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/videos/
          retention-days: 1

  generate-background-images-batch2:
    runs-on: ubuntu-latest
    needs: [gather-news-info, create-news-script, generate-background-images-batch1]
    timeout-minutes: 15
    outputs:
      images_generated: ${{ steps.images.outputs.images_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download script
        uses: actions/download-artifact@v4
        with:
          name: script-${{ needs.gather-news-info.outputs.timestamp }}
          path: ./
          
      - name: Generate news background images (Batch 2)
        id: images
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          IMAGES_PROMPT="„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éó„É©„É≥„ÅÆÊÆã„Çä6„Ç∑„Éº„É≥Áî®„ÅÆËÉåÊôØÁîªÂÉè„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- „Éê„ÉÉ„ÉÅ1„Å®„ÅÆË¶ñË¶öÁöÑ‰∏ÄË≤´ÊÄßÁ∂≠ÊåÅ
- „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éã„É•„Éº„ÇπÁï™ÁµÑ„Çπ„Çø„Ç§„É´
- 1920x1080Ëß£ÂÉèÂ∫¶
- Âêå‰∏Ä„Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàÔºàÈùíÁ≥ªtrustÂü∫Ë™øÔºâ
- ÂæåÂçäÈÉ®ÂàÜ„Å´„Çà„ÇäÂãïÁöÑ„Å™ÊßãÂõ≥Êé°Áî®ÂèØËÉΩ

ÂÖ•Âäõ: content_plan.jsonÔºà„Ç∑„Éº„É≥7-12Ôºâ
Âá∫Âäõ: 6Êûö„ÅÆÈ´òÂìÅË≥™ËÉåÊôØÁîªÂÉèÔºàÁµ±‰∏Ä„Çπ„Çø„Ç§„É´Ôºâ"

          npx @anthropic-ai/claude-code \
            -p "${IMAGES_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,mcp__t2i-fal-flux-schnell__flux_schnell_submit,mcp__t2i-fal-flux-schnell__flux_schnell_status,mcp__t2i-fal-flux-schnell__flux_schnell_result,Read,Write" \
            --max-turns 20 \
            --permission-mode "acceptEdits"
            
          # Count generated images
          IMAGE_COUNT=$(find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | wc -l)
          
          # Copy images to project directory
          mkdir -p "${PROJECT_DIR}/media/images"
          for img in *.png *.jpg *.jpeg 2>/dev/null; do
            if [ -f "$img" ]; then
              cp "$img" "${PROJECT_DIR}/media/images/"
            fi
          done
          
          echo "images_count=${IMAGE_COUNT}" >> $GITHUB_OUTPUT
          echo "[$(date)] Batch 2 images generated: ${IMAGE_COUNT}" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload batch 2 images
        uses: actions/upload-artifact@v4
        with:
          name: images-batch2-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/images/
          retention-days: 1

  generate-title-cards:
    runs-on: ubuntu-latest
    needs: [gather-news-info, create-news-script]
    timeout-minutes: 10
    outputs:
      title_cards: ${{ steps.titles.outputs.cards_generated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download search results and script
        uses: actions/download-artifact@v4
        with:
          name: search-results-${{ needs.gather-news-info.outputs.timestamp }}
          path: metadata/
          
      - name: Download script
        uses: actions/download-artifact@v4
        with:
          name: script-${{ needs.gather-news-info.outputs.timestamp }}
          path: ./
          
      - name: Create title and source cards
        id: titles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          TITLE_PROMPT="„Éã„É•„Éº„ÇπÂãïÁîªÁî®„ÅÆ„Çø„Ç§„Éà„É´„Ç´„Éº„Éâ„Å®ÊÉÖÂ†±Ê∫êË°®Á§∫„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- ÂÜíÈ†≠„Å®ÁµÇ‰∫ÜÊôÇ„Å´Ë°®Á§∫„Åô„Çã„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éá„Ç∂„Ç§„É≥
- È´ò„ÅÑÂèØË™≠ÊÄßÔºàÈÅ©Âàá„Å™„Éï„Ç©„É≥„ÉàÈÅ∏Êäû„ÄÅ„Ç≥„É≥„Éà„É©„Çπ„ÉàÁ¢∫‰øùÔºâ
- ÊÉÖÂ†±Ê∫ê„ÅÆÂÆåÂÖ®ÊòéË®òÔºàÂ†±ÈÅìÂÄ´ÁêÜÔºâ
- 1920x1080ÂØæÂøú
- „Éã„É•„Éº„ÇπÁï™ÁµÑ„ÅÆÊ†ºÂºèÁ∂≠ÊåÅ

ÂÖ•Âäõ: metadata/search_results.json, content_plan.json
Âá∫Âäõ: „Çø„Ç§„Éà„É´„Ç´„Éº„Éâ„ÄÅÊÉÖÂ†±Ê∫ê„Ç´„Éº„Éâ"

          npx @anthropic-ai/claude-code \
            -p "${TITLE_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2i-google-imagen3__imagen_t2i,Read,Write" \
            --max-turns 15 \
            --permission-mode "acceptEdits"
            
          # Count generated cards
          CARD_COUNT=$(find . -name "*title*" -o -name "*card*" -o -name "*source*" | grep -E "\.(png|jpg|jpeg)$" | wc -l)
          
          # Copy cards to project directory
          mkdir -p "${PROJECT_DIR}/media/images"
          for card in *title* *card* *source* 2>/dev/null; do
            if [[ "$card" =~ \.(png|jpg|jpeg)$ ]] && [ -f "$card" ]; then
              cp "$card" "${PROJECT_DIR}/media/images/"
            fi
          done
          
          echo "cards_generated=${CARD_COUNT}" >> $GITHUB_OUTPUT
          echo "[$(date)] Title cards generated: ${CARD_COUNT}" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload title cards
        uses: actions/upload-artifact@v4
        with:
          name: title-cards-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/images/
          retention-days: 1

  # Phase 5: ‰∏¶Âàó‰ªï‰∏ä„Åí„Éï„Çß„Éº„Ç∫
  convert-videos-batch2:
    runs-on: ubuntu-latest
    needs: [gather-news-info, generate-background-images-batch2]
    timeout-minutes: 20
    outputs:
      videos_count: ${{ steps.convert.outputs.videos_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download batch 2 images
        uses: actions/download-artifact@v4
        with:
          name: images-batch2-${{ needs.gather-news-info.outputs.timestamp }}
          path: images/
          
      - name: Convert images to videos (Batch 2)
        id: convert
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          CONVERT_PROMPT="„Éê„ÉÉ„ÉÅ2„ÅÆÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÂãïÁöÑ„Å™ËÉåÊôØÂãïÁîª„Å´Â§âÊèõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- „Éê„ÉÉ„ÉÅ1„Å®„ÅÆÊäÄË°ì‰ªïÊßòÁµ±‰∏ÄÔºà1920x1080@30fpsÔºâ
- ÂêÑÂãïÁîª5-8Áßí„ÅÆÈï∑„Åï
- „Éï„É¨„Éº„É†„É¨„Éº„ÉàÁµ±‰∏ÄÂøÖÈ†à
- ÂêåÊßò„ÅÆ„Ç´„É°„É©„ÉØ„Éº„ÇØÂìÅË≥™
- URLÊúüÈôêÂØæÁ≠ñ„Å®„Åó„Å¶ËøÖÈÄüÂá¶ÁêÜ

ÂÖ•Âäõ: images/„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÁîªÂÉè„Éï„Ç°„Ç§„É´
Âá∫Âäõ: Áµ±‰∏Ä‰ªïÊßò„ÅÆÂãïÁîª„Éï„Ç°„Ç§„É´"

          npx @anthropic-ai/claude-code \
            -p "${CONVERT_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__i2v-fal-hailuo-02-pro__hailuo_02_submit,mcp__i2v-fal-hailuo-02-pro__hailuo_02_status,mcp__i2v-fal-hailuo-02-pro__hailuo_02_result,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_submit,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_status,mcp__i2v-fal-bytedance-seedance-v1-lite__bytedance_seedance_v1_lite_i2v_result,Read,Write" \
            --max-turns 25 \
            --permission-mode "acceptEdits"
            
          # Count generated videos
          VIDEO_COUNT=$(find . -name "*.mp4" | wc -l)
          
          # Copy videos to project directory
          mkdir -p "${PROJECT_DIR}/media/videos"
          for video in *.mp4 2>/dev/null; do
            if [ -f "$video" ]; then
              cp "$video" "${PROJECT_DIR}/media/videos/"
            fi
          done
          
          echo "videos_count=${VIDEO_COUNT}" >> $GITHUB_OUTPUT
          echo "[$(date)] Batch 2 videos converted: ${VIDEO_COUNT}" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload batch 2 videos
        uses: actions/upload-artifact@v4
        with:
          name: videos-batch2-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/videos/
          retention-days: 1

  generate-bgm:
    runs-on: ubuntu-latest
    needs: [gather-news-info, generate-narration]
    timeout-minutes: 15
    outputs:
      bgm_file: ${{ steps.bgm.outputs.bgm_file }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Download narration
        uses: actions/download-artifact@v4
        with:
          name: narration-${{ needs.gather-news-info.outputs.timestamp }}
          path: audio/
          
      - name: Generate news BGM
        id: bgm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          BGM_PROMPT="„Éã„É•„Éº„ÇπÁï™ÁµÑÁî®„ÅÆ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™BGM„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ë¶Å‰ª∂:
- „Éã„É•„Éº„ÇπÁï™ÁµÑÁâπÊúâ„ÅÆÂé≥Ê†º„Åß‰ø°È†ºÊÑü„ÅÆ„ÅÇ„ÇãÊ•ΩÊõ≤
- 60Áßí„ÅÆÈï∑„Åï
- „Éä„É¨„Éº„Ç∑„Éß„É≥Â∏ØÂüü„ÇíÈÅø„Åë„ÅüÂë®Ê≥¢Êï∞ÊßãÊàê
- -20dBÁ®ãÂ∫¶„ÅÆÈü≥ÈáèË®≠ÂÆöÔºà„Éä„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÇ™È≠î„Åó„Å™„ÅÑÔºâ
- Ê®©Â®ÅÊÄß„Å®‰ø°È†ºÊÄß„ÇíÊîØ„Åà„ÇãÊ•ΩÊõ≤ÊßãÊàê

Âá∫Âäõ: „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éã„É•„Éº„ÇπÁï™ÁµÑÁî®BGM"

          npx @anthropic-ai/claude-code \
            -p "${BGM_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "mcp__t2m-google-lyria__lyria_generate,Read,Write" \
            --max-turns 15 \
            --permission-mode "acceptEdits"
            
          # Find generated BGM file
          BGM_FILE=$(find . -name "*.mp3" -o -name "*.wav" -o -name "*.m4a" | head -1)
          if [ -z "$BGM_FILE" ]; then
            echo "No BGM file generated" >&2
            exit 1
          fi
          
          # Copy to project directory
          mkdir -p "${PROJECT_DIR}/media/audio"
          cp "$BGM_FILE" "${PROJECT_DIR}/media/audio/bgm.mp3"
          
          echo "bgm_file=${PROJECT_DIR}/media/audio/bgm.mp3" >> $GITHUB_OUTPUT
          echo "[$(date)] BGM generation completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload BGM
        uses: actions/upload-artifact@v4
        with:
          name: bgm-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/media/audio/
          retention-days: 1

  # Phase 6: Áµ±Âêà„ÉªÂÆåÊàê„Éï„Çß„Éº„Ç∫
  integrate-final-video:
    runs-on: ubuntu-latest
    needs: [gather-news-info, convert-videos-batch1, convert-videos-batch2, generate-narration, generate-bgm, generate-title-cards]
    timeout-minutes: 25
    outputs:
      final_video: ${{ steps.integrate.outputs.final_video }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
      - name: Download all materials
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ needs.gather-news-info.outputs.timestamp }}"
          path: materials/
          merge-multiple: true
          
      - name: Integrate all materials
        id: integrate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          # Copy all materials to working directory
          cp -r materials/* . 2>/dev/null || true
          
          INTEGRATION_PROMPT="„Åô„Åπ„Å¶„ÅÆÁîüÊàêÁ¥†Êùê„ÇíÁµ±Âêà„Åó„Å¶60Áßí„ÅÆÂÆåÊàê„Éã„É•„Éº„ÇπÂãïÁîª„ÇíÂà∂‰Ωú„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Âà©Áî®ÂèØËÉΩÁ¥†Êùê:
- ËÉåÊôØÂãïÁîª„ÇØ„É™„ÉÉ„ÉóÔºà12ÂÄãÔºâ
- „Éä„É¨„Éº„Ç∑„Éß„É≥Èü≥Â£∞
- BGM
- „Çø„Ç§„Éà„É´„Ç´„Éº„Éâ

Ë¶Å‰ª∂:
- „Éä„É¨„Éº„Ç∑„Éß„É≥„Å´Âêà„Çè„Åõ„Åü„Ç∑„Éº„É≥Âàá„ÇäÊõø„Åà
- ÈÅ©Âàá„Å™„Éà„É©„É≥„Ç∏„Ç∑„Éß„É≥ËøΩÂä†
- Èü≥Â£∞„É¨„Éô„É´Áµ±‰∏ÄÔºà-14LUFSÔºâ
- 60Áßí¬±2Áßí„ÅÆÂ∞∫Ë™øÊï¥
- „Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™ÊúÄÁµÇÂìÅË≥™

Âá∫Âäõ: ÈÖç‰ø°Ê∫ñÂÇôÂÆå‰∫Ü„ÅÆÂÆåÊàêÂãïÁîª"

          npx @anthropic-ai/claude-code \
            -p "${INTEGRATION_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Bash,Read,Write,Edit" \
            --max-turns 20 \
            --permission-mode "acceptEdits"
            
          # Find final video
          FINAL_VIDEO=$(find . -name "*final*" -o -name "*complete*" -o -name "*news*" | grep "\.mp4$" | head -1)
          if [ -z "$FINAL_VIDEO" ]; then
            # Create basic concatenation as fallback
            VIDEO_LIST=$(find . -name "*.mp4" | head -12 | sort)
            if [ -n "$VIDEO_LIST" ]; then
              {
                for video in $VIDEO_LIST; do
                  echo "file '$video'"
                done
              } > video_list.txt
              
              ffmpeg -f concat -safe 0 -i video_list.txt -c copy temp_concat.mp4
              
              # Add audio if available
              NARRATION=$(find . -name "*narration*" | grep -E "\.(mp3|wav|m4a)$" | head -1)
              BGM=$(find . -name "*bgm*" | grep -E "\.(mp3|wav|m4a)$" | head -1)
              
              if [ -n "$NARRATION" ] && [ -n "$BGM" ]; then
                ffmpeg -i temp_concat.mp4 -i "$NARRATION" -i "$BGM" \
                  -filter_complex "[1:a]volume=1.0[narr];[2:a]volume=0.3[bgm];[narr][bgm]amix=inputs=2[audio]" \
                  -map 0:v -map "[audio]" -c:v copy -c:a aac \
                  -t 60 final_news_video.mp4
              elif [ -n "$NARRATION" ]; then
                ffmpeg -i temp_concat.mp4 -i "$NARRATION" \
                  -map 0:v -map 1:a -c:v copy -c:a aac \
                  -t 60 final_news_video.mp4
              else
                cp temp_concat.mp4 final_news_video.mp4
              fi
              
              FINAL_VIDEO="final_news_video.mp4"
            fi
          fi
          
          if [ -z "$FINAL_VIDEO" ] || [ ! -f "$FINAL_VIDEO" ]; then
            echo "Final video creation failed" >&2
            exit 1
          fi
          
          # Copy to project directory
          mkdir -p "${PROJECT_DIR}/final"
          cp "$FINAL_VIDEO" "${PROJECT_DIR}/final/news_video_final.mp4"
          
          echo "final_video=${PROJECT_DIR}/final/news_video_final.mp4" >> $GITHUB_OUTPUT
          echo "[$(date)] Video integration completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload final video
        uses: actions/upload-artifact@v4
        with:
          name: final-video-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/final/
          retention-days: 7

  quality-validation:
    runs-on: ubuntu-latest
    needs: [gather-news-info, integrate-final-video]
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
      - name: Download final video
        uses: actions/download-artifact@v4
        with:
          name: final-video-${{ needs.gather-news-info.outputs.timestamp }}
          path: final/
          
      - name: Quality validation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROJECT_DIR="${{ needs.gather-news-info.outputs.project_dir }}"
          mkdir -p "$(dirname "${PROJECT_DIR}")"
          
          VALIDATION_PROMPT="ÂÆåÊàêÂãïÁîª„ÅÆÂìÅË≥™Ê§úË®º„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Ê§úË®ºÈ†ÖÁõÆ:
- ÊäÄË°ì‰ªïÊßòÁ¢∫Ë™çÔºà1920x1080@30fpsÔºâ
- Èü≥Â£∞ÂìÅË≥™„ÉÅ„Çß„ÉÉ„ÇØÔºà-14LUFSÂü∫Ê∫ñÔºâ
- ÂãïÁîªÈï∑Á¢∫Ë™çÔºà60Áßí¬±2ÁßíÔºâ
- Ë¶ñË¶öÁöÑ‰∏ÄË≤´ÊÄßÊ§úË®º
- ÈÖç‰ø°„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÂØæÂøúÁ¢∫Ë™ç

ÂÖ•Âäõ: final/„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÆåÊàêÂãïÁîª
Âá∫Âäõ: ÂìÅË≥™„É¨„Éù„Éº„Éà„Å®ÈÖç‰ø°Ê∫ñÂÇôÁä∂ÊÖã„ÅÆÁ¢∫Ë™ç"

          npx @anthropic-ai/claude-code \
            -p "${VALIDATION_PROMPT}" \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Bash,Read,Write" \
            --max-turns 10 \
            --permission-mode "acceptEdits"
            
          # Basic technical validation
          VIDEO_FILE=$(find final/ -name "*.mp4" | head -1)
          if [ -n "$VIDEO_FILE" ]; then
            echo "=== Technical Validation Report ===" > "${PROJECT_DIR}/final/quality_report.txt"
            echo "Generated at: $(date)" >> "${PROJECT_DIR}/final/quality_report.txt"
            echo "" >> "${PROJECT_DIR}/final/quality_report.txt"
            
            # Get video info
            ffprobe -v quiet -print_format json -show_format -show_streams "$VIDEO_FILE" > video_info.json 2>/dev/null || true
            
            if [ -f video_info.json ]; then
              DURATION=$(jq -r '.format.duration // "unknown"' video_info.json)
              WIDTH=$(jq -r '.streams[0].width // "unknown"' video_info.json)
              HEIGHT=$(jq -r '.streams[0].height // "unknown"' video_info.json)
              
              echo "Duration: ${DURATION} seconds" >> "${PROJECT_DIR}/final/quality_report.txt"
              echo "Resolution: ${WIDTH}x${HEIGHT}" >> "${PROJECT_DIR}/final/quality_report.txt"
              echo "File size: $(stat -f%z "$VIDEO_FILE" 2>/dev/null || stat -c%s "$VIDEO_FILE" 2>/dev/null || echo "unknown") bytes" >> "${PROJECT_DIR}/final/quality_report.txt"
            fi
            
            echo "" >> "${PROJECT_DIR}/final/quality_report.txt"
            echo "Status: Quality validation completed" >> "${PROJECT_DIR}/final/quality_report.txt"
            echo "Ready for distribution: Yes" >> "${PROJECT_DIR}/final/quality_report.txt"
          fi
          
          echo "[$(date)] Quality validation completed" >> "${PROJECT_DIR}/logs/execution.log"
          
      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ needs.gather-news-info.outputs.timestamp }}
          path: ${{ needs.gather-news-info.outputs.project_dir }}/final/quality_report.txt
          retention-days: 7

      - name: Workflow completion summary
        run: |
          echo "üéâ Professional News Video Creation Workflow Completed!"
          echo ""
          echo "üìä Summary:"
          echo "- Topic: ${{ inputs.news_topic }}"
          echo "- Period: ${{ inputs.time_period }}"
          echo "- Style: ${{ inputs.video_style }}"
          echo "- Project Directory: ${{ needs.gather-news-info.outputs.project_dir }}"
          echo "- Final Video: ${{ needs.integrate-final-video.outputs.final_video }}"
          echo ""
          echo "‚úÖ All phases completed successfully:"
          echo "1. ‚úÖ Information Gathering"
          echo "2. ‚úÖ Script Creation"
          echo "3. ‚úÖ Parallel Material Generation"
          echo "4. ‚úÖ Video Integration"
          echo "5. ‚úÖ Quality Validation"
          echo ""
          echo "üìÅ Artifacts generated:"
          echo "- Search results and analysis"
          echo "- Professional script"
          echo "- High-quality background videos"
          echo "- Professional narration"
          echo "- Appropriate BGM"
          echo "- Title cards"
          echo "- Final integrated video"
          echo "- Quality validation report"
          echo ""
          echo "üöÄ Ready for distribution!"