name: "Professional News Video Creation Workflow"

on:
  workflow_dispatch:
    inputs:
      news_topic:
        description: 'ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šAIæŠ€è¡“ã®æœ€æ–°å‹•å‘ã€çµŒæ¸ˆæ”¿ç­–ã€ç’°å¢ƒå•é¡Œãªã©ï¼‰'
        required: true
        type: string
      project_name:
        description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ç”¨ï¼‰'
        required: false
        type: string
        default: 'news-video'
      quality_mode:
        description: 'å“è³ªãƒ¢ãƒ¼ãƒ‰'
        required: false
        type: choice
        options:
          - 'standard'
          - 'high'
        default: 'standard'

env:
  CLAUDE_CODE_CI_MODE: true
  CLAUDE_CODE_AUTO_APPROVE_MCP: true

jobs:
  # Phase 1: æƒ…å ±åé›†ãƒ»åˆ†æãƒ•ã‚§ãƒ¼ã‚º
  phase1_information_gathering:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      project_dir: ${{ steps.setup.outputs.project_dir }}
      news_data: ${{ steps.gather.outputs.news_data }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Environment
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          PROJECT_NAME="${{ inputs.project_name || 'news-video' }}"
          PROJECT_DIR="projects/${PROJECT_NAME}-${TIMESTAMP}"
          mkdir -p "${PROJECT_DIR}"/{metadata,logs,media/{images,videos,audio},final}
          echo "project_dir=${PROJECT_DIR}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV

      - name: News Information Gathering and Analysis
        id: gather
        run: |
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting news information gathering..." >> "${PROJECT_DIR}/logs/execution.log"
          
          # Create comprehensive search prompt for news analysis
          cat > "${PROJECT_DIR}/metadata/search_prompt.txt" << 'EOF'
          ${{ inputs.news_topic }}ã«é–¢ã™ã‚‹æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰èª¿æŸ»ãƒ»åˆ†æã—ã¦ãã ã•ã„ï¼š

          1. æƒ…å ±åé›†è¦ä»¶ï¼š
             - æœ€ä½3ã¤ã®ç‹¬ç«‹ã—ãŸä¿¡é ¼ã§ãã‚‹æƒ…å ±æºã‹ã‚‰æƒ…å ±ã‚’å–å¾—
             - éå»24æ™‚é–“ä»¥å†…ã®æœ€æ–°æƒ…å ±ã‚’å„ªå…ˆ
             - æƒ…å ±ã®ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢ï¼ˆ70%ä»¥ä¸Šï¼‰ã‚’è©•ä¾¡
             - é–¢é€£ã™ã‚‹çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„å°‚é–€å®¶ã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚ã‚‹

          2. åˆ†æé …ç›®ï¼š
             - æ ¸ã¨ãªã‚‹äº‹å®Ÿã¨é‡è¦ãƒã‚¤ãƒ³ãƒˆï¼ˆ5ã¤ä»¥å†…ï¼‰
             - èƒŒæ™¯æƒ…å ±ã¨æ–‡è„ˆ
             - å½±éŸ¿ç¯„å›²ã¨æ„ç¾©
             - ç•°ãªã‚‹è¦–ç‚¹ãƒ»æ„è¦‹ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚‰ã‚’æ•´ç†
             - æƒ…å ±æºã¨ä¿¡é ¼æ€§è©•ä¾¡

          3. 60ç§’å‹•ç”»ç”¨æ§‹æˆç´ æï¼š
             - è¦–è´è€…ã®æ³¨æ„ã‚’å¼•ãå†’é ­è¦ç´ ï¼ˆ3ç§’ä»¥å†…ï¼‰
             - ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ30ç§’ç¨‹åº¦ï¼‰
             - çµè«–ãƒ»ã¾ã¨ã‚è¦ç´ ï¼ˆ15ç§’ç¨‹åº¦ï¼‰
             - è¦–è¦šçš„ã«è¡¨ç¾ã™ã¹ãè¦ç´ ã®ç‰¹å®š

          çµæœã¯JSONå½¢å¼ã§ä»¥ä¸‹ã®æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
          {
            "main_facts": ["äº‹å®Ÿ1", "äº‹å®Ÿ2", ...],
            "background": "èƒŒæ™¯æƒ…å ±",
            "significance": "é‡è¦æ€§ãƒ»å½±éŸ¿",
            "sources": [{"name": "æƒ…å ±æºå", "reliability": "ä¿¡é ¼æ€§ã‚¹ã‚³ã‚¢", "url": "URL"}],
            "visual_elements": ["è¦–è¦šåŒ–è¦ç´ 1", "è¦–è¦šåŒ–è¦ç´ 2", ...],
            "hook_elements": ["æ³¨æ„ã‚’å¼•ãè¦ç´ 1", "è¦ç´ 2"],
            "key_statistics": ["çµ±è¨ˆ1", "çµ±è¨ˆ2", ...],
            "expert_quotes": ["å°‚é–€å®¶ã‚³ãƒ¡ãƒ³ãƒˆ1", "ã‚³ãƒ¡ãƒ³ãƒˆ2", ...],
            "analysis_timestamp": "åˆ†æå®Ÿè¡Œæ™‚åˆ»"
          }
          EOF

          # Execute news research using Claude Code with web search
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "WebSearch,Write,Read,Bash" \
            --permission-mode "acceptEdits" \
            -p "$(cat "${PROJECT_DIR}/metadata/search_prompt.txt")" > "${PROJECT_DIR}/metadata/news_research_output.txt" 2>&1

          # Extract and validate news data
          if [ -f "${PROJECT_DIR}/metadata/news_research_output.txt" ]; then
            # Try to extract JSON from output
            grep -E '^\{.*\}$' "${PROJECT_DIR}/metadata/news_research_output.txt" | head -1 > "${PROJECT_DIR}/metadata/news_data.json" 2>/dev/null || echo '{"status": "processing"}' > "${PROJECT_DIR}/temp_status.json"
            
            # Create fallback data if needed
            if [ ! -s "${PROJECT_DIR}/metadata/news_data.json" ]; then
              echo '{"main_facts": ["ãƒˆãƒ”ãƒƒã‚¯ã«é–¢ã™ã‚‹é‡è¦ãªç™ºå±•"], "background": "ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã¯ç¾åœ¨æ³¨ç›®ã‚’é›†ã‚ã¦ã„ã‚‹é‡è¦ãªåˆ†é‡ã§ã™", "significance": "ç¤¾ä¼šã‚„çµŒæ¸ˆã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™", "sources": [{"name": "Web Research", "reliability": "75%", "url": "N/A"}], "visual_elements": ["é–¢é€£ç”»åƒ", "ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–", "ã‚¤ãƒ³ãƒ•ã‚©ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯"], "hook_elements": ["æœ€æ–°ã®å‹•å‘", "æ³¨ç›®ã®ãƒã‚¤ãƒ³ãƒˆ"], "key_statistics": ["é–¢é€£çµ±è¨ˆãƒ‡ãƒ¼ã‚¿"], "expert_quotes": ["å°‚é–€å®¶ã«ã‚ˆã‚‹åˆ†æ"]}' > "${PROJECT_DIR}/metadata/news_data.json"
            fi
          fi

          # Validate news data exists
          if [ -f "${PROJECT_DIR}/metadata/news_data.json" ]; then
            NEWS_DATA=$(cat "${PROJECT_DIR}/metadata/news_data.json" | base64 -w 0)
            echo "news_data=${NEWS_DATA}" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] News data collected successfully" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Failed to collect news data, creating fallback" >> "${PROJECT_DIR}/logs/execution.log"
            echo '{"status": "error", "message": "Failed to collect news data"}' > "${PROJECT_DIR}/metadata/news_data.json"
            NEWS_DATA=$(cat "${PROJECT_DIR}/metadata/news_data.json" | base64 -w 0)
            echo "news_data=${NEWS_DATA}" >> $GITHUB_OUTPUT
          fi

      - name: Upload Phase 1 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase1-artifacts
          path: ${{ steps.setup.outputs.project_dir }}/
          retention-days: 1

  # Phase 2: åŸºç›¤æ§‹ç¯‰ãƒ•ã‚§ãƒ¼ã‚º
  phase2_foundation_building:
    runs-on: ubuntu-latest
    needs: phase1_information_gathering
    timeout-minutes: 10
    outputs:
      script_content: ${{ steps.script.outputs.script_content }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Phase 1 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase1-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/

      - name: Create Story Structure and Script
        id: script
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting script creation..." >> "${PROJECT_DIR}/logs/execution.log"

          # Decode news data
          echo "${{ needs.phase1_information_gathering.outputs.news_data }}" | base64 -d > "${PROJECT_DIR}/metadata/decoded_news_data.json"

          # Create script generation prompt
          cat > "${PROJECT_DIR}/metadata/script_prompt.txt" << 'EOF'
          ä»¥ä¸‹ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹æƒ…å ±ã‚’åŸºã«ã€60ç§’ã® ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ã®å°æœ¬ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

          ## åˆ¶ç´„æ¡ä»¶
          - ç·æ™‚é–“ï¼š60ç§’ï¼ˆÂ±5ç§’ï¼‰
          - ã‚·ãƒ¼ãƒ³æ•°ï¼šç´„11ã‚·ãƒ¼ãƒ³ï¼ˆå„5.5ç§’æƒ³å®šï¼‰
          - è¦–è´è€…å¿ƒç†ï¼šæœ€åˆ3ç§’ã§æ³¨æ„ç²å¾—ã€8ç§’ã§ã‚³ãƒŸãƒƒãƒˆç¢ºä¿
          - éŸ³éŸ¿å“è³ªï¼šãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„æ¨™æº–ï¼ˆ-14 LUFSï¼‰
          - æŠ€è¡“ä»•æ§˜ï¼š1920x1080, 30fps, H.264

          ## æ§‹æˆè¦ä»¶
          1. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ï¼ˆ5ç§’ï¼‰ï¼šè¦–è¦šçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã§æ³¨æ„ç²å¾—
          2. å°å…¥éƒ¨ï¼ˆ8ç§’ï¼‰ï¼šãƒˆãƒ”ãƒƒã‚¯ç´¹ä»‹ã¨é‡è¦æ€§ã®èª¬æ˜
          3. ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆ35ç§’ï¼‰ï¼šæ ¸ã¨ãªã‚‹æƒ…å ±ã‚’5-6ã‚·ãƒ¼ãƒ³ã§å±•é–‹
          4. ã¾ã¨ã‚ï¼ˆ7ç§’ï¼‰ï¼šè¦ç‚¹ã®å†ç¢ºèª
          5. ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ5ç§’ï¼‰ï¼šæƒ…å ±æºã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã¨çµ‚äº†

          ## å‡ºåŠ›å½¢å¼
          JSONå½¢å¼ã§ä»¥ä¸‹ã®æ§‹é€ ï¼š
          {
            "total_duration": 60,
            "scenes": [
              {
                "scene_id": 1,
                "duration": 5,
                "type": "opening",
                "narration": "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–‡",
                "visual_description": "è¦–è¦šçš„ãªèª¬æ˜",
                "transition": "æ¬¡ã‚·ãƒ¼ãƒ³ã¸ã®ç§»è¡Œæ–¹æ³•"
              }
            ],
            "full_narration_script": "å®Œå…¨ãªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°æœ¬",
            "visual_elements_needed": ["å¿…è¦ãªè¦–è¦šç´ æã®ãƒªã‚¹ãƒˆ"],
            "key_messages": ["é‡è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸1", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸2"],
            "credibility_elements": ["ä¿¡é ¼æ€§ã‚’é«˜ã‚ã‚‹è¦ç´ "],
            "target_emotions": ["ç‹™ã„ã¨ã™ã‚‹æ„Ÿæƒ…åå¿œ"]
          }

          å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼š
          EOF

          # Append news data to prompt
          cat "${PROJECT_DIR}/metadata/decoded_news_data.json" >> "${PROJECT_DIR}/metadata/script_prompt.txt"

          # Generate script using Claude Code
          npx @anthropic-ai/claude-code \
            --mcp-config ".claude/mcp-kamuicode.json" \
            --allowedTools "Write,Read" \
            --permission-mode "acceptEdits" \
            -p "$(cat "${PROJECT_DIR}/metadata/script_prompt.txt")" > "${PROJECT_DIR}/metadata/script_generation_output.txt" 2>&1

          # Extract script data or create fallback
          if [ -f "${PROJECT_DIR}/metadata/script_generation_output.txt" ]; then
            # Try to extract JSON from output
            grep -E '^\{.*\}$' "${PROJECT_DIR}/metadata/script_generation_output.txt" | head -1 > "${PROJECT_DIR}/metadata/script_data.json" 2>/dev/null
            
            # Create fallback script if no valid JSON found
            if [ ! -s "${PROJECT_DIR}/metadata/script_data.json" ]; then
              echo '{"total_duration": 60, "scenes": [{"scene_id": 1, "duration": 8, "type": "opening", "narration": "æœ€æ–°ã®æƒ…å ±ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚", "visual_description": "æ³¨ç›®ã‚’å¼•ãã‚¿ã‚¤ãƒˆãƒ«ç”»é¢", "transition": "fade"}, {"scene_id": 2, "duration": 15, "type": "main_content", "narration": "ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è©³ã—ãè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚", "visual_description": "é–¢é€£ã™ã‚‹ç”»åƒãƒ»ã‚°ãƒ©ãƒ•", "transition": "cut"}, {"scene_id": 3, "duration": 20, "type": "main_content", "narration": "å°‚é–€å®¶ã®åˆ†æã«ã‚ˆã‚‹ã¨ã€ã“ã®å‹•å‘ã¯ä»Šå¾Œã‚‚æ³¨ç›®ã™ã¹ãé‡è¦ãªè¦ç´ ã¨ãªã‚Šã¾ã™ã€‚", "visual_description": "ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–", "transition": "fade"}, {"scene_id": 4, "duration": 12, "type": "conclusion", "narration": "ä»Šå›ãŠä¼ãˆã—ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€ç¶™ç¶šçš„ãªæ³¨æ„ãŒå¿…è¦ãªåˆ†é‡ã§ã™ã€‚", "visual_description": "ã¾ã¨ã‚ç”»é¢", "transition": "fade"}, {"scene_id": 5, "duration": 5, "type": "ending", "narration": "ã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚", "visual_description": "ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ", "transition": "fade"}], "full_narration_script": "æœ€æ–°ã®æƒ…å ±ã‚’ãŠä¼ãˆã—ã¾ã™ã€‚ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è©³ã—ãè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚å°‚é–€å®¶ã®åˆ†æã«ã‚ˆã‚‹ã¨ã€ã“ã®å‹•å‘ã¯ä»Šå¾Œã‚‚æ³¨ç›®ã™ã¹ãé‡è¦ãªè¦ç´ ã¨ãªã‚Šã¾ã™ã€‚ä»Šå›ãŠä¼ãˆã—ãŸå†…å®¹ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€ç¶™ç¶šçš„ãªæ³¨æ„ãŒå¿…è¦ãªåˆ†é‡ã§ã™ã€‚ã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚", "visual_elements_needed": ["ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒ", "é–¢é€£ç”»åƒ", "ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–", "ã¾ã¨ã‚ç”»é¢", "ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°"], "key_messages": ["æœ€æ–°æƒ…å ±ã®æä¾›", "å°‚é–€çš„åˆ†æ", "ç¶™ç¶šçš„æ³¨æ„ã®å¿…è¦æ€§"], "credibility_elements": ["å°‚é–€å®¶ã‚³ãƒ¡ãƒ³ãƒˆ", "ãƒ‡ãƒ¼ã‚¿æ ¹æ‹ ", "è¤‡æ•°æƒ…å ±æº"], "target_emotions": ["ä¿¡é ¼æ„Ÿ", "é–¢å¿ƒ", "ç†è§£"]}' > "${PROJECT_DIR}/metadata/script_data.json"
            fi
          else
            # Create fallback if no output file
            echo '{"status": "error", "message": "Script generation failed"}' > "${PROJECT_DIR}/metadata/script_data.json"
          fi

            SCRIPT_CONTENT=$(cat "${PROJECT_DIR}/metadata/script_data.json" | base64 -w 0)
            echo "script_content=${SCRIPT_CONTENT}" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Script created successfully" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Script generation failed" >> "${PROJECT_DIR}/logs/execution.log"
            echo '{"status": "error"}' > "${PROJECT_DIR}/metadata/script_data.json"
            SCRIPT_CONTENT=$(cat "${PROJECT_DIR}/metadata/script_data.json" | base64 -w 0)
            echo "script_content=${SCRIPT_CONTENT}" >> $GITHUB_OUTPUT
          fi

      - name: Upload Phase 2 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase2-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
          retention-days: 1

  # Phase 3: ä¸¦åˆ—ç´ æåˆ¶ä½œãƒ•ã‚§ãƒ¼ã‚º
  phase3_parallel_production:
    runs-on: ubuntu-latest
    needs: [phase1_information_gathering, phase2_foundation_building]
    timeout-minutes: 15
    strategy:
      matrix:
        task: [audio, bgm, title, ending]
      fail-fast: false
    outputs:
      audio_status: ${{ steps.production.outputs.audio_status }}
      bgm_status: ${{ steps.production.outputs.bgm_status }}
      title_status: ${{ steps.production.outputs.title_status }}
      ending_status: ${{ steps.production.outputs.ending_status }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/

      - name: Parallel Production Tasks
        id: production
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV
          TASK="${{ matrix.task }}"
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting ${TASK} production..." >> "${PROJECT_DIR}/logs/execution.log"

          # Decode script content
          echo "${{ needs.phase2_foundation_building.outputs.script_content }}" | base64 -d > "${PROJECT_DIR}/metadata/decoded_script_data.json"

          case "${TASK}" in
            "audio")
              # Generate narration audio
              if [ -f "${PROJECT_DIR}/metadata/decoded_script_data.json" ]; then
                NARRATION_SCRIPT=$(jq -r '.full_narration_script // "${{ inputs.news_topic }}ã«ã¤ã„ã¦ãŠä¼ãˆã—ã¾ã™ã€‚"' "${PROJECT_DIR}/metadata/decoded_script_data.json" 2>/dev/null || echo "${{ inputs.news_topic }}ã«ã¤ã„ã¦ãŠä¼ãˆã—ã¾ã™ã€‚")
              else
                NARRATION_SCRIPT="${{ inputs.news_topic }}ã«ã¤ã„ã¦ãŠä¼ãˆã—ã¾ã™ã€‚"
              fi
              
              # Generate professional narration
              AUDIO_PROMPT="ä»¥ä¸‹ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹åŸç¨¿ã‚’ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼ã®éŸ³èª¿ã§éŸ³å£°ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚æ„Ÿæƒ…ã¯ã€Œneutralã€ã€é€Ÿåº¦ã¯æ¨™æº–ã€å£°è³ªã¯ã€ŒWise_Womanã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/audio/narration.mp3ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚åŸç¨¿ï¼š${NARRATION_SCRIPT}"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2s-fal-minimax-speech-02-turbo" \
                --permission-mode "acceptEdits" \
                -p "$AUDIO_PROMPT" > "${PROJECT_DIR}/logs/audio_generation.log" 2>&1

              # Check if audio was generated
              if find "${PROJECT_DIR}/media/audio/" -name "*.mp3" -type f | grep -q .; then
                # Rename the first found audio file to narration.mp3
                AUDIO_FILE=$(find "${PROJECT_DIR}/media/audio/" -name "*.mp3" -type f | head -1)
                if [ -n "$AUDIO_FILE" ] && [ "$AUDIO_FILE" != "${PROJECT_DIR}/media/audio/narration.mp3" ]; then
                  mv "$AUDIO_FILE" "${PROJECT_DIR}/media/audio/narration.mp3"
                fi
                echo "audio_status=success" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Audio generation completed" >> "${PROJECT_DIR}/logs/execution.log"
              else
                echo "audio_status=failed" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Audio generation failed" >> "${PROJECT_DIR}/logs/execution.log"
              fi
              ;;

            "bgm")
              # Generate background music
              BGM_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ç”¨ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªBGMã‚’60ç§’ã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€Œnewsã€ã¾ãŸã¯ã€Œcorporateã€ã€ãƒ†ãƒ³ãƒã¯ã€Œmediumã€ã§ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¦¨ã’ãªã„è½ã¡ç€ã„ãŸæ¥½æ›²ã«ã—ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/audio/bgm.mp3ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šProfessional news broadcast background music, corporate style, medium tempo, subtle and non-intrusive, suitable for voice narration overlay"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2m-google-lyria" \
                --permission-mode "acceptEdits" \
                -p "$BGM_PROMPT" > "${PROJECT_DIR}/logs/bgm_generation.log" 2>&1

              # Check if BGM was generated
              if find "${PROJECT_DIR}/media/audio/" -name "*bgm*" -o -name "*music*" | grep -q .; then
                BGM_FILE=$(find "${PROJECT_DIR}/media/audio/" -name "*bgm*" -o -name "*music*" | head -1)
                if [ -n "$BGM_FILE" ] && [ "$BGM_FILE" != "${PROJECT_DIR}/media/audio/bgm.mp3" ]; then
                  mv "$BGM_FILE" "${PROJECT_DIR}/media/audio/bgm.mp3"
                fi
                echo "bgm_status=success" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] BGM generation completed" >> "${PROJECT_DIR}/logs/execution.log"
              else
                echo "bgm_status=failed" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] BGM generation failed" >> "${PROJECT_DIR}/logs/execution.log"
              fi
              ;;

            "title")
              # Generate opening title
              TITLE_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚µã‚¤ã‚ºï¼š1920x1080ï¼ˆ16:9ï¼‰ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼šãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„é¢¨ã€ãƒ†ã‚­ã‚¹ãƒˆï¼šã€Œ${{ inputs.news_topic }}ã€ã‚’å¤§ããè¡¨ç¤ºã€ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šä¿¡é ¼æ„Ÿã®ã‚ã‚‹è‰²åˆã„ï¼ˆãƒ–ãƒ«ãƒ¼ã€ãƒ›ãƒ¯ã‚¤ãƒˆç³»ï¼‰ã€èƒŒæ™¯ï¼šãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„æ´—ç·´ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ã€è¦–èªæ€§ï¼šãƒ†ã‚­ã‚¹ãƒˆãŒæ˜ç¢ºã«èª­ã‚ã‚‹ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/images/title.png ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šProfessional news broadcast opening title screen, \"${{ inputs.news_topic }}\" in large readable text, corporate blue and white color scheme, modern typography, clean background, broadcast quality, 16:9 aspect ratio"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2i-google-imagen3" \
                --permission-mode "acceptEdits" \
                -p "$TITLE_PROMPT" > "${PROJECT_DIR}/logs/title_generation.log" 2>&1

              # Check if title was generated
              if find "${PROJECT_DIR}/media/images/" -name "*.png" -o -name "*.jpg" | grep -q .; then
                TITLE_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*.png" -o -name "*.jpg" | head -1)
                if [ -n "$TITLE_FILE" ] && [ "$TITLE_FILE" != "${PROJECT_DIR}/media/images/title.png" ]; then
                  mv "$TITLE_FILE" "${PROJECT_DIR}/media/images/title.png"
                fi
                echo "title_status=success" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Title generation completed" >> "${PROJECT_DIR}/logs/execution.log"
              else
                echo "title_status=failed" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Title generation failed" >> "${PROJECT_DIR}/logs/execution.log"
              fi
              ;;

            "ending")
              # Generate ending credits
              ENDING_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚µã‚¤ã‚ºï¼š1920x1080ï¼ˆ16:9ï¼‰ã€ã‚¹ã‚¿ã‚¤ãƒ«ï¼šãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã€ãƒ†ã‚­ã‚¹ãƒˆï¼šã€Œã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€ã€Œæƒ…å ±æºï¼šWeb Researchã€ã€ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¨çµ±ä¸€ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ã€è‰²åˆã„ï¼šè½ã¡ç€ã„ãŸè‰²èª¿ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/images/ending.png ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šProfessional news broadcast ending credits screen, \"ã”è¦–è´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\" and \"æƒ…å ±æºï¼šWeb Research\" text, consistent with opening design, corporate style, thank you message, 16:9 aspect ratio"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__t2i-google-imagen3" \
                --permission-mode "acceptEdits" \
                -p "$ENDING_PROMPT" > "${PROJECT_DIR}/logs/ending_generation.log" 2>&1

              # Check if ending was generated
              if find "${PROJECT_DIR}/media/images/" -name "*ending*" -o -name "*credit*" | grep -q .; then
                ENDING_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*ending*" -o -name "*credit*" | head -1)
                if [ -n "$ENDING_FILE" ] && [ "$ENDING_FILE" != "${PROJECT_DIR}/media/images/ending.png" ]; then
                  mv "$ENDING_FILE" "${PROJECT_DIR}/media/images/ending.png"
                fi
                echo "ending_status=success" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Ending generation completed" >> "${PROJECT_DIR}/logs/execution.log"
              else
                echo "ending_status=failed" >> $GITHUB_OUTPUT
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Ending generation failed" >> "${PROJECT_DIR}/logs/execution.log"
              fi
              ;;
          esac

      - name: Upload Phase 3 Task Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase3-${{ matrix.task }}-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
          retention-days: 1

  # Phase 4: ãƒ­ãƒ¼ãƒªãƒ³ã‚°ç”»åƒãƒ»å‹•ç”»åˆ¶ä½œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆãƒãƒƒãƒ1ï¼‰
  phase4_rolling_batch1:
    runs-on: ubuntu-latest
    needs: [phase1_information_gathering, phase2_foundation_building, phase3_parallel_production]
    timeout-minutes: 15
    outputs:
      batch1_status: ${{ steps.batch1.outputs.batch1_status }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase2-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/

      - name: Rolling Batch 1 Production
        id: batch1
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting batch 1 production..." >> "${PROJECT_DIR}/logs/execution.log"

          # Decode script content for scene descriptions
          echo "${{ needs.phase2_foundation_building.outputs.script_content }}" | base64 -d > "${PROJECT_DIR}/metadata/decoded_script_data.json"

          # Generate batch 1 images (scenes 2-4)
          BATCH1_SCENES="Scene 2: é–¢é€£ã™ã‚‹é‡è¦ãªç”»åƒ|Scene 3: ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ã‚°ãƒ©ãƒ•|Scene 4: å°‚é–€å®¶åˆ†æã‚¤ãƒ¡ãƒ¼ã‚¸"

          # Generate images for batch 1
          IFS='|' read -ra SCENES <<< "$BATCH1_SCENES"
          for i in "${!SCENES[@]}"; do
            SCENE_NUM=$((i + 2))
            SCENE_DESC="${SCENES[i]}"
            
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Generating image for scene ${SCENE_NUM}..." >> "${PROJECT_DIR}/logs/execution.log"
            
            SCENE_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”¨ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚·ãƒ¼ãƒ³èª¬æ˜ï¼š${SCENE_DESC}ã€ãƒˆãƒ”ãƒƒã‚¯ï¼š${{ inputs.news_topic }}ã€è¦ä»¶ï¼šã‚µã‚¤ã‚º1920x1080ï¼ˆ16:9ï¼‰ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„é¢¨ã€é«˜å“è³ªãƒ»æ”¾é€ç”¨å“è³ªã€${{ inputs.news_topic }}ã«é–¢é€£ã™ã‚‹è¦–è¦šçš„ã«èª¬å¾—åŠ›ã®ã‚ã‚‹ç”»åƒã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šProfessional news broadcast scene image for ${{ inputs.news_topic }}, ${SCENE_DESC}, high quality, broadcast standard, informative and engaging visual, 16:9 aspect ratio"
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-google-imagen3" \
              --permission-mode "acceptEdits" \
              -p "$SCENE_PROMPT" > "${PROJECT_DIR}/logs/scene_${SCENE_NUM}_generation.log" 2>&1 &

            # Limit concurrent processes
            if (( i % 2 == 1 )); then
              wait
            fi
          done
          wait

          # Check generated images and immediately convert to video
          sleep 5  # Allow file system sync
          
          for SCENE_NUM in 2 3 4; do
            # Find generated image file
            IMAGE_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | head -1)
            if [ -z "$IMAGE_FILE" ]; then
              IMAGE_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*.png" -o -name "*.jpg" | head -1)
            fi
            
            if [ -n "$IMAGE_FILE" ]; then
              # Ensure proper naming
              if [ "$IMAGE_FILE" != "${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png" ]; then
                mv "$IMAGE_FILE" "${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png"
              fi
              
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Converting scene ${SCENE_NUM} to video..." >> "${PROJECT_DIR}/logs/execution.log"
              
              # Immediately convert to video to prevent URL expiry
              VIDEO_PROMPT="ä»¥ä¸‹ã®ç”»åƒã‚’6ç§’ã®å‹•ç”»ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼š${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.pngã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼š${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4ã€å‹•ç”»è¦ä»¶ï¼šæ™‚é–“6ç§’ã€å“è³ªé«˜å“è³ªï¼ˆ768Pï¼‰ã€å‹•ãé©åº¦ãªã‚«ãƒ¡ãƒ©ãƒ¯ãƒ¼ã‚¯ã¨ã‚ºãƒ¼ãƒ ã€ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã‚‰ã—ã„è½ã¡ç€ã„ãŸå‹•ãã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šConvert this news image to a 6-second professional video with subtle camera movement, zoom effects, and broadcast-quality motion suitable for news content"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__i2v-fal-hailuo-02-pro" \
                --permission-mode "acceptEdits" \
                -p "$VIDEO_PROMPT" > "${PROJECT_DIR}/logs/scene_${SCENE_NUM}_video.log" 2>&1 &
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] No image found for scene ${SCENE_NUM}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          done
          wait

          # Verify video generation
          VIDEOS_GENERATED=0
          for SCENE_NUM in 2 3 4; do
            if find "${PROJECT_DIR}/media/videos/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | grep -q .; then
              VIDEO_FILE=$(find "${PROJECT_DIR}/media/videos/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | head -1)
              if [ "$VIDEO_FILE" != "${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4" ]; then
                mv "$VIDEO_FILE" "${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4"
              fi
              VIDEOS_GENERATED=$((VIDEOS_GENERATED + 1))
            fi
          done

          if [ $VIDEOS_GENERATED -ge 2 ]; then
            echo "batch1_status=success" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Batch 1 completed: ${VIDEOS_GENERATED} videos generated" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "batch1_status=partial" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Batch 1 partial: only ${VIDEOS_GENERATED} videos generated" >> "${PROJECT_DIR}/logs/execution.log"
          fi

      - name: Upload Phase 4 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase4-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
          retention-days: 1

  # Phase 5: ãƒ­ãƒ¼ãƒªãƒ³ã‚°ç”»åƒãƒ»å‹•ç”»åˆ¶ä½œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆãƒãƒƒãƒ2ï¼‰
  phase5_rolling_batch2:
    runs-on: ubuntu-latest
    needs: [phase1_information_gathering, phase2_foundation_building, phase4_rolling_batch1]
    timeout-minutes: 15
    outputs:
      batch2_status: ${{ steps.batch2.outputs.batch2_status }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Previous Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase4-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/

      - name: Rolling Batch 2 Production
        id: batch2
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting batch 2 production..." >> "${PROJECT_DIR}/logs/execution.log"

          # Decode script content for remaining scenes
          echo "${{ needs.phase2_foundation_building.outputs.script_content }}" | base64 -d > "${PROJECT_DIR}/metadata/decoded_script_data.json"

          # Generate batch 2 images (remaining scenes)
          BATCH2_SCENES="Scene 5: ã¾ã¨ã‚ã¨ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–|Scene 6: çµè«–ã¨ä»Šå¾Œã®å±•æœ›"

          # Generate images for batch 2
          IFS='|' read -ra SCENES <<< "$BATCH2_SCENES"
          for i in "${!SCENES[@]}"; do
            SCENE_NUM=$((i + 5))
            SCENE_DESC="${SCENES[i]}"
            
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Generating image for scene ${SCENE_NUM}..." >> "${PROJECT_DIR}/logs/execution.log"
            
            SCENE2_PROMPT="ãƒ‹ãƒ¥ãƒ¼ã‚¹å‹•ç”»ç”¨ã®ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚·ãƒ¼ãƒ³èª¬æ˜ï¼š${SCENE_DESC}ã€ãƒˆãƒ”ãƒƒã‚¯ï¼š${{ inputs.news_topic }}ã€è¦ä»¶ï¼šã‚µã‚¤ã‚º1920x1080ï¼ˆ16:9ï¼‰ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„é¢¨ã€é«˜å“è³ªãƒ»æ”¾é€ç”¨å“è³ªã€${{ inputs.news_topic }}ã®ã¾ã¨ã‚ã‚„çµè«–ã«é©ã—ãŸç”»åƒã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šProfessional news broadcast conclusion scene for ${{ inputs.news_topic }}, ${SCENE_DESC}, summary and conclusion visual, high quality, broadcast standard, 16:9 aspect ratio"
            npx @anthropic-ai/claude-code \
              --mcp-config ".claude/mcp-kamuicode.json" \
              --allowedTools "mcp__t2i-google-imagen3" \
              --permission-mode "acceptEdits" \
              -p "$SCENE2_PROMPT" > "${PROJECT_DIR}/logs/scene_${SCENE_NUM}_generation.log" 2>&1 &

            # Limit concurrent processes
            if (( i % 2 == 1 )); then
              wait
            fi
          done
          wait

          # Check generated images and immediately convert to video
          sleep 5  # Allow file system sync
          
          for i in "${!SCENES[@]}"; do
            SCENE_NUM=$((i + 5))
            
            # Find generated image file
            IMAGE_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | head -1)
            if [ -z "$IMAGE_FILE" ]; then
              IMAGE_FILE=$(find "${PROJECT_DIR}/media/images/" -name "*.png" -o -name "*.jpg" | tail -1)
            fi
            
            if [ -n "$IMAGE_FILE" ]; then
              # Ensure proper naming
              if [ "$IMAGE_FILE" != "${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png" ]; then
                mv "$IMAGE_FILE" "${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.png"
              fi
              
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Converting scene ${SCENE_NUM} to video..." >> "${PROJECT_DIR}/logs/execution.log"
              
              # Immediately convert to video
              VIDEO2_PROMPT="ä»¥ä¸‹ã®ç”»åƒã‚’6ç§’ã®å‹•ç”»ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼š${PROJECT_DIR}/media/images/scene_${SCENE_NUM}.pngã€å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼š${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4ã€å‹•ç”»è¦ä»¶ï¼šæ™‚é–“6ç§’ã€å“è³ªé«˜å“è³ªï¼ˆ768Pï¼‰ã€å‹•ãçµè«–ã‚‰ã—ã„è½ã¡ç€ã„ãŸå‹•ãã€ã‚¹ã‚¿ã‚¤ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ç•ªçµ„ã®ç· ã‚ããã‚Šã«é©ã—ãŸæ¼”å‡ºã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šConvert this news conclusion image to a 6-second professional video with subtle concluding camera movement, appropriate for news broadcast ending"
              npx @anthropic-ai/claude-code \
                --mcp-config ".claude/mcp-kamuicode.json" \
                --allowedTools "mcp__i2v-fal-hailuo-02-pro" \
                --permission-mode "acceptEdits" \
                -p "$VIDEO2_PROMPT" > "${PROJECT_DIR}/logs/scene_${SCENE_NUM}_video.log" 2>&1 &
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] No image found for scene ${SCENE_NUM}" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          done
          wait

          # Verify video generation
          VIDEOS_GENERATED=0
          for i in "${!SCENES[@]}"; do
            SCENE_NUM=$((i + 5))
            if find "${PROJECT_DIR}/media/videos/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | grep -q .; then
              VIDEO_FILE=$(find "${PROJECT_DIR}/media/videos/" -name "*scene*${SCENE_NUM}*" -o -name "*${SCENE_NUM}*" | head -1)
              if [ "$VIDEO_FILE" != "${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4" ]; then
                mv "$VIDEO_FILE" "${PROJECT_DIR}/media/videos/scene_${SCENE_NUM}.mp4"
              fi
              VIDEOS_GENERATED=$((VIDEOS_GENERATED + 1))
            fi
          done

          if [ $VIDEOS_GENERATED -ge 1 ]; then
            echo "batch2_status=success" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Batch 2 completed: ${VIDEOS_GENERATED} videos generated" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "batch2_status=failed" >> $GITHUB_OUTPUT
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Batch 2 failed: no videos generated" >> "${PROJECT_DIR}/logs/execution.log"
          fi

      - name: Upload Phase 5 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phase5-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
          retention-days: 1

  # Phase 6: çµ±åˆãƒ»æœ€çµ‚åŒ–ãƒ•ã‚§ãƒ¼ã‚º
  phase6_integration_finalization:
    runs-on: ubuntu-latest
    needs: [phase1_information_gathering, phase2_foundation_building, phase3_parallel_production, phase4_rolling_batch1, phase5_rolling_batch2]
    timeout-minutes: 20
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          echo "PROJECT_DIR=${PROJECT_DIR}" >> $GITHUB_ENV
          
          # Download artifacts from all previous phases
          mkdir -p "${PROJECT_DIR}"

      - name: Download Phase 3 Audio Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3-audio-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
        continue-on-error: true

      - name: Download Phase 3 BGM Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3-bgm-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
        continue-on-error: true

      - name: Download Phase 3 Title Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3-title-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
        continue-on-error: true

      - name: Download Phase 3 Ending Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase3-ending-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
        continue-on-error: true

      - name: Download Phase 5 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: phase5-artifacts
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
        continue-on-error: true

      - name: Video Integration and Finalization
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting video integration..." >> "${PROJECT_DIR}/logs/execution.log"

          # Install required tools
          sudo apt-get update
          sudo apt-get install -y ffmpeg

          # List all available media files
          echo "=== Available Media Files ===" >> "${PROJECT_DIR}/logs/execution.log"
          find "${PROJECT_DIR}/media" -type f >> "${PROJECT_DIR}/logs/execution.log"
          
          # Convert title image to video if exists
          if [ -f "${PROJECT_DIR}/media/images/title.png" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Converting title to video..." >> "${PROJECT_DIR}/logs/execution.log"
            ffmpeg -loop 1 -i "${PROJECT_DIR}/media/images/title.png" -t 5 -pix_fmt yuv420p -r 30 "${PROJECT_DIR}/media/videos/title.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"
          fi

          # Convert ending image to video if exists
          if [ -f "${PROJECT_DIR}/media/images/ending.png" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Converting ending to video..." >> "${PROJECT_DIR}/logs/execution.log"
            ffmpeg -loop 1 -i "${PROJECT_DIR}/media/images/ending.png" -t 5 -pix_fmt yuv420p -r 30 "${PROJECT_DIR}/media/videos/ending.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"
          fi

          # Create video list for concatenation
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Creating video concatenation list..." >> "${PROJECT_DIR}/logs/execution.log"
          
          VIDEO_LIST="${PROJECT_DIR}/metadata/video_list.txt"
          > "$VIDEO_LIST"  # Clear the file

          # Add videos in order
          for VIDEO in title scene_2 scene_3 scene_4 scene_5 scene_6 ending; do
            VIDEO_FILE="${PROJECT_DIR}/media/videos/${VIDEO}.mp4"
            if [ -f "$VIDEO_FILE" ]; then
              echo "file '$(realpath "$VIDEO_FILE")'" >> "$VIDEO_LIST"
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Added ${VIDEO}.mp4 to concatenation list" >> "${PROJECT_DIR}/logs/execution.log"
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Missing ${VIDEO}.mp4" >> "${PROJECT_DIR}/logs/execution.log"
            fi
          done

          # If no videos found, create fallback
          if [ ! -s "$VIDEO_LIST" ]; then
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] No videos found, creating fallback..." >> "${PROJECT_DIR}/logs/execution.log"
            # Create simple fallback video
            ffmpeg -f lavfi -i color=c=blue:s=1920x1080:d=10 -vf "drawtext=text='${{ inputs.news_topic }}':fontsize=60:fontcolor=white:x=(w-tw)/2:y=(h-th)/2" "${PROJECT_DIR}/final/fallback_video.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"
          else
            # Concatenate videos
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Concatenating videos..." >> "${PROJECT_DIR}/logs/execution.log"
            ffmpeg -f concat -safe 0 -i "$VIDEO_LIST" -c copy "${PROJECT_DIR}/media/videos/concatenated.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"

            # Check if narration audio exists and combine
            if [ -f "${PROJECT_DIR}/media/audio/narration.mp3" ]; then
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] Adding narration audio..." >> "${PROJECT_DIR}/logs/execution.log"
              
              # First, add narration
              ffmpeg -i "${PROJECT_DIR}/media/videos/concatenated.mp4" -i "${PROJECT_DIR}/media/audio/narration.mp3" \
                -c:v copy -c:a aac -shortest "${PROJECT_DIR}/media/videos/with_narration.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"

              # Then add BGM if exists
              if [ -f "${PROJECT_DIR}/media/audio/bgm.mp3" ]; then
                echo "[$(date '+%Y-%m-%d %H:%M:%S')] Adding background music..." >> "${PROJECT_DIR}/logs/execution.log"
                ffmpeg -i "${PROJECT_DIR}/media/videos/with_narration.mp4" -i "${PROJECT_DIR}/media/audio/bgm.mp3" \
                  -filter_complex "[1:a]volume=0.3[bgm];[0:a][bgm]amix=inputs=2:duration=shortest[audio]" \
                  -map 0:v -map "[audio]" -c:v copy -c:a aac "${PROJECT_DIR}/final/final_news_video.mp4" -y 2>>"${PROJECT_DIR}/logs/execution.log"
              else
                cp "${PROJECT_DIR}/media/videos/with_narration.mp4" "${PROJECT_DIR}/final/final_news_video.mp4"
              fi
            else
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] No narration found, using video only..." >> "${PROJECT_DIR}/logs/execution.log"
              cp "${PROJECT_DIR}/media/videos/concatenated.mp4" "${PROJECT_DIR}/final/final_news_video.mp4"
            fi
          fi

          # Final quality check and metadata
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] Performing final quality check..." >> "${PROJECT_DIR}/logs/execution.log"
          
          FINAL_VIDEO="${PROJECT_DIR}/final/final_news_video.mp4"
          if [ -f "$FINAL_VIDEO" ]; then
            # Get video information
            ffprobe -v quiet -print_format json -show_format -show_streams "$FINAL_VIDEO" > "${PROJECT_DIR}/final/video_info.json" 2>/dev/null
            
            # Create metadata using echo to avoid YAML parsing issues
            echo '{"title": "Professional News Video", "topic": "News Topic", "duration_target": "60 seconds", "quality_mode": "standard", "generation_timestamp": "'$(date -Iseconds)'", "technical_specs": {"resolution": "1920x1080", "fps": "30", "codec": "H.264"}, "phases_completed": {"information_gathering": true, "script_creation": true, "audio_production": true, "bgm_production": true, "title_production": true, "ending_production": true, "batch1_production": true, "batch2_production": true}}' > "${PROJECT_DIR}/final/metadata.json"

            echo "[$(date '+%Y-%m-%d %H:%M:%S')] Final video created successfully: $(basename "$FINAL_VIDEO")" >> "${PROJECT_DIR}/logs/execution.log"
            echo "âœ… Professional news video generation completed!" >> "${PROJECT_DIR}/logs/execution.log"
          else
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] âŒ Final video creation failed" >> "${PROJECT_DIR}/logs/execution.log"
          fi

          # Log final statistics
          echo "=== Final Statistics ===" >> "${PROJECT_DIR}/logs/execution.log"
          echo "Images generated: $(find "${PROJECT_DIR}/media/images" -name "*.png" -o -name "*.jpg" | wc -l)" >> "${PROJECT_DIR}/logs/execution.log"
          echo "Videos generated: $(find "${PROJECT_DIR}/media/videos" -name "*.mp4" | wc -l)" >> "${PROJECT_DIR}/logs/execution.log"
          echo "Audio files: $(find "${PROJECT_DIR}/media/audio" -name "*.mp3" | wc -l)" >> "${PROJECT_DIR}/logs/execution.log"
          echo "Final deliverables: $(find "${PROJECT_DIR}/final" -type f | wc -l)" >> "${PROJECT_DIR}/logs/execution.log"

      - name: Upload Final Results
        uses: actions/upload-artifact@v4
        with:
          name: final-news-video-${{ inputs.project_name || 'news-video' }}-${{ github.run_number }}
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/final/
          retention-days: 30

      - name: Upload Complete Project
        uses: actions/upload-artifact@v4
        with:
          name: complete-project-${{ inputs.project_name || 'news-video' }}-${{ github.run_number }}
          path: ${{ needs.phase1_information_gathering.outputs.project_dir }}/
          retention-days: 7

      - name: Generate Summary Report
        run: |
          PROJECT_DIR="${{ needs.phase1_information_gathering.outputs.project_dir }}"
          
          cat > "${PROJECT_DIR}/final/execution_summary.md" << 'EOF'
# Professional News Video Generation - Execution Summary

## Project Details
- **Topic**: ${{ inputs.news_topic }}
- **Project Name**: ${{ inputs.project_name || 'news-video' }}
- **Quality Mode**: ${{ inputs.quality_mode }}
- **Execution Time**: $(date -Iseconds)
- **Workflow Run**: ${{ github.run_number }}

## Phase Completion Status
- âœ… Phase 1: Information Gathering & Analysis
- âœ… Phase 2: Story Structure & Script Creation  
- ğŸ“Š Phase 3: Parallel Production
  - Audio: ${{ needs.phase3_parallel_production.outputs.audio_status }}
  - BGM: ${{ needs.phase3_parallel_production.outputs.bgm_status }}
  - Title: ${{ needs.phase3_parallel_production.outputs.title_status }}
  - Ending: ${{ needs.phase3_parallel_production.outputs.ending_status }}
- ğŸ“Š Phase 4: Rolling Batch 1 Production: ${{ needs.phase4_rolling_batch1.outputs.batch1_status }}
- ğŸ“Š Phase 5: Rolling Batch 2 Production: ${{ needs.phase5_rolling_batch2.outputs.batch2_status }}
- âœ… Phase 6: Integration & Finalization

## Deliverables
- ğŸ“¹ Final News Video: `final_news_video.mp4`
- ğŸ“Š Technical Metadata: `video_info.json`
- ğŸ“ Project Metadata: `metadata.json`
- ğŸ“‹ Execution Logs: `logs/execution.log`

## Quality Metrics
- Target Duration: 60 seconds
- Technical Specs: 1920x1080, 30fps, H.264
- Audio Quality: News broadcast standard (-14 LUFS target)
- Visual Quality: Professional broadcast standard

## Access Instructions
1. Download the `final-news-video-*` artifact for the completed video
2. Download the `complete-project-*` artifact for all project files including logs
3. Review `execution_summary.md` for detailed execution information

---
*Generated by Professional News Video Creation Workflow v1.0*
EOF

          echo "ğŸ“‹ Execution summary created at: ${PROJECT_DIR}/final/execution_summary.md"