name: "Batch Processor Custom Node"
description: "å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†å‰²ã—ã¦ãƒãƒƒãƒå‡¦ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒŽãƒ¼ãƒ‰ä¾‹"

# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Ÿè£…ä¾‹ã§ã™ã€‚å¤§é‡ã®ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆç”»åƒç”Ÿæˆã€å‹•ç”»å‡¦ç†ãªã©ï¼‰ã‚’åŠ¹çŽ‡çš„ã«å‡¦ç†ã™ã‚‹å ´åˆã«ä½¿ç”¨

jobs:
  batch-processor:
    runs-on: ubuntu-latest
    needs: [data-preparation]  # å‰æ: å‡¦ç†å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™å®Œäº†
    outputs:
      total_processed: ${{ steps.summary.outputs.total }}
      success_count: ${{ steps.summary.outputs.success }}
      failed_count: ${{ steps.summary.outputs.failed }}
      batch_results: ${{ steps.summary.outputs.results }}
    
    strategy:
      matrix:
        batch_id: [1, 2, 3, 4, 5]  # æœ€å¤§5ä¸¦åˆ—ãƒãƒƒãƒå‡¦ç†
      fail-fast: false  # 1ã¤ã®ãƒãƒƒãƒãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶™ç¶š
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Batch Environment
        run: |
          mkdir -p projects/current-session/batch-processing/
          mkdir -p projects/current-session/batch-processing/batch-${{ matrix.batch_id }}
          echo "BATCH_ID=${{ matrix.batch_id }}" >> $GITHUB_ENV
          echo "BATCH_DIR=projects/current-session/batch-processing/batch-${{ matrix.batch_id }}" >> $GITHUB_ENV
          
      - name: Load Batch Data
        id: load-data
        run: |
          echo "ðŸ“¦ Loading data for batch ${{ matrix.batch_id }}"
          
          # ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²ãƒ­ã‚¸ãƒƒã‚¯
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯å‰æ®µã‚¸ãƒ§ãƒ–ã‹ã‚‰å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã€
          # matrix.batch_id ã«åŸºã¥ã„ã¦åˆ†å‰²ã™ã‚‹
          
          TOTAL_ITEMS=${{ needs.data-preparation.outputs.total_items || 25 }}
          BATCH_SIZE=$((TOTAL_ITEMS / 5))  # 5ãƒãƒƒãƒã«åˆ†å‰²
          START_INDEX=$(((BATCH_ID - 1) * BATCH_SIZE + 1))
          END_INDEX=$((BATCH_ID * BATCH_SIZE))
          
          # æœ€å¾Œã®ãƒãƒƒãƒã¯æ®‹ã‚Šã™ã¹ã¦ã‚’å‡¦ç†
          if [ "$BATCH_ID" -eq "5" ]; then
            END_INDEX=$TOTAL_ITEMS
          fi
          
          echo "Processing items $START_INDEX to $END_INDEX"
          echo "start_index=$START_INDEX" >> $GITHUB_OUTPUT
          echo "end_index=$END_INDEX" >> $GITHUB_OUTPUT
          echo "batch_size=$((END_INDEX - START_INDEX + 1))" >> $GITHUB_OUTPUT
          
          # ãƒãƒƒãƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
          cat > "$BATCH_DIR/batch_config.json" << EOF
          {
            "batch_id": $BATCH_ID,
            "start_index": $START_INDEX,
            "end_index": $END_INDEX,
            "batch_size": $((END_INDEX - START_INDEX + 1)),
            "processing_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
      - name: Process Batch Items
        id: process-items
        run: |
          echo "âš™ï¸ Processing batch ${{ matrix.batch_id }} items"
          
          START=${{ steps.load-data.outputs.start_index }}
          END=${{ steps.load-data.outputs.end_index }}
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          # ãƒãƒƒãƒå†…ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç†ãƒ«ãƒ¼ãƒ—
          for i in $(seq $START $END); do
            echo "Processing item #$i"
            
            # å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç†ï¼ˆä¾‹: ç”»åƒç”Ÿæˆï¼‰
            ITEM_SUCCESS=true
            
            # ã“ã“ã§å®Ÿéš›ã®å‡¦ç†ã‚’å®Ÿè¡Œ
            # ä¾‹: MCP ã‚µãƒ¼ãƒ“ã‚¹å‘¼ã³å‡ºã—ã€ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ã€APIå‘¼ã³å‡ºã—ç­‰
            if [ $((i % 7)) -eq 0 ]; then
              # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 7ã®å€æ•°ã§æ„å›³çš„ã‚¨ãƒ©ãƒ¼
              echo "âŒ Item #$i failed (simulated error)"
              ITEM_SUCCESS=false
              FAILED_COUNT=$((FAILED_COUNT + 1))
            else
              # æˆåŠŸå‡¦ç†
              cat > "$BATCH_DIR/item_${i}_result.json" << EOF
          {
            "item_id": $i,
            "status": "success",
            "processed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "output_url": "https://example.com/output_${i}.jpg"
          }
          EOF
              echo "âœ… Item #$i completed successfully"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            sleep 0.1
          done
          
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "total_items=$((SUCCESS_COUNT + FAILED_COUNT))" >> $GITHUB_OUTPUT
          
      - name: Generate Batch Report
        run: |
          echo "ðŸ“Š Generating batch ${{ matrix.batch_id }} report"
          
          # ãƒãƒƒãƒå‡¦ç†çµæžœãƒ¬ãƒãƒ¼ãƒˆ
          cat > "$BATCH_DIR/batch_report.json" << EOF
          {
            "batch_summary": {
              "batch_id": ${{ matrix.batch_id }},
              "total_items": ${{ steps.process-items.outputs.total_items }},
              "success_count": ${{ steps.process-items.outputs.success_count }},
              "failed_count": ${{ steps.process-items.outputs.failed_count }},
              "success_rate": $(echo "scale=2; ${{ steps.process-items.outputs.success_count }} * 100 / ${{ steps.process-items.outputs.total_items }}" | bc -l)
            },
            "processing_details": {
              "start_time": "$(cat $BATCH_DIR/batch_config.json | jq -r '.processing_timestamp')",
              "end_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "batch_range": "Items ${{ steps.load-data.outputs.start_index }}-${{ steps.load-data.outputs.end_index }}"
            }
          }
          EOF
          
      - name: Handle Batch Failures
        if: steps.process-items.outputs.failed_count > 0
        run: |
          echo "âš ï¸ Batch ${{ matrix.batch_id }} had ${{ steps.process-items.outputs.failed_count }} failures"
          
          # å¤±æ•—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥
          echo "Implementing retry strategy for failed items..."
          
          # å¤±æ•—åŽŸå› ã®åˆ†æž
          cat > "$BATCH_DIR/failure_analysis.json" << EOF
          {
            "batch_id": ${{ matrix.batch_id }},
            "failed_items": ${{ steps.process-items.outputs.failed_count }},
            "failure_patterns": {
              "rate_limit": "Possible rate limiting detected",
              "service_error": "External service temporary issue",
              "data_quality": "Input data validation failed"
            },
            "retry_recommendations": [
              "Reduce batch size",
              "Increase delay between requests",
              "Validate input data quality"
            ]
          }
          EOF
          
      - name: Upload Batch Artifacts
        run: |
          # ãƒãƒƒãƒçµæžœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
          echo "ðŸ“¤ Uploading batch ${{ matrix.batch_id }} artifacts"
          
          # æˆåŠŸã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ä¸€è¦§
          find "$BATCH_DIR" -name "item_*_result.json" > "$BATCH_DIR/successful_items.txt"
          
          echo "Batch ${{ matrix.batch_id }} processing completed"
          echo "Success: ${{ steps.process-items.outputs.success_count }}"
          echo "Failed: ${{ steps.process-items.outputs.failed_count }}"

  # ãƒãƒƒãƒçµæžœã®çµ±åˆã‚¸ãƒ§ãƒ–
  batch-summary:
    runs-on: ubuntu-latest
    needs: [batch-processor]
    if: always()  # ã™ã¹ã¦ã®ãƒãƒƒãƒãŒå®Œäº†å¾Œã«å®Ÿè¡Œï¼ˆå¤±æ•—å«ã‚€ï¼‰
    outputs:
      total_processed: ${{ steps.summary.outputs.total }}
      success_count: ${{ steps.summary.outputs.success }}
      failed_count: ${{ steps.summary.outputs.failed }}
      overall_success_rate: ${{ steps.summary.outputs.success_rate }}
    
    steps:
      - name: Collect Batch Results
        id: summary
        run: |
          echo "ðŸ“ˆ Collecting results from all batches"
          
          # å„ãƒãƒƒãƒã®çµæžœã‚’é›†è¨ˆ
          TOTAL_SUCCESS=0
          TOTAL_FAILED=0
          
          # Matrixçµæžœã®é›†è¨ˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ needs.batch-processor.outputs ã‚’ä½¿ç”¨ï¼‰
          for batch_id in {1..5}; do
            # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ï¼ˆå®Ÿéš›ã¯å„ãƒãƒƒãƒã®å‡ºåŠ›ã‹ã‚‰å–å¾—ï¼‰
            batch_success=$((RANDOM % 10 + 5))  # 5-14ã®æˆåŠŸ
            batch_failed=$((RANDOM % 3))        # 0-2ã®å¤±æ•—
            
            TOTAL_SUCCESS=$((TOTAL_SUCCESS + batch_success))
            TOTAL_FAILED=$((TOTAL_FAILED + batch_failed))
            
            echo "Batch $batch_id: $batch_success success, $batch_failed failed"
          done
          
          TOTAL_PROCESSED=$((TOTAL_SUCCESS + TOTAL_FAILED))
          SUCCESS_RATE=$(echo "scale=2; $TOTAL_SUCCESS * 100 / $TOTAL_PROCESSED" | bc -l)
          
          echo "total=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "success=$TOTAL_SUCCESS" >> $GITHUB_OUTPUT
          echo "failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          
          # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          mkdir -p projects/current-session/batch-processing/
          cat > "projects/current-session/batch-processing/final_report.json" << EOF
          {
            "batch_processing_summary": {
              "total_batches": 5,
              "total_items": $TOTAL_PROCESSED,
              "successful_items": $TOTAL_SUCCESS,
              "failed_items": $TOTAL_FAILED,
              "overall_success_rate": $SUCCESS_RATE,
              "processing_completed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            },
            "performance_metrics": {
              "avg_items_per_batch": $(echo "scale=1; $TOTAL_PROCESSED / 5" | bc -l),
              "parallel_efficiency": "High (5-way parallel processing)"
            }
          }
          EOF
          
          echo "âœ… Batch processing summary completed"
          echo "ðŸ“Š Total: $TOTAL_PROCESSED items ($SUCCESS_RATE% success rate)"

# ä½¿ç”¨ä¾‹:
# å¤§é‡ã®ç”»åƒç”Ÿæˆã€å‹•ç”»å‡¦ç†ã€ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãªã©ã§ä½¿ç”¨
# 
# jobs:
#   prepare-data:
#     # ãƒ‡ãƒ¼ã‚¿æº–å‚™ã‚¸ãƒ§ãƒ–
#     
#   process-large-dataset:
#     uses: ./docs/examples/custom-nodes/data-processing/batch-processor.yml
#     needs: [prepare-data]
#     
#   finalize-results:
#     needs: [process-large-dataset]
#     # çµæžœã®æœ€çµ‚å‡¦ç†