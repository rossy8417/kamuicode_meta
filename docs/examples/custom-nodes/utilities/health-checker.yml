name: "Health Checker Custom Node"
description: "ã‚·ã‚¹ãƒ†ãƒ ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ç›£è¦–ã‚’è¡Œã†ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ãƒ‰ä¾‹"

# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Ÿè£…ä¾‹ã§ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå‰å¾Œã§ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹å ´åˆã«ä½¿ç”¨

jobs:
  health-checker:
    runs-on: ubuntu-latest
    outputs:
      system_status: ${{ steps.overall-status.outputs.status }}
      health_score: ${{ steps.overall-status.outputs.score }}
      service_availability: ${{ steps.overall-status.outputs.services }}
      recommendations: ${{ steps.overall-status.outputs.recommendations }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Health Check Environment
        run: |
          mkdir -p projects/current-session/health-monitoring/
          mkdir -p projects/current-session/health-monitoring/{logs,reports}
          echo "HEALTH_DIR=projects/current-session/health-monitoring" >> $GITHUB_ENV
          echo "CHECK_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          
      # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Check System Resources
        id: system-check
        run: |
          echo "ğŸ–¥ï¸ Checking system resources"
          
          # CPUä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
          CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
          
          # ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
          MEMORY_INFO=$(free -m | awk 'NR==2{printf "%.1f", $3*100/$2}')
          
          # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãƒã‚§ãƒƒã‚¯
          DISK_USAGE=$(df -h | awk '$NF=="/"{printf "%s", $5}' | sed 's/%//')
          
          echo "CPU Usage: ${CPU_USAGE}%"
          echo "Memory Usage: ${MEMORY_INFO}%"
          echo "Disk Usage: ${DISK_USAGE}%"
          
          # ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ…‹è©•ä¾¡
          RESOURCE_SCORE=100
          if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
            RESOURCE_SCORE=$((RESOURCE_SCORE - 30))
            echo "âš ï¸ High CPU usage detected"
          fi
          
          if (( $(echo "$MEMORY_INFO > 85" | bc -l) )); then
            RESOURCE_SCORE=$((RESOURCE_SCORE - 25))
            echo "âš ï¸ High memory usage detected"
          fi
          
          if [ "$DISK_USAGE" -gt 90 ]; then
            RESOURCE_SCORE=$((RESOURCE_SCORE - 25))
            echo "âš ï¸ High disk usage detected"
          fi
          
          # çµæœä¿å­˜
          cat > "$HEALTH_DIR/logs/system_resources.json" << EOF
          {
            "timestamp": "$CHECK_TIMESTAMP",
            "cpu_usage": $CPU_USAGE,
            "memory_usage": $MEMORY_INFO,
            "disk_usage": $DISK_USAGE,
            "resource_score": $RESOURCE_SCORE
          }
          EOF
          
          echo "system_score=$RESOURCE_SCORE" >> $GITHUB_OUTPUT
          echo "âœ… System resource check completed (Score: $RESOURCE_SCORE/100)"
          
      # MCPã‚µãƒ¼ãƒ“ã‚¹å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
      - name: Check MCP Services
        id: mcp-check
        run: |
          echo "ğŸ”Œ Checking MCP service availability"
          
          # ä¸»è¦MCPã‚µãƒ¼ãƒ“ã‚¹ã®ç–‘ä¼¼ãƒã‚§ãƒƒã‚¯
          # å®Ÿéš›ã®å®Ÿè£…ã§ã¯å„MCPã‚µãƒ¼ãƒ“ã‚¹ã¸ã®è»½é‡ãªpingã‚„statusãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          
          declare -A services=(
            ["t2i-google-imagen3"]="available"
            ["t2v-fal-veo3-fast"]="available"
            ["t2s-fal-minimax-speech-02-turbo"]="available"
            ["t2m-google-lyria"]="limited"  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: åˆ¶é™ã‚ã‚Š
            ["i2v-fal-hailuo-02-pro"]="unavailable"  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: åˆ©ç”¨ä¸å¯
          )
          
          AVAILABLE_COUNT=0
          LIMITED_COUNT=0
          UNAVAILABLE_COUNT=0
          SERVICE_SCORE=0
          
          for service in "${!services[@]}"; do
            status=${services[$service]}
            echo "Checking $service: $status"
            
            case $status in
              "available")
                AVAILABLE_COUNT=$((AVAILABLE_COUNT + 1))
                SERVICE_SCORE=$((SERVICE_SCORE + 20))
                ;;
              "limited")
                LIMITED_COUNT=$((LIMITED_COUNT + 1))
                SERVICE_SCORE=$((SERVICE_SCORE + 10))
                ;;
              "unavailable")
                UNAVAILABLE_COUNT=$((UNAVAILABLE_COUNT + 1))
                ;;
            esac
          done
          
          # ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ
          cat > "$HEALTH_DIR/logs/mcp_services.json" << EOF
          {
            "timestamp": "$CHECK_TIMESTAMP",
            "service_status": {
              "available": $AVAILABLE_COUNT,
              "limited": $LIMITED_COUNT,
              "unavailable": $UNAVAILABLE_COUNT
            },
            "detailed_status": {
              "t2i-google-imagen3": "available",
              "t2v-fal-veo3-fast": "available", 
              "t2s-fal-minimax-speech-02-turbo": "available",
              "t2m-google-lyria": "limited",
              "i2v-fal-hailuo-02-pro": "unavailable"
            },
            "service_score": $SERVICE_SCORE
          }
          EOF
          
          echo "mcp_score=$SERVICE_SCORE" >> $GITHUB_OUTPUT
          echo "available_services=$AVAILABLE_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… MCP service check completed (Score: $SERVICE_SCORE/100)"
          
      # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒã‚§ãƒƒã‚¯
      - name: Check Network Connectivity
        id: network-check
        run: |
          echo "ğŸŒ Checking network connectivity"
          
          NETWORK_SCORE=100
          
          # ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®æ¥ç¶šãƒ†ã‚¹ãƒˆ
          endpoints=(
            "google.com"
            "github.com"
            "api.openai.com"
          )
          
          FAILED_CONNECTIONS=0
          
          for endpoint in "${endpoints[@]}"; do
            if ping -c 3 "$endpoint" > /dev/null 2>&1; then
              echo "âœ… $endpoint: Connected"
            else
              echo "âŒ $endpoint: Connection failed"
              FAILED_CONNECTIONS=$((FAILED_CONNECTIONS + 1))
              NETWORK_SCORE=$((NETWORK_SCORE - 20))
            fi
          done
          
          # DNSè§£æ±ºãƒ†ã‚¹ãƒˆ
          if nslookup google.com > /dev/null 2>&1; then
            echo "âœ… DNS resolution: Working"
          else
            echo "âŒ DNS resolution: Failed"
            NETWORK_SCORE=$((NETWORK_SCORE - 30))
          fi
          
          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ãƒ¬ãƒãƒ¼ãƒˆ
          cat > "$HEALTH_DIR/logs/network_status.json" << EOF
          {
            "timestamp": "$CHECK_TIMESTAMP",
            "connectivity_tests": {
              "total_endpoints": ${#endpoints[@]},
              "failed_connections": $FAILED_CONNECTIONS,
              "success_rate": $(echo "scale=1; (${#endpoints[@]} - $FAILED_CONNECTIONS) * 100 / ${#endpoints[@]}" | bc -l)
            },
            "network_score": $NETWORK_SCORE
          }
          EOF
          
          echo "network_score=$NETWORK_SCORE" >> $GITHUB_OUTPUT
          echo "âœ… Network connectivity check completed (Score: $NETWORK_SCORE/100)"
          
      # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
      - name: Check Dependencies
        id: dependency-check
        run: |
          echo "ğŸ“¦ Checking system dependencies"
          
          DEPENDENCY_SCORE=100
          MISSING_DEPS=0
          
          # å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®å­˜åœ¨ç¢ºèª
          dependencies=(
            "curl"
            "jq"
            "bc"
            "git"
            "python3"
          )
          
          for dep in "${dependencies[@]}"; do
            if command -v "$dep" > /dev/null 2>&1; then
              echo "âœ… $dep: Available"
            else
              echo "âŒ $dep: Missing"
              MISSING_DEPS=$((MISSING_DEPS + 1))
              DEPENDENCY_SCORE=$((DEPENDENCY_SCORE - 20))
            fi
          done
          
          # Python ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼‰
          python_packages=("requests" "json")
          for package in "${python_packages[@]}"; do
            if python3 -c "import $package" 2>/dev/null; then
              echo "âœ… Python $package: Available"
            else
              echo "âš ï¸ Python $package: Not available (optional)"
              DEPENDENCY_SCORE=$((DEPENDENCY_SCORE - 5))
            fi
          done
          
          # ä¾å­˜é–¢ä¿‚ãƒ¬ãƒãƒ¼ãƒˆ
          cat > "$HEALTH_DIR/logs/dependencies.json" << EOF
          {
            "timestamp": "$CHECK_TIMESTAMP",
            "system_dependencies": {
              "total_checked": ${#dependencies[@]},
              "missing_critical": $MISSING_DEPS,
              "dependency_score": $DEPENDENCY_SCORE
            },
            "missing_dependencies": []
          }
          EOF
          
          echo "dependency_score=$DEPENDENCY_SCORE" >> $GITHUB_OUTPUT
          echo "âœ… Dependency check completed (Score: $DEPENDENCY_SCORE/100)"
          
      # å…¨ä½“çš„ãªãƒ˜ãƒ«ã‚¹è©•ä¾¡
      - name: Overall Health Assessment
        id: overall-status
        run: |
          echo "ğŸ“Š Calculating overall health status"
          
          SYSTEM_SCORE=${{ steps.system-check.outputs.system_score }}
          MCP_SCORE=${{ steps.mcp-check.outputs.mcp_score }}
          NETWORK_SCORE=${{ steps.network-check.outputs.network_score }}
          DEPENDENCY_SCORE=${{ steps.dependency-check.outputs.dependency_score }}
          
          # é‡ã¿ä»˜ãå¹³å‡ã§ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ç®—å‡º
          OVERALL_SCORE=$(echo "scale=1; ($SYSTEM_SCORE * 0.3 + $MCP_SCORE * 0.4 + $NETWORK_SCORE * 0.2 + $DEPENDENCY_SCORE * 0.1)" | bc -l)
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          if (( $(echo "$OVERALL_SCORE >= 90" | bc -l) )); then
            STATUS="healthy"
            STATUS_EMOJI="ğŸŸ¢"
          elif (( $(echo "$OVERALL_SCORE >= 70" | bc -l) )); then
            STATUS="warning"
            STATUS_EMOJI="ğŸŸ¡"
          else
            STATUS="critical"
            STATUS_EMOJI="ğŸ”´"
          fi
          
          # æ¨å¥¨äº‹é …ç”Ÿæˆ
          RECOMMENDATIONS='[]'
          if [ "$SYSTEM_SCORE" -lt 80 ]; then
            RECOMMENDATIONS=$(echo "$RECOMMENDATIONS" | jq '. + ["Consider reducing system load"]')
          fi
          if [ "$MCP_SCORE" -lt 60 ]; then
            RECOMMENDATIONS=$(echo "$RECOMMENDATIONS" | jq '. + ["Check MCP service configurations"]')
          fi
          if [ "$NETWORK_SCORE" -lt 80 ]; then
            RECOMMENDATIONS=$(echo "$RECOMMENDATIONS" | jq '. + ["Verify network connectivity"]')
          fi
          
          # æœ€çµ‚ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ
          cat > "$HEALTH_DIR/reports/health_report.json" << EOF
          {
            "health_check_summary": {
              "timestamp": "$CHECK_TIMESTAMP",
              "overall_status": "$STATUS",
              "overall_score": $OVERALL_SCORE,
              "component_scores": {
                "system_resources": $SYSTEM_SCORE,
                "mcp_services": $MCP_SCORE,
                "network_connectivity": $NETWORK_SCORE,
                "dependencies": $DEPENDENCY_SCORE
              }
            },
            "service_availability": {
              "available_mcp_services": ${{ steps.mcp-check.outputs.available_services }},
              "total_mcp_services": 5
            },
            "recommendations": $RECOMMENDATIONS,
            "next_check_suggested": "$(date -u -d '+1 hour' +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
          # å‡ºåŠ›è¨­å®š
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "score=$OVERALL_SCORE" >> $GITHUB_OUTPUT
          echo "services=${{ steps.mcp-check.outputs.available_services }}" >> $GITHUB_OUTPUT
          echo "recommendations=$RECOMMENDATIONS" >> $GITHUB_OUTPUT
          
          echo "$STATUS_EMOJI System Health Status: $STATUS (Score: $OVERALL_SCORE/100)"
          
      # ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      - name: Generate Alerts
        if: steps.overall-status.outputs.score < 70
        run: |
          echo "ğŸš¨ Health check detected issues - generating alerts"
          
          OVERALL_SCORE=${{ steps.overall-status.outputs.score }}
          
          # é‡è¦ãªã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
          cat > "$HEALTH_DIR/reports/alert.json" << EOF
          {
            "alert": {
              "severity": "$(if (( $(echo "$OVERALL_SCORE < 50" | bc -l) )); then echo "critical"; else echo "warning"; fi)",
              "message": "System health score below threshold: $OVERALL_SCORE/100",
              "timestamp": "$CHECK_TIMESTAMP",
              "affected_components": [
                $(if [ "${{ steps.system-check.outputs.system_score }}" -lt 80 ]; then echo '"system_resources"'; fi),
                $(if [ "${{ steps.mcp-check.outputs.mcp_score }}" -lt 60 ]; then echo '"mcp_services"'; fi),
                $(if [ "${{ steps.network-check.outputs.network_score }}" -lt 80 ]; then echo '"network"'; fi)
              ],
              "immediate_actions_required": true
            }
          }
          EOF
          
          echo "ğŸš¨ Alert generated for health score: $OVERALL_SCORE"
          
      # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Cleanup Old Health Logs
        run: |
          echo "ğŸ§¹ Cleaning up old health check logs"
          
          # 7æ—¥ä»¥ä¸Šå¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          find "$HEALTH_DIR/logs" -name "*.json" -mtime +7 -delete || true
          find "$HEALTH_DIR/reports" -name "*.json" -mtime +7 -delete || true
          
          echo "âœ… Health check completed and cleanup performed"

# ä½¿ç”¨ä¾‹:
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå‰ã®äº‹å‰ãƒã‚§ãƒƒã‚¯ã€å®šæœŸç›£è¦–ã€éšœå®³æ¤œçŸ¥ãªã©ã§ä½¿ç”¨
#
# jobs:
#   pre-execution-check:
#     uses: ./docs/examples/custom-nodes/utilities/health-checker.yml
#     
#   main-workflow:
#     needs: [pre-execution-check]
#     if: needs.pre-execution-check.outputs.system_status == 'healthy'
#     # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‡¦ç†
#     
#   post-execution-check:
#     needs: [main-workflow]
#     if: always()
#     uses: ./docs/examples/custom-nodes/utilities/health-checker.yml